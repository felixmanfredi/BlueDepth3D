import './polyfills.server.mjs';
import{$,$a as Ia,A as be,Aa as yn,B as Ae,Ba as Ue,C as es,D as N,Da as ga,E as B,Ea as pa,F as pi,Fa as ss,G as mi,Ga as ma,H as Ee,Ha as va,I as Me,Ia as ya,J as oa,Ja as _a,K as aa,Ka as Ea,L as la,La as Sa,M as X,Ma as xa,N as re,Na as _n,O as pn,Oa as ns,P as gt,Pa as En,Q as Qe,Qa as Sn,R as vi,Ra as Ta,S as pt,T as ts,U as Oe,Ua as ba,V as le,W as We,X as _,Y as E,Ya as Aa,Z as at,_ as Mt,a as Qi,aa as F,b as Zi,ba as mn,c as ke,ca as yi,d as Zo,da as vn,e as Jo,ea as _i,f as ui,fa as Ot,g as ea,ga as Ft,h as ta,ha as x,i as ia,ia as is,j as zt,ja as Ze,k as sa,ka as Je,l as kt,la as et,m as fn,ma as Tt,n as na,na as Ei,o as Ji,oa as ca,p as ra,q as gn,qa as da,r as je,ra as ha,s as fi,t as ye,u as Te,v as ot,va as Si,w as J,x as gi,xa as mt,y as Pe,ya as ua,z as Pt,za as fa}from"./chunk-V5MMV7BG.mjs";import{a as Ke,b as xt}from"./chunk-VVCT4QZE.mjs";var Ca=(()=>{class n{constructor(){this.title="cameracontrol"}static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275cmp=Pt({type:n,selectors:[["app-root"]],standalone:!0,features:[Ei],decls:2,vars:0,consts:[[1,"container-fluid"]],template:function(i,s){i&1&&(_(0,"div",0),at(1,"router-outlet"),E())},dependencies:[Aa]})}}return n})();var Fa=(()=>{class n{constructor(t,i){this._renderer=t,this._elementRef=i,this.onChange=s=>{},this.onTouched=()=>{}}setProperty(t,i){this._renderer.setProperty(this._elementRef.nativeElement,t,i)}registerOnTouched(t){this.onTouched=t}registerOnChange(t){this.onChange=t}setDisabledState(t){this.setProperty("disabled",t)}static{this.\u0275fac=function(i){return new(i||n)(re(gt),re(Ee))}}static{this.\u0275dir=Ae({type:n})}}return n})(),In=(()=>{class n extends Fa{static{this.\u0275fac=(()=>{let t;return function(s){return(t||(t=pi(n)))(s||n)}})()}static{this.\u0275dir=Ae({type:n,features:[pt]})}}return n})(),ls=new ot("");var Xd={provide:ls,useExisting:fi(()=>Na),multi:!0};function Qd(){let n=yn()?yn().getUserAgent():"";return/android (\d+)/.test(n.toLowerCase())}var Zd=new ot(""),Na=(()=>{class n extends Fa{constructor(t,i,s){super(t,i),this._compositionMode=s,this._composing=!1,this._compositionMode==null&&(this._compositionMode=!Qd())}writeValue(t){let i=t??"";this.setProperty("value",i)}_handleInput(t){(!this._compositionMode||this._compositionMode&&!this._composing)&&this.onChange(t)}_compositionStart(){this._composing=!0}_compositionEnd(t){this._composing=!1,this._compositionMode&&this.onChange(t)}static{this.\u0275fac=function(i){return new(i||n)(re(gt),re(Ee),re(Zd,8))}}static{this.\u0275dir=Ae({type:n,selectors:[["input","formControlName","",3,"type","checkbox"],["textarea","formControlName",""],["input","formControl","",3,"type","checkbox"],["textarea","formControl",""],["input","ngModel","",3,"type","checkbox"],["textarea","ngModel",""],["","ngDefaultControl",""]],hostBindings:function(i,s){i&1&&$("input",function(o){return s._handleInput(o.target.value)})("blur",function(){return s.onTouched()})("compositionstart",function(){return s._compositionStart()})("compositionend",function(o){return s._compositionEnd(o.target.value)})},features:[Tt([Xd]),pt]})}}return n})();var Jd=new ot(""),eh=new ot("");function Ba(n){return n!=null}function Ua(n){return da(n)?Zo(n):n}function Va(n){let e={};return n.forEach(t=>{e=t!=null?Ke(Ke({},e),t):e}),Object.keys(e).length===0?null:e}function $a(n,e){return e.map(t=>t(n))}function th(n){return!n.validate}function Ga(n){return n.map(e=>th(e)?e:t=>e.validate(t))}function ih(n){if(!n)return null;let e=n.filter(Ba);return e.length==0?null:function(t){return Va($a(t,e))}}function Ha(n){return n!=null?ih(Ga(n)):null}function sh(n){if(!n)return null;let e=n.filter(Ba);return e.length==0?null:function(t){let i=$a(t,e).map(Ua);return ia(i).pipe(ui(Va))}}function Ka(n){return n!=null?sh(Ga(n)):null}function Da(n,e){return n===null?[e]:Array.isArray(n)?[...n,e]:[n,e]}function nh(n){return n._rawValidators}function rh(n){return n._rawAsyncValidators}function xn(n){return n?Array.isArray(n)?n:[n]:[]}function os(n,e){return Array.isArray(n)?n.includes(e):n===e}function Ra(n,e){let t=xn(e);return xn(n).forEach(s=>{os(t,s)||t.push(s)}),t}function La(n,e){return xn(e).filter(t=>!os(n,t))}var as=class{constructor(){this._rawValidators=[],this._rawAsyncValidators=[],this._onDestroyCallbacks=[]}get value(){return this.control?this.control.value:null}get valid(){return this.control?this.control.valid:null}get invalid(){return this.control?this.control.invalid:null}get pending(){return this.control?this.control.pending:null}get disabled(){return this.control?this.control.disabled:null}get enabled(){return this.control?this.control.enabled:null}get errors(){return this.control?this.control.errors:null}get pristine(){return this.control?this.control.pristine:null}get dirty(){return this.control?this.control.dirty:null}get touched(){return this.control?this.control.touched:null}get status(){return this.control?this.control.status:null}get untouched(){return this.control?this.control.untouched:null}get statusChanges(){return this.control?this.control.statusChanges:null}get valueChanges(){return this.control?this.control.valueChanges:null}get path(){return null}_setValidators(e){this._rawValidators=e||[],this._composedValidatorFn=Ha(this._rawValidators)}_setAsyncValidators(e){this._rawAsyncValidators=e||[],this._composedAsyncValidatorFn=Ka(this._rawAsyncValidators)}get validator(){return this._composedValidatorFn||null}get asyncValidator(){return this._composedAsyncValidatorFn||null}_registerOnDestroy(e){this._onDestroyCallbacks.push(e)}_invokeOnDestroyCallbacks(){this._onDestroyCallbacks.forEach(e=>e()),this._onDestroyCallbacks=[]}reset(e=void 0){this.control&&this.control.reset(e)}hasError(e,t){return this.control?this.control.hasError(e,t):!1}getError(e,t){return this.control?this.control.getError(e,t):null}},Tn=class extends as{get formDirective(){return null}get path(){return null}},bi=class extends as{constructor(){super(...arguments),this._parent=null,this.name=null,this.valueAccessor=null}},bn=class{constructor(e){this._cd=e}get isTouched(){return!!this._cd?.control?.touched}get isUntouched(){return!!this._cd?.control?.untouched}get isPristine(){return!!this._cd?.control?.pristine}get isDirty(){return!!this._cd?.control?.dirty}get isValid(){return!!this._cd?.control?.valid}get isInvalid(){return!!this._cd?.control?.invalid}get isPending(){return!!this._cd?.control?.pending}get isSubmitted(){return!!this._cd?.submitted}},oh={"[class.ng-untouched]":"isUntouched","[class.ng-touched]":"isTouched","[class.ng-pristine]":"isPristine","[class.ng-dirty]":"isDirty","[class.ng-valid]":"isValid","[class.ng-invalid]":"isInvalid","[class.ng-pending]":"isPending"},Qm=xt(Ke({},oh),{"[class.ng-submitted]":"isSubmitted"}),ja=(()=>{class n extends bn{constructor(t){super(t)}static{this.\u0275fac=function(i){return new(i||n)(re(bi,2))}}static{this.\u0275dir=Ae({type:n,selectors:[["","formControlName",""],["","ngModel",""],["","formControl",""]],hostVars:14,hostBindings:function(i,s){i&2&&We("ng-untouched",s.isUntouched)("ng-touched",s.isTouched)("ng-pristine",s.isPristine)("ng-dirty",s.isDirty)("ng-valid",s.isValid)("ng-invalid",s.isInvalid)("ng-pending",s.isPending)},features:[pt]})}}return n})();var xi="VALID",rs="INVALID",qt="PENDING",Ti="DISABLED";function ah(n){return(cs(n)?n.validators:n)||null}function lh(n){return Array.isArray(n)?Ha(n):n||null}function ch(n,e){return(cs(e)?e.asyncValidators:n)||null}function dh(n){return Array.isArray(n)?Ka(n):n||null}function cs(n){return n!=null&&!Array.isArray(n)&&typeof n=="object"}var An=class{constructor(e,t){this._pendingDirty=!1,this._hasOwnPendingAsyncValidator=!1,this._pendingTouched=!1,this._onCollectionChange=()=>{},this._parent=null,this.pristine=!0,this.touched=!1,this._onDisabledChange=[],this._assignValidators(e),this._assignAsyncValidators(t)}get validator(){return this._composedValidatorFn}set validator(e){this._rawValidators=this._composedValidatorFn=e}get asyncValidator(){return this._composedAsyncValidatorFn}set asyncValidator(e){this._rawAsyncValidators=this._composedAsyncValidatorFn=e}get parent(){return this._parent}get valid(){return this.status===xi}get invalid(){return this.status===rs}get pending(){return this.status==qt}get disabled(){return this.status===Ti}get enabled(){return this.status!==Ti}get dirty(){return!this.pristine}get untouched(){return!this.touched}get updateOn(){return this._updateOn?this._updateOn:this.parent?this.parent.updateOn:"change"}setValidators(e){this._assignValidators(e)}setAsyncValidators(e){this._assignAsyncValidators(e)}addValidators(e){this.setValidators(Ra(e,this._rawValidators))}addAsyncValidators(e){this.setAsyncValidators(Ra(e,this._rawAsyncValidators))}removeValidators(e){this.setValidators(La(e,this._rawValidators))}removeAsyncValidators(e){this.setAsyncValidators(La(e,this._rawAsyncValidators))}hasValidator(e){return os(this._rawValidators,e)}hasAsyncValidator(e){return os(this._rawAsyncValidators,e)}clearValidators(){this.validator=null}clearAsyncValidators(){this.asyncValidator=null}markAsTouched(e={}){this.touched=!0,this._parent&&!e.onlySelf&&this._parent.markAsTouched(e)}markAllAsTouched(){this.markAsTouched({onlySelf:!0}),this._forEachChild(e=>e.markAllAsTouched())}markAsUntouched(e={}){this.touched=!1,this._pendingTouched=!1,this._forEachChild(t=>{t.markAsUntouched({onlySelf:!0})}),this._parent&&!e.onlySelf&&this._parent._updateTouched(e)}markAsDirty(e={}){this.pristine=!1,this._parent&&!e.onlySelf&&this._parent.markAsDirty(e)}markAsPristine(e={}){this.pristine=!0,this._pendingDirty=!1,this._forEachChild(t=>{t.markAsPristine({onlySelf:!0})}),this._parent&&!e.onlySelf&&this._parent._updatePristine(e)}markAsPending(e={}){this.status=qt,e.emitEvent!==!1&&this.statusChanges.emit(this.status),this._parent&&!e.onlySelf&&this._parent.markAsPending(e)}disable(e={}){let t=this._parentMarkedDirty(e.onlySelf);this.status=Ti,this.errors=null,this._forEachChild(i=>{i.disable(xt(Ke({},e),{onlySelf:!0}))}),this._updateValue(),e.emitEvent!==!1&&(this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._updateAncestors(xt(Ke({},e),{skipPristineCheck:t})),this._onDisabledChange.forEach(i=>i(!0))}enable(e={}){let t=this._parentMarkedDirty(e.onlySelf);this.status=xi,this._forEachChild(i=>{i.enable(xt(Ke({},e),{onlySelf:!0}))}),this.updateValueAndValidity({onlySelf:!0,emitEvent:e.emitEvent}),this._updateAncestors(xt(Ke({},e),{skipPristineCheck:t})),this._onDisabledChange.forEach(i=>i(!1))}_updateAncestors(e){this._parent&&!e.onlySelf&&(this._parent.updateValueAndValidity(e),e.skipPristineCheck||this._parent._updatePristine(),this._parent._updateTouched())}setParent(e){this._parent=e}getRawValue(){return this.value}updateValueAndValidity(e={}){this._setInitialStatus(),this._updateValue(),this.enabled&&(this._cancelExistingSubscription(),this.errors=this._runValidator(),this.status=this._calculateStatus(),(this.status===xi||this.status===qt)&&this._runAsyncValidator(e.emitEvent)),e.emitEvent!==!1&&(this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._parent&&!e.onlySelf&&this._parent.updateValueAndValidity(e)}_updateTreeValidity(e={emitEvent:!0}){this._forEachChild(t=>t._updateTreeValidity(e)),this.updateValueAndValidity({onlySelf:!0,emitEvent:e.emitEvent})}_setInitialStatus(){this.status=this._allControlsDisabled()?Ti:xi}_runValidator(){return this.validator?this.validator(this):null}_runAsyncValidator(e){if(this.asyncValidator){this.status=qt,this._hasOwnPendingAsyncValidator=!0;let t=Ua(this.asyncValidator(this));this._asyncValidationSubscription=t.subscribe(i=>{this._hasOwnPendingAsyncValidator=!1,this.setErrors(i,{emitEvent:e})})}}_cancelExistingSubscription(){this._asyncValidationSubscription&&(this._asyncValidationSubscription.unsubscribe(),this._hasOwnPendingAsyncValidator=!1)}setErrors(e,t={}){this.errors=e,this._updateControlsErrors(t.emitEvent!==!1)}get(e){let t=e;return t==null||(Array.isArray(t)||(t=t.split(".")),t.length===0)?null:t.reduce((i,s)=>i&&i._find(s),this)}getError(e,t){let i=t?this.get(t):this;return i&&i.errors?i.errors[e]:null}hasError(e,t){return!!this.getError(e,t)}get root(){let e=this;for(;e._parent;)e=e._parent;return e}_updateControlsErrors(e){this.status=this._calculateStatus(),e&&this.statusChanges.emit(this.status),this._parent&&this._parent._updateControlsErrors(e)}_initObservables(){this.valueChanges=new Me,this.statusChanges=new Me}_calculateStatus(){return this._allControlsDisabled()?Ti:this.errors?rs:this._hasOwnPendingAsyncValidator||this._anyControlsHaveStatus(qt)?qt:this._anyControlsHaveStatus(rs)?rs:xi}_anyControlsHaveStatus(e){return this._anyControls(t=>t.status===e)}_anyControlsDirty(){return this._anyControls(e=>e.dirty)}_anyControlsTouched(){return this._anyControls(e=>e.touched)}_updatePristine(e={}){this.pristine=!this._anyControlsDirty(),this._parent&&!e.onlySelf&&this._parent._updatePristine(e)}_updateTouched(e={}){this.touched=this._anyControlsTouched(),this._parent&&!e.onlySelf&&this._parent._updateTouched(e)}_registerOnCollectionChange(e){this._onCollectionChange=e}_setUpdateStrategy(e){cs(e)&&e.updateOn!=null&&(this._updateOn=e.updateOn)}_parentMarkedDirty(e){let t=this._parent&&this._parent.dirty;return!e&&!!t&&!this._parent._anyControlsDirty()}_find(e){return null}_assignValidators(e){this._rawValidators=Array.isArray(e)?e.slice():e,this._composedValidatorFn=lh(this._rawValidators)}_assignAsyncValidators(e){this._rawAsyncValidators=Array.isArray(e)?e.slice():e,this._composedAsyncValidatorFn=dh(this._rawAsyncValidators)}};var Wa=new ot("CallSetDisabledState",{providedIn:"root",factory:()=>Cn}),Cn="always";function hh(n,e){return[...e.path,n]}function uh(n,e,t=Cn){gh(n,e),e.valueAccessor.writeValue(n.value),(n.disabled||t==="always")&&e.valueAccessor.setDisabledState?.(n.disabled),ph(n,e),vh(n,e),mh(n,e),fh(n,e)}function wa(n,e){n.forEach(t=>{t.registerOnValidatorChange&&t.registerOnValidatorChange(e)})}function fh(n,e){if(e.valueAccessor.setDisabledState){let t=i=>{e.valueAccessor.setDisabledState(i)};n.registerOnDisabledChange(t),e._registerOnDestroy(()=>{n._unregisterOnDisabledChange(t)})}}function gh(n,e){let t=nh(n);e.validator!==null?n.setValidators(Da(t,e.validator)):typeof t=="function"&&n.setValidators([t]);let i=rh(n);e.asyncValidator!==null?n.setAsyncValidators(Da(i,e.asyncValidator)):typeof i=="function"&&n.setAsyncValidators([i]);let s=()=>n.updateValueAndValidity();wa(e._rawValidators,s),wa(e._rawAsyncValidators,s)}function ph(n,e){e.valueAccessor.registerOnChange(t=>{n._pendingValue=t,n._pendingChange=!0,n._pendingDirty=!0,n.updateOn==="change"&&Ya(n,e)})}function mh(n,e){e.valueAccessor.registerOnTouched(()=>{n._pendingTouched=!0,n.updateOn==="blur"&&n._pendingChange&&Ya(n,e),n.updateOn!=="submit"&&n.markAsTouched()})}function Ya(n,e){n._pendingDirty&&n.markAsDirty(),n.setValue(n._pendingValue,{emitModelToViewChange:!1}),e.viewToModelUpdate(n._pendingValue),n._pendingChange=!1}function vh(n,e){let t=(i,s)=>{e.valueAccessor.writeValue(i),s&&e.viewToModelUpdate(i)};n.registerOnChange(t),e._registerOnDestroy(()=>{n._unregisterOnChange(t)})}function yh(n,e){if(!n.hasOwnProperty("model"))return!1;let t=n.model;return t.isFirstChange()?!0:!Object.is(e,t.currentValue)}function _h(n){return Object.getPrototypeOf(n.constructor)===In}function Eh(n,e){if(!e)return null;Array.isArray(e);let t,i,s;return e.forEach(r=>{r.constructor===Na?t=r:_h(r)?i=r:s=r}),s||i||t||null}function ka(n,e){let t=n.indexOf(e);t>-1&&n.splice(t,1)}function Pa(n){return typeof n=="object"&&n!==null&&Object.keys(n).length===2&&"value"in n&&"disabled"in n}var Sh=class extends An{constructor(e=null,t,i){super(ah(t),ch(i,t)),this.defaultValue=null,this._onChange=[],this._pendingChange=!1,this._applyFormState(e),this._setUpdateStrategy(t),this._initObservables(),this.updateValueAndValidity({onlySelf:!0,emitEvent:!!this.asyncValidator}),cs(t)&&(t.nonNullable||t.initialValueIsDefault)&&(Pa(e)?this.defaultValue=e.value:this.defaultValue=e)}setValue(e,t={}){this.value=this._pendingValue=e,this._onChange.length&&t.emitModelToViewChange!==!1&&this._onChange.forEach(i=>i(this.value,t.emitViewToModelChange!==!1)),this.updateValueAndValidity(t)}patchValue(e,t={}){this.setValue(e,t)}reset(e=this.defaultValue,t={}){this._applyFormState(e),this.markAsPristine(t),this.markAsUntouched(t),this.setValue(this.value,t),this._pendingChange=!1}_updateValue(){}_anyControls(e){return!1}_allControlsDisabled(){return this.disabled}registerOnChange(e){this._onChange.push(e)}_unregisterOnChange(e){ka(this._onChange,e)}registerOnDisabledChange(e){this._onDisabledChange.push(e)}_unregisterOnDisabledChange(e){ka(this._onDisabledChange,e)}_forEachChild(e){}_syncPendingControls(){return this.updateOn==="submit"&&(this._pendingDirty&&this.markAsDirty(),this._pendingTouched&&this.markAsTouched(),this._pendingChange)?(this.setValue(this._pendingValue,{onlySelf:!0,emitModelToViewChange:!1}),!0):!1}_applyFormState(e){Pa(e)?(this.value=this._pendingValue=e.value,e.disabled?this.disable({onlySelf:!0,emitEvent:!1}):this.enable({onlySelf:!0,emitEvent:!1})):this.value=this._pendingValue=e}};var xh={provide:bi,useExisting:fi(()=>Dn)},Ma=Promise.resolve(),Dn=(()=>{class n extends bi{constructor(t,i,s,r,o,a){super(),this._changeDetectorRef=o,this.callSetDisabledState=a,this.control=new Sh,this._registered=!1,this.name="",this.update=new Me,this._parent=t,this._setValidators(i),this._setAsyncValidators(s),this.valueAccessor=Eh(this,r)}ngOnChanges(t){if(this._checkForErrors(),!this._registered||"name"in t){if(this._registered&&(this._checkName(),this.formDirective)){let i=t.name.previousValue;this.formDirective.removeControl({name:i,path:this._getPath(i)})}this._setUpControl()}"isDisabled"in t&&this._updateDisabled(t),yh(t,this.viewModel)&&(this._updateValue(this.model),this.viewModel=this.model)}ngOnDestroy(){this.formDirective&&this.formDirective.removeControl(this)}get path(){return this._getPath(this.name)}get formDirective(){return this._parent?this._parent.formDirective:null}viewToModelUpdate(t){this.viewModel=t,this.update.emit(t)}_setUpControl(){this._setUpdateStrategy(),this._isStandalone()?this._setUpStandalone():this.formDirective.addControl(this),this._registered=!0}_setUpdateStrategy(){this.options&&this.options.updateOn!=null&&(this.control._updateOn=this.options.updateOn)}_isStandalone(){return!this._parent||!!(this.options&&this.options.standalone)}_setUpStandalone(){uh(this.control,this,this.callSetDisabledState),this.control.updateValueAndValidity({emitEvent:!1})}_checkForErrors(){this._isStandalone()||this._checkParentType(),this._checkName()}_checkParentType(){}_checkName(){this.options&&this.options.name&&(this.name=this.options.name),!this._isStandalone()&&this.name}_updateValue(t){Ma.then(()=>{this.control.setValue(t,{emitViewToModelChange:!1}),this._changeDetectorRef?.markForCheck()})}_updateDisabled(t){let i=t.isDisabled.currentValue,s=i!==0&&mt(i);Ma.then(()=>{s&&!this.control.disabled?this.control.disable():!s&&this.control.disabled&&this.control.enable(),this._changeDetectorRef?.markForCheck()})}_getPath(t){return this._parent?hh(t,this._parent):[t]}static{this.\u0275fac=function(i){return new(i||n)(re(Tn,9),re(Jd,10),re(eh,10),re(ls,10),re(Si,8),re(Wa,8))}}static{this.\u0275dir=Ae({type:n,selectors:[["","ngModel","",3,"formControlName","",3,"formControl",""]],inputs:{name:"name",isDisabled:[Pe.None,"disabled","isDisabled"],model:[Pe.None,"ngModel","model"],options:[Pe.None,"ngModelOptions","options"]},outputs:{update:"ngModelChange"},exportAs:["ngModel"],features:[Tt([xh]),pt,es]})}}return n})();var Th={provide:ls,useExisting:fi(()=>ds),multi:!0};function za(n,e){return n==null?`${e}`:(e&&typeof e=="object"&&(e="Object"),`${n}: ${e}`.slice(0,50))}function bh(n){return n.split(":")[0]}var ds=(()=>{class n extends In{constructor(){super(...arguments),this._optionMap=new Map,this._idCounter=0,this._compareWith=Object.is}set compareWith(t){this._compareWith=t}writeValue(t){this.value=t;let i=this._getOptionId(t),s=za(i,t);this.setProperty("value",s)}registerOnChange(t){this.onChange=i=>{this.value=this._getOptionValue(i),t(this.value)}}_registerOption(){return(this._idCounter++).toString()}_getOptionId(t){for(let i of this._optionMap.keys())if(this._compareWith(this._optionMap.get(i),t))return i;return null}_getOptionValue(t){let i=bh(t);return this._optionMap.has(i)?this._optionMap.get(i):t}static{this.\u0275fac=(()=>{let t;return function(s){return(t||(t=pi(n)))(s||n)}})()}static{this.\u0275dir=Ae({type:n,selectors:[["select","formControlName","",3,"multiple",""],["select","formControl","",3,"multiple",""],["select","ngModel","",3,"multiple",""]],hostBindings:function(i,s){i&1&&$("change",function(o){return s.onChange(o.target.value)})("blur",function(){return s.onTouched()})},inputs:{compareWith:"compareWith"},features:[Tt([Th]),pt]})}}return n})(),qa=(()=>{class n{constructor(t,i,s){this._element=t,this._renderer=i,this._select=s,this._select&&(this.id=this._select._registerOption())}set ngValue(t){this._select!=null&&(this._select._optionMap.set(this.id,t),this._setElementValue(za(this.id,t)),this._select.writeValue(this._select.value))}set value(t){this._setElementValue(t),this._select&&this._select.writeValue(this._select.value)}_setElementValue(t){this._renderer.setProperty(this._element.nativeElement,"value",t)}ngOnDestroy(){this._select&&(this._select._optionMap.delete(this.id),this._select.writeValue(this._select.value))}static{this.\u0275fac=function(i){return new(i||n)(re(Ee),re(gt),re(ds,9))}}static{this.\u0275dir=Ae({type:n,selectors:[["option"]],inputs:{ngValue:"ngValue",value:"value"}})}}return n})(),Ah={provide:ls,useExisting:fi(()=>Xa),multi:!0};function Oa(n,e){return n==null?`${e}`:(typeof e=="string"&&(e=`'${e}'`),e&&typeof e=="object"&&(e="Object"),`${n}: ${e}`.slice(0,50))}function Ih(n){return n.split(":")[0]}var Xa=(()=>{class n extends In{constructor(){super(...arguments),this._optionMap=new Map,this._idCounter=0,this._compareWith=Object.is}set compareWith(t){this._compareWith=t}writeValue(t){this.value=t;let i;if(Array.isArray(t)){let s=t.map(r=>this._getOptionId(r));i=(r,o)=>{r._setSelected(s.indexOf(o.toString())>-1)}}else i=(s,r)=>{s._setSelected(!1)};this._optionMap.forEach(i)}registerOnChange(t){this.onChange=i=>{let s=[],r=i.selectedOptions;if(r!==void 0){let o=r;for(let a=0;a<o.length;a++){let c=o[a],l=this._getOptionValue(c.value);s.push(l)}}else{let o=i.options;for(let a=0;a<o.length;a++){let c=o[a];if(c.selected){let l=this._getOptionValue(c.value);s.push(l)}}}this.value=s,t(s)}}_registerOption(t){let i=(this._idCounter++).toString();return this._optionMap.set(i,t),i}_getOptionId(t){for(let i of this._optionMap.keys())if(this._compareWith(this._optionMap.get(i)._value,t))return i;return null}_getOptionValue(t){let i=Ih(t);return this._optionMap.has(i)?this._optionMap.get(i)._value:t}static{this.\u0275fac=(()=>{let t;return function(s){return(t||(t=pi(n)))(s||n)}})()}static{this.\u0275dir=Ae({type:n,selectors:[["select","multiple","","formControlName",""],["select","multiple","","formControl",""],["select","multiple","","ngModel",""]],hostBindings:function(i,s){i&1&&$("change",function(o){return s.onChange(o.target)})("blur",function(){return s.onTouched()})},inputs:{compareWith:"compareWith"},features:[Tt([Ah]),pt]})}}return n})(),Qa=(()=>{class n{constructor(t,i,s){this._element=t,this._renderer=i,this._select=s,this._select&&(this.id=this._select._registerOption(this))}set ngValue(t){this._select!=null&&(this._value=t,this._setElementValue(Oa(this.id,t)),this._select.writeValue(this._select.value))}set value(t){this._select?(this._value=t,this._setElementValue(Oa(this.id,t)),this._select.writeValue(this._select.value)):this._setElementValue(t)}_setElementValue(t){this._renderer.setProperty(this._element.nativeElement,"value",t)}_setSelected(t){this._renderer.setProperty(this._element.nativeElement,"selected",t)}ngOnDestroy(){this._select&&(this._select._optionMap.delete(this.id),this._select.writeValue(this._select.value))}static{this.\u0275fac=function(i){return new(i||n)(re(Ee),re(gt),re(Xa,9))}}static{this.\u0275dir=Ae({type:n,selectors:[["option"]],inputs:{ngValue:"ngValue",value:"value"}})}}return n})();var Ch=(()=>{class n{static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275mod=be({type:n})}static{this.\u0275inj=Te({})}}return n})();var Za=(()=>{class n{static withConfig(t){return{ngModule:n,providers:[{provide:Wa,useValue:t.callSetDisabledState??Cn}]}}static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275mod=be({type:n})}static{this.\u0275inj=Te({imports:[Ch]})}}return n})();function Xt(n){return Array.isArray(n)?n:[n]}function _e(n){return n==null?"":typeof n=="string"?n:`${n}px`}function Ja(n){return n instanceof Ee?n.nativeElement:n}var Rn;try{Rn=typeof Intl<"u"&&Intl.v8BreakIterator}catch{Rn=!1}var vt=(()=>{class n{constructor(t){this._platformId=t,this.isBrowser=this._platformId?ma(this._platformId):typeof document=="object"&&!!document,this.EDGE=this.isBrowser&&/(edge)/i.test(navigator.userAgent),this.TRIDENT=this.isBrowser&&/(msie|trident)/i.test(navigator.userAgent),this.BLINK=this.isBrowser&&!!(window.chrome||Rn)&&typeof CSS<"u"&&!this.EDGE&&!this.TRIDENT,this.WEBKIT=this.isBrowser&&/AppleWebKit/i.test(navigator.userAgent)&&!this.BLINK&&!this.EDGE&&!this.TRIDENT,this.IOS=this.isBrowser&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!("MSStream"in window),this.FIREFOX=this.isBrowser&&/(firefox|minefield)/i.test(navigator.userAgent),this.ANDROID=this.isBrowser&&/android/i.test(navigator.userAgent)&&!this.TRIDENT,this.SAFARI=this.isBrowser&&/safari/i.test(navigator.userAgent)&&this.WEBKIT}static{this.\u0275fac=function(i){return new(i||n)(J(oa))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var Nt;function el(){if(Nt==null){if(typeof document!="object"||!document||typeof Element!="function"||!Element)return Nt=!1,Nt;if("scrollBehavior"in document.documentElement.style)Nt=!0;else{let n=Element.prototype.scrollTo;n?Nt=!/\{\s*\[native code\]\s*\}/.test(n.toString()):Nt=!1}}return Nt}function Ln(n){return n.composedPath?n.composedPath()[0]:n.target}function wn(){return typeof __karma__<"u"&&!!__karma__||typeof jasmine<"u"&&!!jasmine||typeof jest<"u"&&!!jest||typeof Mocha<"u"&&!!Mocha}var Rh=new ot("cdk-dir-doc",{providedIn:"root",factory:Lh});function Lh(){return gi(Ue)}var wh=/^(ar|ckb|dv|he|iw|fa|nqo|ps|sd|ug|ur|yi|.*[-_](Adlm|Arab|Hebr|Nkoo|Rohg|Thaa))(?!.*[-_](Latn|Cyrl)($|-|_))($|-|_)/i;function kh(n){let e=n?.toLowerCase()||"";return e==="auto"&&typeof navigator<"u"&&navigator?.language?wh.test(navigator.language)?"rtl":"ltr":e==="rtl"?"rtl":"ltr"}var tl=(()=>{class n{constructor(t){if(this.value="ltr",this.change=new Me,t){let i=t.body?t.body.dir:null,s=t.documentElement?t.documentElement.dir:null;this.value=kh(i||s||"ltr")}}ngOnDestroy(){this.change.complete()}static{this.\u0275fac=function(i){return new(i||n)(J(Rh,8))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var Ai=(()=>{class n{static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275mod=be({type:n})}static{this.\u0275inj=Te({})}}return n})();var Mh=20,nl=(()=>{class n{constructor(t,i,s){this._ngZone=t,this._platform=i,this._scrolled=new ke,this._globalSubscription=null,this._scrolledCount=0,this.scrollContainers=new Map,this._document=s}register(t){this.scrollContainers.has(t)||this.scrollContainers.set(t,t.elementScrolled().subscribe(()=>this._scrolled.next(t)))}deregister(t){let i=this.scrollContainers.get(t);i&&(i.unsubscribe(),this.scrollContainers.delete(t))}scrolled(t=Mh){return this._platform.isBrowser?new Zi(i=>{this._globalSubscription||this._addGlobalListener();let s=t>0?this._scrolled.pipe(fn(t)).subscribe(i):this._scrolled.subscribe(i);return this._scrolledCount++,()=>{s.unsubscribe(),this._scrolledCount--,this._scrolledCount||this._removeGlobalListener()}}):Jo()}ngOnDestroy(){this._removeGlobalListener(),this.scrollContainers.forEach((t,i)=>this.deregister(i)),this._scrolled.complete()}ancestorScrolled(t,i){let s=this.getAncestorScrollContainers(t);return this.scrolled(i).pipe(kt(r=>!r||s.indexOf(r)>-1))}getAncestorScrollContainers(t){let i=[];return this.scrollContainers.forEach((s,r)=>{this._scrollableContainsElement(r,t)&&i.push(r)}),i}_getWindow(){return this._document.defaultView||window}_scrollableContainsElement(t,i){let s=Ja(i),r=t.getElementRef().nativeElement;do if(s==r)return!0;while(s=s.parentElement);return!1}_addGlobalListener(){this._globalSubscription=this._ngZone.runOutsideAngular(()=>{let t=this._getWindow();return zt(t.document,"scroll").subscribe(()=>this._scrolled.next())})}_removeGlobalListener(){this._globalSubscription&&(this._globalSubscription.unsubscribe(),this._globalSubscription=null)}static{this.\u0275fac=function(i){return new(i||n)(J(Qe),J(vt),J(Ue,8))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var Oh=20,Pn=(()=>{class n{constructor(t,i,s){this._platform=t,this._change=new ke,this._changeListener=r=>{this._change.next(r)},this._document=s,i.runOutsideAngular(()=>{if(t.isBrowser){let r=this._getWindow();r.addEventListener("resize",this._changeListener),r.addEventListener("orientationchange",this._changeListener)}this.change().subscribe(()=>this._viewportSize=null)})}ngOnDestroy(){if(this._platform.isBrowser){let t=this._getWindow();t.removeEventListener("resize",this._changeListener),t.removeEventListener("orientationchange",this._changeListener)}this._change.complete()}getViewportSize(){this._viewportSize||this._updateViewportSize();let t={width:this._viewportSize.width,height:this._viewportSize.height};return this._platform.isBrowser||(this._viewportSize=null),t}getViewportRect(){let t=this.getViewportScrollPosition(),{width:i,height:s}=this.getViewportSize();return{top:t.top,left:t.left,bottom:t.top+s,right:t.left+i,height:s,width:i}}getViewportScrollPosition(){if(!this._platform.isBrowser)return{top:0,left:0};let t=this._document,i=this._getWindow(),s=t.documentElement,r=s.getBoundingClientRect(),o=-r.top||t.body.scrollTop||i.scrollY||s.scrollTop||0,a=-r.left||t.body.scrollLeft||i.scrollX||s.scrollLeft||0;return{top:o,left:a}}change(t=Oh){return t>0?this._change.pipe(fn(t)):this._change}_getWindow(){return this._document.defaultView||window}_updateViewportSize(){let t=this._getWindow();this._viewportSize=this._platform.isBrowser?{width:t.innerWidth,height:t.innerHeight}:{width:0,height:0}}static{this.\u0275fac=function(i){return new(i||n)(J(vt),J(Qe),J(Ue,8))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var il=(()=>{class n{static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275mod=be({type:n})}static{this.\u0275inj=Te({})}}return n})(),Mn=(()=>{class n{static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275mod=be({type:n})}static{this.\u0275inj=Te({imports:[Ai,il,Ai,il]})}}return n})();var Ii=class{attach(e){return this._attachedHost=e,e.attach(this)}detach(){let e=this._attachedHost;e!=null&&(this._attachedHost=null,e.detach())}get isAttached(){return this._attachedHost!=null}setAttachedHost(e){this._attachedHost=e}},On=class extends Ii{constructor(e,t,i,s,r){super(),this.component=e,this.viewContainerRef=t,this.injector=i,this.componentFactoryResolver=s,this.projectableNodes=r}},Qt=class extends Ii{constructor(e,t,i,s){super(),this.templateRef=e,this.viewContainerRef=t,this.context=i,this.injector=s}get origin(){return this.templateRef.elementRef}attach(e,t=this.context){return this.context=t,super.attach(e)}detach(){return this.context=void 0,super.detach()}},Fn=class extends Ii{constructor(e){super(),this.element=e instanceof Ee?e.nativeElement:e}},Nn=class{constructor(){this._isDisposed=!1,this.attachDomPortal=null}hasAttached(){return!!this._attachedPortal}attach(e){if(e instanceof On)return this._attachedPortal=e,this.attachComponentPortal(e);if(e instanceof Qt)return this._attachedPortal=e,this.attachTemplatePortal(e);if(this.attachDomPortal&&e instanceof Fn)return this._attachedPortal=e,this.attachDomPortal(e)}detach(){this._attachedPortal&&(this._attachedPortal.setAttachedHost(null),this._attachedPortal=null),this._invokeDisposeFn()}dispose(){this.hasAttached()&&this.detach(),this._invokeDisposeFn(),this._isDisposed=!0}setDisposeFn(e){this._disposeFn=e}_invokeDisposeFn(){this._disposeFn&&(this._disposeFn(),this._disposeFn=null)}};var hs=class extends Nn{constructor(e,t,i,s,r){super(),this.outletElement=e,this._componentFactoryResolver=t,this._appRef=i,this._defaultInjector=s,this.attachDomPortal=o=>{this._document;let a=o.element;a.parentNode;let c=this._document.createComment("dom-portal");a.parentNode.insertBefore(c,a),this.outletElement.appendChild(a),this._attachedPortal=o,super.setDisposeFn(()=>{c.parentNode&&c.parentNode.replaceChild(a,c)})},this._document=r}attachComponentPortal(e){let i=(e.componentFactoryResolver||this._componentFactoryResolver).resolveComponentFactory(e.component),s;return e.viewContainerRef?(s=e.viewContainerRef.createComponent(i,e.viewContainerRef.length,e.injector||e.viewContainerRef.injector,e.projectableNodes||void 0),this.setDisposeFn(()=>s.destroy())):(s=i.create(e.injector||this._defaultInjector||mi.NULL),this._appRef.attachView(s.hostView),this.setDisposeFn(()=>{this._appRef.viewCount>0&&this._appRef.detachView(s.hostView),s.destroy()})),this.outletElement.appendChild(this._getComponentRootNode(s)),this._attachedPortal=e,s}attachTemplatePortal(e){let t=e.viewContainerRef,i=t.createEmbeddedView(e.templateRef,e.context,{injector:e.injector});return i.rootNodes.forEach(s=>this.outletElement.appendChild(s)),i.detectChanges(),this.setDisposeFn(()=>{let s=t.indexOf(i);s!==-1&&t.remove(s)}),this._attachedPortal=e,i}dispose(){super.dispose(),this.outletElement.remove()}_getComponentRootNode(e){return e.hostView.rootNodes[0]}};var rl=(()=>{class n{static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275mod=be({type:n})}static{this.\u0275inj=Te({})}}return n})();var ol=el(),Bn=class{constructor(e,t){this._viewportRuler=e,this._previousHTMLStyles={top:"",left:""},this._isEnabled=!1,this._document=t}attach(){}enable(){if(this._canBeEnabled()){let e=this._document.documentElement;this._previousScrollPosition=this._viewportRuler.getViewportScrollPosition(),this._previousHTMLStyles.left=e.style.left||"",this._previousHTMLStyles.top=e.style.top||"",e.style.left=_e(-this._previousScrollPosition.left),e.style.top=_e(-this._previousScrollPosition.top),e.classList.add("cdk-global-scrollblock"),this._isEnabled=!0}}disable(){if(this._isEnabled){let e=this._document.documentElement,t=this._document.body,i=e.style,s=t.style,r=i.scrollBehavior||"",o=s.scrollBehavior||"";this._isEnabled=!1,i.left=this._previousHTMLStyles.left,i.top=this._previousHTMLStyles.top,e.classList.remove("cdk-global-scrollblock"),ol&&(i.scrollBehavior=s.scrollBehavior="auto"),window.scroll(this._previousScrollPosition.left,this._previousScrollPosition.top),ol&&(i.scrollBehavior=r,s.scrollBehavior=o)}}_canBeEnabled(){if(this._document.documentElement.classList.contains("cdk-global-scrollblock")||this._isEnabled)return!1;let t=this._document.body,i=this._viewportRuler.getViewportSize();return t.scrollHeight>i.height||t.scrollWidth>i.width}};var Un=class{constructor(e,t,i,s){this._scrollDispatcher=e,this._ngZone=t,this._viewportRuler=i,this._config=s,this._scrollSubscription=null,this._detach=()=>{this.disable(),this._overlayRef.hasAttached()&&this._ngZone.run(()=>this._overlayRef.detach())}}attach(e){this._overlayRef,this._overlayRef=e}enable(){if(this._scrollSubscription)return;let e=this._scrollDispatcher.scrolled(0).pipe(kt(t=>!t||!this._overlayRef.overlayElement.contains(t.getElementRef().nativeElement)));this._config&&this._config.threshold&&this._config.threshold>1?(this._initialScrollPosition=this._viewportRuler.getViewportScrollPosition().top,this._scrollSubscription=e.subscribe(()=>{let t=this._viewportRuler.getViewportScrollPosition().top;Math.abs(t-this._initialScrollPosition)>this._config.threshold?this._detach():this._overlayRef.updatePosition()})):this._scrollSubscription=e.subscribe(this._detach)}disable(){this._scrollSubscription&&(this._scrollSubscription.unsubscribe(),this._scrollSubscription=null)}detach(){this.disable(),this._overlayRef=null}},us=class{enable(){}disable(){}attach(){}};function Vn(n,e){return e.some(t=>{let i=n.bottom<t.top,s=n.top>t.bottom,r=n.right<t.left,o=n.left>t.right;return i||s||r||o})}function al(n,e){return e.some(t=>{let i=n.top<t.top,s=n.bottom>t.bottom,r=n.left<t.left,o=n.right>t.right;return i||s||r||o})}var $n=class{constructor(e,t,i,s){this._scrollDispatcher=e,this._viewportRuler=t,this._ngZone=i,this._config=s,this._scrollSubscription=null}attach(e){this._overlayRef,this._overlayRef=e}enable(){if(!this._scrollSubscription){let e=this._config?this._config.scrollThrottle:0;this._scrollSubscription=this._scrollDispatcher.scrolled(e).subscribe(()=>{if(this._overlayRef.updatePosition(),this._config&&this._config.autoClose){let t=this._overlayRef.overlayElement.getBoundingClientRect(),{width:i,height:s}=this._viewportRuler.getViewportSize();Vn(t,[{width:i,height:s,bottom:s,right:i,top:0,left:0}])&&(this.disable(),this._ngZone.run(()=>this._overlayRef.detach()))}})}}disable(){this._scrollSubscription&&(this._scrollSubscription.unsubscribe(),this._scrollSubscription=null)}detach(){this.disable(),this._overlayRef=null}},Bh=(()=>{class n{constructor(t,i,s,r){this._scrollDispatcher=t,this._viewportRuler=i,this._ngZone=s,this.noop=()=>new us,this.close=o=>new Un(this._scrollDispatcher,this._ngZone,this._viewportRuler,o),this.block=()=>new Bn(this._viewportRuler,this._document),this.reposition=o=>new $n(this._scrollDispatcher,this._viewportRuler,this._ngZone,o),this._document=r}static{this.\u0275fac=function(i){return new(i||n)(J(nl),J(Pn),J(Qe),J(Ue))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})(),Ci=class{constructor(e){if(this.scrollStrategy=new us,this.panelClass="",this.hasBackdrop=!1,this.backdropClass="cdk-overlay-dark-backdrop",this.disposeOnNavigation=!1,e){let t=Object.keys(e);for(let i of t)e[i]!==void 0&&(this[i]=e[i])}}};var Gn=class{constructor(e,t){this.connectionPair=e,this.scrollableViewProperties=t}};var ul=(()=>{class n{constructor(t){this._attachedOverlays=[],this._document=t}ngOnDestroy(){this.detach()}add(t){this.remove(t),this._attachedOverlays.push(t)}remove(t){let i=this._attachedOverlays.indexOf(t);i>-1&&this._attachedOverlays.splice(i,1),this._attachedOverlays.length===0&&this.detach()}static{this.\u0275fac=function(i){return new(i||n)(J(Ue))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})(),Uh=(()=>{class n extends ul{constructor(t,i){super(t),this._ngZone=i,this._keydownListener=s=>{let r=this._attachedOverlays;for(let o=r.length-1;o>-1;o--)if(r[o]._keydownEvents.observers.length>0){let a=r[o]._keydownEvents;this._ngZone?this._ngZone.run(()=>a.next(s)):a.next(s);break}}}add(t){super.add(t),this._isAttached||(this._ngZone?this._ngZone.runOutsideAngular(()=>this._document.body.addEventListener("keydown",this._keydownListener)):this._document.body.addEventListener("keydown",this._keydownListener),this._isAttached=!0)}detach(){this._isAttached&&(this._document.body.removeEventListener("keydown",this._keydownListener),this._isAttached=!1)}static{this.\u0275fac=function(i){return new(i||n)(J(Ue),J(Qe,8))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})(),Vh=(()=>{class n extends ul{constructor(t,i,s){super(t),this._platform=i,this._ngZone=s,this._cursorStyleIsSet=!1,this._pointerDownListener=r=>{this._pointerDownEventTarget=Ln(r)},this._clickListener=r=>{let o=Ln(r),a=r.type==="click"&&this._pointerDownEventTarget?this._pointerDownEventTarget:o;this._pointerDownEventTarget=null;let c=this._attachedOverlays.slice();for(let l=c.length-1;l>-1;l--){let d=c[l];if(d._outsidePointerEvents.observers.length<1||!d.hasAttached())continue;if(d.overlayElement.contains(o)||d.overlayElement.contains(a))break;let h=d._outsidePointerEvents;this._ngZone?this._ngZone.run(()=>h.next(r)):h.next(r)}}}add(t){if(super.add(t),!this._isAttached){let i=this._document.body;this._ngZone?this._ngZone.runOutsideAngular(()=>this._addEventListeners(i)):this._addEventListeners(i),this._platform.IOS&&!this._cursorStyleIsSet&&(this._cursorOriginalValue=i.style.cursor,i.style.cursor="pointer",this._cursorStyleIsSet=!0),this._isAttached=!0}}detach(){if(this._isAttached){let t=this._document.body;t.removeEventListener("pointerdown",this._pointerDownListener,!0),t.removeEventListener("click",this._clickListener,!0),t.removeEventListener("auxclick",this._clickListener,!0),t.removeEventListener("contextmenu",this._clickListener,!0),this._platform.IOS&&this._cursorStyleIsSet&&(t.style.cursor=this._cursorOriginalValue,this._cursorStyleIsSet=!1),this._isAttached=!1}}_addEventListeners(t){t.addEventListener("pointerdown",this._pointerDownListener,!0),t.addEventListener("click",this._clickListener,!0),t.addEventListener("auxclick",this._clickListener,!0),t.addEventListener("contextmenu",this._clickListener,!0)}static{this.\u0275fac=function(i){return new(i||n)(J(Ue),J(vt),J(Qe,8))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})(),fl=(()=>{class n{constructor(t,i){this._platform=i,this._document=t}ngOnDestroy(){this._containerElement?.remove()}getContainerElement(){return this._containerElement||this._createContainer(),this._containerElement}_createContainer(){let t="cdk-overlay-container";if(this._platform.isBrowser||wn()){let s=this._document.querySelectorAll(`.${t}[platform="server"], .${t}[platform="test"]`);for(let r=0;r<s.length;r++)s[r].remove()}let i=this._document.createElement("div");i.classList.add(t),wn()?i.setAttribute("platform","test"):this._platform.isBrowser||i.setAttribute("platform","server"),this._document.body.appendChild(i),this._containerElement=i}static{this.\u0275fac=function(i){return new(i||n)(J(Ue),J(vt))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})(),Hn=class{constructor(e,t,i,s,r,o,a,c,l,d=!1){this._portalOutlet=e,this._host=t,this._pane=i,this._config=s,this._ngZone=r,this._keyboardDispatcher=o,this._document=a,this._location=c,this._outsideClickDispatcher=l,this._animationsDisabled=d,this._backdropElement=null,this._backdropClick=new ke,this._attachments=new ke,this._detachments=new ke,this._locationChanges=Qi.EMPTY,this._backdropClickHandler=h=>this._backdropClick.next(h),this._backdropTransitionendHandler=h=>{this._disposeBackdrop(h.target)},this._keydownEvents=new ke,this._outsidePointerEvents=new ke,s.scrollStrategy&&(this._scrollStrategy=s.scrollStrategy,this._scrollStrategy.attach(this)),this._positionStrategy=s.positionStrategy}get overlayElement(){return this._pane}get backdropElement(){return this._backdropElement}get hostElement(){return this._host}attach(e){!this._host.parentElement&&this._previousHostParent&&this._previousHostParent.appendChild(this._host);let t=this._portalOutlet.attach(e);return this._positionStrategy&&this._positionStrategy.attach(this),this._updateStackingOrder(),this._updateElementSize(),this._updateElementDirection(),this._scrollStrategy&&this._scrollStrategy.enable(),this._ngZone.onStable.pipe(Ji(1)).subscribe(()=>{this.hasAttached()&&this.updatePosition()}),this._togglePointerEvents(!0),this._config.hasBackdrop&&this._attachBackdrop(),this._config.panelClass&&this._toggleClasses(this._pane,this._config.panelClass,!0),this._attachments.next(),this._keyboardDispatcher.add(this),this._config.disposeOnNavigation&&(this._locationChanges=this._location.subscribe(()=>this.dispose())),this._outsideClickDispatcher.add(this),typeof t?.onDestroy=="function"&&t.onDestroy(()=>{this.hasAttached()&&this._ngZone.runOutsideAngular(()=>Promise.resolve().then(()=>this.detach()))}),t}detach(){if(!this.hasAttached())return;this.detachBackdrop(),this._togglePointerEvents(!1),this._positionStrategy&&this._positionStrategy.detach&&this._positionStrategy.detach(),this._scrollStrategy&&this._scrollStrategy.disable();let e=this._portalOutlet.detach();return this._detachments.next(),this._keyboardDispatcher.remove(this),this._detachContentWhenStable(),this._locationChanges.unsubscribe(),this._outsideClickDispatcher.remove(this),e}dispose(){let e=this.hasAttached();this._positionStrategy&&this._positionStrategy.dispose(),this._disposeScrollStrategy(),this._disposeBackdrop(this._backdropElement),this._locationChanges.unsubscribe(),this._keyboardDispatcher.remove(this),this._portalOutlet.dispose(),this._attachments.complete(),this._backdropClick.complete(),this._keydownEvents.complete(),this._outsidePointerEvents.complete(),this._outsideClickDispatcher.remove(this),this._host?.remove(),this._previousHostParent=this._pane=this._host=null,e&&this._detachments.next(),this._detachments.complete()}hasAttached(){return this._portalOutlet.hasAttached()}backdropClick(){return this._backdropClick}attachments(){return this._attachments}detachments(){return this._detachments}keydownEvents(){return this._keydownEvents}outsidePointerEvents(){return this._outsidePointerEvents}getConfig(){return this._config}updatePosition(){this._positionStrategy&&this._positionStrategy.apply()}updatePositionStrategy(e){e!==this._positionStrategy&&(this._positionStrategy&&this._positionStrategy.dispose(),this._positionStrategy=e,this.hasAttached()&&(e.attach(this),this.updatePosition()))}updateSize(e){this._config=Ke(Ke({},this._config),e),this._updateElementSize()}setDirection(e){this._config=xt(Ke({},this._config),{direction:e}),this._updateElementDirection()}addPanelClass(e){this._pane&&this._toggleClasses(this._pane,e,!0)}removePanelClass(e){this._pane&&this._toggleClasses(this._pane,e,!1)}getDirection(){let e=this._config.direction;return e?typeof e=="string"?e:e.value:"ltr"}updateScrollStrategy(e){e!==this._scrollStrategy&&(this._disposeScrollStrategy(),this._scrollStrategy=e,this.hasAttached()&&(e.attach(this),e.enable()))}_updateElementDirection(){this._host.setAttribute("dir",this.getDirection())}_updateElementSize(){if(!this._pane)return;let e=this._pane.style;e.width=_e(this._config.width),e.height=_e(this._config.height),e.minWidth=_e(this._config.minWidth),e.minHeight=_e(this._config.minHeight),e.maxWidth=_e(this._config.maxWidth),e.maxHeight=_e(this._config.maxHeight)}_togglePointerEvents(e){this._pane.style.pointerEvents=e?"":"none"}_attachBackdrop(){let e="cdk-overlay-backdrop-showing";this._backdropElement=this._document.createElement("div"),this._backdropElement.classList.add("cdk-overlay-backdrop"),this._animationsDisabled&&this._backdropElement.classList.add("cdk-overlay-backdrop-noop-animation"),this._config.backdropClass&&this._toggleClasses(this._backdropElement,this._config.backdropClass,!0),this._host.parentElement.insertBefore(this._backdropElement,this._host),this._backdropElement.addEventListener("click",this._backdropClickHandler),!this._animationsDisabled&&typeof requestAnimationFrame<"u"?this._ngZone.runOutsideAngular(()=>{requestAnimationFrame(()=>{this._backdropElement&&this._backdropElement.classList.add(e)})}):this._backdropElement.classList.add(e)}_updateStackingOrder(){this._host.nextSibling&&this._host.parentNode.appendChild(this._host)}detachBackdrop(){let e=this._backdropElement;if(e){if(this._animationsDisabled){this._disposeBackdrop(e);return}e.classList.remove("cdk-overlay-backdrop-showing"),this._ngZone.runOutsideAngular(()=>{e.addEventListener("transitionend",this._backdropTransitionendHandler)}),e.style.pointerEvents="none",this._backdropTimeout=this._ngZone.runOutsideAngular(()=>setTimeout(()=>{this._disposeBackdrop(e)},500))}}_toggleClasses(e,t,i){let s=Xt(t||[]).filter(r=>!!r);s.length&&(i?e.classList.add(...s):e.classList.remove(...s))}_detachContentWhenStable(){this._ngZone.runOutsideAngular(()=>{let e=this._ngZone.onStable.pipe(je(sa(this._attachments,this._detachments))).subscribe(()=>{(!this._pane||!this._host||this._pane.children.length===0)&&(this._pane&&this._config.panelClass&&this._toggleClasses(this._pane,this._config.panelClass,!1),this._host&&this._host.parentElement&&(this._previousHostParent=this._host.parentElement,this._host.remove()),e.unsubscribe())})})}_disposeScrollStrategy(){let e=this._scrollStrategy;e&&(e.disable(),e.detach&&e.detach())}_disposeBackdrop(e){e&&(e.removeEventListener("click",this._backdropClickHandler),e.removeEventListener("transitionend",this._backdropTransitionendHandler),e.remove(),this._backdropElement===e&&(this._backdropElement=null)),this._backdropTimeout&&(clearTimeout(this._backdropTimeout),this._backdropTimeout=void 0)}},ll="cdk-overlay-connected-position-bounding-box",$h=/([A-Za-z%]+)$/,Kn=class{get positions(){return this._preferredPositions}constructor(e,t,i,s,r){this._viewportRuler=t,this._document=i,this._platform=s,this._overlayContainer=r,this._lastBoundingBoxSize={width:0,height:0},this._isPushed=!1,this._canPush=!0,this._growAfterOpen=!1,this._hasFlexibleDimensions=!0,this._positionLocked=!1,this._viewportMargin=0,this._scrollables=[],this._preferredPositions=[],this._positionChanges=new ke,this._resizeSubscription=Qi.EMPTY,this._offsetX=0,this._offsetY=0,this._appliedPanelClasses=[],this.positionChanges=this._positionChanges,this.setOrigin(e)}attach(e){this._overlayRef&&this._overlayRef,this._validatePositions(),e.hostElement.classList.add(ll),this._overlayRef=e,this._boundingBox=e.hostElement,this._pane=e.overlayElement,this._isDisposed=!1,this._isInitialRender=!0,this._lastPosition=null,this._resizeSubscription.unsubscribe(),this._resizeSubscription=this._viewportRuler.change().subscribe(()=>{this._isInitialRender=!0,this.apply()})}apply(){if(this._isDisposed||!this._platform.isBrowser)return;if(!this._isInitialRender&&this._positionLocked&&this._lastPosition){this.reapplyLastPosition();return}this._clearPanelClasses(),this._resetOverlayElementStyles(),this._resetBoundingBoxStyles(),this._viewportRect=this._getNarrowedViewportRect(),this._originRect=this._getOriginRect(),this._overlayRect=this._pane.getBoundingClientRect(),this._containerRect=this._overlayContainer.getContainerElement().getBoundingClientRect();let e=this._originRect,t=this._overlayRect,i=this._viewportRect,s=this._containerRect,r=[],o;for(let a of this._preferredPositions){let c=this._getOriginPoint(e,s,a),l=this._getOverlayPoint(c,t,a),d=this._getOverlayFit(l,t,i,a);if(d.isCompletelyWithinViewport){this._isPushed=!1,this._applyPosition(a,c);return}if(this._canFitWithFlexibleDimensions(d,l,i)){r.push({position:a,origin:c,overlayRect:t,boundingBoxRect:this._calculateBoundingBoxRect(c,a)});continue}(!o||o.overlayFit.visibleArea<d.visibleArea)&&(o={overlayFit:d,overlayPoint:l,originPoint:c,position:a,overlayRect:t})}if(r.length){let a=null,c=-1;for(let l of r){let d=l.boundingBoxRect.width*l.boundingBoxRect.height*(l.position.weight||1);d>c&&(c=d,a=l)}this._isPushed=!1,this._applyPosition(a.position,a.origin);return}if(this._canPush){this._isPushed=!0,this._applyPosition(o.position,o.originPoint);return}this._applyPosition(o.position,o.originPoint)}detach(){this._clearPanelClasses(),this._lastPosition=null,this._previousPushAmount=null,this._resizeSubscription.unsubscribe()}dispose(){this._isDisposed||(this._boundingBox&&Bt(this._boundingBox.style,{top:"",left:"",right:"",bottom:"",height:"",width:"",alignItems:"",justifyContent:""}),this._pane&&this._resetOverlayElementStyles(),this._overlayRef&&this._overlayRef.hostElement.classList.remove(ll),this.detach(),this._positionChanges.complete(),this._overlayRef=this._boundingBox=null,this._isDisposed=!0)}reapplyLastPosition(){if(this._isDisposed||!this._platform.isBrowser)return;let e=this._lastPosition;if(e){this._originRect=this._getOriginRect(),this._overlayRect=this._pane.getBoundingClientRect(),this._viewportRect=this._getNarrowedViewportRect(),this._containerRect=this._overlayContainer.getContainerElement().getBoundingClientRect();let t=this._getOriginPoint(this._originRect,this._containerRect,e);this._applyPosition(e,t)}else this.apply()}withScrollableContainers(e){return this._scrollables=e,this}withPositions(e){return this._preferredPositions=e,e.indexOf(this._lastPosition)===-1&&(this._lastPosition=null),this._validatePositions(),this}withViewportMargin(e){return this._viewportMargin=e,this}withFlexibleDimensions(e=!0){return this._hasFlexibleDimensions=e,this}withGrowAfterOpen(e=!0){return this._growAfterOpen=e,this}withPush(e=!0){return this._canPush=e,this}withLockedPosition(e=!0){return this._positionLocked=e,this}setOrigin(e){return this._origin=e,this}withDefaultOffsetX(e){return this._offsetX=e,this}withDefaultOffsetY(e){return this._offsetY=e,this}withTransformOriginOn(e){return this._transformOriginSelector=e,this}_getOriginPoint(e,t,i){let s;if(i.originX=="center")s=e.left+e.width/2;else{let o=this._isRtl()?e.right:e.left,a=this._isRtl()?e.left:e.right;s=i.originX=="start"?o:a}t.left<0&&(s-=t.left);let r;return i.originY=="center"?r=e.top+e.height/2:r=i.originY=="top"?e.top:e.bottom,t.top<0&&(r-=t.top),{x:s,y:r}}_getOverlayPoint(e,t,i){let s;i.overlayX=="center"?s=-t.width/2:i.overlayX==="start"?s=this._isRtl()?-t.width:0:s=this._isRtl()?0:-t.width;let r;return i.overlayY=="center"?r=-t.height/2:r=i.overlayY=="top"?0:-t.height,{x:e.x+s,y:e.y+r}}_getOverlayFit(e,t,i,s){let r=dl(t),{x:o,y:a}=e,c=this._getOffset(s,"x"),l=this._getOffset(s,"y");c&&(o+=c),l&&(a+=l);let d=0-o,h=o+r.width-i.width,u=0-a,f=a+r.height-i.height,g=this._subtractOverflows(r.width,d,h),m=this._subtractOverflows(r.height,u,f),v=g*m;return{visibleArea:v,isCompletelyWithinViewport:r.width*r.height===v,fitsInViewportVertically:m===r.height,fitsInViewportHorizontally:g==r.width}}_canFitWithFlexibleDimensions(e,t,i){if(this._hasFlexibleDimensions){let s=i.bottom-t.y,r=i.right-t.x,o=cl(this._overlayRef.getConfig().minHeight),a=cl(this._overlayRef.getConfig().minWidth),c=e.fitsInViewportVertically||o!=null&&o<=s,l=e.fitsInViewportHorizontally||a!=null&&a<=r;return c&&l}return!1}_pushOverlayOnScreen(e,t,i){if(this._previousPushAmount&&this._positionLocked)return{x:e.x+this._previousPushAmount.x,y:e.y+this._previousPushAmount.y};let s=dl(t),r=this._viewportRect,o=Math.max(e.x+s.width-r.width,0),a=Math.max(e.y+s.height-r.height,0),c=Math.max(r.top-i.top-e.y,0),l=Math.max(r.left-i.left-e.x,0),d=0,h=0;return s.width<=r.width?d=l||-o:d=e.x<this._viewportMargin?r.left-i.left-e.x:0,s.height<=r.height?h=c||-a:h=e.y<this._viewportMargin?r.top-i.top-e.y:0,this._previousPushAmount={x:d,y:h},{x:e.x+d,y:e.y+h}}_applyPosition(e,t){if(this._setTransformOrigin(e),this._setOverlayElementStyles(t,e),this._setBoundingBoxStyles(t,e),e.panelClass&&this._addPanelClasses(e.panelClass),this._positionChanges.observers.length){let i=this._getScrollVisibility();if(e!==this._lastPosition||!this._lastScrollVisibility||!Gh(this._lastScrollVisibility,i)){let s=new Gn(e,i);this._positionChanges.next(s)}this._lastScrollVisibility=i}this._lastPosition=e,this._isInitialRender=!1}_setTransformOrigin(e){if(!this._transformOriginSelector)return;let t=this._boundingBox.querySelectorAll(this._transformOriginSelector),i,s=e.overlayY;e.overlayX==="center"?i="center":this._isRtl()?i=e.overlayX==="start"?"right":"left":i=e.overlayX==="start"?"left":"right";for(let r=0;r<t.length;r++)t[r].style.transformOrigin=`${i} ${s}`}_calculateBoundingBoxRect(e,t){let i=this._viewportRect,s=this._isRtl(),r,o,a;if(t.overlayY==="top")o=e.y,r=i.height-o+this._viewportMargin;else if(t.overlayY==="bottom")a=i.height-e.y+this._viewportMargin*2,r=i.height-a+this._viewportMargin;else{let f=Math.min(i.bottom-e.y+i.top,e.y),g=this._lastBoundingBoxSize.height;r=f*2,o=e.y-f,r>g&&!this._isInitialRender&&!this._growAfterOpen&&(o=e.y-g/2)}let c=t.overlayX==="start"&&!s||t.overlayX==="end"&&s,l=t.overlayX==="end"&&!s||t.overlayX==="start"&&s,d,h,u;if(l)u=i.width-e.x+this._viewportMargin*2,d=e.x-this._viewportMargin;else if(c)h=e.x,d=i.right-e.x;else{let f=Math.min(i.right-e.x+i.left,e.x),g=this._lastBoundingBoxSize.width;d=f*2,h=e.x-f,d>g&&!this._isInitialRender&&!this._growAfterOpen&&(h=e.x-g/2)}return{top:o,left:h,bottom:a,right:u,width:d,height:r}}_setBoundingBoxStyles(e,t){let i=this._calculateBoundingBoxRect(e,t);!this._isInitialRender&&!this._growAfterOpen&&(i.height=Math.min(i.height,this._lastBoundingBoxSize.height),i.width=Math.min(i.width,this._lastBoundingBoxSize.width));let s={};if(this._hasExactPosition())s.top=s.left="0",s.bottom=s.right=s.maxHeight=s.maxWidth="",s.width=s.height="100%";else{let r=this._overlayRef.getConfig().maxHeight,o=this._overlayRef.getConfig().maxWidth;s.height=_e(i.height),s.top=_e(i.top),s.bottom=_e(i.bottom),s.width=_e(i.width),s.left=_e(i.left),s.right=_e(i.right),t.overlayX==="center"?s.alignItems="center":s.alignItems=t.overlayX==="end"?"flex-end":"flex-start",t.overlayY==="center"?s.justifyContent="center":s.justifyContent=t.overlayY==="bottom"?"flex-end":"flex-start",r&&(s.maxHeight=_e(r)),o&&(s.maxWidth=_e(o))}this._lastBoundingBoxSize=i,Bt(this._boundingBox.style,s)}_resetBoundingBoxStyles(){Bt(this._boundingBox.style,{top:"0",left:"0",right:"0",bottom:"0",height:"",width:"",alignItems:"",justifyContent:""})}_resetOverlayElementStyles(){Bt(this._pane.style,{top:"",left:"",bottom:"",right:"",position:"",transform:""})}_setOverlayElementStyles(e,t){let i={},s=this._hasExactPosition(),r=this._hasFlexibleDimensions,o=this._overlayRef.getConfig();if(s){let d=this._viewportRuler.getViewportScrollPosition();Bt(i,this._getExactOverlayY(t,e,d)),Bt(i,this._getExactOverlayX(t,e,d))}else i.position="static";let a="",c=this._getOffset(t,"x"),l=this._getOffset(t,"y");c&&(a+=`translateX(${c}px) `),l&&(a+=`translateY(${l}px)`),i.transform=a.trim(),o.maxHeight&&(s?i.maxHeight=_e(o.maxHeight):r&&(i.maxHeight="")),o.maxWidth&&(s?i.maxWidth=_e(o.maxWidth):r&&(i.maxWidth="")),Bt(this._pane.style,i)}_getExactOverlayY(e,t,i){let s={top:"",bottom:""},r=this._getOverlayPoint(t,this._overlayRect,e);if(this._isPushed&&(r=this._pushOverlayOnScreen(r,this._overlayRect,i)),e.overlayY==="bottom"){let o=this._document.documentElement.clientHeight;s.bottom=`${o-(r.y+this._overlayRect.height)}px`}else s.top=_e(r.y);return s}_getExactOverlayX(e,t,i){let s={left:"",right:""},r=this._getOverlayPoint(t,this._overlayRect,e);this._isPushed&&(r=this._pushOverlayOnScreen(r,this._overlayRect,i));let o;if(this._isRtl()?o=e.overlayX==="end"?"left":"right":o=e.overlayX==="end"?"right":"left",o==="right"){let a=this._document.documentElement.clientWidth;s.right=`${a-(r.x+this._overlayRect.width)}px`}else s.left=_e(r.x);return s}_getScrollVisibility(){let e=this._getOriginRect(),t=this._pane.getBoundingClientRect(),i=this._scrollables.map(s=>s.getElementRef().nativeElement.getBoundingClientRect());return{isOriginClipped:al(e,i),isOriginOutsideView:Vn(e,i),isOverlayClipped:al(t,i),isOverlayOutsideView:Vn(t,i)}}_subtractOverflows(e,...t){return t.reduce((i,s)=>i-Math.max(s,0),e)}_getNarrowedViewportRect(){let e=this._document.documentElement.clientWidth,t=this._document.documentElement.clientHeight,i=this._viewportRuler.getViewportScrollPosition();return{top:i.top+this._viewportMargin,left:i.left+this._viewportMargin,right:i.left+e-this._viewportMargin,bottom:i.top+t-this._viewportMargin,width:e-2*this._viewportMargin,height:t-2*this._viewportMargin}}_isRtl(){return this._overlayRef.getDirection()==="rtl"}_hasExactPosition(){return!this._hasFlexibleDimensions||this._isPushed}_getOffset(e,t){return t==="x"?e.offsetX==null?this._offsetX:e.offsetX:e.offsetY==null?this._offsetY:e.offsetY}_validatePositions(){}_addPanelClasses(e){this._pane&&Xt(e).forEach(t=>{t!==""&&this._appliedPanelClasses.indexOf(t)===-1&&(this._appliedPanelClasses.push(t),this._pane.classList.add(t))})}_clearPanelClasses(){this._pane&&(this._appliedPanelClasses.forEach(e=>{this._pane.classList.remove(e)}),this._appliedPanelClasses=[])}_getOriginRect(){let e=this._origin;if(e instanceof Ee)return e.nativeElement.getBoundingClientRect();if(e instanceof Element)return e.getBoundingClientRect();let t=e.width||0,i=e.height||0;return{top:e.y,bottom:e.y+i,left:e.x,right:e.x+t,height:i,width:t}}};function Bt(n,e){for(let t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}function cl(n){if(typeof n!="number"&&n!=null){let[e,t]=n.split($h);return!t||t==="px"?parseFloat(e):null}return n||null}function dl(n){return{top:Math.floor(n.top),right:Math.floor(n.right),bottom:Math.floor(n.bottom),left:Math.floor(n.left),width:Math.floor(n.width),height:Math.floor(n.height)}}function Gh(n,e){return n===e?!0:n.isOriginClipped===e.isOriginClipped&&n.isOriginOutsideView===e.isOriginOutsideView&&n.isOverlayClipped===e.isOverlayClipped&&n.isOverlayOutsideView===e.isOverlayOutsideView}var hl="cdk-global-overlay-wrapper",jn=class{constructor(){this._cssPosition="static",this._topOffset="",this._bottomOffset="",this._alignItems="",this._xPosition="",this._xOffset="",this._width="",this._height="",this._isDisposed=!1}attach(e){let t=e.getConfig();this._overlayRef=e,this._width&&!t.width&&e.updateSize({width:this._width}),this._height&&!t.height&&e.updateSize({height:this._height}),e.hostElement.classList.add(hl),this._isDisposed=!1}top(e=""){return this._bottomOffset="",this._topOffset=e,this._alignItems="flex-start",this}left(e=""){return this._xOffset=e,this._xPosition="left",this}bottom(e=""){return this._topOffset="",this._bottomOffset=e,this._alignItems="flex-end",this}right(e=""){return this._xOffset=e,this._xPosition="right",this}start(e=""){return this._xOffset=e,this._xPosition="start",this}end(e=""){return this._xOffset=e,this._xPosition="end",this}width(e=""){return this._overlayRef?this._overlayRef.updateSize({width:e}):this._width=e,this}height(e=""){return this._overlayRef?this._overlayRef.updateSize({height:e}):this._height=e,this}centerHorizontally(e=""){return this.left(e),this._xPosition="center",this}centerVertically(e=""){return this.top(e),this._alignItems="center",this}apply(){if(!this._overlayRef||!this._overlayRef.hasAttached())return;let e=this._overlayRef.overlayElement.style,t=this._overlayRef.hostElement.style,i=this._overlayRef.getConfig(),{width:s,height:r,maxWidth:o,maxHeight:a}=i,c=(s==="100%"||s==="100vw")&&(!o||o==="100%"||o==="100vw"),l=(r==="100%"||r==="100vh")&&(!a||a==="100%"||a==="100vh"),d=this._xPosition,h=this._xOffset,u=this._overlayRef.getConfig().direction==="rtl",f="",g="",m="";c?m="flex-start":d==="center"?(m="center",u?g=h:f=h):u?d==="left"||d==="end"?(m="flex-end",f=h):(d==="right"||d==="start")&&(m="flex-start",g=h):d==="left"||d==="start"?(m="flex-start",f=h):(d==="right"||d==="end")&&(m="flex-end",g=h),e.position=this._cssPosition,e.marginLeft=c?"0":f,e.marginTop=l?"0":this._topOffset,e.marginBottom=this._bottomOffset,e.marginRight=c?"0":g,t.justifyContent=m,t.alignItems=l?"flex-start":this._alignItems}dispose(){if(this._isDisposed||!this._overlayRef)return;let e=this._overlayRef.overlayElement.style,t=this._overlayRef.hostElement,i=t.style;t.classList.remove(hl),i.justifyContent=i.alignItems=e.marginTop=e.marginBottom=e.marginLeft=e.marginRight=e.position="",this._overlayRef=null,this._isDisposed=!0}},Wn=(()=>{class n{constructor(t,i,s,r){this._viewportRuler=t,this._document=i,this._platform=s,this._overlayContainer=r}global(){return new jn}flexibleConnectedTo(t){return new Kn(t,this._viewportRuler,this._document,this._platform,this._overlayContainer)}static{this.\u0275fac=function(i){return new(i||n)(J(Pn),J(Ue),J(vt),J(fl))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})(),Hh=0,Di=(()=>{class n{constructor(t,i,s,r,o,a,c,l,d,h,u,f){this.scrollStrategies=t,this._overlayContainer=i,this._componentFactoryResolver=s,this._positionBuilder=r,this._keyboardDispatcher=o,this._injector=a,this._ngZone=c,this._document=l,this._directionality=d,this._location=h,this._outsideClickDispatcher=u,this._animationsModuleType=f}create(t){let i=this._createHostElement(),s=this._createPaneElement(i),r=this._createPortalOutlet(s),o=new Ci(t);return o.direction=o.direction||this._directionality.value,new Hn(r,i,s,o,this._ngZone,this._keyboardDispatcher,this._document,this._location,this._outsideClickDispatcher,this._animationsModuleType==="NoopAnimations")}position(){return this._positionBuilder}_createPaneElement(t){let i=this._document.createElement("div");return i.id=`cdk-overlay-${Hh++}`,i.classList.add("cdk-overlay-pane"),t.appendChild(i),i}_createHostElement(){let t=this._document.createElement("div");return this._overlayContainer.getContainerElement().appendChild(t),t}_createPortalOutlet(t){return this._appRef||(this._appRef=this._injector.get(ha)),new hs(t,this._componentFactoryResolver,this._appRef,this._injector,this._document)}static{this.\u0275fac=function(i){return new(i||n)(J(Bh),J(fl),J(pn),J(Wn),J(Uh),J(mi),J(Qe),J(Ue),J(tl),J(ga),J(Vh),J(aa,8))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var Kh=new ot("cdk-connected-overlay-scroll-strategy",{providedIn:"root",factory:()=>{let n=gi(Di);return()=>n.scrollStrategies.reposition()}});function jh(n){return()=>n.scrollStrategies.reposition()}var Wh={provide:Kh,deps:[Di],useFactory:jh},gl=(()=>{class n{static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275mod=be({type:n})}static{this.\u0275inj=Te({providers:[Di,Wh],imports:[Ai,rl,Mn,Mn]})}}return n})();var pl=new Set,Ut,zh=(()=>{class n{constructor(t,i){this._platform=t,this._nonce=i,this._matchMedia=this._platform.isBrowser&&window.matchMedia?window.matchMedia.bind(window):Xh}matchMedia(t){return(this._platform.WEBKIT||this._platform.BLINK)&&qh(t,this._nonce),this._matchMedia(t)}static{this.\u0275fac=function(i){return new(i||n)(J(vt),J(la,8))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();function qh(n,e){if(!pl.has(n))try{Ut||(Ut=document.createElement("style"),e&&Ut.setAttribute("nonce",e),Ut.setAttribute("type","text/css"),document.head.appendChild(Ut)),Ut.sheet&&(Ut.sheet.insertRule(`@media ${n} {body{ }}`,0),pl.add(n))}catch(t){console.error(t)}}function Xh(n){return{matches:n==="all"||n==="",media:n,addListener:()=>{},removeListener:()=>{}}}var vl=(()=>{class n{constructor(t,i){this._mediaMatcher=t,this._zone=i,this._queries=new Map,this._destroySubject=new ke}ngOnDestroy(){this._destroySubject.next(),this._destroySubject.complete()}isMatched(t){return ml(Xt(t)).some(s=>this._registerQuery(s).mql.matches)}observe(t){let s=ml(Xt(t)).map(o=>this._registerQuery(o).observable),r=ea(s);return r=ta(r.pipe(Ji(1)),r.pipe(ra(1),na(0))),r.pipe(ui(o=>{let a={matches:!1,breakpoints:{}};return o.forEach(({matches:c,query:l})=>{a.matches=a.matches||c,a.breakpoints[l]=c}),a}))}_registerQuery(t){if(this._queries.has(t))return this._queries.get(t);let i=this._mediaMatcher.matchMedia(t),r={observable:new Zi(o=>{let a=c=>this._zone.run(()=>o.next(c));return i.addListener(a),()=>{i.removeListener(a)}}).pipe(gn(i),ui(({matches:o})=>({query:t,matches:o})),je(this._destroySubject)),mql:i};return this._queries.set(t,r),r}static{this.\u0275fac=function(i){return new(i||n)(J(zh),J(Qe))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();function ml(n){return n.map(e=>e.split(",")).reduce((e,t)=>e.concat(t)).map(e=>e.trim())}var Zh=["dropdownTemplate"],Jh=["mdbDropdown",""],eu=["*",[["",8,"dropdown-toggle"]],[["",8,"dropdown-menu"]]],tu=["*",".dropdown-toggle",".dropdown-menu"];function iu(n,e){if(n&1){let t=Mt();_(0,"div"),$("@fade.done",function(s){N(t);let r=F();return B(r.onAnimationEnd(s))}),yi(1,2),E()}if(n&2){let t=F();le("@fade",t._animationState)("@.disabled",!t.animation)}}var Yn=(()=>{class n{constructor(){}static \u0275fac=function(i){return new(i||n)};static \u0275dir=Ae({type:n,selectors:[["","mdbDropdownToggle",""]],exportAs:["mdbDropdownToggle"]})}return n})(),zn=(()=>{class n{elementRef;_renderer;constructor(t,i){this.elementRef=t,this._renderer=i}menuPositionClassChanged=new Me;get menuPositionClass(){return this._menuPositionClass}set menuPositionClass(t){let i=this.elementRef.nativeElement,s=i.classList.contains(t);this._menuPositionClass!==t&&!s&&(["dropdown-menu-start","dropdown-menu-sm-start","dropdown-menu-md-start","dropdown-menu-lg-start","dropdown-menu-xl-start","dropdown-menu-xxl-start","dropdown-menu-xxl-start","dropdown-menu-xxl-start","dropdown-menu-end","dropdown-menu-sm-end","dropdown-menu-md-end","dropdown-menu-lg-end","dropdown-menu-xl-end","dropdown-menu-xxl-end","dropdown-menu-xxl-end","dropdown-menu-xxl-end"].forEach(o=>{this._renderer.removeClass(i,o)}),this._renderer.addClass(i,t),this.menuPositionClassChanged.emit(this.menuPositionClass))}_menuPositionClass;static \u0275fac=function(i){return new(i||n)(re(Ee),re(gt))};static \u0275dir=Ae({type:n,selectors:[["","mdbDropdownMenu",""]],inputs:{menuPositionClass:"menuPositionClass"},outputs:{menuPositionClassChanged:"menuPositionClassChanged"},exportAs:["mdbDropdownMenu"]})}return n})(),yl=(()=>{class n{_overlay;_overlayPositionBuilder;_elementRef;_vcr;_breakpointObserver;_cdRef;_renderer;_template;_dropdownToggle;_dropdownMenu;animation=!0;closeOnEsc=!0;closeOnItemClick=!0;closeOnOutsideClick=!0;offset=0;get positionClass(){return this._positionClass}set positionClass(t){let i=this.host.classList.contains(t);this._positionClass!==t&&!i&&(["dropdown","dropup","dropstart","dropend"].forEach(r=>{this._renderer.removeClass(this.host,r)}),this._renderer.addClass(this.host,t)),this._updateOverlay()}_positionClass;withPush=!1;dropdownShow=new Me;dropdownShown=new Me;dropdownHide=new Me;dropdownHidden=new Me;_overlayRef;_portal;_open=!1;_isDropUp;_isDropStart;_isDropEnd;_isDropdownMenuEnd;_xPosition;_breakpoints;_destroy$=new ke;get host(){return this._elementRef.nativeElement}_breakpointSubscription;_animationState="hidden";constructor(t,i,s,r,o,a,c){this._overlay=t,this._overlayPositionBuilder=i,this._elementRef=s,this._vcr=r,this._breakpointObserver=o,this._cdRef=a,this._renderer=c,this._breakpoints={isSm:this._breakpointObserver.isMatched("(min-width: 576px)"),isMd:this._breakpointObserver.isMatched("(min-width: 768px)"),isLg:this._breakpointObserver.isMatched("(min-width: 992px)"),isXl:this._breakpointObserver.isMatched("(min-width: 1200px)"),isXxl:this._breakpointObserver.isMatched("(min-width: 1400px)")}}ngAfterContentInit(){this._bindDropdownToggleClick(),this._listenToMenuPositionClassChange()}ngOnDestroy(){this._overlayRef&&(this._overlayRef.detach(),this._overlayRef.dispose()),this._destroy$.next(),this._destroy$.complete()}_bindDropdownToggleClick(){zt(this._dropdownToggle.nativeElement,"click").pipe(je(this._destroy$)).subscribe(()=>this.toggle())}_listenToMenuPositionClassChange(){this._dropdownMenu.menuPositionClassChanged.pipe(je(this._destroy$)).subscribe(()=>this._updateOverlay())}_updateOverlay(){this._overlayRef?.updatePositionStrategy(this._createPositionStrategy())}_createOverlayConfig(){return new Ci({hasBackdrop:!1,scrollStrategy:this._overlay.scrollStrategies.reposition(),positionStrategy:this._createPositionStrategy()})}_createOverlay(){this._overlayRef=this._overlay.create(this._createOverlayConfig())}_createPositionStrategy(){return this._overlayPositionBuilder.flexibleConnectedTo(this._dropdownToggle).withPositions(this._getPosition()).withFlexibleDimensions(!1).withPush(this.withPush)}_getPosition(){this._isDropUp=this.host.classList.contains("dropup"),this._isDropStart=this.host.classList.contains("dropstart"),this._isDropEnd=this.host.classList.contains("dropend"),this._isDropdownMenuEnd=this._dropdownMenu.elementRef.nativeElement.classList.contains("dropdown-menu-end"),this._xPosition=this._isDropdownMenuEnd?"end":"start";let t=new RegExp(/dropdown-menu-(sm|md|lg|xl|xxl)-(start|end)/,"g"),i=this._dropdownMenu.elementRef.nativeElement.className.match(t);if(i){this._subscribeBrakpoints();let l=new RegExp(/start|end/,"g"),d=new RegExp(/(sm|md|lg|xl|xxl)/,"g"),h=l.exec(i)[0],u=d.exec(i)[0];switch(!0){case(u==="xxl"&&this._breakpoints.isXxl):this._xPosition=h;break;case(u==="xl"&&this._breakpoints.isXl):this._xPosition=h;break;case(u==="lg"&&this._breakpoints.isLg):this._xPosition=h;break;case(u==="md"&&this._breakpoints.isMd):this._xPosition=h;break;case(u==="sm"&&this._breakpoints.isSm):this._xPosition=h;break;default:break}}let s,r={originX:this._xPosition,originY:"top",overlayX:this._xPosition,overlayY:"bottom",offsetY:-this.offset},o={originX:this._xPosition,originY:"bottom",overlayX:this._xPosition,overlayY:"top",offsetY:this.offset},a={originX:"start",originY:"top",overlayX:"end",overlayY:"top",offsetX:this.offset},c={originX:"end",originY:"top",overlayX:"start",overlayY:"top",offsetX:-this.offset};switch(!0){case this._isDropEnd:s=[c,a];break;case this._isDropStart:s=[a,c];break;case this._isDropUp:s=[r,o];break;default:s=[o,r];break}return s}_listenToEscKeyup(t){return zt(document,"keyup").pipe(kt(i=>i.key==="Escape"),je(t.detachments()))}_listenToClick(t,i){return zt(document,"click").pipe(kt(s=>{let r=s.target,o=this._dropdownMenu.elementRef.nativeElement.contains(r),a=!this._dropdownToggle.nativeElement.contains(r),c=!o||r.classList&&r.classList.contains("dropdown-item");return r!==i&&a&&c}),je(t.detachments()))}onAnimationEnd(t){t.fromState==="visible"&&t.toState==="hidden"&&(this._overlayRef.detach(),this._open=!1,this.dropdownHidden.emit(this)),t.fromState==="hidden"&&t.toState==="visible"&&this.dropdownShown.emit(this)}_subscribeBrakpoints(){let t=["(min-width: 576px)","(min-width: 768px)","(min-width: 992px)","(min-width: 1200px)","(min-width: 1400px)"];this._breakpointSubscription=this._breakpointObserver.observe(t).pipe(je(this._destroy$)).subscribe(i=>{Object.keys(this._breakpoints).forEach((s,r)=>{let o=t[r],a=i.breakpoints[o];a!==this._breakpoints[s]&&(this._breakpoints[s]=a,this._open&&this._updateOverlay())})})}show(){this._cdRef.markForCheck(),!this._open&&(this._overlayRef||this._createOverlay(),this._portal=new Qt(this._template,this._vcr),this.dropdownShow.emit(this),this._open=!0,this._overlayRef.attach(this._portal),this._listenToEscKeyup(this._overlayRef).subscribe(t=>{t&&this.closeOnEsc&&this.hide()}),this._overlayRef.keydownEvents().pipe(je(this._overlayRef.detachments())).subscribe(t=>{this._handleKeyboardNavigation(t)}),this._listenToClick(this._overlayRef,this._dropdownToggle.nativeElement).subscribe(t=>{let i=t.target,s=i.classList&&i.classList.contains("dropdown-item");if(this.closeOnItemClick&&s){this.hide();return}if(this.closeOnOutsideClick&&!s){this.hide();return}}),this._animationState="visible")}_handleKeyboardNavigation(t){let i=Array.from(this._dropdownMenu.elementRef.nativeElement.querySelectorAll(".dropdown-item")),s=t.key,r=this._dropdownMenu.elementRef.nativeElement.ownerDocument.activeElement;if(i.length===0)return;let o=i.indexOf(r);switch(s){case"ArrowDown":t.preventDefault(),o=Math.min(o+1,i.length-1);break;case"ArrowUp":if(t.preventDefault(),o===-1){o=i.length-1;break}o=Math.max(o-1,0);break}let a=i[o];a&&a.focus()}hide(){this._cdRef.markForCheck(),this._open&&(this.dropdownHide.emit(this),this._animationState="hidden")}toggle(){this._cdRef.markForCheck(),this._open?this.hide():this.show()}static \u0275fac=function(i){return new(i||n)(re(Di),re(Wn),re(Ee),re(vi),re(vl),re(Si),re(gt))};static \u0275cmp=Pt({type:n,selectors:[["","mdbDropdown",""]],contentQueries:function(i,s,r){if(i&1&&(vn(r,Yn,5,Ee),vn(r,zn,5)),i&2){let o;Ot(o=Ft())&&(s._dropdownToggle=o.first),Ot(o=Ft())&&(s._dropdownMenu=o.first)}},viewQuery:function(i,s){if(i&1&&_i(Zh,5),i&2){let r;Ot(r=Ft())&&(s._template=r.first)}},inputs:{animation:[Pe.HasDecoratorInputTransform,"animation","animation",mt],closeOnEsc:[Pe.HasDecoratorInputTransform,"closeOnEsc","closeOnEsc",mt],closeOnItemClick:[Pe.HasDecoratorInputTransform,"closeOnItemClick","closeOnItemClick",mt],closeOnOutsideClick:[Pe.HasDecoratorInputTransform,"closeOnOutsideClick","closeOnOutsideClick",mt],offset:[Pe.HasDecoratorInputTransform,"offset","offset",ua],positionClass:"positionClass",withPush:[Pe.HasDecoratorInputTransform,"withPush","withPush",mt]},outputs:{dropdownShow:"dropdownShow",dropdownShown:"dropdownShown",dropdownHide:"dropdownHide",dropdownHidden:"dropdownHidden"},features:[ts],attrs:Jh,ngContentSelectors:tu,decls:4,vars:0,consts:[["dropdownTemplate",""]],template:function(i,s){i&1&&(mn(eu),yi(0),yi(1,1),Oe(2,iu,2,2,"ng-template",null,0,ca))},encapsulation:2,data:{animation:[xa("fade",[En("visible",ns({opacity:1})),En("hidden",ns({opacity:0})),Sn("visible => hidden",_n("150ms linear")),Sn("hidden => visible",[ns({opacity:0}),_n("150ms linear")])])]},changeDetection:0})}return n})(),_l=(()=>{class n{static \u0275fac=function(i){return new(i||n)};static \u0275mod=be({type:n});static \u0275inj=Te({imports:[ss,gl]})}return n})();var El=(()=>{class n{static \u0275fac=function(i){return new(i||n)};static \u0275mod=be({type:n});static \u0275inj=Te({})}return n})();var G=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)},nu=Number.isSafeInteger||function(n){return typeof n=="number"&&Math.abs(n)<=ru},ru=Number.MAX_SAFE_INTEGER||9007199254740991,z=function(n){return n.NETWORK_ERROR="networkError",n.MEDIA_ERROR="mediaError",n.KEY_SYSTEM_ERROR="keySystemError",n.MUX_ERROR="muxError",n.OTHER_ERROR="otherError",n}({}),R=function(n){return n.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",n.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",n.KEY_SYSTEM_NO_SESSION="keySystemNoSession",n.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",n.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",n.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",n.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",n.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",n.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",n.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",n.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",n.MANIFEST_LOAD_ERROR="manifestLoadError",n.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",n.MANIFEST_PARSING_ERROR="manifestParsingError",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",n.LEVEL_EMPTY_ERROR="levelEmptyError",n.LEVEL_LOAD_ERROR="levelLoadError",n.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",n.LEVEL_PARSING_ERROR="levelParsingError",n.LEVEL_SWITCH_ERROR="levelSwitchError",n.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",n.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",n.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",n.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",n.FRAG_LOAD_ERROR="fragLoadError",n.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",n.FRAG_DECRYPT_ERROR="fragDecryptError",n.FRAG_PARSING_ERROR="fragParsingError",n.FRAG_GAP="fragGap",n.REMUX_ALLOC_ERROR="remuxAllocError",n.KEY_LOAD_ERROR="keyLoadError",n.KEY_LOAD_TIMEOUT="keyLoadTimeOut",n.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",n.BUFFER_APPEND_ERROR="bufferAppendError",n.BUFFER_APPENDING_ERROR="bufferAppendingError",n.BUFFER_STALLED_ERROR="bufferStalledError",n.BUFFER_FULL_ERROR="bufferFullError",n.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",n.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",n.ASSET_LIST_LOAD_ERROR="assetListLoadError",n.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",n.ASSET_LIST_PARSING_ERROR="assetListParsingError",n.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",n.INTERNAL_EXCEPTION="internalException",n.INTERNAL_ABORTED="aborted",n.ATTACH_MEDIA_ERROR="attachMediaError",n.UNKNOWN="unknown",n}({}),p=function(n){return n.MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.MEDIA_ENDED="hlsMediaEnded",n.STALL_RESOLVED="hlsStallResolved",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFERED_TO_END="hlsBufferedToEnd",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached",n.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",n.ASSET_LIST_LOADING="hlsAssetListLoading",n.ASSET_LIST_LOADED="hlsAssetListLoaded",n.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",n.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",n.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",n.INTERSTITIAL_STARTED="hlsInterstitialStarted",n.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",n.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",n.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",n.INTERSTITIAL_ENDED="hlsInterstitialEnded",n.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",n.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",n.EVENT_CUE_ENTER="hlsEventCueEnter",n}({}),ne={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},W={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"},It=class{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){let i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){let e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}},mr=class{constructor(e,t,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new It(e),this.fast_=new It(t),this.defaultTTFB_=s,this.ttfb_=new It(e)}update(e,t){let{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new It(e,i.getEstimate(),i.getTotalWeight())),s.halfLife!==t&&(this.fast_=new It(t,s.getEstimate(),s.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new It(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);let i=8*t,s=e/1e3,r=i/s;this.fast_.sample(s,r),this.slow_.sample(s,r)}sampleTTFB(e){let t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}};function ou(n,e,t){return(e=lu(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function fe(){return fe=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(n[i]=t[i])}return n},fe.apply(null,arguments)}function Sl(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,i)}return t}function he(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Sl(Object(t),!0).forEach(function(i){ou(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Sl(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function au(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function lu(n){var e=au(n,"string");return typeof e=="symbol"?e:e+""}var rt=class{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;let i=`[${e}]:`;this.trace=Ct,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}},Ct=function(){},cu={trace:Ct,debug:Ct,log:Ct,warn:Ct,info:Ct,error:Ct};function vr(){return fe({},cu)}function du(n,e){let t=self.console[n];return t?t.bind(self.console,`${e?"["+e+"] ":""}[${n}] >`):Ct}function xl(n,e,t){return e[n]?e[n].bind(e):du(n,t)}var yr=vr();function hu(n,e,t){let i=vr();if(typeof console=="object"&&n===!0||typeof n=="object"){let s=["debug","log","info","warn","error"];s.forEach(r=>{i[r]=xl(r,n,t)});try{i.log(`Debug logs enabled for "${e}" in hls.js version 1.6.5`)}catch{return vr()}s.forEach(r=>{yr[r]=xl(r,n)})}else fe(yr,i);return i}var ce=yr;function Dt(n=!0){return typeof self>"u"?void 0:(n||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function uu(n){return typeof self<"u"&&n===self.ManagedMediaSource}function Dc(n,e){let t=Object.keys(n),i=Object.keys(e),s=t.length,r=i.length;return!s||!r||s===r&&!t.some(o=>i.indexOf(o)===-1)}function Ge(n,e=!1){if(typeof TextDecoder<"u"){let l=new TextDecoder("utf-8").decode(n);if(e){let d=l.indexOf("\0");return d!==-1?l.substring(0,d):l}return l.replace(/\0/g,"")}let t=n.length,i,s,r,o="",a=0;for(;a<t;){if(i=n[a++],i===0&&e)return o;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:s=n[a++],o+=String.fromCharCode((i&31)<<6|s&63);break;case 14:s=n[a++],r=n[a++],o+=String.fromCharCode((i&15)<<12|(s&63)<<6|(r&63)<<0);break}}return o}var dt={hexDump:function(n){let e="";for(let t=0;t<n.length;t++){let i=n[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}};function fu(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var qn={exports:{}},Tl;function gu(){return Tl||(Tl=1,function(n,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(c,l,d){if(d=d||{},c=c.trim(),l=l.trim(),!l){if(!d.alwaysNormalize)return c;var h=a.parseURL(c);if(!h)throw new Error("Error trying to parse base URL.");return h.path=a.normalizePath(h.path),a.buildURLFromParts(h)}var u=a.parseURL(l);if(!u)throw new Error("Error trying to parse relative URL.");if(u.scheme)return d.alwaysNormalize?(u.path=a.normalizePath(u.path),a.buildURLFromParts(u)):l;var f=a.parseURL(c);if(!f)throw new Error("Error trying to parse base URL.");if(!f.netLoc&&f.path&&f.path[0]!=="/"){var g=s.exec(f.path);f.netLoc=g[1],f.path=g[2]}f.netLoc&&!f.path&&(f.path="/");var m={scheme:f.scheme,netLoc:u.netLoc,path:null,params:u.params,query:u.query,fragment:u.fragment};if(!u.netLoc&&(m.netLoc=f.netLoc,u.path[0]!=="/"))if(!u.path)m.path=f.path,u.params||(m.params=f.params,u.query||(m.query=f.query));else{var v=f.path,y=v.substring(0,v.lastIndexOf("/")+1)+u.path;m.path=a.normalizePath(y)}return m.path===null&&(m.path=d.alwaysNormalize?a.normalizePath(u.path):u.path),a.buildURLFromParts(m)},parseURL:function(c){var l=i.exec(c);return l?{scheme:l[1]||"",netLoc:l[2]||"",path:l[3]||"",params:l[4]||"",query:l[5]||"",fragment:l[6]||""}:null},normalizePath:function(c){for(c=c.split("").reverse().join("").replace(r,"");c.length!==(c=c.replace(o,"")).length;);return c.split("").reverse().join("")},buildURLFromParts:function(c){return c.scheme+c.netLoc+c.path+c.params+c.query+c.fragment}};n.exports=a})()}(qn)),qn.exports}var ko=gu(),Fi=class{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},pe={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"},Ms=class{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,pu(this,"stats")}setByteRange(e,t){let i=e.split("@",2),s;i.length===1?s=t?.byteRangeEndOffset||0:s=parseInt(i[1]),this._byteRange=[s,parseInt(i[0])+s]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[pe.AUDIO]:null,[pe.VIDEO]:null,[pe.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new Fi),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=ko.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){let{elementaryStreams:e}=this;e[pe.AUDIO]=null,e[pe.VIDEO]=null,e[pe.AUDIOVIDEO]=null}};function Ce(n){return n.sn!=="initSegment"}var ki=class extends Ms{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){let e=this.stats.total;if(e)return e}if(this.byteRange){let e=this.byteRange[0],t=this.byteRange[1];if(G(e)&&G(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){let{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){let t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{let i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;let e=G(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){let t=Object.keys(this.levelkeys),i=t.length;if(i>1||i===1&&this.levelkeys[t[0]].encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!G(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return Ce(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){if(this.levelkeys){let t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,s,r,o=!1){let{elementaryStreams:a}=this,c=a[e];if(!c){a[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:r,partial:o};return}c.startPTS=Math.min(c.startPTS,t),c.endPTS=Math.max(c.endPTS,i),c.startDTS=Math.min(c.startDTS,s),c.endDTS=Math.max(c.endDTS,r)}},_r=class extends Ms{constructor(e,t,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=s;let o=e.enumeratedString("BYTERANGE");o&&this.setByteRange(o,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){let{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}};function Rc(n,e){let t=Object.getPrototypeOf(n);if(t){let i=Object.getOwnPropertyDescriptor(t,e);return i||Rc(t,e)}}function pu(n,e){let t=Rc(n,e);t&&(t.enumerable=!0,Object.defineProperty(n,e,t))}var Os=Math.pow(2,32)-1,mu=[].push,Lc={video:1,audio:2,id3:3,text:4};function Se(n){return String.fromCharCode.apply(null,n)}function wc(n,e){let t=n[e]<<8|n[e+1];return t<0?65536+t:t}function Q(n,e){let t=kc(n,e);return t<0?4294967296+t:t}function bl(n,e){let t=Q(n,e);return t*=Math.pow(2,32),t+=Q(n,e+4),t}function kc(n,e){return n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3]}function Xn(n,e,t){n[e]=t>>24,n[e+1]=t>>16&255,n[e+2]=t>>8&255,n[e+3]=t&255}function vu(n){let e=n.byteLength;for(let t=0;t<e;){let i=Q(n,t);if(i>8&&n[t+4]===109&&n[t+5]===111&&n[t+6]===111&&n[t+7]===102)return!0;t=i>1?t+i:e}return!1}function te(n,e){let t=[];if(!e.length)return t;let i=n.byteLength;for(let s=0;s<i;){let r=Q(n,s),o=Se(n.subarray(s+4,s+8)),a=r>1?s+r:i;if(o===e[0])if(e.length===1)t.push(n.subarray(s+8,a));else{let c=te(n.subarray(s+8,a),e.slice(1));c.length&&mu.apply(t,c)}s=a}return t}function yu(n){let e=[],t=n[0],i=8,s=Q(n,i);i+=4;let r=0,o=0;t===0?(r=Q(n,i),o=Q(n,i+4),i+=8):(r=bl(n,i),o=bl(n,i+8),i+=16),i+=2;let a=n.length+o,c=wc(n,i);i+=2;for(let l=0;l<c;l++){let d=i,h=Q(n,d);d+=4;let u=h&2147483647;if((h&2147483648)>>>31===1)return ce.warn("SIDX has hierarchical references (not supported)"),null;let g=Q(n,d);d+=4,e.push({referenceSize:u,subsegmentDuration:g,info:{duration:g/s,start:a,end:a+u-1}}),a+=u,d+=4,i=d}return{earliestPresentationTime:r,timescale:s,version:t,referencesCount:c,references:e}}function Pc(n){let e=[],t=te(n,["moov","trak"]);for(let s=0;s<t.length;s++){let r=t[s],o=te(r,["tkhd"])[0];if(o){let a=o[0],c=Q(o,a===0?12:20),l=te(r,["mdia","mdhd"])[0];if(l){a=l[0];let d=Q(l,a===0?12:20),h=te(r,["mdia","hdlr"])[0];if(h){let u=Se(h.subarray(8,12)),f={soun:pe.AUDIO,vide:pe.VIDEO}[u],g=te(r,["mdia","minf","stbl","stsd"])[0],m=_u(g);f?(e[c]={timescale:d,type:f,stsd:m},e[f]=he({timescale:d,id:c},m)):e[c]={timescale:d,type:u,stsd:m}}}}}return te(n,["moov","mvex","trex"]).forEach(s=>{let r=Q(s,4),o=e[r];o&&(o.default={duration:Q(s,12),flags:Q(s,20)})}),e}function _u(n){let e=n.subarray(8),t=e.subarray(86),i=Se(e.subarray(4,8)),s=i,r,o=i==="enca"||i==="encv";if(o){let l=te(e,[i])[0].subarray(i==="enca"?28:78);te(l,["sinf"]).forEach(h=>{let u=te(h,["schm"])[0];if(u){let f=Se(u.subarray(4,8));if(f==="cbcs"||f==="cenc"){let g=te(h,["frma"])[0];g&&(s=Se(g))}}})}let a=s;switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{let c=te(t,["avcC"])[0];c&&c.length>3&&(s+="."+gs(c[1])+gs(c[2])+gs(c[3]),r=fs(a==="avc1"?"dva1":"dvav",t));break}case"mp4a":{let c=te(e,[i])[0],l=te(c.subarray(28),["esds"])[0];if(l&&l.length>7){let d=4;if(l[d++]!==3)break;d=Qn(l,d),d+=2;let h=l[d++];if(h&128&&(d+=2),h&64&&(d+=l[d++]),l[d++]!==4)break;d=Qn(l,d);let u=l[d++];if(u===64)s+="."+gs(u);else break;if(d+=12,l[d++]!==5)break;d=Qn(l,d);let f=l[d++],g=(f&248)>>3;g===31&&(g+=1+((f&7)<<3)+((l[d]&224)>>5)),s+="."+g}break}case"hvc1":case"hev1":{let c=te(t,["hvcC"])[0];if(c&&c.length>12){let l=c[1],d=["","A","B","C"][l>>6],h=l&31,u=Q(c,2),f=(l&32)>>5?"H":"L",g=c[12],m=c.subarray(6,12);s+="."+d+h,s+="."+Eu(u).toString(16).toUpperCase(),s+="."+f+g;let v="";for(let y=m.length;y--;){let T=m[y];(T||v)&&(v="."+T.toString(16).toUpperCase()+v)}s+=v}r=fs(a=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{s=fs(s,t)||s;break}case"vp09":{let c=te(t,["vpcC"])[0];if(c&&c.length>6){let l=c[4],d=c[5],h=c[6]>>4&15;s+="."+ct(l)+"."+ct(d)+"."+ct(h)}break}case"av01":{let c=te(t,["av1C"])[0];if(c&&c.length>2){let l=c[1]>>>5,d=c[1]&31,h=c[2]>>>7?"H":"M",u=(c[2]&64)>>6,f=(c[2]&32)>>5,g=l===2&&u?f?12:10:u?10:8,m=(c[2]&16)>>4,v=(c[2]&8)>>3,y=(c[2]&4)>>2,T=c[2]&3;s+="."+l+"."+ct(d)+h+"."+ct(g)+"."+m+"."+v+y+T+"."+ct(1)+"."+ct(1)+"."+ct(1)+"."+0,r=fs("dav1",t)}break}}return{codec:s,encrypted:o,supplemental:r}}function fs(n,e){let t=te(e,["dvvC"]),i=t.length?t[0]:te(e,["dvcC"])[0];if(i){let s=i[2]>>1&127,r=i[2]<<5&32|i[3]>>3&31;return n+"."+ct(s)+"."+ct(r)}}function Eu(n){let e=0;for(let t=0;t<32;t++)e|=(n>>t&1)<<31-t;return e>>>0}function Qn(n,e){let t=e+5;for(;n[e++]&128&&e<t;);return e}function gs(n){return("0"+n.toString(16).toUpperCase()).slice(-2)}function ct(n){return(n<10?"0":"")+n}function Su(n,e){if(!n||!e)return n;let t=e.keyId;return t&&e.isCommonEncryption&&te(n,["moov","trak"]).forEach(s=>{let o=te(s,["mdia","minf","stbl","stsd"])[0].subarray(8),a=te(o,["enca"]),c=a.length>0;c||(a=te(o,["encv"])),a.forEach(l=>{let d=c?l.subarray(28):l.subarray(78);te(d,["sinf"]).forEach(u=>{let f=Mc(u);if(f){let g=f.subarray(8,24);g.some(m=>m!==0)||(ce.log(`[eme] Patching keyId in 'enc${c?"a":"v"}>sinf>>tenc' box: ${dt.hexDump(g)} -> ${dt.hexDump(t)}`),f.set(t,8))}})})}),n}function Mc(n){let e=te(n,["schm"])[0];if(e){let t=Se(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return te(n,["schi","tenc"])[0]}return null}function xu(n,e,t){let i={},s=te(n,["moof","traf"]);for(let r=0;r<s.length;r++){let o=s[r],a=te(o,["tfhd"])[0],c=Q(a,4),l=e[c];if(!l)continue;let d=i[c]||(i[c]={start:NaN,duration:0,sampleCount:0,timescale:l.timescale,type:l.type}),h=te(o,["tfdt"])[0];if(h){let S=h[0],b=Q(h,4);S===1&&(b===Os?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(b*=Os+1,b+=Q(h,8))),G(b)&&(!G(d.start)||b<d.start)&&(d.start=b)}let u=l.default,f=Q(a,0)|u?.flags,g=u?.duration||0;f&8&&(f&2?g=Q(a,12):g=Q(a,8));let m=te(o,["trun"]),v=d.start||0,y=0,T=g;for(let S=0;S<m.length;S++){let b=m[S],A=Q(b,4),L=d.sampleCount;d.sampleCount+=A;let I=b[3]&1,D=b[3]&4,w=b[2]&1,C=b[2]&2,P=b[2]&4,U=b[2]&8,q=8,H=A;for(I&&(q+=4),D&&A&&(!(b[q+1]&1)&&d.keyFrameIndex===void 0&&(d.keyFrameIndex=L),q+=4,w?(T=Q(b,q),q+=4):T=g,C&&(q+=4),U&&(q+=4),v+=T,y+=T,H--);H--;)w?(T=Q(b,q),q+=4):T=g,C&&(q+=4),P&&(b[q+1]&1||d.keyFrameIndex===void 0&&(d.keyFrameIndex=d.sampleCount-(H+1),d.keyFrameStart=v),q+=4),U&&(q+=4),v+=T,y+=T;!y&&g&&(y+=g*A)}d.duration+=y}if(!Object.keys(i).some(r=>i[r].duration)){let r=1/0,o=0,a=te(n,["sidx"]);for(let c=0;c<a.length;c++){let l=yu(a[c]);if(l!=null&&l.references){r=Math.min(r,l.earliestPresentationTime/l.timescale);let d=l.references.reduce((h,u)=>h+u.info.duration||0,0);o=Math.max(o,d+l.earliestPresentationTime/l.timescale)}}o&&G(o)&&Object.keys(i).forEach(c=>{i[c].duration||(i[c].duration=o*i[c].timescale-i[c].start)})}return i}function Tu(n,e,t){te(e,["moof","traf"]).forEach(i=>{te(i,["tfhd"]).forEach(s=>{let r=Q(s,4),o=n[r];if(!o)return;let a=o.timescale||9e4;te(i,["tfdt"]).forEach(c=>{let l=c[0],d=t*a;if(d){let h=Q(c,4);if(l===0)h-=d,h=Math.max(h,0),Xn(c,4,h);else{h*=Math.pow(2,32),h+=Q(c,8),h-=d,h=Math.max(h,0);let u=Math.floor(h/(Os+1)),f=Math.floor(h%(Os+1));Xn(c,4,u),Xn(c,8,f)}}})})})}function bu(n){let e={valid:null,remainder:null},t=te(n,["moof"]);if(t.length<2)return e.remainder=n,e;let i=t[t.length-1];return e.valid=n.slice(0,i.byteOffset-8),e.remainder=n.slice(i.byteOffset-8),e}function qe(n,e){let t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function Al(n,e){let t=[],i=e.samples,s=e.timescale,r=e.id,o=!1;return te(i,["moof"]).map(c=>{let l=c.byteOffset-8;te(c,["traf"]).map(h=>{let u=te(h,["tfdt"]).map(f=>{let g=f[0],m=Q(f,4);return g===1&&(m*=Math.pow(2,32),m+=Q(f,8)),m/s})[0];return u!==void 0&&(n=u),te(h,["tfhd"]).map(f=>{let g=Q(f,4),m=Q(f,0)&16777215,v=(m&1)!==0,y=(m&2)!==0,T=(m&8)!==0,S=0,b=(m&16)!==0,A=0,L=(m&32)!==0,I=8;g===r&&(v&&(I+=8),y&&(I+=4),T&&(S=Q(f,I),I+=4),b&&(A=Q(f,I),I+=4),L&&(I+=4),e.type==="video"&&(o=ln(e.codec)),te(h,["trun"]).map(D=>{let w=D[0],C=Q(D,0)&16777215,P=(C&1)!==0,U=0,q=(C&4)!==0,H=(C&256)!==0,K=0,V=(C&512)!==0,j=0,Y=(C&1024)!==0,M=(C&2048)!==0,O=0,ee=Q(D,4),Z=8;P&&(U=Q(D,Z),Z+=4),q&&(Z+=4);let se=U+l;for(let oe=0;oe<ee;oe++){if(H?(K=Q(D,Z),Z+=4):K=S,V?(j=Q(D,Z),Z+=4):j=A,Y&&(Z+=4),M&&(w===0?O=Q(D,Z):O=kc(D,Z),Z+=4),e.type===pe.VIDEO){let de=0;for(;de<j;){let ge=Q(i,se);if(se+=4,Au(o,i[se])){let Le=i.subarray(se,se+ge);Po(Le,o?2:1,n+O/s,t)}se+=ge,de+=ge+4}}n+=K/s}}))})})}),t}function ln(n){if(!n)return!1;let e=n.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function Au(n,e){if(n){let t=e>>1&63;return t===39||t===40}else return(e&31)===6}function Po(n,e,t,i){let s=Oc(n),r=0;r+=e;let o=0,a=0,c=0;for(;r<s.length;){o=0;do{if(r>=s.length)break;c=s[r++],o+=c}while(c===255);a=0;do{if(r>=s.length)break;c=s[r++],a+=c}while(c===255);let l=s.length-r,d=r;if(a<l)r+=a;else if(a>l){ce.error(`Malformed SEI payload. ${a} is too small, only ${l} bytes left to parse.`);break}if(o===4){if(s[d++]===181){let u=wc(s,d);if(d+=2,u===49){let f=Q(s,d);if(d+=4,f===1195456820){let g=s[d++];if(g===3){let m=s[d++],v=31&m,y=64&m,T=y?2+v*3:0,S=new Uint8Array(T);if(y){S[0]=m;for(let b=1;b<T;b++)S[b]=s[d++]}i.push({type:g,payloadType:o,pts:t,bytes:S})}}}}}else if(o===5&&a>16){let h=[];for(let g=0;g<16;g++){let m=s[d++].toString(16);h.push(m.length==1?"0"+m:m),(g===3||g===5||g===7||g===9)&&h.push("-")}let u=a-16,f=new Uint8Array(u);for(let g=0;g<u;g++)f[g]=s[d++];i.push({payloadType:o,pts:t,uuid:h.join(""),userData:Ge(f),userDataBytes:f})}}}function Oc(n){let e=n.byteLength,t=[],i=1;for(;i<e-2;)n[i]===0&&n[i+1]===0&&n[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return n;let s=e-t.length,r=new Uint8Array(s),o=0;for(i=0;i<s;o++,i++)o===t[0]&&(o++,t.shift()),r[i]=n[o];return r}function Iu(n){let e=n[0],t="",i="",s=0,r=0,o=0,a=0,c=0,l=0;if(e===0){for(;Se(n.subarray(l,l+1))!=="\0";)t+=Se(n.subarray(l,l+1)),l+=1;for(t+=Se(n.subarray(l,l+1)),l+=1;Se(n.subarray(l,l+1))!=="\0";)i+=Se(n.subarray(l,l+1)),l+=1;i+=Se(n.subarray(l,l+1)),l+=1,s=Q(n,12),r=Q(n,16),a=Q(n,20),c=Q(n,24),l=28}else if(e===1){l+=4,s=Q(n,l),l+=4;let h=Q(n,l);l+=4;let u=Q(n,l);for(l+=4,o=2**32*h+u,nu(o)||(o=Number.MAX_SAFE_INTEGER,ce.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=Q(n,l),l+=4,c=Q(n,l),l+=4;Se(n.subarray(l,l+1))!=="\0";)t+=Se(n.subarray(l,l+1)),l+=1;for(t+=Se(n.subarray(l,l+1)),l+=1;Se(n.subarray(l,l+1))!=="\0";)i+=Se(n.subarray(l,l+1)),l+=1;i+=Se(n.subarray(l,l+1)),l+=1}let d=n.subarray(l,n.byteLength);return{schemeIdUri:t,value:i,timeScale:s,presentationTime:o,presentationTimeDelta:r,eventDuration:a,id:c,payload:d}}function Cu(n,...e){let t=e.length,i=8,s=t;for(;s--;)i+=e[s].byteLength;let r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(n,4),s=0,i=8;s<t;s++)r.set(e[s],i),i+=e[s].byteLength;return r}function Du(n,e,t){if(n.byteLength!==16)throw new RangeError("Invalid system id");let i,s;i=0,s=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;let o=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(o.buffer).setUint32(0,t.byteLength,!1),Cu([112,115,115,104],new Uint8Array([i,0,0,0]),n,r,s,o,t||new Uint8Array)}function Ru(n){let e=[];if(n instanceof ArrayBuffer){let t=n.byteLength,i=0;for(;i+32<t;){let s=new DataView(n,i),r=Lu(s);e.push(r),i+=r.size}}return e}function Lu(n){let e=n.getUint32(0),t=n.byteOffset,i=n.byteLength;if(i<e)return{offset:t,size:i};if(n.getUint32(4)!==1886614376)return{offset:t,size:e};let r=n.getUint32(8)>>>24;if(r!==0&&r!==1)return{offset:t,size:e};let o=n.buffer,a=dt.hexDump(new Uint8Array(o,t+12,16)),c=n.getUint32(28),l=null,d=null;if(r===0){if(e-32<c||c<22)return{offset:t,size:e};d=new Uint8Array(o,t+32,c)}else if(r===1){if(!c||i<t+32+c*16+16)return{offset:t,size:e};l=[];for(let h=0;h<c;h++)l.push(new Uint8Array(o,t+32+h*16,16))}return{version:r,systemId:a,kids:l,data:d,offset:t,size:e}}var Fc=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),li={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Nc(n,e){let t=li[e];return!!t&&!!t[n.slice(0,4)]}function Er(n,e,t=!0){return!n.split(",").some(i=>!Bc(i,e,t))}function Bc(n,e,t=!0){var i;let s=Dt(t);return(i=s?.isTypeSupported(Ni(n,e)))!=null?i:!1}function Ni(n,e){return`${e}/mp4;codecs=${n}`}function Il(n){if(n){let e=n.substring(0,4);return li.video[e]}return 2}function Fs(n){let e=Fc();return n.split(",").reduce((t,i)=>{let r=e&&ln(i)?9:li.video[i];return r?(r*2+t)/(t?3:2):(li.audio[i]+t)/(t?2:1)},0)}var Zn={};function wu(n,e=!0){if(Zn[n])return Zn[n];let t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[n];for(let s=0;s<t.length;s++){var i;if(Bc(t[s],"audio",e))return Zn[n]=t[s],t[s];if(t[s]==="mp3"&&(i=Dt(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return n}var ku=/flac|opus|mp4a\.40\.34/i;function Ns(n,e=!0){return n.replace(ku,t=>wu(t.toLowerCase(),e))}function Pu(n,e){let t=[];if(n){let i=n.split(",");for(let s=0;s<i.length;s++)Nc(i[s],"video")||t.push(i[s])}return e&&t.push(e),t.join(",")}function Cs(n,e){if(n&&(n.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(n)!==-1))return n;if(e){let t=e.split(",");if(t.length>1){if(n){for(let i=t.length;i--;)if(t[i].substring(0,4)===n.substring(0,4))return t[i]}return t[0]}}return e||n}function Mu(n){let e=n.split(",");for(let t=0;t<e.length;t++){let i=e[t].split(".");i.length>2&&i[0]==="avc1"&&(e[t]=`avc1.${parseInt(i[1]).toString(16)}${("000"+parseInt(i[2]).toString(16)).slice(-4)}`)}return e.join(",")}function Ou(n){if(n.startsWith("av01.")){let e=n.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return n}function Cl(n){let e=Dt(n)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Uc(n){return n.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}var Vc={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function $c(n,e){return{supported:!1,configurations:e,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:n}}var Dl={};function Fu(n,e,t,i,s,r){let o=n.audioCodec?n.audioGroups:null,a=r?.audioCodec,c=r?.channels,l=c?parseInt(c):a?1/0:2,d=null;if(o!=null&&o.length)try{o.length===1&&o[0]?d=e.groups[o[0]].channels:d=o.reduce((h,u)=>{if(u){let f=e.groups[u];if(!f)throw new Error(`Audio track group ${u} not found`);Object.keys(f.channels).forEach(g=>{h[g]=(h[g]||0)+f.channels[g]})}return h},{2:0})}catch{return!0}return n.videoCodec!==void 0&&(n.width>1920&&n.height>1088||n.height>1920&&n.width>1088||n.frameRate>Math.max(i,30)||n.videoRange!=="SDR"&&n.videoRange!==t||n.bitrate>Math.max(s,8e6))||!!d&&G(l)&&Object.keys(d).some(h=>parseInt(h)>l)}function Gc(n,e,t){let i=n.videoCodec,s=n.audioCodec;if(!i&&!s||!t)return Promise.resolve(Vc);let r=[];if(i){let o={width:n.width,height:n.height,bitrate:Math.ceil(Math.max(n.bitrate*.9,n.averageBitrate)),framerate:n.frameRate||30},a=n.videoRange;a!=="SDR"&&(o.transferFunction=a.toLowerCase());let c=i.split(","),l=navigator.userAgent;if(c.some(d=>ln(d))&&Fc())return Promise.resolve($c(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: (${l})`),r));r.push.apply(r,c.map(d=>({type:"media-source",video:he(he({},o),{},{contentType:Ni(Ou(d),"video")})})))}return s&&n.audioGroups&&n.audioGroups.forEach(o=>{var a;o&&((a=e.groups[o])==null||a.tracks.forEach(c=>{if(c.groupId===o){let l=c.channels||"",d=parseFloat(l);G(d)&&d>2&&r.push.apply(r,s.split(",").map(h=>({type:"media-source",audio:{contentType:Ni(h,"audio"),channels:""+d}})))}}))}),Promise.all(r.map(o=>{let a=Nu(o);return Dl[a]||(Dl[a]=t.decodingInfo(o))})).then(o=>({supported:!o.some(a=>!a.supported),configurations:r,decodingInfoResults:o})).catch(o=>({supported:!1,configurations:r,decodingInfoResults:[],error:o}))}function Nu(n){let{audio:e,video:t}=n,i=t||e;if(i){let s=Uc(i.contentType);if(t)return`r${t.height}x${t.width}f${Math.ceil(t.framerate)}${t.transferFunction||"sd"}_${s}_${Math.ceil(t.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${s}`}return""}var Sr=["NONE","TYPE-0","TYPE-1",null];function Bu(n){return Sr.indexOf(n)>-1}var Bs=["SDR","PQ","HLG"];function Uu(n){return!!n&&Bs.indexOf(n)>-1}var Ds={No:"",Yes:"YES",v2:"v2"};function Rl(n){let{canSkipUntil:e,canSkipDateRanges:t,age:i}=n,s=i<e/2;return e&&s?t?Ds.v2:Ds.Yes:Ds.No}var Us=class{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){let t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}},jt=class{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;let i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Ll(this._audioGroups,e)}hasSubtitleGroup(e){return Ll(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}};function Ll(n,e){return!e||!n?!1:n.indexOf(e)!==-1}function Vu(){if(typeof matchMedia=="function"){let n=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(n.media!==e.media)return n.matches===!0}return!1}function $u(n,e){let t=!1,i=[];if(n&&(t=n!=="SDR",i=[n]),e){i=e.allowedVideoRanges||Bs.slice(0);let s=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:s&&Vu(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}var Gu=n=>{let e=new WeakSet;return(t,i)=>{if(n&&(i=n(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},me=(n,e)=>JSON.stringify(n,Gu(e));function Hu(n,e,t,i,s){let r=Object.keys(n),o=i?.channels,a=i?.audioCodec,c=s?.videoCodec,l=o&&parseInt(o)===2,d=!1,h=!1,u=1/0,f=1/0,g=1/0,m=1/0,v=0,y=[],{preferHDR:T,allowedVideoRanges:S}=$u(e,s);for(let D=r.length;D--;){let w=n[r[D]];d||(d=w.channels[2]>0),u=Math.min(u,w.minHeight),f=Math.min(f,w.minFramerate),g=Math.min(g,w.minBitrate),S.filter(P=>w.videoRanges[P]>0).length>0&&(h=!0)}u=G(u)?u:0,f=G(f)?f:0;let b=Math.max(1080,u),A=Math.max(30,f);g=G(g)?g:t,t=Math.max(g,t),h||(e=void 0);let L=r.length>1;return{codecSet:r.reduce((D,w)=>{let C=n[w];if(w===D)return D;if(y=h?S.filter(P=>C.videoRanges[P]>0):[],L){if(C.minBitrate>t)return lt(w,`min bitrate of ${C.minBitrate} > current estimate of ${t}`),D;if(!C.hasDefaultAudio)return lt(w,"no renditions with default or auto-select sound found"),D;if(a&&w.indexOf(a.substring(0,4))%5!==0)return lt(w,`audio codec preference "${a}" not found`),D;if(o&&!l){if(!C.channels[o])return lt(w,`no renditions with ${o} channel sound found (channels options: ${Object.keys(C.channels)})`),D}else if((!a||l)&&d&&C.channels[2]===0)return lt(w,"no renditions with stereo sound found"),D;if(C.minHeight>b)return lt(w,`min resolution of ${C.minHeight} > maximum of ${b}`),D;if(C.minFramerate>A)return lt(w,`min framerate of ${C.minFramerate} > maximum of ${A}`),D;if(!y.some(P=>C.videoRanges[P]>0))return lt(w,`no variants with VIDEO-RANGE of ${me(y)} found`),D;if(c&&w.indexOf(c.substring(0,4))%5!==0)return lt(w,`video codec preference "${c}" not found`),D;if(C.maxScore<v)return lt(w,`max score of ${C.maxScore} < selected max of ${v}`),D}return D&&(Fs(w)>=Fs(D)||C.fragmentError>n[D].fragmentError)?D:(m=C.minIndex,v=C.maxScore,w)},void 0),videoRanges:y,preferHDR:T,minFramerate:f,minBitrate:g,minIndex:m}}function lt(n,e){ce.log(`[abr] start candidates with "${n}" ignored because ${e}`)}function Hc(n){return n.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);let s=t.channels||"2";return i.channels[s]=(i.channels[s]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Ku(n,e,t,i){return n.slice(t,i+1).reduce((s,r,o)=>{if(!r.codecSet)return s;let a=r.audioGroups,c=s[r.codecSet];c||(s[r.codecSet]=c={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:o,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),c.minBitrate=Math.min(c.minBitrate,r.bitrate);let l=Math.min(r.height,r.width);return c.minHeight=Math.min(c.minHeight,l),c.minFramerate=Math.min(c.minFramerate,r.frameRate),c.minIndex=Math.min(c.minIndex,o),c.maxScore=Math.max(c.maxScore,r.score),c.fragmentError+=r.fragmentError,c.videoRanges[r.videoRange]=(c.videoRanges[r.videoRange]||0)+1,a&&a.forEach(d=>{if(!d)return;let h=e.groups[d];h&&(c.hasDefaultAudio=c.hasDefaultAudio||e.hasDefaultAudio?h.hasDefault:h.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(h.channels).forEach(u=>{c.channels[u]=(c.channels[u]||0)+h.channels[u]}))}),s},{})}function wl(n){if(!n)return n;let{lang:e,assocLang:t,characteristics:i,channels:s,audioCodec:r}=n;return{lang:e,assocLang:t,characteristics:i,channels:s,audioCodec:r}}function ut(n,e,t){if("attrs"in n){let i=e.indexOf(n);if(i!==-1)return i}for(let i=0;i<e.length;i++){let s=e[i];if(Ht(n,s,t))return i}return-1}function Ht(n,e,t){let{groupId:i,name:s,lang:r,assocLang:o,default:a}=n,c=n.forced;return(i===void 0||e.groupId===i)&&(s===void 0||e.name===s)&&(r===void 0||ju(r,e.lang))&&(r===void 0||e.assocLang===o)&&(a===void 0||e.default===a)&&(c===void 0||e.forced===c)&&(!("characteristics"in n)||Wu(n.characteristics||"",e.characteristics))&&(t===void 0||t(n,e))}function ju(n,e="--"){return n.length===e.length?n===e:n.startsWith(e)||e.startsWith(n)}function Wu(n,e=""){let t=n.split(","),i=e.split(",");return t.length===i.length&&!t.some(s=>i.indexOf(s)===-1)}function $t(n,e){let{audioCodec:t,channels:i}=n;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function Yu(n,e,t,i,s){let r=e[i],a=e.reduce((u,f,g)=>{let m=f.uri;return(u[m]||(u[m]=[])).push(g),u},{})[r.uri];a.length>1&&(i=Math.max.apply(Math,a));let c=r.videoRange,l=r.frameRate,d=r.codecSet.substring(0,4),h=kl(e,i,u=>{if(u.videoRange!==c||u.frameRate!==l||u.codecSet.substring(0,4)!==d)return!1;let f=u.audioGroups,g=t.filter(m=>!f||f.indexOf(m.groupId)!==-1);return ut(n,g,s)>-1});return h>-1?h:kl(e,i,u=>{let f=u.audioGroups,g=t.filter(m=>!f||f.indexOf(m.groupId)!==-1);return ut(n,g,s)>-1})}function kl(n,e,t){for(let i=e;i>-1;i--)if(t(n[i]))return i;for(let i=e+1;i<n.length;i++)if(t(n[i]))return i;return-1}function Vs(n,e){var t;return!!n&&n!==((t=e.loadLevelObj)==null?void 0:t.uri)}var xr=class extends rt{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;let{fragCurrent:s,partCurrent:r,hls:o}=this,{autoLevelEnabled:a,media:c}=o;if(!s||!c)return;let l=performance.now(),d=r?r.stats:s.stats,h=r?r.duration:s.duration,u=l-d.loading.start,f=o.minAutoLevel,g=s.level,m=this._nextAutoLevel;if(d.aborted||d.loaded&&d.loaded===d.total||g<=f){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;let v=m>-1&&m!==g,y=!!t||v;if(!y&&(c.paused||!c.playbackRate||!c.readyState))return;let T=o.mainForwardBufferInfo;if(!y&&T===null)return;let S=this.bwEstimator.getEstimateTTFB(),b=Math.abs(c.playbackRate);if(u<=Math.max(S,1e3*(h/(b*2))))return;let A=T?T.len/b:0,L=d.loading.first?d.loading.first-d.loading.start:-1,I=d.loaded&&L>-1,D=this.getBwEstimate(),w=o.levels,C=w[g],P=Math.max(d.loaded,Math.round(h*(s.bitrate||C.averageBitrate)/8)),U=I?u-L:u;U<1&&I&&(U=Math.min(u,d.loaded*8/D));let q=I?d.loaded*1e3/U:0,H=S/1e3,K=q?(P-d.loaded)/q:P*8/D+H;if(K<=A)return;let V=q?q*8:D,j=((i=t?.details||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,Y=this.hls.config.abrBandWidthUpFactor,M=Number.POSITIVE_INFINITY,O;for(O=g-1;O>f;O--){let oe=w[O].maxBitrate,de=!w[O].details||j;if(M=this.getTimeToLoadFrag(H,V,h*oe,de),M<Math.min(A,h+H))break}if(M>=K||M>h*10)return;I?this.bwEstimator.sample(u-Math.min(S,L),d.loaded):this.bwEstimator.sampleTTFB(u);let ee=w[O].maxBitrate;this.getBwEstimate()*Y>ee&&this.resetEstimator(ee);let Z=this.findBestLevel(ee,f,O,0,A,1,1);Z>-1&&(O=Z),this.warn(`Fragment ${s.sn}${r?" part "+r.index:""} of level ${g} is loading too slowly;
      Fragment duration: ${s.duration.toFixed(3)}
      Time to underbuffer: ${A.toFixed(3)} s
      Estimated load time for current fragment: ${K.toFixed(3)} s
      Estimated load time for down switch fragment: ${M.toFixed(3)} s
      TTFB estimate: ${L|0} ms
      Current BW estimate: ${G(D)?D|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${O} @ ${ee|0} bps`),o.nextLoadLevel=o.nextAutoLevel=O,this.clearTimer();let se=()=>{if(this.clearTimer(),this.fragCurrent===s&&this.hls.loadLevel===O&&O>0){let oe=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${O>0?"and switching down":""}
      Fragment duration: ${s.duration.toFixed(3)} s
      Time to underbuffer: ${oe.toFixed(3)} s`),s.abortRequests(),this.fragCurrent=this.partCurrent=null,O>f){let de=this.findBestLevel(this.hls.levels[f].bitrate,f,O,0,oe,1,1);de===-1&&(de=f),this.hls.nextLoadLevel=this.hls.nextAutoLevel=de,this.resetEstimator(this.hls.levels[de].bitrate)}}};v||K>M*2?se():this.timer=self.setInterval(se,M*1e3),o.trigger(p.FRAG_LOAD_EMERGENCY_ABORTED,{frag:s,part:r,stats:d})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){let e=this.hls.config;return new mr(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){let{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.FRAG_LOADING,this.onFragLoading,this),e.on(p.FRAG_LOADED,this.onFragLoaded,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e&&(e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.FRAG_LOADING,this.onFragLoading,this),e.off(p.FRAG_LOADED,this.onFragLoaded,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(p.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){let i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=(s=t.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case R.BUFFER_ADD_CODEC_ERROR:case R.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case R.FRAG_LOAD_TIMEOUT:{let i=t.frag,{fragCurrent:s,partCurrent:r}=this;if(i&&s&&i.sn===s.sn&&i.level===s.level){let o=performance.now(),a=r?r.stats:i.stats,c=o-a.loading.start,l=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&l>-1){let h=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(c-Math.min(h,l),a.loaded)}else this.bwEstimator.sampleTTFB(c)}break}}}getTimeToLoadFrag(e,t,i,s){let r=e+i/t,o=s?e+this.lastLevelLoadSec:0;return r+o}onLevelLoaded(e,t){let i=this.hls.config,{loading:s}=t.stats,r=s.end-s.first;G(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){let s=i?i.stats:t.stats;if(t.type===W.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){let r=i?i.duration:t.duration,o=this.hls.levels[t.level],a=(o.loaded?o.loaded.bytes:0)+s.loaded,c=(o.loaded?o.loaded.duration:0)+r;o.loaded={bytes:a,duration:c},o.realBitrate=Math.round(8*a/c)}if(t.bitrateTest){let r={stats:s,frag:t,part:i,id:t.type};this.onFragBuffered(p.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){let{frag:i,part:s}=t,r=s!=null&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;let o=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==W.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){let{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,s,1,1);if(r>-1)return r;let o=this.hls.firstLevel,a=Math.min(Math.max(o,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${o} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){let e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),s=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!s||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;let r=i&&s?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){let o=this.hls.levels;if(o.length>Math.max(e,r)&&o[e].loadError<=o[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){let{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;let{maxAutoLevel:s,config:r,minAutoLevel:o}=i,a=t?t.duration:e?e.duration:0,c=this.getBwEstimate(),l=this.getStarvationDelay(),d=r.abrBandWidthFactor,h=r.abrBandWidthUpFactor;if(l){let v=this.findBestLevel(c,o,s,l,0,d,h);if(v>=0)return this.rebufferNotice=-1,v}let u=a?Math.min(a,r.maxStarvationDelay):r.maxStarvationDelay;if(!l){let v=this.bitrateTestDelay;v&&(u=(a?Math.min(a,r.maxLoadingDelay):r.maxLoadingDelay)-v,this.info(`bitrate test took ${Math.round(1e3*v)}ms, set first fragment max fetchDuration to ${Math.round(1e3*u)} ms`),d=h=1)}let f=this.findBestLevel(c,o,s,l,u,d,h);if(this.rebufferNotice!==f&&(this.rebufferNotice=f,this.info(`${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${f}`)),f>-1)return f;let g=i.levels[o],m=i.loadLevelObj;return m&&g?.bitrate<m.bitrate?o:i.loadLevel}getStarvationDelay(){let e=this.hls,t=e.media;if(!t)return 1/0;let i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,s=e.mainForwardBufferInfo;return(s?s.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,s,r,o,a){var c;let l=s+r,d=this.lastLoadedFragLevel,h=d===-1?this.hls.firstLevel:d,{fragCurrent:u,partCurrent:f}=this,{levels:g,allAudioTracks:m,loadLevel:v,config:y}=this.hls;if(g.length===1)return 0;let T=g[h],S=!!((c=this.hls.latestLevelDetails)!=null&&c.live),b=v===-1||d===-1,A,L="SDR",I=T?.frameRate||0,{audioPreference:D,videoPreference:w}=y,C=this.audioTracksByGroup||(this.audioTracksByGroup=Hc(m)),P=-1;if(b){if(this.firstSelection!==-1)return this.firstSelection;let V=this.codecTiers||(this.codecTiers=Ku(g,C,t,i)),j=Hu(V,L,e,D,w),{codecSet:Y,videoRanges:M,minFramerate:O,minBitrate:ee,minIndex:Z,preferHDR:se}=j;P=Z,A=Y,L=se?M[M.length-1]:M[0],I=O,e=Math.max(e,ee),this.log(`picked start tier ${me(j)}`)}else A=T?.codecSet,L=T?.videoRange;let U=f?f.duration:u?u.duration:0,q=this.bwEstimator.getEstimateTTFB()/1e3,H=[];for(let V=i;V>=t;V--){var K;let j=g[V],Y=V>h;if(!j)continue;if(y.useMediaCapabilities&&!j.supportedResult&&!j.supportedPromise){let de=navigator.mediaCapabilities;typeof de?.decodingInfo=="function"&&(Fu(j,C,L,I,e,D)||ln(j.videoCodec))?(j.supportedPromise=Gc(j,C,de),j.supportedPromise.then(ge=>{if(!this.hls)return;j.supportedResult=ge;let Le=this.hls.levels,we=Le.indexOf(j);ge.error?this.warn(`MediaCapabilities decodingInfo error: "${ge.error}" for level ${we} ${me(ge)}`):ge.supported||(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${we} ${me(ge)}`),we>-1&&Le.length>1&&(this.log(`Removing unsupported level ${we}`),this.hls.removeLevel(we),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))})):j.supportedResult=Vc}if((A&&j.codecSet!==A||L&&j.videoRange!==L||Y&&I>j.frameRate||!Y&&I>0&&I<j.frameRate||j.supportedResult&&!((K=j.supportedResult.decodingInfoResults)!=null&&K[0].smooth))&&(!b||V!==P)){H.push(V);continue}let M=j.details,O=(f?M?.partTarget:M?.averagetargetduration)||U,ee;Y?ee=a*e:ee=o*e;let Z=U&&s>=U*2&&r===0?j.averageBitrate:j.maxBitrate,se=this.getTimeToLoadFrag(q,ee,Z*O,M===void 0);if(ee>=Z&&(V===d||j.loadError===0&&j.fragmentError===0)&&(se<=q||!G(se)||S&&!this.bitrateTestDelay||se<l)){let de=this.forcedAutoLevel;return V!==v&&(de===-1||de!==v)&&(H.length&&this.trace(`Skipped level(s) ${H.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${g[H[0]].codecs}" ${g[H[0]].videoRange}; not compatible with "${A}" ${L}`),this.info(`switch candidate:${h}->${V} adjustedbw(${Math.round(ee)})-bitrate=${Math.round(ee-Z)} ttfb:${q.toFixed(1)} avgDuration:${O.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${se.toFixed(1)} firstSelection:${b} codecSet:${j.codecSet} videoRange:${j.videoRange} hls.loadLevel:${v}`)),b&&(this.firstSelection=V),V}}return-1}set nextAutoLevel(e){let t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){let{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}},Kc={search:function(n,e){let t=0,i=n.length-1,s=null,r=null;for(;t<=i;){s=(t+i)/2|0,r=n[s];let o=e(r);if(o>0)t=s+1;else if(o<0)i=s-1;else return r}return null}};function zu(n,e,t){if(e===null||!Array.isArray(n)||!n.length||!G(e))return null;let i=n[0].programDateTime;if(e<(i||0))return null;let s=n[n.length-1].endProgramDateTime;if(e>=(s||0))return null;for(let r=0;r<n.length;++r){let o=n[r];if(Xu(e,t,o))return o}return null}function Wt(n,e,t=0,i=0,s=.005){let r=null;if(n){r=e[1+n.sn-e[0].sn]||null;let a=n.endDTS-t;a>0&&a<15e-7&&(t+=15e-7),r&&n.level!==r.level&&r.end<=n.end&&(r=e[2+n.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(r=e[0]);if(r&&((!n||n.level===r.level)&&Pl(t,i,r)===0||qu(r,n,Math.min(s,i))))return r;let o=Kc.search(e,Pl.bind(null,t,i));return o&&(o!==n||!r)?o:r}function qu(n,e,t){if(e&&e.start===0&&e.level<n.level&&(e.endPTS||0)>0){let i=e.tagList.reduce((s,r)=>(r[0]==="INF"&&(s+=parseFloat(r[1])),s),t);return n.start<=i}return!1}function Pl(n=0,e=0,t){if(t.start<=n&&t.start+t.duration>n)return 0;let i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=n?1:t.start-i>n&&t.start?-1:0}function Xu(n,e,t){let i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>n}function jc(n,e,t){if(n&&n.startCC<=e&&n.endCC>=e){let i=n.fragments,{fragmentHint:s}=n;s&&(i=i.concat(s));let r;return Kc.search(i,o=>o.cc<e?1:o.cc>e?-1:(r=o,o.end<=t?1:o.start>t?-1:0)),r||null}return null}function $s(n){switch(n.details){case R.FRAG_LOAD_TIMEOUT:case R.KEY_LOAD_TIMEOUT:case R.LEVEL_LOAD_TIMEOUT:case R.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Ml(n,e){let t=$s(e);return n.default[`${t?"timeout":"error"}Retry`]}function Mo(n,e){let t=n.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*n.retryDelayMs,n.maxRetryDelayMs)}function Ol(n){return he(he({},n),{errorRetry:null,timeoutRetry:null})}function Gs(n,e,t,i){if(!n)return!1;let s=i?.code,r=e<n.maxNumRetry&&(Qu(s)||!!t);return n.shouldRetry?n.shouldRetry(n,e,t,i,r):r}function Qu(n){return n===0&&navigator.onLine===!1||!!n&&(n<400||n>499)}var De={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},st={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4},Tr=class extends rt{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){let e=this.hls;e.on(p.ERROR,this.onError,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){let e=this.hls;e&&(e.off(p.ERROR,this.onError,this),e.off(p.ERROR,this.onErrorOut,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return e?.type===W.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;let s=this.hls,r=t.context;switch(t.details){case R.FRAG_LOAD_ERROR:case R.FRAG_LOAD_TIMEOUT:case R.KEY_LOAD_ERROR:case R.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case R.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=Bi();return}case R.FRAG_GAP:case R.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=De.SendAlternateToPenaltyBox;return}case R.LEVEL_EMPTY_ERROR:case R.LEVEL_PARSING_ERROR:{var o,a;let l=t.parent===W.MAIN?t.level:s.loadLevel;t.details===R.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(a=o.levelDetails)!=null&&a.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,l):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,l))}return;case R.LEVEL_LOAD_ERROR:case R.LEVEL_LOAD_TIMEOUT:typeof r?.level=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.level));return;case R.AUDIO_TRACK_LOAD_ERROR:case R.AUDIO_TRACK_LOAD_TIMEOUT:case R.SUBTITLE_LOAD_ERROR:case R.SUBTITLE_TRACK_LOAD_TIMEOUT:if(r){let l=s.loadLevelObj;if(l&&(r.type===ne.AUDIO_TRACK&&l.hasAudioGroup(r.groupId)||r.type===ne.SUBTITLE_TRACK&&l.hasSubtitleGroup(r.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.loadLevel),t.errorAction.action=De.SendAlternateToPenaltyBox,t.errorAction.flags=st.MoveAllAlternatesMatchingHost;return}}return;case R.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{let l=s.loadLevelObj,d=l?.attrs["HDCP-LEVEL"];d?t.errorAction={action:De.SendAlternateToPenaltyBox,flags:st.MoveAllAlternatesMatchingHDCP,hdcpLevel:d}:this.keySystemError(t)}return;case R.BUFFER_ADD_CODEC_ERROR:case R.REMUX_ALLOC_ERROR:case R.BUFFER_APPEND_ERROR:if(!t.errorAction){var c;t.errorAction=this.getLevelSwitchAction(t,(c=t.level)!=null?c:s.loadLevel)}return;case R.INTERNAL_EXCEPTION:case R.BUFFER_APPENDING_ERROR:case R.BUFFER_FULL_ERROR:case R.LEVEL_SWITCH_ERROR:case R.BUFFER_STALLED_ERROR:case R.BUFFER_SEEK_OVER_HOLE:case R.BUFFER_NUDGE_ON_STALL:t.errorAction=Bi();return}t.type===z.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){let t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){let i=this.hls,s=Ml(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(Gs(s,r,$s(e),e.response))return{action:De.RetryRequest,flags:st.None,retryConfig:s,retryCount:r};let a=this.getLevelSwitchAction(e,t);return s&&(a.retryConfig=s,a.retryCount=r),a}getFragRetryOrSwitchAction(e){let t=this.hls,i=this.getVariantLevelIndex(e.frag),s=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:o}=t.config,a=Ml(e.details.startsWith("key")?o:r,e),c=t.levels.reduce((d,h)=>d+h.fragmentError,0);if(s&&(e.details!==R.FRAG_GAP&&s.fragmentError++,Gs(a,c,$s(e),e.response)))return{action:De.RetryRequest,flags:st.None,retryConfig:a,retryCount:c};let l=this.getLevelSwitchAction(e,i);return a&&(l.retryConfig=a,l.retryCount=c),l}getLevelSwitchAction(e,t){let i=this.hls;t==null&&(t=i.loadLevel);let s=this.hls.levels[t];if(s){var r,o;let l=e.details;s.loadError++,l===R.BUFFER_APPEND_ERROR&&s.fragmentError++;let d=-1,{levels:h,loadLevel:u,minAutoLevel:f,maxAutoLevel:g}=i;!i.autoLevelEnabled&&!i.config.preserveManualLevelOnError&&(i.loadLevel=-1);let m=(r=e.frag)==null?void 0:r.type,y=(m===W.AUDIO&&l===R.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(l===R.BUFFER_ADD_CODEC_ERROR||l===R.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:L})=>s.audioCodec!==L),S=e.sourceBufferName==="video"&&(l===R.BUFFER_ADD_CODEC_ERROR||l===R.BUFFER_APPEND_ERROR)&&h.some(({codecSet:L,audioCodec:I})=>s.codecSet!==L&&s.audioCodec===I),{type:b,groupId:A}=(o=e.context)!=null?o:{};for(let L=h.length;L--;){let I=(L+u)%h.length;if(I!==u&&I>=f&&I<=g&&h[I].loadError===0){var a,c;let D=h[I];if(l===R.FRAG_GAP&&m===W.MAIN&&e.frag){let w=h[I].details;if(w){let C=Wt(e.frag,w.fragments,e.frag.start);if(C!=null&&C.gap)continue}}else{if(b===ne.AUDIO_TRACK&&D.hasAudioGroup(A)||b===ne.SUBTITLE_TRACK&&D.hasSubtitleGroup(A))continue;if(m===W.AUDIO&&(a=s.audioGroups)!=null&&a.some(w=>D.hasAudioGroup(w))||m===W.SUBTITLE&&(c=s.subtitleGroups)!=null&&c.some(w=>D.hasSubtitleGroup(w))||y&&s.audioCodec===D.audioCodec||!y&&s.audioCodec!==D.audioCodec||S&&s.codecSet===D.codecSet)continue}d=I;break}}if(d>-1&&i.loadLevel!==d)return e.levelRetry=!0,this.playlistError=0,{action:De.SendAlternateToPenaltyBox,flags:st.None,nextAutoLevel:d}}return{action:De.SendAlternateToPenaltyBox,flags:st.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case De.DoNothing:break;case De.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==R.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case De.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){let t=this.hls,i=e.errorAction;if(!i)return;let{flags:s,hdcpLevel:r,nextAutoLevel:o}=i;switch(s){case st.None:this.switchLevel(e,o);break;case st.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=Sr[Sr.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,o)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===R.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){let i=Uc(e.mimeType),s=this.hls.levels;for(let r=s.length;r--;)s[r][`${e.sourceBufferName}Codec`]===i&&this.hls.removeLevel(r)}}};function Bi(n){let e={action:De.DoNothing,flags:st.None};return n&&(e.resolved=!0),e}var xe={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"},br=class{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){let{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.BUFFER_APPENDED,this.onBufferAppended,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this),e.on(p.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){let{hls:e}=this;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.BUFFER_APPENDED,this.onBufferAppended,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this),e.off(p.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){let i=this.activePartLists[t];if(i)for(let s=i.length;s--;){let r=i[s];if(!r)break;let o=r.end;if(r.start<=e&&o!==null&&e<=o)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,i){let{fragments:s}=this,r=Object.keys(s);for(let o=r.length;o--;){let a=s[r[o]];if(a?.body.type===t&&(!i||a.buffered)){let c=a.body;if(c.start<=e&&e<=c.end)return c}}return null}detectEvictedFragments(e,t,i,s,r){this.timeRanges&&(this.timeRanges[e]=t);let o=s?.fragment.sn||-1;Object.keys(this.fragments).forEach(a=>{let c=this.fragments[a];if(!c||o>=c.body.sn)return;if(!c.buffered&&(!c.loaded||r)){c.body.type===i&&this.removeFragment(c.body);return}let l=c.range[e];if(l){if(l.time.length===0){this.removeFragment(c.body);return}l.time.some(d=>{let h=!this.isTimeBuffered(d.startPTS,d.endPTS,t);return h&&this.removeFragment(c.body),h})}})}detectPartialFragments(e){let t=this.timeRanges;if(!t||e.frag.sn==="initSegment")return;let i=e.frag,s=Zt(i),r=this.fragments[s];if(!r||r.buffered&&i.gap)return;let o=!i.relurl;Object.keys(t).forEach(a=>{let c=i.elementaryStreams[a];if(!c)return;let l=t[a],d=o||c.partial===!0;r.range[a]=this.getBufferedTimes(i,e.part,d,l)}),r.loaded=null,Object.keys(r.range).length?(r.buffered=!0,(r.body.endList=i.endList||r.body.endList)&&(this.endListFragments[r.body.type]=r),ps(r)||this.removeParts(i.sn-1,i.type)):this.removeFragment(r.body)}removeParts(e,t){let i=this.activePartLists[t];i&&(this.activePartLists[t]=Fl(i,s=>s.fragment.sn>=e))}fragBuffered(e,t){let i=Zt(e),s=this.fragments[i];!s&&t&&(s=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(e,t,i,s){let r={time:[],partial:i},o=e.start,a=e.end,c=e.minEndPTS||a,l=e.maxStartPTS||o;for(let d=0;d<s.length;d++){let h=s.start(d)-this.bufferPadding,u=s.end(d)+this.bufferPadding;if(l>=h&&c<=u){r.time.push({startPTS:Math.max(o,s.start(d)),endPTS:Math.min(a,s.end(d))});break}else if(o<u&&a>h){let f=Math.max(o,s.start(d)),g=Math.min(a,s.end(d));g>f&&(r.partial=!0,r.time.push({startPTS:f,endPTS:g}))}else if(a<=h)break}return r}getPartialFragment(e){let t=null,i,s,r,o=0,{bufferPadding:a,fragments:c}=this;return Object.keys(c).forEach(l=>{let d=c[l];d&&ps(d)&&(s=d.body.start-a,r=d.body.end+a,e>=s&&e<=r&&(i=Math.min(e-s,r-e),o<=i&&(t=d.body,o=i)))}),t}isEndListAppended(e){let t=this.endListFragments[e];return t!==void 0&&(t.buffered||ps(t))}getState(e){let t=Zt(e),i=this.fragments[t];return i?i.buffered?ps(i)?xe.PARTIAL:xe.OK:xe.APPENDING:xe.NOT_LOADED}isTimeBuffered(e,t,i){let s,r;for(let o=0;o<i.length;o++){if(s=i.start(o)-this.bufferPadding,r=i.end(o)+this.bufferPadding,e>=s&&t<=r)return!0;if(t<=s)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn==="initSegment"||t.frag.bitrateTest)return;let i=t.frag,s=t.part?null:t,r=Zt(i);this.fragments[r]={body:i,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){let{frag:i,part:s,timeRanges:r,type:o}=t;if(i.sn==="initSegment")return;let a=i.type;if(s){let l=this.activePartLists[a];l||(this.activePartLists[a]=l=[]),l.push(s)}this.timeRanges=r;let c=r[o];this.detectEvictedFragments(o,c,a,s)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){let t=Zt(e);return!!this.fragments[t]}hasFragments(e){let{fragments:t}=this,i=Object.keys(t);if(!e)return i.length>0;for(let s=i.length;s--;){let r=t[i[s]];if(r?.body.type===e)return!0}return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,s,r){s&&!this.hasGaps||Object.keys(this.fragments).forEach(o=>{let a=this.fragments[o];if(!a)return;let c=a.body;c.type!==i||s&&!c.gap||c.start<t&&c.end>e&&(a.buffered||r)&&this.removeFragment(c)})}removeFragment(e){let t=Zt(e);e.clearElementaryStreamInfo();let i=this.activePartLists[e.type];if(i){let s=e.sn;this.activePartLists[e.type]=Fl(i,r=>r.fragment.sn!==s)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e,t;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;let i=(e=this.hls)==null||(t=e.latestLevelDetails)==null?void 0:t.partList;i&&i.forEach(s=>s.clearElementaryStreamInfo())}};function ps(n){var e,t,i;return n.buffered&&(n.body.gap||((e=n.range.video)==null?void 0:e.partial)||((t=n.range.audio)==null?void 0:t.partial)||((i=n.range.audiovideo)==null?void 0:i.partial))}function Zt(n){return`${n.type}_${n.level}_${n.sn}`}function Fl(n,e){return n.filter(t=>{let i=e(t);return i||t.clearElementaryStreamInfo(),i})}var Rt={cbc:0,ctr:1},Ar=class{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case Rt.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case Rt.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}};function Zu(n){let e=n.byteLength,t=e&&new DataView(n.buffer).getUint8(e-1);return t?n.slice(0,e-t):n}var Ir=class{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){let t=new DataView(e),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=t.getUint32(s*4);return i}initTable(){let e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],o=i[2],a=i[3],c=this.invSubMix,l=c[0],d=c[1],h=c[2],u=c[3],f=new Uint32Array(256),g=0,m=0,v=0;for(v=0;v<256;v++)v<128?f[v]=v<<1:f[v]=v<<1^283;for(v=0;v<256;v++){let y=m^m<<1^m<<2^m<<3^m<<4;y=y>>>8^y&255^99,e[g]=y,t[y]=g;let T=f[g],S=f[T],b=f[S],A=f[y]*257^y*16843008;s[g]=A<<24|A>>>8,r[g]=A<<16|A>>>16,o[g]=A<<8|A>>>24,a[g]=A,A=b*16843009^S*65537^T*257^g*16843008,l[y]=A<<24|A>>>8,d[y]=A<<16|A>>>16,h[y]=A<<8|A>>>24,u[y]=A,g?(g=T^f[f[f[b^T]]],m^=f[f[m]]):g=m=1}}expandKey(e){let t=this.uint8ArrayToUint32Array_(e),i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;let r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);let o=this.ksRows=(r+6+1)*4,a,c,l=this.keySchedule=new Uint32Array(o),d=this.invKeySchedule=new Uint32Array(o),h=this.sBox,u=this.rcon,f=this.invSubMix,g=f[0],m=f[1],v=f[2],y=f[3],T,S;for(a=0;a<o;a++){if(a<r){T=l[a]=t[a];continue}S=T,a%r===0?(S=S<<8|S>>>24,S=h[S>>>24]<<24|h[S>>>16&255]<<16|h[S>>>8&255]<<8|h[S&255],S^=u[a/r|0]<<24):r>6&&a%r===4&&(S=h[S>>>24]<<24|h[S>>>16&255]<<16|h[S>>>8&255]<<8|h[S&255]),l[a]=T=(l[a-r]^S)>>>0}for(c=0;c<o;c++)a=o-c,c&3?S=l[a]:S=l[a-4],c<4||a<=4?d[c]=S:d[c]=g[h[S>>>24]]^m[h[S>>>16&255]]^v[h[S>>>8&255]]^y[h[S&255]],d[c]=d[c]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){let s=this.keySize+6,r=this.invKeySchedule,o=this.invSBox,a=this.invSubMix,c=a[0],l=a[1],d=a[2],h=a[3],u=this.uint8ArrayToUint32Array_(i),f=u[0],g=u[1],m=u[2],v=u[3],y=new Int32Array(e),T=new Int32Array(y.length),S,b,A,L,I,D,w,C,P,U,q,H,K,V,j=this.networkToHostOrderSwap;for(;t<y.length;){for(P=j(y[t]),U=j(y[t+1]),q=j(y[t+2]),H=j(y[t+3]),I=P^r[0],D=H^r[1],w=q^r[2],C=U^r[3],K=4,V=1;V<s;V++)S=c[I>>>24]^l[D>>16&255]^d[w>>8&255]^h[C&255]^r[K],b=c[D>>>24]^l[w>>16&255]^d[C>>8&255]^h[I&255]^r[K+1],A=c[w>>>24]^l[C>>16&255]^d[I>>8&255]^h[D&255]^r[K+2],L=c[C>>>24]^l[I>>16&255]^d[D>>8&255]^h[w&255]^r[K+3],I=S,D=b,w=A,C=L,K=K+4;S=o[I>>>24]<<24^o[D>>16&255]<<16^o[w>>8&255]<<8^o[C&255]^r[K],b=o[D>>>24]<<24^o[w>>16&255]<<16^o[C>>8&255]<<8^o[I&255]^r[K+1],A=o[w>>>24]<<24^o[C>>16&255]<<16^o[I>>8&255]<<8^o[D&255]^r[K+2],L=o[C>>>24]<<24^o[I>>16&255]<<16^o[D>>8&255]<<8^o[w&255]^r[K+3],T[t]=j(S^f),T[t+1]=j(L^g),T[t+2]=j(A^m),T[t+3]=j(b^v),f=P,g=U,m=q,v=H,t=t+4}return T.buffer}},Cr=class{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){let e=Ju(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}};function Ju(n){switch(n){case Rt.cbc:return"AES-CBC";case Rt.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${n}`)}}var ef=16,Ui=class{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{let i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){let{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;let i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?Zu(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,s){return this.useSoftware?new Promise((r,o)=>{let a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,i,s);let c=this.flush();c?r(c.buffer):o(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,s)}softwareDecrypt(e,t,i,s){let{currentIV:r,currentResult:o,remainderData:a}=this;if(s!==Rt.cbc||t.byteLength!==16)return ce.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=qe(a,e),this.remainderData=null);let c=this.getValidChunk(e);if(!c.length)return null;r&&(i=r);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new Ir),l.expandKey(t);let d=o;return this.currentResult=l.decrypt(c.buffer,0,i),this.currentIV=c.slice(-16).buffer,d||null}webCryptoDecrypt(e,t,i,s){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,s));this.key=t,this.fastAesKey=new Cr(this.subtle,t,s)}return this.fastAesKey.expandKey().then(r=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new Ar(this.subtle,new Uint8Array(i),s).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(ce.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i,s)))}onWebCryptoError(e,t,i,s){let r=this.enableSoftwareAES;if(r){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,s);let o=this.flush();if(o)return o.buffer}throw new Error("WebCrypto"+(r?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e,i=e.length-e.length%ef;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(ce.log(`[decrypter]: ${e}`),this.logEnabled=!1)}},Nl=Math.pow(2,17),Dr=class{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){let i=e.url;if(!i)return Promise.reject(new nt({type:z.NETWORK_ERROR,details:R.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();let s=this.config,r=s.fLoader,o=s.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(g=>g[0]==="GAP")){c(Ul(e));return}else e.gap=!1;let l=this.loader=r?new r(s):new o(s),d=Bl(e);e.loader=l;let h=Ol(s.fragLoadPolicy.default),u={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:Nl};e.stats=l.stats;let f={onSuccess:(g,m,v,y)=>{this.resetLoader(e,l);let T=g.data;v.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(T.slice(0,16)),T=T.slice(16)),a({frag:e,part:null,payload:T,networkDetails:y})},onError:(g,m,v,y)=>{this.resetLoader(e,l),c(new nt({type:z.NETWORK_ERROR,details:R.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:he({url:i,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:v,stats:y}))},onAbort:(g,m,v)=>{this.resetLoader(e,l),c(new nt({type:z.NETWORK_ERROR,details:R.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:v,stats:g}))},onTimeout:(g,m,v)=>{this.resetLoader(e,l),c(new nt({type:z.NETWORK_ERROR,details:R.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:v,stats:g}))}};t&&(f.onProgress=(g,m,v,y)=>t({frag:e,part:null,payload:v,networkDetails:y})),l.load(d,u,f)})}loadPart(e,t,i){this.abort();let s=this.config,r=s.fLoader,o=s.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){c(Ul(e,t));return}let l=this.loader=r?new r(s):new o(s),d=Bl(e,t);e.loader=l;let h=Ol(s.fragLoadPolicy.default),u={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Nl};t.stats=l.stats,l.load(d,u,{onSuccess:(f,g,m,v)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);let y={frag:e,part:t,payload:f.data,networkDetails:v};i(y),a(y)},onError:(f,g,m,v)=>{this.resetLoader(e,l),c(new nt({type:z.NETWORK_ERROR,details:R.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:he({url:d.url,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:m,stats:v}))},onAbort:(f,g,m)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),c(new nt({type:z.NETWORK_ERROR,details:R.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:m,stats:f}))},onTimeout:(f,g,m)=>{this.resetLoader(e,l),c(new nt({type:z.NETWORK_ERROR,details:R.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:m,stats:f}))}})})}updateStatsFromPart(e,t){let i=e.stats,s=t.stats,r=s.total;if(i.loaded+=s.loaded,r){let c=Math.round(e.duration/t.duration),l=Math.min(Math.round(i.loaded/r),c),h=(c-l)*Math.round(i.loaded/l);i.total=i.loaded+h}else i.total=Math.max(i.loaded,i.total);let o=i.loading,a=s.loading;o.start?o.first+=a.first-a.start:(o.start=a.start,o.first=a.first),o.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}};function Bl(n,e=null){let t=e||n,i={frag:n,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},s=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(G(s)&&G(r)){var o;let a=s,c=r;if(n.sn==="initSegment"&&tf((o=n.decryptdata)==null?void 0:o.method)){let l=r-s;l%16&&(c=r+(16-l%16)),s!==0&&(i.resetIV=!0,a=s-16)}i.rangeStart=a,i.rangeEnd=c}return i}function Ul(n,e){let t=new Error(`GAP ${n.gap?"tag":"attribute"} found`),i={type:z.MEDIA_ERROR,details:R.FRAG_GAP,fatal:!1,frag:n,error:t,networkDetails:null};return e&&(i.part=e),(e||n).stats.aborted=!0,new nt(i)}function tf(n){return n==="AES-128"||n==="AES-256"}var nt=class extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}},Hs=class extends rt{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}},Vi=class{constructor(e,t,i,s=0,r=-1,o=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=ms(),this.buffering={audio:ms(),video:ms(),audiovideo:ms()},this.level=e,this.sn=t,this.id=i,this.size=s,this.part=r,this.partial=o}};function ms(){return{start:0,executeStart:0,executeEnd:0,end:0}}var Vl={length:0,start:()=>0,end:()=>0},ie=class n{static isBuffered(e,t){if(e){let i=n.getBuffered(e);for(let s=i.length;s--;)if(t>=i.start(s)&&t<=i.end(s))return!0}return!1}static bufferedRanges(e){if(e){let t=n.getBuffered(e);return n.timeRangesToArray(t)}return[]}static timeRangesToArray(e){let t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){let s=n.bufferedRanges(e);if(s.length)return n.bufferedInfo(s,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((d,h)=>d.start-h.start||h.end-d.end);let s=-1,r=[];if(i)for(let d=0;d<e.length;d++){t>=e[d].start&&t<=e[d].end&&(s=d);let h=r.length;if(h){let u=r[h-1].end;e[d].start-u<i?e[d].end>u&&(r[h-1].end=e[d].end):r.push(e[d])}else r.push(e[d])}else r=e;let o=0,a,c=t,l=t;for(let d=0;d<r.length;d++){let h=r[d].start,u=r[d].end;if(s===-1&&t>=h&&t<=u&&(s=d),t+i>=h&&t<u)c=h,l=u,o=l-t;else if(t+i<h){a=h;break}}return{len:o,start:c||0,end:l||0,nextStart:a,buffered:e,bufferedIndex:s}}static getBuffered(e){try{return e.buffered||Vl}catch(t){return ce.log("failed to get media.buffered",t),Vl}}},Wc=/\{\$([a-zA-Z0-9-_]+)\}/g;function $l(n){return Wc.test(n)}function Rr(n,e){if(n.variableList!==null||n.hasVariableRefs){let t=n.variableList;return e.replace(Wc,i=>{let s=i.substring(2,i.length-1),r=t?.[s];return r===void 0?(n.playlistParsingError||(n.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),i):r})}return e}function Gl(n,e,t){let i=n.variableList;i||(n.variableList=i={});let s,r;if("QUERYPARAM"in e){s=e.QUERYPARAM;try{let o=new self.URL(t).searchParams;if(o.has(s))r=o.get(s);else throw new Error(`"${s}" does not match any query parameter in URI: "${t}"`)}catch(o){n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${o.message}`))}}else s=e.NAME,r=e.VALUE;s in i?n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):i[s]=r||""}function sf(n,e,t){let i=e.IMPORT;if(t&&i in t){let s=n.variableList;s||(n.variableList=s={}),s[i]=t[i]}else n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}var nf=/^(\d+)x(\d+)$/,Hl=/(.+?)=(".*?"|.*?)(?:,|$)/g,ve=class n{constructor(e,t){typeof e=="string"&&(e=n.parseAttrList(e,t)),fe(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){let t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;let i=new Uint8Array(t.length/2);for(let s=0;s<t.length/2;s++)i[s]=parseInt(t.slice(s*2,s*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){let t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){let i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){let i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((s,r)=>(s[r.toLowerCase()]=!0,s),t)}bool(e){return this[e]==="YES"}decimalResolution(e){let t=nf.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i,s={},r='"';for(Hl.lastIndex=0;(i=Hl.exec(e))!==null;){let o=i[1].trim(),a=i[2],c=a.indexOf(r)===0&&a.lastIndexOf(r)===a.length-1,l=!1;if(c)a=a.slice(1,-1);else switch(o){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":l=!0}if(t&&(c||l))a=Rr(t,a);else if(!l&&!c)switch(o){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":ce.warn(`${e}: attribute ${o} is missing quotes`)}s[o]=a}return s}},rf="com.apple.hls.interstitial";function of(n){return n!=="ID"&&n!=="CLASS"&&n!=="CUE"&&n!=="START-DATE"&&n!=="DURATION"&&n!=="END-DATE"&&n!=="END-ON-NEXT"}function af(n){return n==="SCTE35-OUT"||n==="SCTE35-IN"||n==="SCTE35-CMD"}var Ks=class{constructor(e,t,i=0){var s;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=t?.tagAnchor||null,this.tagOrder=(s=t?.tagOrder)!=null?s:i,t){let r=t.attr;for(let o in r)if(Object.prototype.hasOwnProperty.call(e,o)&&e[o]!==r[o]){ce.warn(`DATERANGE tag attribute: "${o}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=o;break}e=fe(new ve({}),r,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){let r=t?.endDate||new Date(this.attr["END-DATE"]);G(r.getTime())&&(this._endDate=r)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){let e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){let{tagAnchor:e}=this;return e===null||e.programDateTime===null?(ce.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){let e=this._endDate||this._dateAtEnd;if(e)return e;let t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){let e=this.attr.decimalFloatingPoint("DURATION");if(G(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===rf}get isValid(){return!!this.id&&!this._badValueForSameId&&G(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}},lf=10,Lr=class{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}let t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}get hasProgramDateTime(){return this.fragments.length?G(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||lf}get drift(){let e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){let e=this.partList;if(e){let t=this.lastPartIndex;if(t!==-1){for(let i=e.length;i--;)if(e[i].index>t)return e[i].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){let e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}};function ri(n){return n==="AES-128"||n==="AES-256"||n==="AES-256-CTR"}function Oo(n){switch(n){case"AES-128":case"AES-256":return Rt.cbc;case"AES-256-CTR":return Rt.ctr;default:throw new Error(`invalid full segment method ${n}`)}}function Fo(n){return Uint8Array.from(atob(n),e=>e.charCodeAt(0))}function wr(n){return Uint8Array.from(unescape(encodeURIComponent(n)),e=>e.charCodeAt(0))}function cf(n){let e=wr(n).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function df(n){let e=function(i,s,r){let o=i[s];i[s]=i[r],i[r]=o};e(n,0,3),e(n,1,2),e(n,4,5),e(n,6,7)}function hf(n){let e=n.split(":"),t=null;if(e[0]==="data"&&e.length===2){let i=e[1].split(";"),s=i[i.length-1].split(",");if(s.length===2){let r=s[0]==="base64",o=s[1];r?(i.splice(-1,1),t=Fo(o)):t=cf(o)}}return t}var js=typeof self<"u"?self:void 0,ue={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Be={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Rs(n){switch(n){case Be.FAIRPLAY:return ue.FAIRPLAY;case Be.PLAYREADY:return ue.PLAYREADY;case Be.WIDEVINE:return ue.WIDEVINE;case Be.CLEARKEY:return ue.CLEARKEY}}var vs={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Jn(n){if(n===vs.WIDEVINE)return ue.WIDEVINE;if(n===vs.PLAYREADY)return ue.PLAYREADY;if(n===vs.CENC||n===vs.CLEARKEY)return ue.CLEARKEY}function ys(n){switch(n){case ue.FAIRPLAY:return Be.FAIRPLAY;case ue.PLAYREADY:return Be.PLAYREADY;case ue.WIDEVINE:return Be.WIDEVINE;case ue.CLEARKEY:return Be.CLEARKEY}}function Li(n){let{drmSystems:e,widevineLicenseUrl:t}=n,i=e?[ue.FAIRPLAY,ue.WIDEVINE,ue.PLAYREADY,ue.CLEARKEY].filter(s=>!!e[s]):[];return!i[ue.WIDEVINE]&&t&&i.push(ue.WIDEVINE),i}var Yc=function(n){return js!=null&&(n=js.navigator)!=null&&n.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function uf(n,e,t,i){let s;switch(n){case ue.FAIRPLAY:s=["cenc","sinf"];break;case ue.WIDEVINE:case ue.PLAYREADY:s=["cenc"];break;case ue.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${n}`)}return ff(s,e,t,i)}function ff(n,e,t,i){return[{initDataTypes:n,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs=${r}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs=${r}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function gf(n){var e;return n.sessionType==="persistent-license"||!!((e=n.sessionTypes)!=null&&e.some(t=>t==="persistent-license"))}function zc(n){let e=new Uint16Array(n.buffer,n.byteOffset,n.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),o=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(o){let a=o.childNodes[0]?o.childNodes[0].nodeValue:o.getAttribute("VALUE");if(a){let c=Fo(a).subarray(0,16);return df(c),c}}return null}var _s={},$i=class n{static clearKeyUriToKeyIdMap(){_s={}}constructor(e,t,i,s=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!ri(e)}isSupported(){if(this.method){if(ri(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Be.FAIRPLAY:case Be.WIDEVINE:case Be.PLAYREADY:case Be.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(ri(this.method)&&this.uri&&!this.iv){typeof e!="number"&&(ce.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);let i=pf(e);return new n(this.method,this.uri,"identity",this.keyFormatVersions,i)}let t=hf(this.uri);if(t)switch(this.keyFormat){case Be.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case Be.PLAYREADY:{let i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Du(i,null,t),this.keyId=zc(t);break}default:{let i=t.subarray(0,16);if(i.length!==16){let s=new Uint8Array(16);s.set(i,16-i.length),i=s}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=_s[this.uri];if(!i){let s=Object.keys(_s).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,s),_s[this.uri]=i}this.keyId=i}return this}};function pf(n){let e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=n>>8*(15-t)&255;return e}var Kl=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,jl=/#EXT-X-MEDIA:(.*)/g,mf=/^#EXT(?:INF|-X-TARGETDURATION):/m,er=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),vf=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),Gt=class n{static findGroup(e,t){for(let i=0;i<e.length;i++){let s=e[i];if(s.id===t)return s}}static resolve(e,t){return ko.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return mf.test(e)}static parseMasterPlaylist(e,t){let i=$l(e),s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];Kl.lastIndex=0;let o;for(;(o=Kl.exec(e))!=null;)if(o[1]){var a;let l=new ve(o[1],s),d=Rr(s,o[2]),h={attrs:l,bitrate:l.decimalInteger("BANDWIDTH")||l.decimalInteger("AVERAGE-BANDWIDTH"),name:l.NAME,url:n.resolve(d,t)},u=l.decimalResolution("RESOLUTION");u&&(h.width=u.width,h.height=u.height),zl(l.CODECS,h);let f=l["SUPPLEMENTAL-CODECS"];f&&(h.supplemental={},zl(f,h.supplemental)),(a=h.unknownCodecs)!=null&&a.length||r.push(h),s.levels.push(h)}else if(o[3]){let l=o[3],d=o[4];switch(l){case"SESSION-DATA":{let h=new ve(d,s),u=h["DATA-ID"];u&&(s.sessionData===null&&(s.sessionData={}),s.sessionData[u]=h);break}case"SESSION-KEY":{let h=Wl(d,t,s);h.encrypted&&h.isSupported()?(s.sessionKeys===null&&(s.sessionKeys=[]),s.sessionKeys.push(h)):ce.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${d}"`);break}case"DEFINE":{{let h=new ve(d,s);Gl(s,h,t)}break}case"CONTENT-STEERING":{let h=new ve(d,s);s.contentSteering={uri:n.resolve(h["SERVER-URI"],t),pathwayId:h["PATHWAY-ID"]||"."};break}case"START":{s.startTimeOffset=Yl(d);break}}}let c=r.length>0&&r.length<s.levels.length;return s.levels=c?r:s.levels,s.levels.length===0&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(e,t,i){let s,r={},o=i.levels,a={AUDIO:o.map(l=>({id:l.attrs.AUDIO,audioCodec:l.audioCodec})),SUBTITLES:o.map(l=>({id:l.attrs.SUBTITLES,textCodec:l.textCodec})),"CLOSED-CAPTIONS":[]},c=0;for(jl.lastIndex=0;(s=jl.exec(e))!==null;){let l=new ve(s[1],i),d=l.TYPE;if(d){let h=a[d],u=r[d]||[];r[d]=u;let f=l.LANGUAGE,g=l["ASSOC-LANGUAGE"],m=l.CHANNELS,v=l.CHARACTERISTICS,y=l["INSTREAM-ID"],T={attrs:l,bitrate:0,id:c++,groupId:l["GROUP-ID"]||"",name:l.NAME||f||"",type:d,default:l.bool("DEFAULT"),autoselect:l.bool("AUTOSELECT"),forced:l.bool("FORCED"),lang:f,url:l.URI?n.resolve(l.URI,t):""};if(g&&(T.assocLang=g),m&&(T.channels=m),v&&(T.characteristics=v),y&&(T.instreamId=y),h!=null&&h.length){let S=n.findGroup(h,T.groupId)||h[0];ql(T,S,"audioCodec"),ql(T,S,"textCodec")}u.push(T)}}return r}static parseLevelPlaylist(e,t,i,s,r,o){var a;let c={url:t},l=new Lr(t),d=l.fragments,h=[],u=null,f=0,g=0,m=0,v=0,y=0,T=null,S=new ki(s,c),b,A,L,I=-1,D=!1,w=null,C;if(er.lastIndex=0,l.m3u8=e,l.hasVariableRefs=$l(e),((a=er.exec(e))==null?void 0:a[0])!=="#EXTM3U")return l.playlistParsingError=new Error("Missing format identifier #EXTM3U"),l;for(;(b=er.exec(e))!==null;){D&&(D=!1,S=new ki(s,c),S.playlistOffset=m,S.start=m,S.sn=f,S.cc=v,y&&(S.bitrate=y),S.level=i,u&&(S.initSegment=u,u.rawProgramDateTime&&(S.rawProgramDateTime=u.rawProgramDateTime,u.rawProgramDateTime=null),w&&(S.setByteRange(w),w=null)));let H=b[1];if(H){S.duration=parseFloat(H);let K=(" "+b[2]).slice(1);S.title=K||null,S.tagList.push(K?["INF",H,K]:["INF",H])}else if(b[3]){if(G(S.duration)){S.playlistOffset=m,S.start=m,L&&Ql(S,L,l),S.sn=f,S.level=i,S.cc=v,d.push(S);let K=(" "+b[3]).slice(1);S.relurl=Rr(l,K),kr(S,T,h),T=S,m+=S.duration,f++,g=0,D=!0}}else{if(b=b[0].match(vf),!b){ce.warn("No matches on slow regex match for level playlist!");continue}for(A=1;A<b.length&&b[A]===void 0;A++);let K=(" "+b[A]).slice(1),V=(" "+b[A+1]).slice(1),j=b[A+2]?(" "+b[A+2]).slice(1):null;switch(K){case"BYTERANGE":T?S.setByteRange(V,T):S.setByteRange(V);break;case"PROGRAM-DATE-TIME":S.rawProgramDateTime=V,S.tagList.push(["PROGRAM-DATE-TIME",V]),I===-1&&(I=d.length);break;case"PLAYLIST-TYPE":l.type&&yt(l,K,b),l.type=V.toUpperCase();break;case"MEDIA-SEQUENCE":l.startSN!==0?yt(l,K,b):d.length>0&&Zl(l,K,b),f=l.startSN=parseInt(V);break;case"SKIP":{l.skippedSegments&&yt(l,K,b);let Y=new ve(V,l),M=Y.decimalInteger("SKIPPED-SEGMENTS");if(G(M)){l.skippedSegments+=M;for(let ee=M;ee--;)d.push(null);f+=M}let O=Y.enumeratedString("RECENTLY-REMOVED-DATERANGES");O&&(l.recentlyRemovedDateranges=(l.recentlyRemovedDateranges||[]).concat(O.split("	")));break}case"TARGETDURATION":l.targetduration!==0&&yt(l,K,b),l.targetduration=Math.max(parseInt(V),1);break;case"VERSION":l.version!==null&&yt(l,K,b),l.version=parseInt(V);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":l.live||yt(l,K,b),l.live=!1;break;case"#":(V||j)&&S.tagList.push(j?[V,j]:[V]);break;case"DISCONTINUITY":v++,S.tagList.push(["DIS"]);break;case"GAP":S.gap=!0,S.tagList.push([K]);break;case"BITRATE":S.tagList.push([K,V]),y=parseInt(V)*1e3,G(y)?S.bitrate=y:y=0;break;case"DATERANGE":{let Y=new ve(V,l),M=new Ks(Y,l.dateRanges[Y.ID],l.dateRangeTagCount);l.dateRangeTagCount++,M.isValid||l.skippedSegments?l.dateRanges[M.id]=M:ce.warn(`Ignoring invalid DATERANGE tag: "${V}"`),S.tagList.push(["EXT-X-DATERANGE",V]);break}case"DEFINE":{{let Y=new ve(V,l);"IMPORT"in Y?sf(l,Y,o):Gl(l,Y,t)}break}case"DISCONTINUITY-SEQUENCE":l.startCC!==0?yt(l,K,b):d.length>0&&Zl(l,K,b),l.startCC=v=parseInt(V);break;case"KEY":{let Y=Wl(V,t,l);if(Y.isSupported()){if(Y.method==="NONE"){L=void 0;break}L||(L={}),L[Y.keyFormat]&&(L=fe({},L)),L[Y.keyFormat]=Y}else ce.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${V}"`);break}case"START":l.startTimeOffset=Yl(V);break;case"MAP":{let Y=new ve(V,l);if(S.duration){let M=new ki(s,c);Xl(M,Y,i,L),u=M,S.initSegment=u,u.rawProgramDateTime&&!S.rawProgramDateTime&&(S.rawProgramDateTime=u.rawProgramDateTime)}else{let M=S.byteRangeEndOffset;if(M){let O=S.byteRangeStartOffset;w=`${M-O}@${O}`}else w=null;Xl(S,Y,i,L),u=S,D=!0}u.cc=v;break}case"SERVER-CONTROL":{C&&yt(l,K,b),C=new ve(V),l.canBlockReload=C.bool("CAN-BLOCK-RELOAD"),l.canSkipUntil=C.optionalFloat("CAN-SKIP-UNTIL",0),l.canSkipDateRanges=l.canSkipUntil>0&&C.bool("CAN-SKIP-DATERANGES"),l.partHoldBack=C.optionalFloat("PART-HOLD-BACK",0),l.holdBack=C.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{l.partTarget&&yt(l,K,b);let Y=new ve(V);l.partTarget=Y.decimalFloatingPoint("PART-TARGET");break}case"PART":{let Y=l.partList;Y||(Y=l.partList=[]);let M=g>0?Y[Y.length-1]:void 0,O=g++,ee=new ve(V,l),Z=new _r(ee,S,c,O,M);Y.push(Z),S.duration+=Z.duration;break}case"PRELOAD-HINT":{let Y=new ve(V,l);l.preloadHint=Y;break}case"RENDITION-REPORT":{let Y=new ve(V,l);l.renditionReports=l.renditionReports||[],l.renditionReports.push(Y);break}default:ce.warn(`line parsed but not handled: ${b}`);break}}}T&&!T.relurl?(d.pop(),m-=T.duration,l.partList&&(l.fragmentHint=T)):l.partList&&(kr(S,T,h),S.cc=v,l.fragmentHint=S,L&&Ql(S,L,l)),l.targetduration||(l.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));let P=d.length,U=d[0],q=d[P-1];if(m+=l.skippedSegments*l.targetduration,m>0&&P&&q){l.averagetargetduration=m/P;let H=q.sn;l.endSN=H!=="initSegment"?H:0,l.live||(q.endList=!0),U&&l.startCC===void 0&&(l.startCC=U.cc),I>0&&(_f(d,I),U&&h.unshift(U))}else l.endSN=0,l.startCC=0;return l.fragmentHint&&(m+=l.fragmentHint.duration),l.totalduration=m,h.length&&l.dateRangeTagCount&&U&&qc(h,l),l.endCC=v,l}};function qc(n,e){let t=n.length;if(!t)return;let i=n[t-1],s=e.live?1/0:e.totalduration,r=Object.keys(e.dateRanges);for(let o=r.length;o--;){let a=e.dateRanges[r[o]],c=a.startDate.getTime();a.tagAnchor=i.ref;for(let l=t;l--;){let d=yf(e,c,n,l,s);if(d!==-1){a.tagAnchor=e.fragments[d].ref;break}}}}function yf(n,e,t,i,s){let r=t[i];if(r){let a=r.programDateTime;if(e>=a||i===0){var o;let c=(((o=t[i+1])==null?void 0:o.start)||s)-r.start;if(e<=a+c*1e3){let l=t[i].sn-n.startSN,d=n.fragments;if(d.length>t.length){let u=(t[i+1]||d[d.length-1]).sn-n.startSN;for(let f=u;f>l;f--){let g=d[f].programDateTime;if(e>=g&&e<g+d[f].duration*1e3)return f}}return l}}}return-1}function Wl(n,e,t){var i,s;let r=new ve(n,t),o=(i=r.METHOD)!=null?i:"",a=r.URI,c=r.hexadecimalInteger("IV"),l=r.KEYFORMATVERSIONS,d=(s=r.KEYFORMAT)!=null?s:"identity";a&&r.IV&&!c&&ce.error(`Invalid IV: ${r.IV}`);let h=a?Gt.resolve(a,e):"",u=(l||"1").split("/").map(Number).filter(Number.isFinite);return new $i(o,h,d,u,c)}function Yl(n){let t=new ve(n).decimalFloatingPoint("TIME-OFFSET");return G(t)?t:null}function zl(n,e){let t=(n||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{let s=t.filter(r=>Nc(r,i));s.length&&(e[`${i}Codec`]=s.map(r=>r.split("/")[0]).join(","),t=t.filter(r=>s.indexOf(r)===-1))}),e.unknownCodecs=t}function ql(n,e,t){let i=e[t];i&&(n[t]=i)}function _f(n,e){let t=n[e];for(let i=e;i--;){let s=n[i];if(!s)return;s.programDateTime=t.programDateTime-s.duration*1e3,t=s}}function kr(n,e,t){n.rawProgramDateTime?t.push(n):e!=null&&e.programDateTime&&(n.programDateTime=e.endProgramDateTime)}function Xl(n,e,t,i){n.relurl=e.URI,e.BYTERANGE&&n.setByteRange(e.BYTERANGE),n.level=t,n.sn="initSegment",i&&(n.levelkeys=i),n.initSegment=null}function Ql(n,e,t){n.levelkeys=e;let{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(s=>e[s].isCommonEncryption)&&i.push(n)}function yt(n,e,t){n.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${t[0]})`)}function Zl(n,e,t){n.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${t[0]})`)}function tr(n,e){let t=e.startPTS;if(G(t)){let i=0,s;e.sn>n.sn?(i=t-n.start,s=n):(i=n.start-t,s=e),s.duration!==i&&s.setDuration(i)}else e.sn>n.sn?n.cc===e.cc&&n.minEndPTS?e.setStart(n.start+(n.minEndPTS-n.start)):e.setStart(n.start+n.duration):e.setStart(Math.max(n.start-e.duration,0))}function Xc(n,e,t,i,s,r){i-t<=0&&(ce.warn("Fragment should have a positive duration",e),i=t+e.duration,r=s+e.duration);let a=t,c=i,l=e.startPTS,d=e.endPTS;if(G(l)){let v=Math.abs(l-t);G(e.deltaPTS)?e.deltaPTS=Math.max(v,e.deltaPTS):e.deltaPTS=v,a=Math.max(t,l),t=Math.min(t,l),s=Math.min(s,e.startDTS),c=Math.min(i,d),i=Math.max(i,d),r=Math.max(r,e.endDTS)}let h=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=a,e.startDTS=s,e.endPTS=i,e.minEndPTS=c,e.endDTS=r;let u=e.sn;if(!n||u<n.startSN||u>n.endSN)return 0;let f,g=u-n.startSN,m=n.fragments;for(m[g]=e,f=g;f>0;f--)tr(m[f],m[f-1]);for(f=g;f<m.length-1;f++)tr(m[f],m[f+1]);return n.fragmentHint&&tr(m[m.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,h}function Ef(n,e){if(n===e)return;let t=null,i=n.fragments;for(let l=i.length-1;l>=0;l--){let d=i[l].initSegment;if(d){t=d;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;let s;Tf(n,e,(l,d,h,u)=>{if((!e.startCC||e.skippedSegments)&&d.cc!==l.cc){let f=l.cc-d.cc;for(let g=h;g<u.length;g++)u[g].cc+=f;e.endCC=u[u.length-1].cc}G(l.startPTS)&&G(l.endPTS)&&(d.setStart(d.startPTS=l.startPTS),d.startDTS=l.startDTS,d.maxStartPTS=l.maxStartPTS,d.endPTS=l.endPTS,d.endDTS=l.endDTS,d.minEndPTS=l.minEndPTS,d.setDuration(l.endPTS-l.startPTS),d.duration&&(s=d),e.PTSKnown=e.alignedSliding=!0),l.hasStreams&&(d.elementaryStreams=l.elementaryStreams),d.loader=l.loader,l.hasStats&&(d.stats=l.stats),l.initSegment&&(d.initSegment=l.initSegment,t=l.initSegment)});let r=e.fragments,o=e.fragmentHint?r.concat(e.fragmentHint):r;if(t&&o.forEach(l=>{var d;l&&(!l.initSegment||l.initSegment.relurl===((d=t)==null?void 0:d.relurl))&&(l.initSegment=t)}),e.skippedSegments){if(e.deltaUpdateFailed=r.some(l=>!l),e.deltaUpdateFailed){ce.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=e.skippedSegments;l--;)r.shift();e.startSN=r[0].sn}else{e.canSkipDateRanges&&(e.dateRanges=Sf(n.dateRanges,e));let l=n.fragments.filter(d=>d.rawProgramDateTime);if(n.hasProgramDateTime&&!e.hasProgramDateTime)for(let d=1;d<o.length;d++)o[d].programDateTime===null&&kr(o[d],o[d-1],l);qc(l,e)}e.endCC=r[r.length-1].cc}if(!e.startCC){var a;let l=Jc(n,e.startSN-1);e.startCC=(a=l?.cc)!=null?a:r[0].cc}xf(n.partList,e.partList,(l,d)=>{d.elementaryStreams=l.elementaryStreams,d.stats=l.stats}),s?Xc(e,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):Qc(n,e),r.length&&(e.totalduration=e.edge-r[0].start),e.driftStartTime=n.driftStartTime,e.driftStart=n.driftStart;let c=e.advancedDateTime;if(e.advanced&&c){let l=e.edge;e.driftStart||(e.driftStartTime=c,e.driftStart=l),e.driftEndTime=c,e.driftEnd=l}else e.driftEndTime=n.driftEndTime,e.driftEnd=n.driftEnd,e.advancedDateTime=n.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=n.requestScheduled)}function Sf(n,e){let{dateRanges:t,recentlyRemovedDateranges:i}=e,s=fe({},n);i&&i.forEach(a=>{delete s[a]});let o=Object.keys(s).length;return o&&Object.keys(t).forEach(a=>{let c=s[a],l=new Ks(t[a].attr,c);l.isValid?(s[a]=l,c||(l.tagOrder+=o)):ce.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${me(t[a].attr)}"`)}),s}function xf(n,e,t){if(n&&e){let i=0;for(let s=0,r=n.length;s<=r;s++){let o=n[s],a=e[s+i];o&&a&&o.index===a.index&&o.fragment.sn===a.fragment.sn?t(o,a):i--}}}function Tf(n,e,t){let i=e.skippedSegments,s=Math.max(n.startSN,e.startSN)-e.startSN,r=(n.fragmentHint?1:0)+(i?e.endSN:Math.min(n.endSN,e.endSN))-e.startSN,o=e.startSN-n.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,c=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments;for(let l=s;l<=r;l++){let d=c[o+l],h=a[l];if(i&&!h&&d&&(h=e.fragments[l]=d),d&&h){if(t(d,h,l,a),d.url&&d.url!==h.url){e.playlistParsingError=Jl(`media sequence mismatch ${h.sn}:`,n,e,d,h);return}else if(d.cc!==h.cc){e.playlistParsingError=Jl(`discontinuity sequence mismatch (${d.cc}!=${h.cc})`,n,e,d,h);return}}}}function Jl(n,e,t,i,s){return new Error(`${n} ${s.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function Qc(n,e,t=!0){let i=e.startSN+e.skippedSegments-n.startSN,s=n.fragments,r=i>=0,o=0;if(r&&i<s.length)o=s[i].start;else if(r&&e.startSN===n.endSN+1)o=n.fragmentEnd;else if(r&&t)o=n.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)o=n.fragmentStart;else return;Pr(e,o)}function Pr(n,e){if(e){let t=n.fragments;for(let i=n.skippedSegments;i<t.length;i++)t[i].addStart(e);n.fragmentHint&&n.fragmentHint.addStart(e)}}function Zc(n,e=1/0){let t=1e3*n.targetduration;if(n.updated){let i=n.fragments;if(i.length&&t*4>e){let r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function Jc(n,e,t){if(!n)return null;let i=n.fragments[e-n.startSN];return i||(i=n.fragmentHint,i&&i.sn===e)?i:e<n.startSN&&t&&t.sn===e?t:null}function ec(n,e,t){return n?ed(n.partList,e,t):null}function ed(n,e,t){if(n)for(let i=n.length;i--;){let s=n[i];if(s.index===t&&s.fragment.sn===e)return s}return null}function td(n){n.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(s=>{s.level=t,s.initSegment&&(s.initSegment.level=t)})})}function Pi(n,e){for(let i=0,s=n.length;i<s;i++){var t;if(((t=n[i])==null?void 0:t.cc)===e)return n[i]}return null}function bf(n,e){return!!(n&&e.startCC<n.endCC&&e.endCC>n.startCC)}function tc(n,e){if(n){let t=n.start+e;n.start=n.startPTS=t,n.endPTS=t+n.duration}}function id(n,e){let t=e.fragments;for(let i=0,s=t.length;i<s;i++)tc(t[i],n);e.fragmentHint&&tc(e.fragmentHint,n),e.alignedSliding=!0}function Af(n,e){n&&(sd(e,n),!e.alignedSliding&&n&&Ws(e,n),!e.alignedSliding&&n&&!e.skippedSegments&&Qc(n,e,!1))}function sd(n,e){if(!bf(e,n))return;let t=Math.min(e.endCC,n.endCC),i=Pi(e.fragments,t),s=Pi(n.fragments,t);if(!i||!s)return;ce.log(`Aligning playlist at start of dicontinuity sequence ${t}`);let r=i.start-s.start;id(r,n)}function Ws(n,e){if(!n.hasProgramDateTime||!e.hasProgramDateTime)return;let t=n.fragments,i=e.fragments;if(!t.length||!i.length)return;let s,r,o=Math.min(e.endCC,n.endCC);e.startCC<o&&n.startCC<o&&(s=Pi(i,o),r=Pi(t,o)),(!s||!r)&&(s=i[Math.floor(i.length/2)],r=Pi(t,s.cc)||t[Math.floor(t.length/2)]);let a=s.programDateTime,c=r.programDateTime;if(!a||!c)return;let l=(c-a)/1e3-(r.start-s.start);id(l,n)}var If={toString:function(n){let e="",t=n.length;for(let i=0;i<t;i++)e+=`[${n.start(i).toFixed(3)}-${n.end(i).toFixed(3)}]`;return e}},k={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},Gi=class extends Hs{constructor(e,t,i,s,r){super(s,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=k.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{let{config:o,fragCurrent:a,media:c,mediaBuffer:l,state:d}=this,h=c?c.currentTime:0,u=ie.bufferInfo(l||c,h,o.maxBufferHole);if(this.log(`media seeking to ${G(h)?h.toFixed(3):h}, state: ${d}`),this.state===k.ENDED)this.resetLoadingState();else if(a){let f=o.maxFragLookUpTolerance,g=a.start-f,m=a.start+a.duration+f;if(!u.len||m<u.start||g>u.end){let v=h>m;(h<g||v)&&(v&&a.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(c){this.fragmentTracker.removeFragmentsInRange(h,1/0,this.playlistType,!0);let f=this.lastCurrentTime;if(h>f&&(this.lastCurrentTime=h),!this.loadingParts){let g=Math.max(u.end,h),m=this.shouldLoadParts(this.getLevelDetails(),g);m&&(this.log(`LL-Part loading ON after seeking to ${h.toFixed(2)} with buffer @${g.toFixed(2)}`),this.loadingParts=m)}}!this.hls.hasEnoughToStart&&!u.len&&(this.log(`setting startPosition to ${h} because of seek before start`),this.nextLoadPosition=this.startPosition=h),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=r,this.hls=e,this.fragmentLoader=new Dr(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Ui(e.config)}registerListeners(){let{hls:e}=this;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===k.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);let e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=k.STOPPED}get startPositionValue(){let{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;let i=e.end||0,s=this.config.timelineOffset||0;if(i<=s)return!1;let r=e.buffered;this.config.maxBufferHole&&r&&r.length>1&&(e=ie.bufferedInfo(r,e.start,0));let o=e.nextStart;if(o&&o>s&&o<t.edge||this.media.currentTime<e.start)return!1;let c=t.partList;if(c!=null&&c.length){let d=c[c.length-1];return ie.isBuffered(this.media,d.start+d.duration/2)}let l=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(l)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}get timelineOffset(){let e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){let i=this.media=this.mediaBuffer=t.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);let s=this.config;this.levels&&s.autoStartLoad&&this.state===k.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(e,t){let i=!!t.transferMedia,s=this.media;if(s!==null){if(s.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),s.removeEventListener("seeking",this.onMediaSeeking),s.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=k.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){let s=r=>{let o=r.frag;if(this.fragContextChanged(o)){this.warn(`${o.type} sn: ${o.sn}${r.part?" part: "+r.part.index:""} of ${this.fragInfo(o,!1,r.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(o);return}o.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,s).then(r=>{if(!r)return;let o=this.state,a=r.frag;if(this.fragContextChanged(a)){(o===k.FRAG_LOADING||!this.fragCurrent&&o===k.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=k.IDLE);return}"payload"in r&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(p.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===k.STOPPED||this.state===k.ERROR||(this.warn(`Frag error: ${r?.message||r}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;let{fragmentTracker:i}=this;if(i.getState(e)===xe.APPENDING){let r=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,r),a=Math.max(e.duration,o?o.len:this.config.maxBufferLength),c=this.backtrackFragment;((c?e.sn-c.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===xe.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){let t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){let t=e.details;return t?.live&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;let s={startOffset:e,endOffset:t,type:i};this.hls.trigger(p.BUFFER_FLUSHING,s)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{let s=i?.frag;if(!s||this.fragContextChanged(s)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{let{hls:s}=this,{frag:r,payload:o}=i,a=r.decryptdata;if(o&&o.byteLength>0&&a!=null&&a.key&&a.iv&&ri(a.method)){let c=self.performance.now();return this.decrypter.decrypt(new Uint8Array(o),a.key.buffer,a.iv.buffer,Oo(a.method)).catch(l=>{throw s.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:r}),l}).then(l=>{let d=self.performance.now();return s.trigger(p.FRAG_DECRYPTED,{frag:r,payload:l,stats:{tstart:c,tdecrypt:d}}),i.payload=l,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===k.STOPPED||this.state===k.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){let{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");let i=e.frag.stats;this.state!==k.STOPPED&&(this.state=k.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){let{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){let i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?If.toString(ie.getBuffered(i)):"(detached)"})`),Ce(e)){var s;if(e.type!==W.SUBTITLE){let o=e.elementaryStreams;if(!Object.keys(o).some(a=>!!o[a])){this.state=k.IDLE;return}}let r=(s=this.levels)==null?void 0:s[e.level];r!=null&&r.fragmentError&&(this.log(`Resetting level fragment error count of ${r.fragmentError} on frag buffered`),r.fragmentError=0)}this.state=k.IDLE}_handleFragmentLoadComplete(e){let{transmuxer:t}=this;if(!t)return;let{frag:i,part:s,partsLoaded:r}=e,o=!r||r.length===0||r.some(c=>!c),a=new Vi(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!o);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,s){var r;this.fragCurrent=e;let o=t?.details;if(!this.levels||!o)throw new Error(`frag load aborted, missing level${o?"":" detail"}s`);let a=null;e.encrypted&&!((r=e.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=k.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(h=>{if(!this.fragContextChanged(h.frag))return this.hls.trigger(p.KEY_LOADED,h),this.state===k.KEY_LOADING&&(this.state=k.IDLE),h}),this.hls.trigger(p.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):e.encrypted||(a=this.keyLoader.loadClear(e,o.encryptedFragments),a&&this.log("[eme] blocking frag load until media-keys acquired"));let c=this.fragPrevious;if(Ce(e)&&(!c||e.sn!==c.sn)){let h=this.shouldLoadParts(t.details,e.end);h!==this.loadingParts&&(this.log(`LL-Part loading ${h?"ON":"OFF"} loading sn ${c?.sn}->${e.sn}`),this.loadingParts=h)}if(i=Math.max(e.start,i||0),this.loadingParts&&Ce(e)){let h=o.partList;if(h&&s){i>e.end&&o.fragmentHint&&(e=o.fragmentHint);let u=this.getNextPart(h,e,i);if(u>-1){let f=h[u];e=this.fragCurrent=f.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${f.index} (${u}/${h.length-1}) of ${this.fragInfo(e,!1,f)}) cc: ${e.cc} [${o.startSN}-${o.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=f.start+f.duration,this.state=k.FRAG_LOADING;let g;return a?g=a.then(m=>!m||this.fragContextChanged(m.frag)?null:this.doFragPartsLoad(e,f,t,s)).catch(m=>this.handleFragLoadError(m)):g=this.doFragPartsLoad(e,f,t,s).catch(m=>this.handleFragLoadError(m)),this.hls.trigger(p.FRAG_LOADING,{frag:e,part:f,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!e.url||this.loadedEndOfParts(h,i))return Promise.resolve(null)}}if(Ce(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${o?"["+o.startSN+"-"+o.endSN+"]":""}, target: ${parseFloat(i.toFixed(3))}`),G(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=k.FRAG_LOADING;let l=this.config.progressive,d;return l&&a?d=a.then(h=>!h||this.fragContextChanged(h?.frag)?null:this.fragmentLoader.load(e,s)).catch(h=>this.handleFragLoadError(h)):d=Promise.all([this.fragmentLoader.load(e,l?s:void 0),a]).then(([h])=>(!l&&h&&s&&s(h),h)).catch(h=>this.handleFragLoadError(h)),this.hls.trigger(p.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):d}doFragPartsLoad(e,t,i,s){return new Promise((r,o)=>{var a;let c=[],l=(a=i.details)==null?void 0:a.partList,d=h=>{this.fragmentLoader.loadPart(e,h,s).then(u=>{c[h.index]=u;let f=u.part;this.hls.trigger(p.FRAG_LOADED,u);let g=ec(i.details,e.sn,h.index+1)||ed(l,e.sn,h.index+1);if(g)d(g);else return r({frag:e,part:f,partsLoaded:c})}).catch(o)};d(t)})}handleFragLoadError(e){if("data"in e){let t=e.data;e.data&&t.details===R.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(p.ERROR,t)}else this.hls.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){let t=this.getCurrentContext(e);if(!t||this.state!==k.PARSING){!this.fragCurrent&&this.state!==k.STOPPED&&this.state!==k.ERROR&&(this.state=k.IDLE);return}let{frag:i,part:s,level:r}=t,o=self.performance.now();i.stats.parsing.end=o,s&&(s.stats.parsing.end=o);let a=this.getLevelDetails(),l=a&&i.sn>a.endSN||this.shouldLoadParts(a,i.end);l!==this.loadingParts&&(this.log(`LL-Part loading ${l?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=l),this.updateLevelTiming(i,s,r,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e!=null&&e.partList){var i;let r=e.partList[0],o=r.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=o){var s;if((this.hls.hasEnoughToStart?((s=this.media)==null?void 0:s.currentTime)||this.lastCurrentTime:this.getLoadPosition())>r.start-r.fragment.duration)return!0}}}return!1}getCurrentContext(e){let{levels:t,fragCurrent:i}=this,{level:s,sn:r,part:o}=e;if(!(t!=null&&t[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of ${this.playlistLabel()} ${s}. The current chunk will not be buffered.`),null;let a=t[s],c=a.details,l=o>-1?ec(c,r,o):null,d=l?l.fragment:Jc(c,r,i);return d?(i&&i!==d&&(d.stats=i.stats),{frag:d,part:l,level:a}):null}bufferFragmentData(e,t,i,s,r){var o;if(!e||this.state!==k.PARSING)return;let{data1:a,data2:c}=e,l=a;if(a&&c&&(l=qe(a,c)),!((o=l)!=null&&o.length))return;let d={type:e.type,frag:t,part:i,chunkMeta:s,parent:t.type,data:l};if(this.hls.trigger(p.BUFFER_APPENDING,d),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){let t=this.media;if(!t)return;if(!ie.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}let i=t.currentTime,s=ie.bufferInfo(t,i,0),r=e.duration,o=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),a=Math.max(Math.min(e.start-o,s.end-o),i+o);e.start-a>o&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var i;let s=this.getLoadPosition();if(!G(s))return null;let o=this.lastCurrentTime>s||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,s,t,o)}getFwdBufferInfoAtPos(e,t,i,s){let r=ie.bufferInfo(e,t,s);if(r.len===0&&r.nextStart!==void 0){let o=this.fragmentTracker.getBufferedFrag(t,i);if(o&&(r.nextStart<=o.end||o.gap)){let a=Math.max(Math.min(r.nextStart,o.end)-t,s);return ie.bufferInfo(e,t,a)}}return r}getMaxBufferLength(e){let{config:t}=this,i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){let i=this.config,s=Math.max(Math.min(e-t,i.maxBufferLength),t),r=Math.max(e-t*3,i.maxMaxBufferLength/2,s);return r>=s?(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0):!1}getAppendedFrag(e,t=W.MAIN){var i;let s=(i=this.fragmentTracker)==null?void 0:i.getAppendedFrag(e,t);return s&&"fragment"in s?s.fragment:s}getNextFragment(e,t){let i=t.fragments,s=i.length;if(!s)return null;let{config:r}=this,o=i[0].start,a=r.lowLatencyMode&&!!t.partList,c=null;if(t.live){let h=r.initialLiveManifestSize;if(s<h)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${h})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<o){var l;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),c=this.getInitialLiveFragment(t);let u=this.hls.startPosition,f=this.hls.liveSyncPosition,g=c?(u!==-1&&u>=o?u:f)||c.start:e;this.log(`Setting startPosition to ${g} to match start frag at live edge. mainStart: ${u} liveSyncPosition: ${f} frag.start: ${(l=c)==null?void 0:l.start}`),this.startPosition=this.nextLoadPosition=g}}else e<=o&&(c=i[0]);if(!c){let h=this.loadingParts?t.partEnd:t.fragmentEnd;c=this.getFragmentAtPosition(e,h,t)}let d=this.filterReplacedPrimary(c,t);if(!d&&c){let h=c.sn-t.startSN;d=this.filterReplacedPrimary(i[h+1]||null,t)}return this.mapToInitFragWhenRequired(d)}isLoopLoading(e,t){let i=this.fragmentTracker.getState(e);return(i===xe.OK||i===xe.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,s,r){let o=null;if(e.gap&&(o=this.getNextFragment(this.nextLoadPosition,t),o&&!o.gap&&i.nextStart)){let a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s,0);if(a!==null&&i.len+a.len>=r){let c=o.sn;return this.loopSn!==c&&(this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${c}`),this.loopSn=c),null}}return this.loopSn=void 0,o}get primaryPrefetch(){if(ic(this.hls.config)){var e,t;if((e=this.hls.interstitialsManager)==null||(t=e.playingItem)==null?void 0:t.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(ic(this.hls.config)&&e.type!==W.SUBTITLE){let i=this.hls.interstitialsManager,s=i?.bufferingItem;if(s){let o=s.event;if(o){if(o.appendInPlace||Math.abs(e.start-s.start)>1||s.start===0)return null}else if(e.end<=s.start&&t?.live===!1||e.start>s.end&&s.nextEvent&&(s.nextEvent.appendInPlace||e.start-s.end>1))return null}let r=i?.playerQueue;if(r)for(let o=r.length;o--;){let a=r[o].interstitial;if(a.appendInPlace&&e.start>=a.startTime&&e.end<=a.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let s=-1,r=!1,o=!0;for(let a=0,c=e.length;a<c;a++){let l=e[a];if(o=o&&!l.independent,s>-1&&i<l.start)break;let d=l.loaded;d?s=-1:(r||l.independent||o)&&l.fragment===t&&(s=a),r=d}return s}loadedEndOfParts(e,t){let i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e){let t=e.fragments,i=this.fragPrevious,s=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=zu(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){let r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){let o=t[r-e.startSN];i.cc===o.cc&&(s=o,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=jc(e,i.cc,i.end),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{let r=this.hls.liveSyncPosition;r!==null&&(s=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s}getFragmentAtPosition(e,t,i){let{config:s}=this,{fragPrevious:r}=this,{fragments:o,endSN:a}=i,{fragmentHint:c}=i,{maxFragLookUpTolerance:l}=s,d=i.partList,h=!!(this.loadingParts&&d!=null&&d.length&&c);h&&c&&!this.bitrateTest&&d[d.length-1].fragment.sn===c.sn&&(o=o.concat(c),a=c.sn);let u;if(e<t){var f;let m=e<this.lastCurrentTime||e>t-l||(f=this.media)!=null&&f.paused||!this.startFragRequested?0:l;u=Wt(r,o,e,m)}else u=o[o.length-1];if(u){let g=u.sn-i.startSN,m=this.fragmentTracker.getState(u);if((m===xe.OK||m===xe.PARTIAL&&u.gap)&&(r=u),r&&u.sn===r.sn&&(!h||d[0].fragment.sn>u.sn||!i.live&&!h)&&r&&u.level===r.level){let y=o[g+1];u.sn<a&&this.fragmentTracker.getState(y)!==xe.OK?u=y:u=null}}return u}alignPlaylists(e,t,i){let s=e.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;let r=e.fragmentStart,o=!t,a=e.alignedSliding&&G(r);if(o||!a&&!r){Af(i,e);let c=e.fragmentStart;return this.log(`Live playlist sliding: ${c.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${s}`),c}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);let s=this.timelineOffset;if(i===-1){let r=this.startTimeOffset!==null,o=r?this.startTimeOffset:e.startTimeOffset;o!==null&&G(o)?(i=t+o,o<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${o} found in ${r?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+s}this.nextLoadPosition=i+s}getLoadPosition(){var e;let{media:t}=this,i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&Ce(e)&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==k.FRAG_LOADING_WAITING_RETRY)&&(this.state=k.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){let g=this.getCurrentContext(t.chunkMeta);g&&(t.frag=g.frag)}let i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var s;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}let r=t.details===R.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);let o=t.errorAction,{action:a,flags:c,retryCount:l=0,retryConfig:d}=o||{},h=!!o&&!!d,u=h&&a===De.RetryRequest,f=h&&!o.resolved&&c===st.MoveAllAlternatesMatchingHost;if(!u&&f&&Ce(i)&&!i.endList)this.resetFragmentErrors(e),this.treatAsGap(i),o.resolved=!0;else if((u||f)&&l<d.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);let g=Mo(d,l);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${l+1}/${d.maxNumRetry} in ${g}ms`),o.resolved=!0,this.retryDate=self.performance.now()+g,this.state=k.FRAG_LOADING_WAITING_RETRY}else if(d&&o)if(this.resetFragmentErrors(e),l<d.maxNumRetry)!r&&a!==De.RemoveAlternatePermanently&&(o.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${l})`);return}else a===De.SendAlternateToPenaltyBox?this.state=k.WAITING_LEVEL:this.state=k.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===k.PARSING||this.state===k.PARSED){let t=e.frag,i=e.parent,s=this.getFwdBufferInfo(this.mediaBuffer,i),r=s&&s.len>.5;r&&this.reduceMaxBufferLength(s.len,t?.duration||10);let o=!r;return o&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),o}return!1}resetFragmentErrors(e){e===W.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==k.STOPPED&&(this.state=k.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;let s=ie.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===k.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==k.STOPPED&&(this.state=k.IDLE)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;let t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,s){let r=i.details;if(!r){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((c,l)=>{let d=e.elementaryStreams[l];if(d){let h=d.endPTS-d.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${e.sn} ${l} duration reliably (${h})`),c||!1;let u=s?0:Xc(r,e,d.startPTS,d.endPTS,d.startDTS,d.endDTS);return this.hls.trigger(p.LEVEL_PTS_UPDATED,{details:r,level:i,drift:u,type:l,frag:e,start:d.startPTS,end:d.endPTS}),!0}return c},!1)){var a;if(i.fragmentError===0&&this.treatAsGap(e,i),((a=this.transmuxer)==null?void 0:a.error)===null){let c=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(c.message),this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.FRAG_PARSING_ERROR,fatal:!1,error:c,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=k.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(p.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===W.MAIN?"level":"track"}fragInfo(e,t=!0,i){var s,r;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((s=t&&!i?e.startPTS:(i||e).start)!=null?s:NaN).toFixed(3)}-${((r=t&&!i?e.endPTS:(i||e).end)!=null?r:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){let t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}};function ic(n){return!!n.interstitialsController&&n.enableInterstitialPlayback!==!1}var Ys=class{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){let{chunks:e,dataLength:t}=this,i;if(e.length)e.length===1?i=e[0]:i=Cf(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}};function Cf(n,e){let t=new Uint8Array(e),i=0;for(let s=0;s<n.length;s++){let r=n[s];t.set(r,i),i+=r.length}return t}var ir={exports:{}},sc;function Df(){return sc||(sc=1,function(n){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function s(c,l,d){this.fn=c,this.context=l,this.once=d||!1}function r(c,l,d,h,u){if(typeof d!="function")throw new TypeError("The listener must be a function");var f=new s(d,h||c,u),g=t?t+l:l;return c._events[g]?c._events[g].fn?c._events[g]=[c._events[g],f]:c._events[g].push(f):(c._events[g]=f,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new i:delete c._events[l]}function a(){this._events=new i,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],d,h;if(this._eventsCount===0)return l;for(h in d=this._events)e.call(d,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(d)):l},a.prototype.listeners=function(l){var d=t?t+l:l,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var u=0,f=h.length,g=new Array(f);u<f;u++)g[u]=h[u].fn;return g},a.prototype.listenerCount=function(l){var d=t?t+l:l,h=this._events[d];return h?h.fn?1:h.length:0},a.prototype.emit=function(l,d,h,u,f,g){var m=t?t+l:l;if(!this._events[m])return!1;var v=this._events[m],y=arguments.length,T,S;if(v.fn){switch(v.once&&this.removeListener(l,v.fn,void 0,!0),y){case 1:return v.fn.call(v.context),!0;case 2:return v.fn.call(v.context,d),!0;case 3:return v.fn.call(v.context,d,h),!0;case 4:return v.fn.call(v.context,d,h,u),!0;case 5:return v.fn.call(v.context,d,h,u,f),!0;case 6:return v.fn.call(v.context,d,h,u,f,g),!0}for(S=1,T=new Array(y-1);S<y;S++)T[S-1]=arguments[S];v.fn.apply(v.context,T)}else{var b=v.length,A;for(S=0;S<b;S++)switch(v[S].once&&this.removeListener(l,v[S].fn,void 0,!0),y){case 1:v[S].fn.call(v[S].context);break;case 2:v[S].fn.call(v[S].context,d);break;case 3:v[S].fn.call(v[S].context,d,h);break;case 4:v[S].fn.call(v[S].context,d,h,u);break;default:if(!T)for(A=1,T=new Array(y-1);A<y;A++)T[A-1]=arguments[A];v[S].fn.apply(v[S].context,T)}}return!0},a.prototype.on=function(l,d,h){return r(this,l,d,h,!1)},a.prototype.once=function(l,d,h){return r(this,l,d,h,!0)},a.prototype.removeListener=function(l,d,h,u){var f=t?t+l:l;if(!this._events[f])return this;if(!d)return o(this,f),this;var g=this._events[f];if(g.fn)g.fn===d&&(!u||g.once)&&(!h||g.context===h)&&o(this,f);else{for(var m=0,v=[],y=g.length;m<y;m++)(g[m].fn!==d||u&&!g[m].once||h&&g[m].context!==h)&&v.push(g[m]);v.length?this._events[f]=v.length===1?v[0]:v:o(this,f)}return this},a.prototype.removeAllListeners=function(l){var d;return l?(d=t?t+l:l,this._events[d]&&o(this,d)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,n.exports=a}(ir)),ir.exports}var Rf=Df(),No=fu(Rf),Hi="1.6.5",ci={};function Lf(){return typeof __HLS_WORKER_BUNDLE__=="function"}function wf(){let n=ci[Hi];if(n)return n.clientCount++,n;let e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),s={worker:new self.Worker(t),objectURL:t,clientCount:1};return ci[Hi]=s,s}function kf(n){let e=ci[n];if(e)return e.clientCount++,e;let t=new self.URL(n,self.location.href).href,s={worker:new self.Worker(t),scriptURL:t,clientCount:1};return ci[n]=s,s}function Pf(n){let e=ci[n||Hi];if(e&&e.clientCount--===1){let{worker:i,objectURL:s}=e;delete ci[n||Hi],s&&self.URL.revokeObjectURL(s),i.terminate()}}function nd(n,e){return e+10<=n.length&&n[e]===51&&n[e+1]===68&&n[e+2]===73&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128}function Bo(n,e){return e+10<=n.length&&n[e]===73&&n[e+1]===68&&n[e+2]===51&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128}function cn(n,e){let t=0;return t=(n[e]&127)<<21,t|=(n[e+1]&127)<<14,t|=(n[e+2]&127)<<7,t|=n[e+3]&127,t}function Ki(n,e){let t=e,i=0;for(;Bo(n,e);){i+=10;let s=cn(n,e+6);i+=s,nd(n,e+10)&&(i+=10),e+=i}if(i>0)return n.subarray(t,t+i)}function Mf(n,e,t,i){let s=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],r=e[t+2],o=r>>2&15;if(o>12){let f=new Error(`invalid ADTS sampling index:${o}`);n.emit(p.ERROR,p.ERROR,{type:z.MEDIA_ERROR,details:R.FRAG_PARSING_ERROR,fatal:!0,error:f,reason:f.message});return}let a=(r>>6&3)+1,c=e[t+3]>>6&3|(r&1)<<2,l="mp4a.40."+a,d=s[o],h=o;(a===5||a===29)&&(h-=3);let u=[a<<3|(h&14)>>1,(h&1)<<7|c<<3];return ce.log(`manifest codec:${i}, parsed codec:${l}, channels:${c}, rate:${d} (ADTS object type:${a} sampling index:${o})`),{config:u,samplerate:d,channelCount:c,codec:l,parsedCodec:l,manifestCodec:i}}function rd(n,e){return n[e]===255&&(n[e+1]&246)===240}function od(n,e){return n[e+1]&1?7:9}function Uo(n,e){return(n[e+3]&3)<<11|n[e+4]<<3|(n[e+5]&224)>>>5}function Of(n,e){return e+5<n.length}function zs(n,e){return e+1<n.length&&rd(n,e)}function Ff(n,e){return Of(n,e)&&rd(n,e)&&Uo(n,e)<=n.length-e}function Nf(n,e){if(zs(n,e)){let t=od(n,e);if(e+t>=n.length)return!1;let i=Uo(n,e);if(i<=t)return!1;let s=e+i;return s===n.length||zs(n,s)}return!1}function ad(n,e,t,i,s){if(!n.samplerate){let r=Mf(e,t,i,s);if(!r)return;fe(n,r)}}function ld(n){return 1024*9e4/n}function Bf(n,e){let t=od(n,e);if(e+t<=n.length){let i=Uo(n,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function cd(n,e,t,i,s){let r=ld(n.samplerate),o=i+s*r,a=Bf(e,t),c;if(a){let{frameLength:h,headerLength:u}=a,f=u+h,g=Math.max(0,t+f-e.length);g?(c=new Uint8Array(f-u),c.set(e.subarray(t+u,e.length),0)):c=e.subarray(t+u,t+f);let m={unit:c,pts:o};return g||n.samples.push(m),{sample:m,length:f,missing:g}}let l=e.length-t;return c=new Uint8Array(l),c.set(e.subarray(t,e.length),0),{sample:{unit:c,pts:o},length:l,missing:-1}}function Uf(n,e){return Bo(n,e)&&cn(n,e+6)+10<=n.length-e}function Vf(n){return n instanceof ArrayBuffer?n:n.byteOffset==0&&n.byteLength==n.buffer.byteLength?n.buffer:new Uint8Array(n).buffer}function sr(n,e=0,t=1/0){return $f(n,e,t,Uint8Array)}function $f(n,e,t,i){let s=Gf(n),r=1;"BYTES_PER_ELEMENT"in i&&(r=i.BYTES_PER_ELEMENT);let o=Hf(n)?n.byteOffset:0,a=(o+n.byteLength)/r,c=(o+e)/r,l=Math.floor(Math.max(0,Math.min(c,a))),d=Math.floor(Math.min(l+Math.max(t,0),a));return new i(s,l,d-l)}function Gf(n){return n instanceof ArrayBuffer?n:n.buffer}function Hf(n){return n&&n.buffer instanceof ArrayBuffer&&n.byteLength!==void 0&&n.byteOffset!==void 0}function Kf(n){let e={key:n.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(n.size<2)return;if(n.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}let i=n.data.subarray(1).indexOf(0);if(i===-1)return;let s=Ge(sr(n.data,1,i)),r=n.data[2+i],o=n.data.subarray(3+i).indexOf(0);if(o===-1)return;let a=Ge(sr(n.data,3+i,o)),c;return s==="-->"?c=Ge(sr(n.data,4+i+o)):c=Vf(n.data.subarray(4+i+o)),e.mimeType=s,e.pictureType=r,e.description=a,e.data=c,e}function jf(n){if(n.size<2)return;let e=Ge(n.data,!0),t=new Uint8Array(n.data.subarray(e.length+1));return{key:n.type,info:e,data:t.buffer}}function Wf(n){if(n.size<2)return;if(n.type==="TXXX"){let t=1,i=Ge(n.data.subarray(t),!0);t+=i.length+1;let s=Ge(n.data.subarray(t));return{key:n.type,info:i,data:s}}let e=Ge(n.data.subarray(1));return{key:n.type,info:"",data:e}}function Yf(n){if(n.type==="WXXX"){if(n.size<2)return;let t=1,i=Ge(n.data.subarray(t),!0);t+=i.length+1;let s=Ge(n.data.subarray(t));return{key:n.type,info:i,data:s}}let e=Ge(n.data);return{key:n.type,info:"",data:e}}function zf(n){return n.type==="PRIV"?jf(n):n.type[0]==="W"?Yf(n):n.type==="APIC"?Kf(n):Wf(n)}function qf(n){let e=String.fromCharCode(n[0],n[1],n[2],n[3]),t=cn(n,4),i=10;return{type:e,size:t,data:n.subarray(i,i+t)}}var Es=10,Xf=10;function dd(n){let e=0,t=[];for(;Bo(n,e);){let i=cn(n,e+6);n[e+5]>>6&1&&(e+=Es),e+=Es;let s=e+i;for(;e+Xf<s;){let r=qf(n.subarray(e)),o=zf(r);o&&t.push(o),e+=r.size+Es}nd(n,e)&&(e+=Es)}return t}function hd(n){return n&&n.key==="PRIV"&&n.info==="com.apple.streaming.transportStreamTimestamp"}function Qf(n){if(n.data.byteLength===8){let e=new Uint8Array(n.data),t=e[3]&1,i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function Vo(n){let e=dd(n);for(let t=0;t<e.length;t++){let i=e[t];if(hd(i))return Qf(i)}}var Ve=function(n){return n.audioId3="org.id3",n.dateRange="com.apple.quicktime.HLS",n.emsg="https://aomedia.org/emsg/ID3",n.misbklv="urn:misb:KLV:bin:1910.1",n}({});function ht(n="",e=9e4){return{type:n,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}var ji=class{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=qe(this.cachedData,e),this.cachedData=null);let i=Ki(e,0),s=i?i.length:0,r,o=this._audioTrack,a=this._id3Track,c=i?Vo(i):void 0,l=e.length;for((this.basePTS===null||this.frameIndex===0&&G(c))&&(this.basePTS=Zf(c,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Ve.audioId3,duration:Number.POSITIVE_INFINITY});s<l;){if(this.canParse(e,s)){let d=this.appendFrame(o,e,s);d?(this.frameIndex++,this.lastPTS=d.sample.pts,s+=d.length,r=s):s=l}else Uf(e,s)?(i=Ki(e,s),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Ve.audioId3,duration:Number.POSITIVE_INFINITY}),s+=i.length,r=s):s++;if(s===l&&r!==l){let d=e.slice(r);this.cachedData?this.cachedData=qe(this.cachedData,d):this.cachedData=d}}return{audioTrack:o,videoTrack:ht(),id3Track:a,textTrack:ht()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){let t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:ht(),id3Track:this._id3Track,textTrack:ht()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}},Zf=(n,e,t)=>{if(G(n))return n*90;let i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i},Ss=null,Jf=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],eg=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],tg=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],ig=[0,1,1,4];function ud(n,e,t,i,s){if(t+24>e.length)return;let r=fd(e,t);if(r&&t+r.frameLength<=e.length){let o=r.samplesPerFrame*9e4/r.sampleRate,a=i+s*o,c={unit:e.subarray(t,t+r.frameLength),pts:a,dts:a};return n.config=[],n.channelCount=r.channelCount,n.samplerate=r.sampleRate,n.samples.push(c),{sample:c,length:r.frameLength,missing:0}}}function fd(n,e){let t=n[e+1]>>3&3,i=n[e+1]>>1&3,s=n[e+2]>>4&15,r=n[e+2]>>2&3;if(t!==1&&s!==0&&s!==15&&r!==3){let o=n[e+2]>>1&1,a=n[e+3]>>6,c=t===3?3-i:i===3?3:4,l=Jf[c*14+s-1]*1e3,h=eg[(t===3?0:t===2?1:2)*3+r],u=a===3?1:2,f=tg[t][i],g=ig[i],m=f*8*g,v=Math.floor(f*l/h+o)*g;if(Ss===null){let S=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Ss=S?parseInt(S[1]):0}return!!Ss&&Ss<=87&&i===2&&l>=224e3&&a===0&&(n[e+3]=n[e+3]|128),{sampleRate:h,channelCount:u,frameLength:v,samplesPerFrame:m}}}function $o(n,e){return n[e]===255&&(n[e+1]&224)===224&&(n[e+1]&6)!==0}function gd(n,e){return e+1<n.length&&$o(n,e)}function sg(n,e){return $o(n,e)&&4<=n.length-e}function pd(n,e){if(e+1<n.length&&$o(n,e)){let i=fd(n,e),s=4;i!=null&&i.frameLength&&(s=i.frameLength);let r=e+s;return r===n.length||gd(n,r)}return!1}var Mr=class extends ji{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;let i=Ki(e,0),s=i?.length||0;if(pd(e,s))return!1;for(let r=e.length;s<r;s++)if(Nf(e,s))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return Ff(e,t)}appendFrame(e,t,i){ad(e,this.observer,t,i,e.manifestCodec);let s=cd(e,t,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}},md=(n,e)=>{let t=0,i=5;e+=i;let s=new Uint32Array(1),r=new Uint32Array(1),o=new Uint8Array(1);for(;i>0;){o[0]=n[e];let a=Math.min(i,8),c=8-a;r[0]=4278190080>>>24+c<<c,s[0]=(o[0]&r[0])>>c,t=t?t<<a|s[0]:s[0],e+=1,i-=a}return t},Or=class extends ji{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){let s=vd(e,t,i,this.basePTS,this.frameIndex);if(s!==-1)return{sample:e.samples[e.samples.length-1],length:s,missing:0}}static probe(e){if(!e)return!1;let t=Ki(e,0);if(!t)return!1;let i=t.length;return e[i]===11&&e[i+1]===119&&Vo(t)!==void 0&&md(e,i)<16}};function vd(n,e,t,i,s){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;let r=e[t+4]>>6;if(r>=3)return-1;let a=[48e3,44100,32e3][r],c=e[t+4]&63,d=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][c*3+r]*2;if(t+d>e.length)return-1;let h=e[t+6]>>5,u=0;h===2?u+=2:(h&1&&h!==1&&(u+=2),h&4&&(u+=2));let f=(e[t+6]<<8|e[t+7])>>12-u&1,m=[2,1,2,3,3,4,4,5][h]+f,v=e[t+5]>>3,y=e[t+5]&7,T=new Uint8Array([r<<6|v<<1|y>>2,(y&3)<<6|h<<3|f<<2|c>>4,c<<4&224]),S=1536/a*9e4,b=i+s*S,A=e.subarray(t,t+d);return n.config=T,n.channelCount=m,n.samplerate=a,n.samples.push({unit:A,pts:b}),d}var Fr=class extends ji{resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;let t=Ki(e,0),i=t?.length||0;if(t&&e[i]===11&&e[i+1]===119&&Vo(t)!==void 0&&md(e,i)<=16)return!1;for(let s=e.length;i<s;i++)if(pd(e,i))return ce.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return sg(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return ud(e,t,i,this.basePTS,this.frameIndex)}},ng=/\/emsg[-/]ID3/i,Nr=class{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,s){let r=this.videoTrack=ht("video",1),o=this.audioTrack=ht("audio",1),a=this.txtTrack=ht("text",1);if(this.id3Track=ht("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;let c=Pc(e);if(c.video){let{id:l,timescale:d,codec:h,supplemental:u}=c.video;r.id=l,r.timescale=a.timescale=d,r.codec=h,r.supplemental=u}if(c.audio){let{id:l,timescale:d,codec:h}=c.audio;o.id=l,o.timescale=d,o.codec=h}a.id=Lc.text,r.sampleDuration=0,r.duration=o.duration=s}resetContiguity(){this.remainderData=null}static probe(e){return vu(e)}demux(e,t){this.timeOffset=t;let i=e,s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=qe(this.remainderData,e));let a=bu(i);this.remainderData=a.remainder,s.samples=a.valid||new Uint8Array}else s.samples=i;let o=this.extractID3Track(s,t);return r.samples=Al(t,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}}flush(){let e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;let s=this.extractID3Track(t,this.timeOffset);return i.samples=Al(e,t),{videoTrack:t,audioTrack:ht(),id3Track:s,textTrack:ht()}}extractID3Track(e,t){let i=this.id3Track;if(e.samples.length){let s=te(e.samples,["emsg"]);s&&s.forEach(r=>{let o=Iu(r);if(ng.test(o.schemeIdUri)){let a=nc(o,t),c=o.eventDuration===4294967295?Number.POSITIVE_INFINITY:o.eventDuration/o.timeScale;c<=.001&&(c=Number.POSITIVE_INFINITY);let l=o.payload;i.samples.push({data:l,len:l.byteLength,dts:a,pts:a,type:Ve.emsg,duration:c})}else if(this.config.enableEmsgKLVMetadata&&o.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){let a=nc(o,t);i.samples.push({data:o.payload,len:o.payload.byteLength,dts:a,pts:a,type:Ve.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}};function nc(n,e){return G(n.presentationTime)?n.presentationTime/n.timeScale:e+n.presentationTimeDelta/n.timeScale}var Br=class{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Ui(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,Rt.cbc)}decryptAacSample(e,t,i){let s=e[t].unit;if(s.length<=16)return;let r=s.subarray(16,s.length-s.length%16),o=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(o).then(a=>{let c=new Uint8Array(a);s.set(c,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){let t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t),s=0;for(let r=32;r<e.length-16;r+=160,s+=16)i.set(e.subarray(r,r+16),s);return i}getAvcDecryptedUnit(e,t){let i=new Uint8Array(t),s=0;for(let r=32;r<e.length-16;r+=160,s+=16)e.set(i.subarray(s,s+16),r);return e}decryptAvcSample(e,t,i,s,r){let o=Oc(r.data),a=this.getAvcEncryptedData(o);this.decryptBuffer(a.buffer).then(c=>{r.data=this.getAvcDecryptedUnit(o,c),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,s)})}decryptAvcSamples(e,t,i,s){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){s();return}let r=e[t].units;for(;!(i>=r.length);i++){let o=r[i];if(!(o.data.length<=48||o.type!==1&&o.type!==5)&&(this.decryptAvcSample(e,t,i,s,o),!this.decrypter.isSync()))return}}}},qs=class{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,s;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){let r=i.units;s=r[r.length-1]}return s}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){let i=t.samples,s=i.length;if(s){let r=i[s-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){let s=t.byteLength,r=e.naluState||0,o=r,a=[],c=0,l,d,h,u=-1,f=0;for(r===-1&&(u=0,f=this.getNALuType(t,0),r=0,c=1);c<s;){if(l=t[c++],!r){r=l?0:1;continue}if(r===1){r=l?0:2;continue}if(!l)r=3;else if(l===1){if(d=c-r-1,u>=0){let g={data:t.subarray(u,d),type:f};a.push(g)}else{let g=this.getLastNalUnit(e.samples);g&&(o&&c<=4-o&&g.state&&(g.data=g.data.subarray(0,g.data.byteLength-o)),d>0&&(g.data=qe(g.data,t.subarray(0,d)),g.state=0))}c<s?(h=this.getNALuType(t,c),u=c,f=h,r=0):r=-1}else r=0}if(u>=0&&r>=0){let g={data:t.subarray(u,s),type:f,state:r};a.push(g)}if(a.length===0){let g=this.getLastNalUnit(e.samples);g&&(g.data=qe(g.data,t))}return e.naluState=r,a}},Kt=class{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let e=this.data,t=this.bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e),i=this.word>>>32-t;if(e>32&&ce.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let e=this.skipLZ();return this.readBits(e+1)-1}readEG(){let e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}},Xs=class extends qs{parsePES(e,t,i,s){let r=this.parseNALu(e,i.data,s),o=this.VideoSample,a,c=!1;i.data=null,o&&r.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(l=>{var d,h;switch(l.type){case 1:{let m=!1;a=!0;let v=l.data;if(c&&v.length>4){let y=this.readSliceType(v);(y===2||y===4||y===7||y===9)&&(m=!0)}if(m){var u;(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.frame=!0,o.key=m;break}case 5:a=!0,(d=o)!=null&&d.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 6:{a=!0,Po(l.data,1,i.pts,t.samples);break}case 7:{var f,g;a=!0,c=!0;let m=l.data,v=this.readSPS(m);if(!e.sps||e.width!==v.width||e.height!==v.height||((f=e.pixelRatio)==null?void 0:f[0])!==v.pixelRatio[0]||((g=e.pixelRatio)==null?void 0:g[1])!==v.pixelRatio[1]){e.width=v.width,e.height=v.height,e.pixelRatio=v.pixelRatio,e.sps=[m];let y=m.subarray(1,4),T="avc1.";for(let S=0;S<3;S++){let b=y[S].toString(16);b.length<2&&(b="0"+b),T+=b}e.codec=T}break}case 8:a=!0,e.pps=[l.data];break;case 9:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:a=!0;break;default:a=!1;break}o&&a&&o.units.push(l)}),s&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){let t=new Kt(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,s=8,r;for(let o=0;o<e;o++)s!==0&&(r=t.readEG(),s=(i+r+256)%256),i=s===0?i:s}readSPS(e){let t=new Kt(e),i=0,s=0,r=0,o=0,a,c,l,d=t.readUByte.bind(t),h=t.readBits.bind(t),u=t.readUEG.bind(t),f=t.readBoolean.bind(t),g=t.skipBits.bind(t),m=t.skipEG.bind(t),v=t.skipUEG.bind(t),y=this.skipScalingList.bind(this);d();let T=d();if(h(5),g(3),d(),v(),T===100||T===110||T===122||T===244||T===44||T===83||T===86||T===118||T===128){let D=u();if(D===3&&g(1),v(),v(),g(1),f())for(c=D!==3?8:12,l=0;l<c;l++)f()&&(l<6?y(16,t):y(64,t))}v();let S=u();if(S===0)u();else if(S===1)for(g(1),m(),m(),a=u(),l=0;l<a;l++)m();v(),g(1);let b=u(),A=u(),L=h(1);L===0&&g(1),g(1),f()&&(i=u(),s=u(),r=u(),o=u());let I=[1,1];if(f()&&f())switch(d()){case 1:I=[1,1];break;case 2:I=[12,11];break;case 3:I=[10,11];break;case 4:I=[16,11];break;case 5:I=[40,33];break;case 6:I=[24,11];break;case 7:I=[20,11];break;case 8:I=[32,11];break;case 9:I=[80,33];break;case 10:I=[18,11];break;case 11:I=[15,11];break;case 12:I=[64,33];break;case 13:I=[160,99];break;case 14:I=[4,3];break;case 15:I=[3,2];break;case 16:I=[2,1];break;case 255:{I=[d()<<8|d(),d()<<8|d()];break}}return{width:Math.ceil((b+1)*16-i*2-s*2),height:(2-L)*(A+1)*16-(L?2:4)*(r+o),pixelRatio:I}}},Qs=class extends qs{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,s){let r=this.parseNALu(e,i.data,s),o=this.VideoSample,a,c=!1;i.data=null,o&&r.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(l=>{var d,h;switch(l.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),o.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,c){var u;(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 19:case 20:a=!0,(d=o)!=null&&d.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 39:a=!0,Po(l.data,2,i.pts,t.samples);break;case 32:a=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=fe(e.params,this.readVPS(l.data)),this.initVPS=l.data),e.vps=[l.data];break;case 33:if(a=!0,c=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],l.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){let f=this.readSPS(l.data);e.width=f.width,e.height=f.height,e.pixelRatio=f.pixelRatio,e.codec=f.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(let g in f.params)e.params[g]=f.params[g]}this.pushParameterSet(e.sps,l.data,e.vps),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0;break;case 34:if(a=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];let f=this.readPPS(l.data);for(let g in f)e.params[g]=f[g]}this.pushParameterSet(e.pps,l.data,e.vps)}break;case 35:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:a=!1;break}o&&a&&o.units.push(l)}),s&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){let t=new Uint8Array(e.byteLength),i=0;for(let s=0;s<e.byteLength;s++)s>=2&&e[s]===3&&e[s-1]===0&&e[s-2]===0||(t[i]=e[s],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){let t=new Kt(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);let i=t.readBits(3),s=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:s}}readSPS(e){let t=new Kt(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);let i=t.readBits(3);t.readBoolean();let s=t.readBits(2),r=t.readBoolean(),o=t.readBits(5),a=t.readUByte(),c=t.readUByte(),l=t.readUByte(),d=t.readUByte(),h=t.readUByte(),u=t.readUByte(),f=t.readUByte(),g=t.readUByte(),m=t.readUByte(),v=t.readUByte(),y=t.readUByte(),T=[],S=[];for(let ae=0;ae<i;ae++)T.push(t.readBoolean()),S.push(t.readBoolean());if(i>0)for(let ae=i;ae<8;ae++)t.readBits(2);for(let ae=0;ae<i;ae++)T[ae]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),S[ae]&&t.readUByte();t.readUEG();let b=t.readUEG();b==3&&t.skipBits(1);let A=t.readUEG(),L=t.readUEG(),I=t.readBoolean(),D=0,w=0,C=0,P=0;I&&(D+=t.readUEG(),w+=t.readUEG(),C+=t.readUEG(),P+=t.readUEG());let U=t.readUEG(),q=t.readUEG(),H=t.readUEG(),K=t.readBoolean();for(let ae=K?0:i;ae<=i;ae++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let Re=0;Re<4;Re++)for(let He=0;He<(Re===3?2:6);He++)if(!t.readBoolean())t.readUEG();else{let Xe=Math.min(64,1<<4+(Re<<1));Re>1&&t.readEG();for(let Yt=0;Yt<Xe;Yt++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());let Y=t.readUEG(),M=0;for(let ae=0;ae<Y;ae++){let Re=!1;if(ae!==0&&(Re=t.readBoolean()),Re){ae===Y&&t.readUEG(),t.readBoolean(),t.readUEG();let He=0;for(let Lt=0;Lt<=M;Lt++){let Xe=t.readBoolean(),Yt=!1;Xe||(Yt=t.readBoolean()),(Xe||Yt)&&He++}M=He}else{let He=t.readUEG(),Lt=t.readUEG();M=He+Lt;for(let Xe=0;Xe<He;Xe++)t.readUEG(),t.readBoolean();for(let Xe=0;Xe<Lt;Xe++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){let ae=t.readUEG();for(let Re=0;Re<ae;Re++){for(let He=0;He<H+4;He++)t.readBits(1);t.readBits(1)}}let ee=0,Z=1,se=1,oe=!0,de=1,ge=0;t.readBoolean(),t.readBoolean();let Le=!1;if(t.readBoolean()){if(t.readBoolean()){let wt=t.readUByte(),Yo=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],Xi=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];wt>0&&wt<16?(Z=Yo[wt-1],se=Xi[wt-1]):wt===255&&(Z=t.readBits(16),se=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),Le=t.readBoolean(),Le&&(D+=t.readUEG(),w+=t.readUEG(),C+=t.readUEG(),P+=t.readUEG()),t.readBoolean()&&(de=t.readBits(32),ge=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){let Xi=t.readBoolean(),zo=t.readBoolean(),di=!1;(Xi||zo)&&(di=t.readBoolean(),di&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),di&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let qo=0;qo<=i;qo++){oe=t.readBoolean();let zd=oe||t.readBoolean(),Xo=!1;zd?t.readEG():Xo=t.readBoolean();let Qo=Xo?1:t.readUEG()+1;if(Xi)for(let hi=0;hi<Qo;hi++)t.readUEG(),t.readUEG(),di&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(zo)for(let hi=0;hi<Qo;hi++)t.readUEG(),t.readUEG(),di&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),ee=t.readUEG())}let St=A,Wo=L;if(I||Le){let ae=1,Re=1;b===1?ae=Re=2:b==2&&(ae=2),St=A-ae*w-ae*D,Wo=L-Re*P-Re*C}let Wd=s?["A","B","C"][s]:"",Yd=a<<24|c<<16|l<<8|d,hn=0;for(let ae=0;ae<32;ae++)hn=(hn|(Yd>>ae&1)<<31-ae)>>>0;let un=hn.toString(16);return o===1&&un==="2"&&(un="6"),{codecString:`hvc1.${Wd}${o}.${un}.${r?"H":"L"}${y}.B0`,params:{general_tier_flag:r,general_profile_idc:o,general_profile_space:s,general_profile_compatibility_flags:[a,c,l,d],general_constraint_indicator_flags:[h,u,f,g,m,v],general_level_idc:y,bit_depth:U+8,bit_depth_luma_minus8:U,bit_depth_chroma_minus8:q,min_spatial_segmentation_idc:ee,chroma_format_idc:b,frame_rate:{fixed:oe,fps:ge/de}},width:St,height:Wo,pixelRatio:[Z,se]}}readPPS(e){let t=new Kt(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);let s=t.readBoolean(),r=t.readBoolean(),o=1;return r&&s?o=0:r?o=3:s&&(o=2),{parallelismType:o}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}},Ie=188,Ur=class n{constructor(e,t,i,s){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=s,this.videoParser=null}static probe(e,t){let i=n.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){let t=e.length,i=Math.min(Ie*5,t-Ie)+1,s=0;for(;s<i;){let r=!1,o=-1,a=0;for(let c=s;c<t;c+=Ie)if(e[c]===71&&(t-c===Ie||e[c+Ie]===71)){if(a++,o===-1&&(o=c,o!==0&&(i=Math.min(o+Ie*99,e.length-Ie)+1)),r||(r=Vr(e,c)===0),r&&a>1&&(o===0&&a>2||c+Ie>i))return o}else{if(a)return-1;break}s++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Lc[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=n.createTrack("video"),this._videoTrack.duration=s,this._audioTrack=n.createTrack("audio",s),this._id3Track=n.createTrack("id3"),this._txtTrack=n.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){let{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,s=!1){i||(this.sampleAes=null);let r,o=this._videoTrack,a=this._audioTrack,c=this._id3Track,l=this._txtTrack,d=o.pid,h=o.pesData,u=a.pid,f=c.pid,g=a.pesData,m=c.pesData,v=null,y=this.pmtParsed,T=this._pmtId,S=e.length;if(this.remainderData&&(e=qe(this.remainderData,e),S=e.length,this.remainderData=null),S<Ie&&!s)return this.remainderData=e,{audioTrack:a,videoTrack:o,id3Track:c,textTrack:l};let b=Math.max(0,n.syncOffset(e));S-=(S-b)%Ie,S<e.byteLength&&!s&&(this.remainderData=new Uint8Array(e.buffer,S,e.buffer.byteLength-S));let A=0;for(let I=b;I<S;I+=Ie)if(e[I]===71){let D=!!(e[I+1]&64),w=Vr(e,I),C=(e[I+3]&48)>>4,P;if(C>1){if(P=I+5+e[I+4],P===I+Ie)continue}else P=I+4;switch(w){case d:if(D){if(h&&(r=Jt(h,this.logger))){if(this.videoParser===null)switch(o.segmentCodec){case"avc":this.videoParser=new Xs;break;case"hevc":this.videoParser=new Qs;break}this.videoParser!==null&&this.videoParser.parsePES(o,l,r,!1)}h={data:[],size:0}}h&&(h.data.push(e.subarray(P,I+Ie)),h.size+=I+Ie-P);break;case u:if(D){if(g&&(r=Jt(g,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,r);break;case"mp3":this.parseMPEGPES(a,r);break;case"ac3":this.parseAC3PES(a,r);break}g={data:[],size:0}}g&&(g.data.push(e.subarray(P,I+Ie)),g.size+=I+Ie-P);break;case f:D&&(m&&(r=Jt(m,this.logger))&&this.parseID3PES(c,r),m={data:[],size:0}),m&&(m.data.push(e.subarray(P,I+Ie)),m.size+=I+Ie-P);break;case 0:D&&(P+=e[P]+1),T=this._pmtId=rg(e,P);break;case T:{D&&(P+=e[P]+1);let U=og(e,P,this.typeSupported,i,this.observer,this.logger);d=U.videoPid,d>0&&(o.pid=d,o.segmentCodec=U.segmentVideoCodec),u=U.audioPid,u>0&&(a.pid=u,a.segmentCodec=U.segmentAudioCodec),f=U.id3Pid,f>0&&(c.pid=f),v!==null&&!y&&(this.logger.warn(`MPEG-TS PMT found at ${I} after unknown PID '${v}'. Backtracking to sync byte @${b} to parse all TS packets.`),v=null,I=b-188),y=this.pmtParsed=!0;break}case 17:case 8191:break;default:v=w;break}}else A++;A>0&&$r(this.observer,new Error(`Found ${A} TS packet/s that do not start with 0x47`),void 0,this.logger),o.pesData=h,a.pesData=g,c.pesData=m;let L={audioTrack:a,videoTrack:o,id3Track:c,textTrack:l};return s&&this.extractRemainingSamples(L),L}flush(){let{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){let{audioTrack:t,videoTrack:i,id3Track:s,textTrack:r}=e,o=i.pesData,a=t.pesData,c=s.pesData,l;if(o&&(l=Jt(o,this.logger))){if(this.videoParser===null)switch(i.segmentCodec){case"avc":this.videoParser=new Xs;break;case"hevc":this.videoParser=new Qs;break}this.videoParser!==null&&(this.videoParser.parsePES(i,r,l,!0),i.pesData=null)}else i.pesData=o;if(a&&(l=Jt(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l);break}t.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;c&&(l=Jt(c,this.logger))?(this.parseID3PES(s,l),s.pesData=null):s.pesData=c}demuxSampleAes(e,t,i){let s=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new Br(this.observer,this.config,t);return this.decrypt(s,r)}decrypt(e,t){return new Promise(i=>{let{audioTrack:s,videoTrack:r}=e;s.samples&&s.segmentCodec==="aac"?t.decryptAacSamples(s.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0,s=this.aacOverFlow,r=t.data;if(s){this.aacOverFlow=null;let h=s.missing,u=s.sample.unit.byteLength;if(h===-1)r=qe(s.sample.unit,r);else{let f=u-h;s.sample.unit.set(r.subarray(0,h),f),e.samples.push(s.sample),i=s.missing}}let o,a;for(o=i,a=r.length;o<a-1&&!zs(r,o);o++);if(o!==i){let h,u=o<a-1;if(u?h=`AAC PES did not start with ADTS header,offset:${o}`:h="No ADTS header found in AAC PES",$r(this.observer,new Error(h),u,this.logger),!u)return}ad(e,this.observer,r,o,this.audioCodec);let c;if(t.pts!==void 0)c=t.pts;else if(s){let h=ld(e.samplerate);c=s.sample.pts+h}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let l=0,d;for(;o<a;)if(d=cd(e,r,o,c,l),o+=d.length,d.missing){this.aacOverFlow=d;break}else for(l++;o<a-1&&!zs(r,o);o++);}parseMPEGPES(e,t){let i=t.data,s=i.length,r=0,o=0,a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<s;)if(gd(i,o)){let c=ud(e,i,o,a,r);if(c)o+=c.length,r++;else break}else o++}parseAC3PES(e,t){{let i=t.data,s=t.pts;if(s===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}let r=i.length,o=0,a=0,c;for(;a<r&&(c=vd(e,i,a,s,o++))>0;)a+=c}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}let i=fe({},t,{type:this._videoTrack?Ve.emsg:Ve.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}};function Vr(n,e){return((n[e+1]&31)<<8)+n[e+2]}function rg(n,e){return(n[e+10]&31)<<8|n[e+11]}function og(n,e,t,i,s,r){let o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(n[e+1]&15)<<8|n[e+2],c=e+3+a-4,l=(n[e+10]&15)<<8|n[e+11];for(e+=12+l;e<c;){let d=Vr(n,e),h=(n[e+3]&15)<<8|n[e+4];switch(n[e]){case 207:if(!i){nr("ADTS AAC",r);break}case 15:o.audioPid===-1&&(o.audioPid=d);break;case 21:o.id3Pid===-1&&(o.id3Pid=d);break;case 219:if(!i){nr("H.264",r);break}case 27:o.videoPid===-1&&(o.videoPid=d);break;case 3:case 4:!t.mpeg&&!t.mp3?r.log("MPEG audio found, not supported in this browser"):o.audioPid===-1&&(o.audioPid=d,o.segmentAudioCodec="mp3");break;case 193:if(!i){nr("AC-3",r);break}case 129:t.ac3?o.audioPid===-1&&(o.audioPid=d,o.segmentAudioCodec="ac3"):r.log("AC-3 audio found, not supported in this browser");break;case 6:if(o.audioPid===-1&&h>0){let u=e+5,f=h;for(;f>2;){switch(n[u]){case 106:t.ac3!==!0?r.log("AC-3 audio found, not supported in this browser for now"):(o.audioPid=d,o.segmentAudioCodec="ac3");break}let m=n[u+1]+2;u+=m,f-=m}}break;case 194:case 135:return $r(s,new Error("Unsupported EC-3 in M2TS found"),void 0,r),o;case 36:o.videoPid===-1&&(o.videoPid=d,o.segmentVideoCodec="hevc",r.log("HEVC in M2TS found"));break}e+=h+5}return o}function $r(n,e,t,i){i.warn(`parsing error: ${e.message}`),n.emit(p.ERROR,p.ERROR,{type:z.MEDIA_ERROR,details:R.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function nr(n,e){e.log(`${n} with AES-128-CBC encryption found in unencrypted stream`)}function Jt(n,e){let t=0,i,s,r,o,a,c=n.data;if(!n||n.size===0)return null;for(;c[0].length<19&&c.length>1;)c[0]=qe(c[0],c[1]),c.splice(1,1);if(i=c[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(s=(i[4]<<8)+i[5],s&&s>n.size-6)return null;let d=i[7];d&192&&(o=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,d&64?(a=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,o-a>60*9e4&&(e.warn(`${Math.round((o-a)/9e4)}s delta between PTS and DTS, align them`),o=a)):a=o),r=i[8];let h=r+9;if(n.size<=h)return null;n.size-=h;let u=new Uint8Array(n.size);for(let f=0,g=c.length;f<g;f++){i=c[f];let m=i.byteLength;if(h)if(h>m){h-=m;continue}else i=i.subarray(h),m-=h,h=0;u.set(i,t),t+=m}return s&&(s-=r+3),{data:u,pts:o,dts:a,len:s}}return null}var Gr=class{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}},bt=Math.pow(2,32)-1,ei=(()=>{class n{static init(){n.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let t;for(t in n.types)n.types.hasOwnProperty(t)&&(n.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);let i=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);n.HDLR_TYPES={video:i,audio:s};let r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),o=new Uint8Array([0,0,0,0,0,0,0,0]);n.STTS=n.STSC=n.STCO=o,n.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),n.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),n.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),n.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let a=new Uint8Array([105,115,111,109]),c=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);n.FTYP=n.box(n.types.ftyp,a,l,a,c),n.DINF=n.box(n.types.dinf,n.box(n.types.dref,r))}static box(t,...i){let s=8,r=i.length,o=r;for(;r--;)s+=i[r].byteLength;let a=new Uint8Array(s);for(a[0]=s>>24&255,a[1]=s>>16&255,a[2]=s>>8&255,a[3]=s&255,a.set(t,4),r=0,s=8;r<o;r++)a.set(i[r],s),s+=i[r].byteLength;return a}static hdlr(t){return n.box(n.types.hdlr,n.HDLR_TYPES[t])}static mdat(t){return n.box(n.types.mdat,t)}static mdhd(t,i){i*=t;let s=Math.floor(i/(bt+1)),r=Math.floor(i%(bt+1));return n.box(n.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,s>>24,s>>16&255,s>>8&255,s&255,r>>24,r>>16&255,r>>8&255,r&255,85,196,0,0]))}static mdia(t){return n.box(n.types.mdia,n.mdhd(t.timescale||0,t.duration||0),n.hdlr(t.type),n.minf(t))}static mfhd(t){return n.box(n.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))}static minf(t){return t.type==="audio"?n.box(n.types.minf,n.box(n.types.smhd,n.SMHD),n.DINF,n.stbl(t)):n.box(n.types.minf,n.box(n.types.vmhd,n.VMHD),n.DINF,n.stbl(t))}static moof(t,i,s){return n.box(n.types.moof,n.mfhd(t),n.traf(s,i))}static moov(t){let i=t.length,s=[];for(;i--;)s[i]=n.trak(t[i]);return n.box.apply(null,[n.types.moov,n.mvhd(t[0].timescale||0,t[0].duration||0)].concat(s).concat(n.mvex(t)))}static mvex(t){let i=t.length,s=[];for(;i--;)s[i]=n.trex(t[i]);return n.box.apply(null,[n.types.mvex,...s])}static mvhd(t,i){i*=t;let s=Math.floor(i/(bt+1)),r=Math.floor(i%(bt+1)),o=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,s>>24,s>>16&255,s>>8&255,s&255,r>>24,r>>16&255,r>>8&255,r&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return n.box(n.types.mvhd,o)}static sdtp(t){let i=t.samples||[],s=new Uint8Array(4+i.length),r,o;for(r=0;r<i.length;r++)o=i[r].flags,s[r+4]=o.dependsOn<<4|o.isDependedOn<<2|o.hasRedundancy;return n.box(n.types.sdtp,s)}static stbl(t){return n.box(n.types.stbl,n.stsd(t),n.box(n.types.stts,n.STTS),n.box(n.types.stsc,n.STSC),n.box(n.types.stsz,n.STSZ),n.box(n.types.stco,n.STCO))}static avc1(t){let i=[],s=[],r,o,a;for(r=0;r<t.sps.length;r++)o=t.sps[r],a=o.byteLength,i.push(a>>>8&255),i.push(a&255),i=i.concat(Array.prototype.slice.call(o));for(r=0;r<t.pps.length;r++)o=t.pps[r],a=o.byteLength,s.push(a>>>8&255),s.push(a&255),s=s.concat(Array.prototype.slice.call(o));let c=n.box(n.types.avcC,new Uint8Array([1,i[3],i[4],i[5],255,224|t.sps.length].concat(i).concat([t.pps.length]).concat(s))),l=t.width,d=t.height,h=t.pixelRatio[0],u=t.pixelRatio[1];return n.box(n.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,d>>8&255,d&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,n.box(n.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),n.box(n.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,h&255,u>>24,u>>16&255,u>>8&255,u&255])))}static esds(t){let i=t.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...i,6,1,2])}static audioStsd(t){let i=t.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount||0,0,16,0,0,0,0,i>>8&255,i&255,0,0])}static mp4a(t){return n.box(n.types.mp4a,n.audioStsd(t),n.box(n.types.esds,n.esds(t)))}static mp3(t){return n.box(n.types[".mp3"],n.audioStsd(t))}static ac3(t){return n.box(n.types["ac-3"],n.audioStsd(t),n.box(n.types.dac3,t.config))}static stsd(t){let{segmentCodec:i}=t;if(t.type==="audio"){if(i==="aac")return n.box(n.types.stsd,n.STSD,n.mp4a(t));if(i==="ac3"&&t.config)return n.box(n.types.stsd,n.STSD,n.ac3(t));if(i==="mp3"&&t.codec==="mp3")return n.box(n.types.stsd,n.STSD,n.mp3(t))}else if(t.pps&&t.sps){if(i==="avc")return n.box(n.types.stsd,n.STSD,n.avc1(t));if(i==="hevc"&&t.vps)return n.box(n.types.stsd,n.STSD,n.hvc1(t))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${t.type} segment codec (${i}/${t.codec})`)}static tkhd(t){let i=t.id,s=(t.duration||0)*(t.timescale||0),r=t.width||0,o=t.height||0,a=Math.floor(s/(bt+1)),c=Math.floor(s%(bt+1));return n.box(n.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,i>>24&255,i>>16&255,i>>8&255,i&255,0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,c>>24,c>>16&255,c>>8&255,c&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,r&255,0,0,o>>8&255,o&255,0,0]))}static traf(t,i){let s=n.sdtp(t),r=t.id,o=Math.floor(i/(bt+1)),a=Math.floor(i%(bt+1));return n.box(n.types.traf,n.box(n.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255])),n.box(n.types.tfdt,new Uint8Array([1,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,a>>24,a>>16&255,a>>8&255,a&255])),n.trun(t,s.length+16+20+8+16+8+8),s)}static trak(t){return t.duration=t.duration||4294967295,n.box(n.types.trak,n.tkhd(t),n.mdia(t))}static trex(t){let i=t.id;return n.box(n.types.trex,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,i){let s=t.samples||[],r=s.length,o=12+16*r,a=new Uint8Array(o),c,l,d,h,u,f;for(i+=8+o,a.set([t.type==="video"?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,r&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255],0),c=0;c<r;c++)l=s[c],d=l.duration,h=l.size,u=l.flags,f=l.cts,a.set([d>>>24&255,d>>>16&255,d>>>8&255,d&255,h>>>24&255,h>>>16&255,h>>>8&255,h&255,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,u.degradPrio&61440,u.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*c);return n.box(n.types.trun,a)}static initSegment(t){n.types||n.init();let i=n.moov(t);return qe(n.FTYP,i)}static hvc1(t){let i=t.params,s=[t.vps,t.sps,t.pps],r=4,o=new Uint8Array([1,i.general_profile_space<<6|(i.general_tier_flag?32:0)|i.general_profile_idc,i.general_profile_compatibility_flags[0],i.general_profile_compatibility_flags[1],i.general_profile_compatibility_flags[2],i.general_profile_compatibility_flags[3],i.general_constraint_indicator_flags[0],i.general_constraint_indicator_flags[1],i.general_constraint_indicator_flags[2],i.general_constraint_indicator_flags[3],i.general_constraint_indicator_flags[4],i.general_constraint_indicator_flags[5],i.general_level_idc,240|i.min_spatial_segmentation_idc>>8,255&i.min_spatial_segmentation_idc,252|i.parallelismType,252|i.chroma_format_idc,248|i.bit_depth_luma_minus8,248|i.bit_depth_chroma_minus8,0,parseInt(i.frame_rate.fps),r-1|i.temporal_id_nested<<2|i.num_temporal_layers<<3|(i.frame_rate.fixed?64:0),s.length]),a=o.length;for(let m=0;m<s.length;m+=1){a+=3;for(let v=0;v<s[m].length;v+=1)a+=2+s[m][v].length}let c=new Uint8Array(a);c.set(o,0),a=o.length;let l=s.length-1;for(let m=0;m<s.length;m+=1){c.set(new Uint8Array([32+m|(m===l?128:0),0,s[m].length]),a),a+=3;for(let v=0;v<s[m].length;v+=1)c.set(new Uint8Array([s[m][v].length>>8,s[m][v].length&255]),a),a+=2,c.set(s[m][v],a),a+=s[m][v].length}let d=n.box(n.types.hvcC,c),h=t.width,u=t.height,f=t.pixelRatio[0],g=t.pixelRatio[1];return n.box(n.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,h>>8&255,h&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),d,n.box(n.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),n.box(n.types.pasp,new Uint8Array([f>>24,f>>16&255,f>>8&255,f&255,g>>24,g>>16&255,g>>8&255,g&255])))}}return n.types=void 0,n.HDLR_TYPES=void 0,n.STTS=void 0,n.STSC=void 0,n.STCO=void 0,n.STSZ=void 0,n.VMHD=void 0,n.SMHD=void 0,n.STSD=void 0,n.FTYP=void 0,n.DINF=void 0,n})(),yd=9e4;function Go(n,e,t=1,i=!1){let s=n*e*t;return i?Math.round(s):s}function ag(n,e,t=1,i=!1){return Go(n,e,1/t,i)}function Ri(n,e=!1){return Go(n,1e3,1/yd,e)}function lg(n,e=1){return Go(n,yd,1/e)}var cg=10*1e3,dg=1024,hg=1152,ug=1536,ti=null,rr=null;function rc(n,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:n?2:1,isNonSync:n?0:1}}}var oi=class{constructor(e,t,i,s){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=s,this.ISGenerated=!1,ti===null){let o=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);ti=o?parseInt(o[1]):0}if(rr===null){let r=navigator.userAgent.match(/Safari\/(\d+)/i);rr=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1,i=e[0].pts,s=e.reduce((r,o)=>{let a=o.pts,c=a-r;return c<-4294967296&&(t=!0,a=Ye(a,i),c=a-r),c>0?r:a},i);return t&&this.logger.debug("PTS rollover detected"),s}remux(e,t,i,s,r,o,a,c){let l,d,h,u,f,g,m=r,v=r,y=e.pid>-1,T=t.pid>-1,S=t.samples.length,b=e.samples.length>0,A=a&&S>0||S>1;if((!y||b)&&(!T||A)||this.ISGenerated||a){if(this.ISGenerated){var I,D,w,C;let H=this.videoTrackConfig;(H&&(t.width!==H.width||t.height!==H.height||((I=t.pixelRatio)==null?void 0:I[0])!==((D=H.pixelRatio)==null?void 0:D[0])||((w=t.pixelRatio)==null?void 0:w[1])!==((C=H.pixelRatio)==null?void 0:C[1]))||!H&&A||this.nextAudioPts===null&&b)&&this.resetInitSegment()}this.ISGenerated||(h=this.generateIS(e,t,r,o));let P=this.isVideoContiguous,U=-1,q;if(A&&(U=fg(t.samples),!P&&this.config.forceKeyFrameOnDiscontinuity))if(g=!0,U>0){this.logger.warn(`[mp4-remuxer]: Dropped ${U} out of ${S} video samples due to a missing keyframe`);let H=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(U),t.dropped+=U,v+=(t.samples[0].pts-H)/t.inputTimeScale,q=v}else U===-1&&(this.logger.warn(`[mp4-remuxer]: No keyframe found out of ${S} video samples`),g=!1);if(this.ISGenerated){if(b&&A){let H=this.getVideoStartPts(t.samples),V=(Ye(e.samples[0].pts,H)-H)/t.inputTimeScale;m+=Math.max(0,V),v+=Math.max(0,-V)}if(b){if(e.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),h=this.generateIS(e,t,r,o)),d=this.remuxAudio(e,m,this.isAudioContiguous,o,T||A||c===W.AUDIO?v:void 0),A){let H=d?d.endPTS-d.startPTS:0;t.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),h=this.generateIS(e,t,r,o)),l=this.remuxVideo(t,v,P,H)}}else A&&(l=this.remuxVideo(t,v,P,0));l&&(l.firstKeyFrame=U,l.independent=U!==-1,l.firstKeyFramePTS=q)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(f=_d(i,r,this._initPTS,this._initDTS)),s.samples.length&&(u=Ed(s,r,this._initPTS))),{audio:d,video:l,initSegment:h,independent:g,text:u,id3:f}}generateIS(e,t,i,s){let r=e.samples,o=t.samples,a=this.typeSupported,c={},l=this._initPTS,d=!l||s,h="audio/mp4",u,f,g,m;if(d&&(u=f=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(h="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}c.audio={id:"audio",container:h,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):ei.initSegment([e]),metadata:{channelCount:e.channelCount}},d&&(m=e.id,g=e.inputTimeScale,!l||g!==l.timescale?u=f=r[0].pts-Math.round(g*i):d=!1)}if(t.sps&&t.pps&&o.length){if(t.timescale=t.inputTimeScale,c.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:ei.initSegment([t]),metadata:{width:t.width,height:t.height}},d)if(m=t.id,g=t.inputTimeScale,!l||g!==l.timescale){let v=this.getVideoStartPts(o),y=Math.round(g*i);f=Math.min(f,Ye(o[0].dts,v)-y),u=Math.min(u,v-y)}else d=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(c).length)return this.ISGenerated=!0,d?(this._initPTS={baseTime:u,timescale:g},this._initDTS={baseTime:f,timescale:g}):u=g=void 0,{tracks:c,initPTS:u,timescale:g,trackId:m}}remuxVideo(e,t,i,s){let r=e.inputTimeScale,o=e.samples,a=[],c=o.length,l=this._initPTS,d=this.nextAvcDts,h=8,u=this.videoSampleDuration,f,g,m=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY,y=!1;if(!i||d===null){let M=t*r,O=o[0].pts-Ye(o[0].dts,o[0].pts);ti&&d!==null&&Math.abs(M-O-d)<15e3?i=!0:d=M-O}let T=l.baseTime*r/l.timescale;for(let M=0;M<c;M++){let O=o[M];O.pts=Ye(O.pts-T,d),O.dts=Ye(O.dts-T,d),O.dts<o[M>0?M-1:M].dts&&(y=!0)}y&&o.sort(function(M,O){let ee=M.dts-O.dts,Z=M.pts-O.pts;return ee||Z}),f=o[0].dts,g=o[o.length-1].dts;let S=g-f,b=S?Math.round(S/(c-1)):u||e.inputTimeScale/30;if(i){let M=f-d,O=M>b,ee=M<-1;if((O||ee)&&(O?this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${Ri(M,!0)} ms (${M}dts) hole between fragments detected at ${t.toFixed(3)}`):this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${Ri(-M,!0)} ms (${M}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!ee||d>=o[0].pts||ti)){f=d;let Z=o[0].pts-M;if(O)o[0].dts=f,o[0].pts=Z;else{let se=!0;for(let oe=0;oe<o.length&&!(o[oe].dts>Z&&se);oe++){let de=o[oe].pts;if(o[oe].dts-=M,o[oe].pts-=M,oe<o.length-1){let ge=o[oe+1].pts,Le=o[oe].pts,we=ge<=Le,St=ge<=de;se=we==St}}}this.logger.log(`Video: Initial PTS/DTS adjusted: ${Ri(Z,!0)}/${Ri(f,!0)}, delta: ${Ri(M,!0)} ms`)}}f=Math.max(0,f);let A=0,L=0,I=f;for(let M=0;M<c;M++){let O=o[M],ee=O.units,Z=ee.length,se=0;for(let oe=0;oe<Z;oe++)se+=ee[oe].data.length;L+=se,A+=Z,O.length=se,O.dts<I?(O.dts=I,I+=b/4|0||1):I=O.dts,m=Math.min(O.pts,m),v=Math.max(O.pts,v)}g=o[c-1].dts;let D=L+4*A+8,w;try{w=new Uint8Array(D)}catch(M){this.observer.emit(p.ERROR,p.ERROR,{type:z.MUX_ERROR,details:R.REMUX_ALLOC_ERROR,fatal:!1,error:M,bytes:D,reason:`fail allocating video mdat ${D}`});return}let C=new DataView(w.buffer);C.setUint32(0,D),w.set(ei.types.mdat,4);let P=!1,U=Number.POSITIVE_INFINITY,q=Number.POSITIVE_INFINITY,H=Number.NEGATIVE_INFINITY,K=Number.NEGATIVE_INFINITY;for(let M=0;M<c;M++){let O=o[M],ee=O.units,Z=0;for(let de=0,ge=ee.length;de<ge;de++){let Le=ee[de],we=Le.data,St=Le.data.byteLength;C.setUint32(h,St),h+=4,w.set(we,h),h+=St,Z+=4+St}let se;if(M<c-1)u=o[M+1].dts-O.dts,se=o[M+1].pts-O.pts;else{let de=this.config,ge=M>0?O.dts-o[M-1].dts:b;if(se=M>0?O.pts-o[M-1].pts:b,de.stretchShortVideoTrack&&this.nextAudioPts!==null){let Le=Math.floor(de.maxBufferHole*r),we=(s?m+s*r:this.nextAudioPts)-O.pts;we>Le?(u=we-ge,u<0?u=ge:P=!0,this.logger.log(`[mp4-remuxer]: It is approximately ${we/90} ms to the next segment; using duration ${u/90} ms for the last video frame.`)):u=ge}else u=ge}let oe=Math.round(O.pts-O.dts);U=Math.min(U,u),H=Math.max(H,u),q=Math.min(q,se),K=Math.max(K,se),a.push(rc(O.key,u,Z,oe))}if(a.length){if(ti){if(ti<70){let M=a[0].flags;M.dependsOn=2,M.isNonSync=0}}else if(rr&&K-q<H-U&&b/H<.025&&a[0].cts===0){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let M=f;for(let O=0,ee=a.length;O<ee;O++){let Z=M+a[O].duration,se=M+a[O].cts;if(O<ee-1){let oe=Z+a[O+1].cts;a[O].duration=oe-se}else a[O].duration=O?a[O-1].duration:b;a[O].cts=0,M=Z}}}u=P||!u?b:u,this.nextAvcDts=d=g+u,this.videoSampleDuration=u,this.isVideoContiguous=!0;let Y={data1:ei.moof(e.sequenceNumber++,f,fe(e,{samples:a})),data2:w,startPTS:m/r,endPTS:(v+u)/r,startDTS:f/r,endDTS:d/r,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,Y}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return hg;case"ac3":return ug;default:return dg}}remuxAudio(e,t,i,s,r){let o=e.inputTimeScale,a=e.samplerate?e.samplerate:o,c=o/a,l=this.getSamplesPerFrame(e),d=l*c,h=this._initPTS,u=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,f=[],g=r!==void 0,m=e.samples,v=u?0:8,y=this.nextAudioPts||-1,T=t*o,S=h.baseTime*o/h.timescale;if(this.isAudioContiguous=i=i||m.length&&y>0&&(s&&Math.abs(T-y)<9e3||Math.abs(Ye(m[0].pts-S,T)-y)<20*d),m.forEach(function(V){V.pts=Ye(V.pts-S,T)}),!i||y<0){if(m=m.filter(V=>V.pts>=0),!m.length)return;r===0?y=0:s&&!g?y=Math.max(0,T):y=m[0].pts}if(e.segmentCodec==="aac"){let V=this.config.maxAudioFramesDrift;for(let j=0,Y=y;j<m.length;j++){let M=m[j],O=M.pts,ee=O-Y,Z=Math.abs(1e3*ee/o);if(ee<=-V*d&&g)j===0&&(this.logger.warn(`Audio frame @ ${(O/o).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*ee/o)} ms.`),this.nextAudioPts=y=Y=O);else if(ee>=V*d&&Z<cg&&g){let se=Math.round(ee/d);Y=O-se*d,Y<0&&(se--,Y+=d),j===0&&(this.nextAudioPts=y=Y),this.logger.warn(`[mp4-remuxer]: Injecting ${se} audio frame @ ${(Y/o).toFixed(3)}s due to ${Math.round(1e3*ee/o)} ms gap.`);for(let oe=0;oe<se;oe++){let de=Math.max(Y,0),ge=Gr.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);ge||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),ge=M.unit.subarray()),m.splice(j,0,{unit:ge,pts:de}),Y+=d,j++}}M.pts=Y,Y+=d}}let b=null,A=null,L,I=0,D=m.length;for(;D--;)I+=m[D].unit.byteLength;for(let V=0,j=m.length;V<j;V++){let Y=m[V],M=Y.unit,O=Y.pts;if(A!==null){let Z=f[V-1];Z.duration=Math.round((O-A)/c)}else if(i&&e.segmentCodec==="aac"&&(O=y),b=O,I>0){I+=v;try{L=new Uint8Array(I)}catch(Z){this.observer.emit(p.ERROR,p.ERROR,{type:z.MUX_ERROR,details:R.REMUX_ALLOC_ERROR,fatal:!1,error:Z,bytes:I,reason:`fail allocating audio mdat ${I}`});return}u||(new DataView(L.buffer).setUint32(0,I),L.set(ei.types.mdat,4))}else return;L.set(M,v);let ee=M.byteLength;v+=ee,f.push(rc(!0,l,ee,0)),A=O}let w=f.length;if(!w)return;let C=f[f.length-1];this.nextAudioPts=y=A+c*C.duration;let P=u?new Uint8Array(0):ei.moof(e.sequenceNumber++,b/c,fe({},e,{samples:f}));e.samples=[];let U=b/o,q=y/o,K={data1:P,data2:L,startPTS:U,endPTS:q,startDTS:U,endDTS:q,type:"audio",hasAudio:!0,hasVideo:!1,nb:w};return this.isAudioContiguous=!0,K}};function Ye(n,e){let t;if(e===null)return n;for(e<n?t=-8589934592:t=8589934592;Math.abs(n-e)>4294967296;)n+=t;return n}function fg(n){for(let e=0;e<n.length;e++)if(n[e].key)return e;return-1}function _d(n,e,t,i){let s=n.samples.length;if(!s)return;let r=n.inputTimeScale;for(let a=0;a<s;a++){let c=n.samples[a];c.pts=Ye(c.pts-t.baseTime*r/t.timescale,e*r)/r,c.dts=Ye(c.dts-i.baseTime*r/i.timescale,e*r)/r}let o=n.samples;return n.samples=[],{samples:o}}function Ed(n,e,t){let i=n.samples.length;if(!i)return;let s=n.inputTimeScale;for(let o=0;o<i;o++){let a=n.samples[o];a.pts=Ye(a.pts-t.baseTime*s/t.timescale,e*s)/s}n.samples.sort((o,a)=>o.pts-a.pts);let r=n.samples;return n.samples=[],{samples:r}}var Hr=class{constructor(e,t,i,s){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1,this.logger=s}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,i,s){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(Su(e,s)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}let s=this.initData=Pc(e);s.audio&&(t=oc(s.audio,pe.AUDIO,this.logger)),s.video&&(i=oc(s.video,pe.VIDEO,this.logger));let r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:t+","+i,supplemental:s.video.supplemental,initSegment:e,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,supplemental:s.video.supplemental,initSegment:e,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,s,r,o){var a,c;let{initPTS:l,lastEndTime:d}=this,h={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};G(d)||(d=this.lastEndTime=r||0);let u=t.samples;if(!(u!=null&&u.length))return h;let f={initPTS:void 0,timescale:void 0,trackId:void 0},g=this.initData;if((a=g)!=null&&a.length||(this.generateInitSegment(u),g=this.initData),!((c=g)!=null&&c.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),h;this.emitInitSegment&&(f.tracks=this.initTracks,this.emitInitSegment=!1);let m=xu(u,g,this.logger),v=g.audio?m[g.audio.id]:null,y=g.video?m[g.video.id]:null,T=xs(y,1/0),S=xs(v,1/0),b=xs(y,0,!0),A=xs(v,0,!0),L,I=r,D=0;if(v&&(!y||!l&&S<T||l&&l.trackId===g.audio.id)?(f.trackId=g.audio.id,L=v,D=A-S):y&&(f.trackId=g.video.id,L=y,D=b-T),L){let V=L.timescale;I=L.start/V,f.timescale=V,l||(f.initPTS=L.start-r*V,this.initPTS=l={baseTime:f.initPTS,timescale:V,trackId:f.trackId})}(o||!l)&&(gg(l,I,r,D)||f.timescale!==l.timescale)&&(f.initPTS=I-r,l&&l.timescale===1&&this.logger.warn(`Adjusting initPTS @${r} from ${l.baseTime/l.timescale} to ${f.initPTS}`),this.initPTS=l={baseTime:f.initPTS,timescale:1});let w=e?I-l.baseTime/l.timescale:d;Tu(g,u,l.baseTime/l.timescale);let C=w+D;D>0?this.lastEndTime=C:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());let P=!!g.audio,U=!!g.video,q="";P&&(q+="audio"),U&&(q+="video");let H={data1:u,startPTS:w,startDTS:w,endPTS:C,endDTS:C,type:q,hasAudio:P,hasVideo:U,nb:1,dropped:0};h.audio=P&&!U?H:void 0,h.video=U?H:void 0;let K=y?.sampleCount;if(K){let V=y.keyFrameIndex,j=V!==-1;H.nb=K,H.dropped=V===0||this.isVideoContiguous?0:j?V:K,H.independent=j,H.firstKeyFrame=V,j&&y.keyFrameStart&&(H.firstKeyFramePTS=y.keyFrameStart-l.baseTime/l.timescale),this.isVideoContiguous||(h.independent=j),this.isVideoContiguous||(this.isVideoContiguous=j),H.dropped&&this.logger.warn(`fmp4 does not start with IDR: firstIDR ${V}/${K} dropped: ${H.dropped} pts: ${H.firstKeyFramePTS||"NA"}`)}return h.initSegment=f,h.id3=_d(i,r,l,l),s.samples.length&&(h.text=Ed(s,r,l)),h}};function xs(n,e,t=!1){return n?.start!==void 0?(n.start+(t?n.duration:0))/n.timescale:e}function gg(n,e,t,i){if(n===null)return!0;let s=Math.max(i,1),r=e-n.baseTime/n.timescale;return Math.abs(r-t)>s}function oc(n,e,t){let i=n?.codec;return i&&i.length>4?i:e===pe.AUDIO?i==="ec-3"||i==="ac-3"||i==="alac"?i:i==="fLaC"||i==="Opus"?Ns(i,!1):(t.warn(`Unhandled audio codec "${i}" in mp4 MAP`),i||"mp4a"):(t.warn(`Unhandled video codec "${i}" in mp4 MAP`),i||"avc1")}var Et;try{Et=self.performance.now.bind(self.performance)}catch{Et=Date.now}var Ls=[{demux:Nr,remux:Hr},{demux:Ur,remux:oi},{demux:Mr,remux:oi},{demux:Fr,remux:oi}];Ls.splice(2,0,{demux:Or,remux:oi});var Zs=class{constructor(e,t,i,s,r,o){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=r,this.logger=o}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,s){let r=i.transmuxing;r.executeStart=Et();let o=new Uint8Array(e),{currentTransmuxState:a,transmuxConfig:c}=this;s&&(this.currentTransmuxState=s);let{contiguous:l,discontinuity:d,trackSwitch:h,accurateTimeOffset:u,timeOffset:f,initSegmentChange:g}=s||a,{audioCodec:m,videoCodec:v,defaultInitPts:y,duration:T,initSegmentData:S}=c,b=pg(o,t);if(b&&ri(b.method)){let D=this.getDecrypter(),w=Oo(b.method);if(D.isSync()){let C=D.softwareDecrypt(o,b.key.buffer,b.iv.buffer,w);if(i.part>-1){let U=D.flush();C=U&&U.buffer}if(!C)return r.executeEnd=Et(),or(i);o=new Uint8Array(C)}else return this.asyncResult=!0,this.decryptionPromise=D.webCryptoDecrypt(o,b.key.buffer,b.iv.buffer,w).then(C=>{let P=this.push(C,null,i);return this.decryptionPromise=null,P}),this.decryptionPromise}let A=this.needsProbing(d,h);if(A){let D=this.configureTransmuxer(o);if(D)return this.logger.warn(`[transmuxer] ${D.message}`),this.observer.emit(p.ERROR,p.ERROR,{type:z.MEDIA_ERROR,details:R.FRAG_PARSING_ERROR,fatal:!1,error:D,reason:D.message}),r.executeEnd=Et(),or(i)}(d||h||g||A)&&this.resetInitSegment(S,m,v,T,t),(d||g||A)&&this.resetInitialTimestamp(y),l||this.resetContiguity();let L=this.transmux(o,b,f,u,i);this.asyncResult=Wi(L);let I=this.currentTransmuxState;return I.contiguous=!0,I.discontinuity=!1,I.trackSwitch=!1,r.executeEnd=Et(),L}flush(e){let t=e.transmuxing;t.executeStart=Et();let{decrypter:i,currentTransmuxState:s,decryptionPromise:r}=this;if(r)return this.asyncResult=!0,r.then(()=>this.flush(e));let o=[],{timeOffset:a}=s;if(i){let h=i.flush();h&&o.push(this.push(h.buffer,null,e))}let{demuxer:c,remuxer:l}=this;if(!c||!l){t.executeEnd=Et();let h=[or(e)];return this.asyncResult?Promise.resolve(h):h}let d=c.flush(a);return Wi(d)?(this.asyncResult=!0,d.then(h=>(this.flushRemux(o,h,e),o))):(this.flushRemux(o,d,e),this.asyncResult?Promise.resolve(o):o)}flushRemux(e,t,i){let{audioTrack:s,videoTrack:r,id3Track:o,textTrack:a}=t,{accurateTimeOffset:c,timeOffset:l}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===W.MAIN?"level":"track"} ${i.level}`);let d=this.remuxer.remux(s,r,o,a,l,c,!0,this.id);e.push({remuxResult:d,chunkMeta:i}),i.transmuxing.executeEnd=Et()}resetInitialTimestamp(e){let{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){let{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,s,r){let{demuxer:o,remuxer:a}=this;!o||!a||(o.resetInitSegment(e,t,i,s),a.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,s,r){let o;return t&&t.method==="SAMPLE-AES"?o=this.transmuxSampleAes(e,t,i,s,r):o=this.transmuxUnencrypted(e,i,s,r),o}transmuxUnencrypted(e,t,i,s){let{audioTrack:r,videoTrack:o,id3Track:a,textTrack:c}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,o,a,c,t,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(e,t,i,s,r){return this.demuxer.demuxSampleAes(e,t,i).then(o=>({remuxResult:this.remuxer.remux(o.audioTrack,o.videoTrack,o.id3Track,o.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){let{config:t,observer:i,typeSupported:s}=this,r;for(let h=0,u=Ls.length;h<u;h++){var o;if((o=Ls[h].demux)!=null&&o.probe(e,this.logger)){r=Ls[h];break}}if(!r)return new Error("Failed to find demuxer by probing fragment data");let a=this.demuxer,c=this.remuxer,l=r.remux,d=r.demux;(!c||!(c instanceof l))&&(this.remuxer=new l(i,t,s,this.logger)),(!a||!(a instanceof d))&&(this.demuxer=new d(i,t,s,this.logger),this.probe=d.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Ui(this.config)),e}};function pg(n,e){let t=null;return n.byteLength>0&&e?.key!=null&&e.iv!==null&&e.method!=null&&(t=e),t}var or=n=>({remuxResult:{},chunkMeta:n});function Wi(n){return"then"in n&&n.then instanceof Function}var Kr=class{constructor(e,t,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}},jr=class{constructor(e,t,i,s,r,o){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=o}},ac=0,Js=class{constructor(e,t,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=ac++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=c=>{let l=c.data,d=this.hls;if(!(!d||!(l!=null&&l.event)||l.instanceNo!==this.instanceNo))switch(l.event){case"init":{var h;let u=(h=this.workerContext)==null?void 0:h.objectURL;u&&self.URL.revokeObjectURL(u);break}case"transmuxComplete":{this.handleTransmuxComplete(l.data);break}case"flush":{this.onFlush(l.data);break}case"workerLog":{d.logger[l.data.logType]&&d.logger[l.data.logType](l.data.message);break}default:{l.data=l.data||{},l.data.frag=this.frag,l.data.part=this.part,l.data.id=this.id,d.trigger(l.event,l.data);break}}},this.onWorkerError=c=>{if(!this.hls)return;let l=new Error(`${c.message}  (${c.filename}:${c.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:l})};let r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;let o=(c,l)=>{l=l||{},l.frag=this.frag||void 0,c===p.ERROR&&(l=l,l.parent=this.id,l.part=this.part,this.error=l.error),this.hls.trigger(c,l)};this.observer=new No,this.observer.on(p.FRAG_DECRYPTED,o),this.observer.on(p.ERROR,o);let a=Cl(r.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){let c=this.hls.logger;if(r.workerPath||Lf()){try{r.workerPath?(c.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=kf(r.workerPath)):(c.log(`injecting Web Worker for "${t}"`),this.workerContext=wf());let{worker:d}=this.workerContext;d.addEventListener("message",this.onWorkerMessage),d.addEventListener("error",this.onWorkerError),d.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:me(r)})}catch(d){c.warn(`Error setting up "${t}" Web Worker, fallback to inline`,d),this.terminateWorker(),this.error=null,this.transmuxer=new Zs(this.observer,a,r,"",t,e.logger)}return}}this.transmuxer=new Zs(this.observer,a,r,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){let e=this.instanceNo;this.instanceNo=ac++;let t=this.hls.config,i=Cl(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:me(t)})}}terminateWorker(){if(this.workerContext){let{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),Pf(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{let t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}let e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,s,r,o,a,c,l,d){var h,u;l.transmuxing.start=self.performance.now();let{instanceNo:f,transmuxer:g}=this,m=o?o.start:r.start,v=r.decryptdata,y=this.frag,T=!(y&&r.cc===y.cc),S=!(y&&l.level===y.level),b=y?l.sn-y.sn:-1,A=this.part?l.part-this.part.index:-1,L=b===0&&l.id>1&&l.id===y?.stats.chunkCount,I=!S&&(b===1||b===0&&(A===1||L&&A<=0)),D=self.performance.now();(S||b||r.stats.parsing.start===0)&&(r.stats.parsing.start=D),o&&(A||!I)&&(o.stats.parsing.start=D);let w=!(y&&((h=r.initSegment)==null?void 0:h.url)===((u=y.initSegment)==null?void 0:u.url)),C=new jr(T,I,c,S,m,w);if(!I||T||w){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${r.type} sn: ${l.sn}${l.part>-1?" part: "+l.part:""} ${this.id===W.MAIN?"level":"track"}: ${l.level} id: ${l.id}
        discontinuity: ${T}
        trackSwitch: ${S}
        contiguous: ${I}
        accurateTimeOffset: ${c}
        timeOffset: ${m}
        initSegmentChange: ${w}`);let P=new Kr(i,s,t,a,d);this.configureTransmuxer(P)}if(this.frag=r,this.part=o,this.workerContext)this.workerContext.worker.postMessage({instanceNo:f,cmd:"demux",data:e,decryptdata:v,chunkMeta:l,state:C},e instanceof ArrayBuffer?[e]:[]);else if(g){let P=g.push(e,v,l,C);Wi(P)?P.then(U=>{this.handleTransmuxComplete(U)}).catch(U=>{this.transmuxerError(U,l,"transmuxer-interface push error")}):this.handleTransmuxComplete(P)}}flush(e){e.transmuxing.start=self.performance.now();let{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){let s=i.flush(e);Wi(s)?s.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")}):this.handleFlushResult(s,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){let{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}},lc=100,Wr=class extends Gi{constructor(e,t,i){super(e,t,i,"audio-stream-controller",W.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();let{hls:e}=this;e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(p.BUFFER_RESET,this.onBufferReset,this),e.on(p.BUFFER_CREATED,this.onBufferCreated,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(p.FRAG_LOADING,this.onFragLoading,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){let{hls:e}=this;e&&(super.unregisterListeners(),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(p.BUFFER_RESET,this.onBufferReset,this),e.off(p.BUFFER_CREATED,this.onBufferCreated,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(p.FRAG_LOADING,this.onFragLoading,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){if(i===W.MAIN){let o=t.cc,a=this.fragCurrent;if(this.initPTS[o]={baseTime:s,timescale:r},this.log(`InitPTS for cc: ${o} found from main: ${s}/${r}`),this.mainAnchor=t,this.state===k.WAITING_INIT_PTS){let c=this.waitingData;(!c&&!this.loadingParts||c&&c.frag.cc!==o)&&this.syncWithAnchor(t,c?.frag)}else!this.hls.hasEnoughToStart&&a&&a.cc!==o?(a.abortRequests(),this.syncWithAnchor(t,a)):this.state===k.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var i;let s=((i=this.mainFragLoading)==null?void 0:i.frag)||null;if(t&&s?.cc===t.cc)return;let r=(s||e).cc,o=this.getLevelDetails(),a=this.getLoadPosition(),c=jc(o,r,a);c&&(this.log(`Waiting fragment cc (${t?.cc}) cancelled because video is at cc ${e.cc}`),this.startFragRequested=!1,this.nextLoadPosition=c.start,this.resetLoadingState(),this.state===k.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=k.STOPPED;return}let i=this.lastCurrentTime;this.stopLoad(),this.setInterval(lc),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=k.IDLE):this.state=k.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case k.IDLE:this.doTickIdle();break;case k.WAITING_TRACK:{let{levels:t,trackId:i}=this,s=t?.[i],r=s?.details;if(r&&!this.waitForLive(s)){if(this.waitForCdnTuneIn(r))break;this.state=k.WAITING_INIT_PTS}break}case k.FRAG_LOADING_WAITING_RETRY:{var e;let t=performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){let{levels:s,trackId:r}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(s?.[r]||null),this.state=k.IDLE}break}case k.WAITING_INIT_PTS:{let t=this.waitingData;if(t){let{frag:i,part:s,cache:r,complete:o}=t,a=this.mainAnchor;if(this.initPTS[i.cc]!==void 0){this.waitingData=null,this.state=k.FRAG_LOADING;let c=r.flush().buffer,l={frag:i,part:s,payload:c,networkDetails:null};this._handleFragmentLoadProgress(l),o&&super._handleFragmentLoadComplete(l)}else a&&a.cc!==t.frag.cc&&this.syncWithAnchor(a,t.frag)}else this.state=k.IDLE}}this.onTickEnd()}resetLoadingState(){let e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){let{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;let{hls:t,levels:i,media:s,trackId:r}=this,o=t.config;if(!this.buffering||!s&&!this.primaryPrefetch&&(this.startFragRequested||!o.startFragPrefetch)||!(i!=null&&i[r]))return;let a=i[r],c=a.details;if(!c||this.waitForLive(a)||this.waitForCdnTuneIn(c)){this.state=k.WAITING_TRACK,this.startFragRequested=!1;return}let l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,pe.AUDIO,W.AUDIO));let d=this.getFwdBufferInfo(l,W.AUDIO);if(d===null)return;if(!this.switchingTrack&&this._streamEnded(d,c)){t.trigger(p.BUFFER_EOS,{type:"audio"}),this.state=k.ENDED;return}let h=d.len,u=t.maxBufferLength,f=c.fragments,g=f[0].start,m=this.getLoadPosition(),v=this.flushing?m:d.end;if(this.switchingTrack&&s){let S=m;c.PTSKnown&&S<g&&(d.end>g||d.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),s.currentTime=g+.05)}if(h>=u&&!this.switchingTrack&&v<f[f.length-1].start)return;let y=this.getNextFragment(v,c);if(y&&this.isLoopLoading(y,v)&&(y=this.getNextFragmentLoopLoading(y,c,d,W.MAIN,u)),!y){this.bufferFlushed=!0;return}let T=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&T&&Ce(y)&&!y.endList&&(!c.live||!this.loadingParts&&v<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(T)===xe.OK&&(this.mainFragLoading=T=null),T&&Ce(T))){if(y.start>T.end){let b=this.fragmentTracker.getFragAtPos(v,W.MAIN);b&&b.end>T.end&&(T=b,this.mainFragLoading={frag:b,targetBufferTime:null})}if(y.start>T.end)return}this.loadFragment(y,a,v)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new jt(i))}onAudioTrackSwitching(e,t){let i=!!t.url;this.trackId=t.id;let{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==k.STOPPED&&(this.setInterval(lc),this.state=k.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;let i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(p.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;let{levels:s}=this,{details:r,id:o,groupId:a,track:c}=t;if(!s){this.warn(`Audio tracks reset while loading track ${o} "${c.name}" of "${a}"`);return}let l=this.mainDetails;if(!l||r.endCC>l.endCC||l.expired){this.cachedTrackLoadedData=t,this.state!==k.STOPPED&&(this.state=k.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${o} "${c.name}" of "${a}" loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);let d=s[o],h=0;if(r.live||(i=d.details)!=null&&i.live){if(this.checkLiveUpdate(r),r.deltaUpdateFailed)return;if(d.details){var u;h=this.alignPlaylists(r,d.details,(u=this.levelLastLoaded)==null?void 0:u.details)}r.alignedSliding||(sd(r,l),r.alignedSliding||Ws(r,l),h=r.fragmentStart)}d.details=r,this.levelLastLoaded=d,this.startFragRequested||this.setStartPosition(l,h),this.hls.trigger(p.AUDIO_TRACK_UPDATED,{details:r,id:o,groupId:t.groupId}),this.state===k.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=k.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;let i=e.frag,{part:s,payload:r}=e,{config:o,trackId:a,levels:c}=this;if(!c){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}let l=c[a];if(!l){this.warn("Audio track is undefined on fragment load progress");return}let d=l.details;if(!d){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}let h=o.defaultAudioCodec||l.audioCodec||"mp4a.40.2",u=this.transmuxer;u||(u=this.transmuxer=new Js(this.hls,W.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));let f=this.initPTS[i.cc],g=(t=i.initSegment)==null?void 0:t.data;if(f!==void 0){let v=s?s.index:-1,y=v!==-1,T=new Vi(i.level,i.sn,i.stats.chunkCount,r.byteLength,v,y);u.push(r,g,h,"",i,s,d.totalduration,!1,T,f)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${d.startSN} ,${d.endSN}],track ${a}`);let{cache:m}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new Ys,complete:!1};m.push(new Uint8Array(r)),this.state!==k.STOPPED&&(this.state=k.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;let i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===W.MAIN&&Ce(t.frag)&&(this.mainFragLoading=t,this.state===k.IDLE&&this.tick())}onFragBuffered(e,t){let{frag:i,part:s}=t;if(i.type!==W.AUDIO){!this.audioOnly&&i.type===W.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(Ce(i)){this.fragPrevious=i;let r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(p.AUDIO_TRACK_SWITCHED,he({},r)))}this.fragBufferedComplete(i,s),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=k.ERROR;return}switch(t.details){case R.FRAG_GAP:case R.FRAG_PARSING_ERROR:case R.FRAG_DECRYPT_ERROR:case R.FRAG_LOAD_ERROR:case R.FRAG_LOAD_TIMEOUT:case R.KEY_LOAD_ERROR:case R.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(W.AUDIO,t);break;case R.AUDIO_TRACK_LOAD_ERROR:case R.AUDIO_TRACK_LOAD_TIMEOUT:case R.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===k.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===ne.AUDIO_TRACK&&(this.state=k.IDLE);break;case R.BUFFER_ADD_CODEC_ERROR:case R.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.resetLoadingState();break;case R.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case R.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==pe.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==pe.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===k.ENDED&&(this.state=k.IDLE);let i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,W.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;let i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}let{frag:c,part:l,level:d}=a,{details:h}=d,{audio:u,text:f,id3:g,initSegment:m}=r;if(this.fragContextChanged(c)||!h){this.fragmentTracker.removeFragment(c);return}if(this.state=k.PARSING,this.switchingTrack&&u&&this.completeAudioSwitch(this.switchingTrack),m!=null&&m.tracks){let v=c.initSegment||c;this._bufferInitSegment(d,m.tracks,v,o),s.trigger(p.FRAG_PARSING_INIT_SEGMENT,{frag:v,id:i,tracks:m.tracks})}if(u){let{startPTS:v,endPTS:y,startDTS:T,endDTS:S}=u;l&&(l.elementaryStreams[pe.AUDIO]={startPTS:v,endPTS:y,startDTS:T,endDTS:S}),c.setElementaryStreamInfo(pe.AUDIO,v,y,T,S),this.bufferFragmentData(u,c,l,o)}if(g!=null&&(t=g.samples)!=null&&t.length){let v=fe({id:i,frag:c,details:h},g);s.trigger(p.FRAG_PARSING_METADATA,v)}if(f){let v=fe({id:i,frag:c,details:h},f);s.trigger(p.FRAG_PARSING_USERDATA,v)}}_bufferInitSegment(e,t,i,s){if(this.state!==k.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;let r=t.audio;r.id=W.AUDIO;let o=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${o}/${r.codec}]`),o&&o.split(",").length===1&&(r.levelCodec=o),this.hls.trigger(p.BUFFER_CODECS,t);let a=r.initSegment;if(a!=null&&a.byteLength){let c={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:a};this.hls.trigger(p.BUFFER_APPENDING,c)}this.tickImmediate()}loadFragment(e,t,i){let s=this.fragmentTracker.getState(e);if(this.switchingTrack||s===xe.NOT_LOADED||s===xe.PARTIAL){var r;if(!Ce(e))this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=k.WAITING_INIT_PTS;let o=this.mainDetails;o&&o.fragmentStart!==t.details.fragmentStart&&Ws(t.details,o)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){let{name:t,lang:i,assocLang:s,characteristics:r,audioCodec:o,channels:a}=this.bufferedTrack;Ht({name:t,lang:i,assocLang:s,characteristics:r,audioCodec:o,channels:a},e,$t)||(Vs(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){let{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(p.AUDIO_TRACK_SWITCHED,he({},e))}},Yi=class extends rt{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){let s=t?.renditionReports;if(s){let r=-1;for(let o=0;o<s.length;o++){let a=s[o],c;try{c=new self.URL(a.URI,t.url).href}catch(l){this.warn(`Could not construct new URL for Rendition Report: ${l}`),c=a.URI||""}if(c===e){r=o;break}else c===e.substring(0,c.length)&&(r=o)}if(r!==-1){let o=s[r],a=parseInt(o["LAST-MSN"])||t?.lastPartSn,c=parseInt(o["LAST-PART"])||t?.lastPartIndex;if(this.hls.config.lowLatencyMode){let d=Math.min(t.age-t.partTarget,t.targetduration);c>=0&&d>t.partTarget&&(c+=1)}let l=i&&Rl(i);return new Us(a,c>=0?c:void 0,l)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){let{details:s,stats:r}=t,o=self.performance.now(),a=r.loading.first?Math.max(0,o-r.loading.first):0;s.advancedDateTime=Date.now()-a;let c=this.hls.config.timelineOffset;if(c!==s.appliedTimelineOffset){let d=Math.max(c||0,0);s.appliedTimelineOffset=d,s.fragments.forEach(h=>{h.start=h.playlistOffset+d})}if(s.live||i!=null&&i.live){let d="levelInfo"in t?t.levelInfo:t.track;if(s.reloaded(i),i&&s.fragments.length>0){Ef(i,s);let T=s.playlistParsingError;if(T){this.warn(T);let S=this.hls;if(!S.config.ignorePlaylistParsingErrors){var l;let{networkDetails:b}=t;S.trigger(p.ERROR,{type:z.NETWORK_ERROR,details:R.LEVEL_PARSING_ERROR,fatal:!1,url:s.url,error:T,reason:T.message,level:t.level||void 0,parent:(l=s.fragments[0])==null?void 0:l.type,networkDetails:b,stats:r});return}s.playlistParsingError=null}}s.requestScheduled===-1&&(s.requestScheduled=r.loading.start);let h=this.hls.mainForwardBufferInfo,u=h?h.end-h.len:0,f=(s.edge-u)*1e3,g=Zc(s,f);if(s.requestScheduled+g<o?s.requestScheduled=o:s.requestScheduled+=g,this.log(`live playlist ${e} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),!this.canLoad||!s.live)return;let m,v,y;if(s.canBlockReload&&s.endSN&&s.advanced){let T=this.hls.config.lowLatencyMode,S=s.lastPartSn,b=s.endSN,A=s.lastPartIndex,L=A!==-1,I=S===b;L?I?(v=b+1,y=T?0:A):(v=S,y=T?A+1:s.maxPartIndex):v=b+1;let D=s.age,w=D+s.ageHeader,C=Math.min(w-s.partTarget,s.targetduration*1.5);if(C>0){if(w>s.targetduration*3)this.log(`Playlist last advanced ${D.toFixed(2)}s ago. Omitting segment and part directives.`),v=void 0,y=void 0;else if(i!=null&&i.tuneInGoal&&w-s.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${C} with playlist age: ${s.age}`),C=0;else{let P=Math.floor(C/s.targetduration);if(v+=P,y!==void 0){let U=Math.round(C%s.targetduration/s.partTarget);y+=U}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${D.toFixed(2)}s goal: ${C} skip sn ${P} to part ${y}`)}s.tuneInGoal=C}if(m=this.getDeliveryDirectives(s,t.deliveryDirectives,v,y),T||!I){s.requestScheduled=o,this.loadingPlaylist(d,m);return}}else(s.canBlockReload||s.canSkipUntil)&&(m=this.getDeliveryDirectives(s,t.deliveryDirectives,v,y));m&&v!==void 0&&s.canBlockReload&&(s.requestScheduled=r.loading.first+Math.max(g-a*2,g/2)),this.scheduleLoading(d,m,s)}else this.clearTimer()}scheduleLoading(e,t,i){let s=i||e.details;if(!s){this.loadingPlaylist(e,t);return}let r=self.performance.now(),o=s.requestScheduled;if(r>=o){this.loadingPlaylist(e,t);return}let a=o-r;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,i,s){let r=Rl(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,r=Ds.No),new Us(i,s,r)}checkRetry(e){let t=e.details,i=$s(e),s=e.errorAction,{action:r,retryCount:o=0,retryConfig:a}=s||{},c=!!s&&!!a&&(r===De.RetryRequest||!s.resolved&&r===De.SendAlternateToPenaltyBox);if(c){var l;if(o>=a.maxNumRetry)return!1;if(i&&(l=e.context)!=null&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{let d=Mo(a,o);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),d),this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" in ${d}ms`)}e.levelRetry=!0,s.resolved=!0}return c}};function Sd(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(!zi(n[t].attrs,e[t].attrs))return!1;return!0}function zi(n,e,t){let i=n["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(s=>n[s]!==e[s])}function Yr(n,e){return e.label.toLowerCase()===n.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(n.lang||"").toLowerCase())}var zr=class extends Yi{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){let{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADING,this.onLevelLoading,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(p.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){let{id:i,groupId:s,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==s){this.warn(`Audio track with id:${i} and group:${s} not found in active group ${o?.groupId}`);return}let a=o.details;o.details=t.details,this.log(`Audio track ${i} "${o.name}" lang:${o.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){let t=this.hls.levels[e];if(!t)return;let i=t.audioGroups||null,s=this.groupIds,r=this.currentTrack;if(!i||s?.length!==i?.length||i!=null&&i.some(a=>s?.indexOf(a)===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;let a=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(u=>u.default)&&(this.selectDefaultTrack=!1),a.forEach((u,f)=>{u.id=f});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;let c=this.hls.config.audioPreference;if(!r&&c){let u=ut(c,a,$t);if(u>-1)r=a[u];else{let f=ut(c,this.tracks);r=this.tracks[f]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));let d={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${i?.join(",")}`),this.hls.trigger(p.AUDIO_TRACKS_UPDATED,d);let h=this.trackId;if(l!==-1&&h===-1)this.setAudioTrack(l);else if(a.length&&h===-1){var o;let u=new Error(`No audio track selected for current audio group-ID(s): ${(o=this.groupIds)==null?void 0:o.join(",")} track count: ${a.length}`);this.warn(u.message),this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:u})}}}onError(e,t){t.fatal||!t.context||t.context.type===ne.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){let t=this.hls;if(t.config.audioPreference=e,e){let i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){let s=this.currentTrack;if(s&&Ht(e,s,$t))return s;let r=ut(e,this.tracksInGroup,$t);if(r>-1){let o=this.tracksInGroup[r];return this.setAudioTrack(r),o}else if(s){let o=t.loadLevel;o===-1&&(o=t.firstAutoLevel);let a=Yu(e,t.levels,i,o,$t);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){let o=ut(e,i);if(o>-1)return i[o]}}}return null}setAudioTrack(e){let t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;let i=this.currentTrack,s=t[e],r=s.details&&!s.details.live;if(e===this.trackId&&s===i&&r||(this.log(`Switching to audio-track ${e} "${s.name}" lang:${s.lang} group:${s.groupId} channels:${s.channels}`),this.trackId=e,this.currentTrack=s,this.hls.trigger(p.AUDIO_TRACK_SWITCHING,he({},s)),r))return;let o=this.switchParams(s.url,i?.details,s.details);this.loadPlaylist(o)}findTrackId(e){let t=this.tracksInGroup;for(let i=0;i<t.length;i++){let s=t[i];if(!(this.selectDefaultTrack&&!s.default)&&(!e||Ht(e,s,$t)))return i}if(e){let{name:i,lang:s,assocLang:r,characteristics:o,audioCodec:a,channels:c}=e;for(let l=0;l<t.length;l++){let d=t[l];if(Ht({name:i,lang:s,assocLang:r,characteristics:o,audioCodec:a,channels:c},d,$t))return l}for(let l=0;l<t.length;l++){let d=t[l];if(zi(e.attrs,d.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<t.length;l++){let d=t[l];if(zi(e.attrs,d.attrs,["LANGUAGE"]))return l}}return-1}loadPlaylist(e){super.loadPlaylist();let t=this.currentTrack;this.shouldLoadPlaylist(t)&&Vs(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);let i=e.id,s=e.groupId,r=this.getUrlWithDirectives(e.url,t),o=e.details,a=o?.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${s}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${r}`),this.hls.trigger(p.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:t||null,track:e})}},qr=class{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;let s=this.queues[t];s.push(e),s.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{let i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){let i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;let i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;let t=this.queues[e];if(t.length){let s=t[0];try{s.execute()}catch(r){var i;if(s.onError(r),this.queues===null||this.tracks===null)return;let o=(i=this.tracks[e])==null?void 0:i.buffer;o!=null&&o.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){let{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;let i=(t=this.tracks)==null?void 0:t[e],s=i?.buffer;return s?`SourceBuffer${s.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}},cc=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,xd="HlsJsTrackRemovedError",Xr=class extends Error{constructor(e){super(e),this.name=xd}},Qr=class extends rt{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var s;this.hls&&((s=this.mediaSource)==null?void 0:s.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{let{media:s,mediaSource:r}=this;i&&this.log("Media source opened"),!(!s||!r)&&(r.removeEventListener("sourceopen",this._onMediaSourceOpen),s.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(p.MEDIA_ATTACHED,{media:s,mediaSource:r}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{let{mediaSrc:i,_objectUrl:s}=this;i!==s&&this.error(`Media element src was set while attaching MediaSource (${s} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=uu(Dt(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){let{hls:e}=this;e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.BUFFER_RESET,this.onBufferReset,this),e.on(p.BUFFER_APPENDING,this.onBufferAppending,this),e.on(p.BUFFER_CODECS,this.onBufferCodecs,this),e.on(p.BUFFER_EOS,this.onBufferEos,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(p.FRAG_PARSED,this.onFragParsed,this),e.on(p.FRAG_CHANGED,this.onFragChanged,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.BUFFER_RESET,this.onBufferReset,this),e.off(p.BUFFER_APPENDING,this.onBufferAppending,this),e.off(p.BUFFER_CODECS,this.onBufferCodecs,this),e.off(p.BUFFER_EOS,this.onBufferEos,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(p.FRAG_PARSED,this.onFragParsed,this),e.off(p.FRAG_CHANGED,this.onFragChanged,this),e.off(p.ERROR,this.onError,this)}transferMedia(){let{media:e,mediaSource:t}=this;if(!e)return null;let i={};if(this.operationQueue){let r=this.isUpdating();r||this.operationQueue.removeBlockers();let o=this.isQueued();(r||o)&&this.warn(`Transfering MediaSource with${o?" operations in queue":""}${r?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}let s=this.transferData;return!this.sourceBufferCount&&s&&s.mediaSource===t?fe(i,s.tracks):this.sourceBuffers.forEach(r=>{let[o]=r;o&&(i[o]=fe({},this.tracks[o]),this.removeBuffer(o)),r[0]=r[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){let e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let s=2;(t.audio&&!t.video||!t.altAudio)&&(s=1),this.bufferCodecEventsTotal=s,this.log(`${s} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&s&&this.bufferCreated()}onMediaAttaching(e,t){let i=this.media=t.media,s=Dt(this.appendSource);if(this.transferData=this.overrides=void 0,i&&s){let r=!!t.mediaSource;(r||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);let o=this.mediaSource=t.mediaSource||new s;if(this.assignMediaSource(o),r)this._objectUrl=i.src,this.attachTransferred();else{let a=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{i.removeAttribute("src");let c=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||c&&o instanceof c,dc(i),mg(i,a),i.load()}catch{i.src=a}else i.src=a}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){let e=this.media,t=this.transferData;if(!t||!e)return;let i=this.tracks,s=t.tracks,r=s?Object.keys(s):null,o=r?r.length:0,a=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(s&&r&&o){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${me(i,(c,l)=>c==="initSegment"?void 0:l)};
transfer tracks: ${me(s,(c,l)=>c==="initSegment"?void 0:l)}}`),!Dc(s,i)){t.mediaSource=null,t.tracks=void 0;let c=e.currentTime,l=this.details,d=Math.max(c,l?.fragments[0].start||0);if(d-c>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${c} -> ${d}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(s)}"->"${Object.keys(i)}") start time: ${d} currentTime: ${c}`),this.onMediaDetaching(p.MEDIA_DETACHING,{}),this.onMediaAttaching(p.MEDIA_ATTACHING,t),e.currentTime=d;return}this.transferData=void 0,r.forEach(c=>{let l=c,d=s[l];if(d){let h=d.buffer;if(h){let u=this.fragmentTracker,f=d.id;if(u.hasFragments(f)||u.hasParts(f)){let v=ie.getBuffered(h);u.detectEvictedFragments(l,v,f,null,!0)}let g=ar(l),m=[l,h];this.sourceBuffers[g]=m,h.updating&&this.operationQueue&&this.operationQueue.prependBlocker(l),this.trackSourceBuffer(l,d)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;let t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){let i=!!t.transferMedia;this.transferData=this.overrides=void 0;let{media:s,mediaSource:r,_objectUrl:o}=this;if(r){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){let a=r.readyState==="open";try{let c=r.sourceBuffers;for(let l=c.length;l--;)a&&c[l].abort(),r.removeSourceBuffer(c[l]);a&&r.endOfStream()}catch(c){this.warn(`onMediaDetaching: ${c.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(r.removeEventListener("startstreaming",this._onStartStreaming),r.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}s&&(s.removeEventListener("emptied",this._onMediaEmptied),i||(o&&self.URL.revokeObjectURL(o),this.mediaSrc===o?(s.removeAttribute("src"),this.appendSource&&dc(s),s.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(p.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;let i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var s;(s=this.mediaSource)!=null&&s.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(r){this.warn(`onBufferReset ${e}`,r)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[ar(e)]=[null,null];let t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new qr(this.tracks)}onBufferCodecs(e,t){let i=this.tracks,s=Object.keys(t);this.log(`BUFFER_CODECS: "${s}" (current SB count ${this.sourceBufferCount})`);let r="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),o=!r&&this.sourceBufferCount&&this.media&&s.some(a=>!i[a]);if(r||o){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${s}" SourceBuffers`);return}s.forEach(a=>{var c,l,d;let h=t[a],{id:u,codec:f,levelCodec:g,container:m,metadata:v,supplemental:y}=h,T=i[a],S=(c=this.transferData)==null||(l=c.tracks)==null?void 0:l[a],b=S!=null&&S.buffer?S:T,A=b?.pendingCodec||b?.codec,L=b?.levelCodec;T||(T=i[a]={buffer:void 0,listeners:[],codec:f,supplemental:y,container:m,levelCodec:g,metadata:v,id:u});let I=Cs(A,L),D=I?.replace(cc,"$1"),w=Cs(f,g),C=(d=w)==null?void 0:d.replace(cc,"$1");w&&I&&D!==C&&(a.slice(0,5)==="audio"&&(w=Ns(w,this.appendSource)),this.log(`switching codec ${A} to ${w}`),w!==(T.pendingCodec||T.codec)&&(T.pendingCodec=w),T.container=m,this.appendChangeType(a,m,w))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{let i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){let s=`${t};codecs=${i}`,r={label:`change-type=${s}`,execute:()=>{let o=this.tracks[e];if(o){let a=o.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${s}`),a.changeType(s),o.codec=i,o.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn(`Failed to change ${e} SourceBuffer type`,o)}};this.append(r,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;let i=e.start,s=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,W.MAIN))==null?void 0:t.gap)===!0)return;let o={label:"block-audio",execute:()=>{var a;let c=this.tracks.video;(this.lastVideoAppendEnd>s||c!=null&&c.buffer&&ie.isBuffered(c.buffer,s)||((a=this.fragmentTracker.getAppendedFrag(s,W.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:o,frag:e},this.append(o,"audio",!0)}unblockAudio(){let{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){let{tracks:i}=this,{data:s,type:r,parent:o,frag:a,part:c,chunkMeta:l}=t,d=l.buffering[r],h=a.sn,u=self.performance.now();d.start=u;let f=a.stats.buffering,g=c?c.stats.buffering:null;f.start===0&&(f.start=u),g&&g.start===0&&(g.start=u);let m=i.audio,v=!1;r==="audio"&&m?.container==="audio/mpeg"&&(v=!this.lastMpegAudioChunk||l.id===1||this.lastMpegAudioChunk.sn!==l.sn,this.lastMpegAudioChunk=l);let y=this.tracks.video,T=y?.buffer;if(T&&h!=="initSegment"){let A=c||a,L=this.blockedAudioAppend;if(r==="audio"&&o!=="main"&&!this.blockedAudioAppend){let D=A.start+A.duration*.05,w=T.buffered,C=this.currentOp("video");!w.length&&!C?this.blockAudio(A):!C&&!ie.isBuffered(T,D)&&this.lastVideoAppendEnd<D&&this.blockAudio(A)}else if(r==="video"){let I=A.end;if(L){let D=L.frag.start;(I>D||I<this.lastVideoAppendEnd||ie.isBuffered(T,D))&&this.unblockAudio()}this.lastVideoAppendEnd=I}}let S=(c||a).start,b={label:`append-${r}`,execute:()=>{if(d.executeStart=self.performance.now(),v){let A=this.tracks[r];if(A){let L=A.buffer;if(L){let I=S-L.timestampOffset;Math.abs(I)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${S} (delta: ${I}) sn: ${h})`),L.timestampOffset=S)}}}this.appendExecutor(s,r)},onStart:()=>{},onComplete:()=>{let A=self.performance.now();d.executeEnd=d.end=A,f.first===0&&(f.first=A),g&&g.first===0&&(g.first=A);let L={};this.sourceBuffers.forEach(([I,D])=>{I&&(L[I]=ie.getBuffered(D))}),this.appendErrors[r]=0,r==="audio"||r==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(p.BUFFER_APPENDED,{type:r,frag:a,part:c,chunkMeta:l,parent:a.type,timeRanges:L})},onError:A=>{var L;let I={type:z.MEDIA_ERROR,parent:a.type,details:R.BUFFER_APPEND_ERROR,sourceBufferName:r,frag:a,part:c,chunkMeta:l,error:A,err:A,fatal:!1},D=(L=this.media)==null?void 0:L.error;if(A.code===DOMException.QUOTA_EXCEEDED_ERR)I.details=R.BUFFER_FULL_ERROR;else if(A.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!D)I.errorAction=Bi(!0);else if(A.name===xd&&this.sourceBufferCount===0)I.errorAction=Bi(!0);else{let w=++this.appendErrors[r];this.warn(`Failed ${w}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${r}" sourceBuffer (${D||"no media error"})`),(w>=this.hls.config.appendErrorMaxRetry||D)&&(I.fatal=!0)}this.hls.trigger(p.ERROR,I)}};this.append(b,r,this.isPending(this.tracks[r]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(p.BUFFER_FLUSHED,{type:e})},onError:s=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,s)}}}onBufferFlushing(e,t){let{type:i,startOffset:s,endOffset:r}=t;i?this.append(this.getFlushOp(i,s,r),i):this.sourceBuffers.forEach(([o])=>{o&&this.append(this.getFlushOp(o,s,r),o)})}onFragParsed(e,t){let{frag:i,part:s}=t,r=[],o=s?s.elementaryStreams:i.elementaryStreams;o[pe.AUDIOVIDEO]?r.push("audiovideo"):(o[pe.AUDIO]&&r.push("audio"),o[pe.VIDEO]&&r.push("video"));let a=()=>{let c=self.performance.now();i.stats.buffering.end=c,s&&(s.stats.buffering.end=c);let l=s?s.stats:i.stats;this.hls.trigger(p.FRAG_BUFFERED,{frag:i,part:s,stats:l,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(a,r).catch(c=>{this.warn(`Fragment buffered callback ${c}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t,i;return e&&(!((t=this.tracks[e])!=null&&t.ended)||((i=this.tracks[e])==null?void 0:i.ending))})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([o])=>{if(o){let a=this.tracks[o];(!t.type||t.type===o)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${o} buffer reached EOS`)))}});let s=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([o])=>{var a;return o&&!((a=this.tracks[o])!=null&&a.ended)})&&(s?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();let{mediaSource:o}=this;if(!o||o.readyState!=="open"){o&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${o.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),o.endOfStream(),this.hls.trigger(p.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(p.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){let t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){let e=this.getDurationAndRange();e&&this.blockUntilOpen(()=>this.updateMediaSource(e))}onError(e,t){if(t.details===R.BUFFER_APPEND_ERROR&&t.frag){var i;let s=(i=t.errorAction)==null?void 0:i.nextAutoLevel;G(s)&&s!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){let{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;let s=e.config,r=i.currentTime,o=t.levelTargetDuration,a=t.live&&s.liveBackBufferLength!==null?s.liveBackBufferLength:s.backBufferLength;if(G(a)&&a>=0){let c=Math.max(a,o),l=Math.floor(r/o)*o-c;this.flushBackBuffer(r,o,l)}if(G(s.frontBufferFlushThreshold)&&s.frontBufferFlushThreshold>0){let c=Math.max(s.maxBufferLength,s.frontBufferFlushThreshold),l=Math.max(c,o),d=Math.floor(r/o)*o+l;this.flushFrontBuffer(r,o,d)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([s,r])=>{if(r){let a=ie.getBuffered(r);if(a.length>0&&i>a.start(0)){var o;this.hls.trigger(p.BACK_BUFFER_REACHED,{bufferEnd:i});let c=this.tracks[s];if((o=this.details)!=null&&o.live)this.hls.trigger(p.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(c!=null&&c.ended){this.log(`Cannot flush ${s} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(p.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:s})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([s,r])=>{if(r){let o=ie.getBuffered(r),a=o.length;if(a<2)return;let c=o.start(a-1),l=o.end(a-1);if(i>c||e>=c&&e<=l)return;this.hls.trigger(p.BUFFER_FLUSHING,{startOffset:c,endOffset:1/0,type:s})}})}getDurationAndRange(){var e;let{details:t,mediaSource:i}=this;if(!t||!this.media||i?.readyState!=="open")return null;let s=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&t.live&&i.setLiveSeekableRange){let l=Math.max(0,t.fragmentStart),d=Math.max(l,s);return{duration:1/0,start:l,end:d}}return{duration:1/0}}let r=(e=this.overrides)==null?void 0:e.duration;if(r)return G(r)?{duration:r}:null;let o=this.media.duration,a=G(i.duration)?i.duration:0;return s>a&&s>o||!G(o)?{duration:s}:null}updateMediaSource({duration:e,start:t,end:i}){let s=this.mediaSource;!this.media||!s||s.readyState!=="open"||(s.duration!==e&&(G(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),s.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${s.duration}. Setting seekable range to ${t}-${i}.`),s.setLiveSeekableRange(t,i)))}get tracksReady(){let e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){let{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${me(i)}`),this.tracksReady){var s;let r=(s=this.transferData)==null?void 0:s.tracks;r&&Object.keys(r).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){let e={};this.sourceBuffers.forEach(([t,i])=>{if(t){let s=this.tracks[t];e[t]={buffer:i,container:s.container,codec:s.codec,supplemental:s.supplemental,levelCodec:s.levelCodec,id:s.id,metadata:s.metadata}}}),this.hls.trigger(p.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{let e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){let{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(let r in e){let o=r,a=e[o];if(this.isPending(a)){let c=this.getTrackCodec(a,o),l=`${a.container};codecs=${c}`;a.codec=c,this.log(`creating sourceBuffer(${l})${this.currentOp(o)?" Queued":""} ${me(a)}`);try{let d=i.addSourceBuffer(l),h=ar(o),u=[o,d];t[h]=u,a.buffer=d}catch(d){var s;this.error(`error while trying to add sourceBuffer: ${d.message}`),this.shiftAndExecuteNext(o),(s=this.operationQueue)==null||s.removeBlockers(),delete this.tracks[o],this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:d,sourceBufferName:o,mimeType:l,parent:a.id});return}this.trackSourceBuffer(o,a)}}this.bufferCreated()}getTrackCodec(e,t){let i=e.supplemental,s=e.codec;i&&(t==="video"||t==="audiovideo")&&Er(i,"video")&&(s=Pu(s,i));let r=Cs(s,e.levelCodec);return r?t.slice(0,5)==="audio"?Ns(r,this.appendSource):r:""}trackSourceBuffer(e,t){let i=t.buffer;if(!i)return;let s=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:s,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(r,o)=>{let a=o.removedRanges;a!=null&&a.length&&this.hls.trigger(p.BUFFER_FLUSHED,{type:r})})}get mediaSrc(){var e,t;let i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i?.src}onSBUpdateStart(e){let t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}let i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;let s=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${s}`,t),this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:s,fatal:!1});let r=this.currentOp(e);r&&r.onError(s)}removeExecutor(e,t,i){let{media:s,mediaSource:r}=this,o=this.tracks[e],a=o?.buffer;if(!s||!r||!a){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}let c=G(s.duration)?s.duration:1/0,l=G(r.duration)?r.duration:1/0,d=Math.max(0,t),h=Math.min(i,c,l);h>d&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${d},${h}] from the ${e} SourceBuffer`),a.remove(d,h)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){let i=this.tracks[t],s=i?.buffer;if(!s)throw new Xr(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,s.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);let{operationQueue:i}=this,s=t.map(o=>this.appendBlocker(o));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(s).then(o=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;let s=(i=this.tracks[t])==null?void 0:i.buffer;!s||s.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){let s=this.tracks[e];if(!s)return;let r=s.buffer;if(!r)return;let o=i.bind(this,e);s.listeners.push({event:t,listener:o}),r.addEventListener(t,o)}removeBufferListeners(e){let t=this.tracks[e];if(!t)return;let i=t.buffer;i&&(t.listeners.forEach(s=>{i.removeEventListener(s.event,s.listener)}),t.listeners.length=0)}};function dc(n){let e=n.querySelectorAll("source");[].slice.call(e).forEach(t=>{n.removeChild(t)})}function mg(n,e){let t=self.document.createElement("source");t.type="video/mp4",t.src=e,n.appendChild(t)}function ar(n){return n==="audio"?1:0}var Zr=class n{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){let{hls:e}=this;e.on(p.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.BUFFER_CODECS,this.onBufferCodecs,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){let{hls:e}=this;e.off(p.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.BUFFER_CODECS,this.onBufferCodecs,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){let i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){let i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&G(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}let e=this.hls.levels;if(e.length){let t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){let t=this.hls.levels;if(!t.length)return-1;let i=t.filter((s,r)=>this.isLevelAllowed(s)&&r<=e);return this.clientRect=null,n.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;let e=this.media,t={width:0,height:0};if(e){let i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;let s=(a,c)=>c?a.width!==c.width||a.height!==c.height:!0,r=e.length-1,o=Math.max(t,i);for(let a=0;a<e.length;a+=1){let c=e[a];if((c.width>=o||c.height>=o)&&s(c,e[a+1])){r=a;break}}return r}},vg={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},Fe=vg,yg={HLS:"h"},_g=yg,Eg="CMCD-Object",Sg="CMCD-Request",xg="CMCD-Session",Tg="CMCD-Status",wi={OBJECT:Eg,REQUEST:Sg,SESSION:xg,STATUS:Tg},bg={[wi.OBJECT]:["br","d","ot","tb"],[wi.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[wi.SESSION]:["cid","pr","sf","sid","st","v"],[wi.STATUS]:["bs","rtp"]},qi=class n{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof n?i:new n(i))),this.value=e,this.params=t}},Ag="Dict";function Ig(n){return Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":typeof n=="object"?JSON.stringify(n):String(n)}function Cg(n,e,t,i){return new Error(`failed to ${n} "${Ig(e)}" as ${t}`,{cause:i})}function ft(n,e,t){return Cg("serialize",n,e,t)}var en=class{constructor(e){this.description=e}},hc="Bare Item",Dg="Boolean";function Rg(n){if(typeof n!="boolean")throw ft(n,Dg);return n?"?1":"?0"}function Lg(n){return btoa(String.fromCharCode(...n))}var wg="Byte Sequence";function kg(n){if(ArrayBuffer.isView(n)===!1)throw ft(n,wg);return`:${Lg(n)}:`}var Pg="Integer";function Mg(n){return n<-999999999999999||999999999999999<n}function Td(n){if(Mg(n))throw ft(n,Pg);return n.toString()}function Og(n){return`@${Td(n.getTime()/1e3)}`}function bd(n,e){if(n<0)return-bd(-n,e);let t=Math.pow(10,e);if(Math.abs(n*t%1-.5)<Number.EPSILON){let s=Math.floor(n*t);return(s%2===0?s:s+1)/t}else return Math.round(n*t)/t}var Fg="Decimal";function Ng(n){let e=bd(n,3);if(Math.floor(Math.abs(e)).toString().length>12)throw ft(n,Fg);let t=e.toString();return t.includes(".")?t:`${t}.0`}var Bg="String",Ug=/[\x00-\x1f\x7f]+/;function Vg(n){if(Ug.test(n))throw ft(n,Bg);return`"${n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function $g(n){return n.description||n.toString().slice(7,-1)}var Gg="Token";function uc(n){let e=$g(n);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw ft(e,Gg);return e}function Jr(n){switch(typeof n){case"number":if(!G(n))throw ft(n,hc);return Number.isInteger(n)?Td(n):Ng(n);case"string":return Vg(n);case"symbol":return uc(n);case"boolean":return Rg(n);case"object":if(n instanceof Date)return Og(n);if(n instanceof Uint8Array)return kg(n);if(n instanceof en)return uc(n);default:throw ft(n,hc)}}var Hg="Key";function eo(n){if(/^[a-z*][a-z0-9\-_.*]*$/.test(n)===!1)throw ft(n,Hg);return n}function Ho(n){return n==null?"":Object.entries(n).map(([e,t])=>t===!0?`;${eo(e)}`:`;${eo(e)}=${Jr(t)}`).join("")}function Ad(n){return n instanceof qi?`${Jr(n.value)}${Ho(n.params)}`:Jr(n)}function Kg(n){return`(${n.value.map(Ad).join(" ")})${Ho(n.params)}`}function jg(n,e={whitespace:!0}){if(typeof n!="object")throw ft(n,Ag);let t=n instanceof Map?n.entries():Object.entries(n),i=e?.whitespace?" ":"";return Array.from(t).map(([s,r])=>{r instanceof qi||(r=new qi(r));let o=eo(s);return r.value===!0?o+=Ho(r.params):(o+="=",Array.isArray(r.value)?o+=Kg(r):o+=Ad(r)),o}).join(`,${i}`)}function Wg(n,e){return jg(n,e)}function Yg(n){return n==="ot"||n==="sf"||n==="st"}function zg(n){return typeof n=="number"?G(n):n!=null&&n!==""&&n!==!1}function qg(n,e){let t=new URL(n),i=new URL(e);if(t.origin!==i.origin)return n;let s=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;s[0]===r[0];)s.shift(),r.shift();for(;r.length;)r.shift(),s.unshift("..");return s.join("/")}var ws=n=>Math.round(n),Xg=(n,e)=>(e?.baseUrl&&(n=qg(n,e.baseUrl)),encodeURIComponent(n)),Ts=n=>ws(n/100)*100,Qg={br:ws,d:ws,bl:Ts,dl:Ts,mtp:Ts,nor:Xg,rtp:Ts,tb:ws};function Zg(n,e){let t={};if(n==null||typeof n!="object")return t;let i=Object.keys(n).sort(),s=fe({},Qg,e?.formatters),r=e?.filter;return i.forEach(o=>{if(r?.(o))return;let a=n[o],c=s[o];c&&(a=c(a,e)),!(o==="v"&&a===1)&&(o=="pr"&&a===1||zg(a)&&(Yg(o)&&typeof a=="string"&&(a=new en(a)),t[o]=a))}),t}function Id(n,e={}){return n?Wg(Zg(n,e),fe({whitespace:!1},e)):""}function Jg(n,e={}){let t={};if(!n)return t;let i=Object.entries(n),s=Object.entries(bg).concat(Object.entries(e?.customHeaderMap||{})),r=i.reduce((o,a)=>{var c,l;let[d,h]=a,u=((c=s.find(f=>f[1].includes(d)))===null||c===void 0?void 0:c[0])||wi.REQUEST;return(l=o[u])!==null&&l!==void 0||(o[u]={}),o[u][d]=h,o},{});return Object.entries(r).reduce((o,[a,c])=>(o[a]=Id(c,e),o),t)}function ep(n,e,t){return fe(n,Jg(e,t))}var tp="CMCD";function ip(n,e={}){if(!n)return"";let t=Id(n,e);return`${tp}=${encodeURIComponent(t)}`}var fc=/CMCD=[^&#]+/;function sp(n,e,t){let i=ip(e,t);if(!i)return n;if(fc.test(n))return n.replace(fc,i);let s=n.includes("?")?"&":"?";return`${n}${s}${i}`}var to=class{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=s=>{try{this.apply(s,{ot:Fe.MANIFEST,su:!this.initialized})}catch(r){this.hls.logger.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=s=>{try{let{frag:r,part:o}=s,a=this.hls.levels[r.level],c=this.getObjectType(r),l={d:(o||r).duration*1e3,ot:c};(c===Fe.VIDEO||c===Fe.AUDIO||c==Fe.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(c)/1e3,l.bl=this.getBufferLength(c));let d=o?this.getNextPart(o):this.getNextFrag(r);d!=null&&d.url&&d.url!==r.url&&(l.nor=d.url),this.apply(s,l)}catch(r){this.hls.logger.warn("Could not generate segment CMCD data.",r)}},this.hls=e;let t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){let e=this.hls;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHED,this.onMediaDetached,this),e.on(p.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){let e=this.hls;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHED,this.onMediaDetached,this),e.off(p.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,s;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(s=t.tracks.video)==null?void 0:s.buffer}createData(){var e;return{v:1,sf:_g.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){fe(t,this.createData());let i=t.ot===Fe.INIT||t.ot===Fe.VIDEO||t.ot===Fe.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);let{includeKeys:s}=this;s&&(t=Object.keys(t).reduce((o,a)=>(s.includes(a)&&(o[a]=t[a]),o),{}));let r={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),ep(e.headers,t,r)):e.url=sp(e.url,t,r)}getNextFrag(e){var t;let i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){let s=e.sn-i.startSN;return i.fragments[s+1]}}getNextPart(e){var t,i;let{index:s,fragment:r}=e,o=(t=this.hls.levels[r.level])==null||(i=t.details)==null?void 0:i.partList;if(o){let{sn:a}=r;for(let c=o.length-1;c>=0;c--){let l=o[c];if(l.index===s&&l.fragment.sn===a)return o[c+1]}}}getObjectType(e){let{type:t}=e;if(t==="subtitle")return Fe.TIMED_TEXT;if(e.sn==="initSegment")return Fe.INIT;if(t==="audio")return Fe.AUDIO;if(t==="main")return this.hls.audioTracks.length?Fe.VIDEO:Fe.MUXED}getTopBandwidth(e){let t=0,i,s=this.hls;if(e===Fe.AUDIO)i=s.audioTracks;else{let r=s.maxAutoLevel,o=r>-1?r+1:s.levels.length;i=s.levels.slice(0,o)}return i.forEach(r=>{r.bitrate>t&&(t=r.bitrate)}),t>0?t:NaN}getBufferLength(e){let t=this.media,i=e===Fe.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:ie.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){let{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}createFragmentLoader(){let{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}},np=3e5,io=class extends rt{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){let e=this.hls;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){let e=this.hls;e&&(e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){let e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){let t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){let{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){let{errorAction:i}=t;if(i?.action===De.SendAlternateToPenaltyBox&&i.flags===st.MoveAllAlternatesMatchingHost){let s=this.levels,r=this._pathwayPriority,o=this.pathwayId;if(t.context){let{groupId:a,pathwayId:c,type:l}=t.context;a&&s?o=this.getPathwayForGroupId(a,l,o):c&&(o=c)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!r&&s&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==o),i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${o} levels: ${s&&s.length} priorities: ${me(r)} penalized: ${me(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){let i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t,i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(r=>{s-i[r]>np&&delete i[r]});for(let r=0;r<e.length;r++){let o=e[r];if(o in i)continue;if(o===this.pathwayId)return;let a=this.hls.nextLoadLevel,c=this.hls.levels[a];if(t=this.getLevelsForPathway(o),t.length>0){this.log(`Setting Pathway to "${o}"`),this.pathwayId=o,td(t),this.hls.trigger(p.LEVELS_UPDATED,{levels:t});let l=this.hls.levels[a];c&&l&&this.levels&&(l.attrs["STABLE-VARIANT-ID"]!==c.attrs["STABLE-VARIANT-ID"]&&l.bitrate!==c.bitrate&&this.log(`Unstable Pathways change from bitrate ${c.bitrate} to ${l.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){let s=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<s.length;r++)if(t===ne.AUDIO_TRACK&&s[r].hasAudioGroup(e)||t===ne.SUBTITLE_TRACK&&s[r].hasSubtitleGroup(e))return s[r].pathwayId;return i}clonePathways(e){let t=this.levels;if(!t)return;let i={},s={};e.forEach(r=>{let{ID:o,"BASE-ID":a,"URI-REPLACEMENT":c}=r;if(t.some(d=>d.pathwayId===o))return;let l=this.getLevelsForPathway(a).map(d=>{let h=new ve(d.attrs);h["PATHWAY-ID"]=o;let u=h.AUDIO&&`${h.AUDIO}_clone_${o}`,f=h.SUBTITLES&&`${h.SUBTITLES}_clone_${o}`;u&&(i[h.AUDIO]=u,h.AUDIO=u),f&&(s[h.SUBTITLES]=f,h.SUBTITLES=f);let g=Cd(d.uri,h["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",c),m=new jt({attrs:h,audioCodec:d.audioCodec,bitrate:d.bitrate,height:d.height,name:d.name,url:g,videoCodec:d.videoCodec,width:d.width});if(d.audioGroups)for(let v=1;v<d.audioGroups.length;v++)m.addGroupId("audio",`${d.audioGroups[v]}_clone_${o}`);if(d.subtitleGroups)for(let v=1;v<d.subtitleGroups.length;v++)m.addGroupId("text",`${d.subtitleGroups[v]}_clone_${o}`);return m});t.push(...l),gc(this.audioTracks,i,c,o),gc(this.subtitleTracks,s,c,o)})}loadSteeringManifest(e){let t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let s;try{s=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(s.protocol!=="data:"){let d=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+d)}let r={responseType:"json",url:s.href},o=t.steeringManifestLoadPolicy.default,a=o.errorRetry||o.timeoutRetry||{},c={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(d,h,u,f)=>{this.log(`Loaded steering manifest: "${s}"`);let g=d.data;if(g?.VERSION!==1){this.log(`Steering VERSION ${g.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=g.TTL;let{"RELOAD-URI":m,"PATHWAY-CLONES":v,"PATHWAY-PRIORITY":y}=g;if(m)try{this.uri=new self.URL(m,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${m}`);return}this.scheduleRefresh(this.uri||u.url),v&&this.clonePathways(v);let T={steeringManifest:g,url:s.toString()};this.hls.trigger(p.STEERING_MANIFEST_LOADED,T),y&&this.updatePathwayPriority(y)},onError:(d,h,u,f)=>{if(this.log(`Error loading steering manifest: ${d.code} ${d.text} (${h.url})`),this.stopLoad(),d.code===410){this.enabled=!1,this.log(`Steering manifest ${h.url} no longer available`);return}let g=this.timeToLoad*1e3;if(d.code===429){let m=this.loader;if(typeof m?.getResponseHeader=="function"){let v=m.getResponseHeader("Retry-After");v&&(g=parseFloat(v)*1e3)}this.log(`Steering manifest ${h.url} rate limited`);return}this.scheduleRefresh(this.uri||h.url,g)},onTimeout:(d,h,u)=>{this.log(`Timeout loading steering manifest (${h.url})`),this.scheduleRefresh(this.uri||h.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(r,c,l)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;let s=(i=this.hls)==null?void 0:i.media;if(s&&!s.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}};function gc(n,e,t,i){n&&Object.keys(e).forEach(s=>{let r=n.filter(o=>o.groupId===s).map(o=>{let a=fe({},o);return a.details=void 0,a.attrs=new ve(a.attrs),a.url=a.attrs.URI=Cd(o.url,o.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[s],a.attrs["PATHWAY-ID"]=i,a});n.push(...r)})}function Cd(n,e,t,i){let{HOST:s,PARAMS:r,[t]:o}=i,a;e&&(a=o?.[e],a&&(n=a));let c=new self.URL(n);return s&&!a&&(c.host=s),r&&Object.keys(r).sort().forEach(l=>{l&&c.searchParams.set(l,r[l])}),c.href}function $e(n,e,t){ze(n,e,t),n.addEventListener(e,t)}function ze(n,e,t){n.removeEventListener(e,t)}var rp=(()=>{class n extends rt{constructor(t){super("eme",t.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=n.CDMCleanupPromise?[n.CDMCleanupPromise]:[],this.onMediaEncrypted=i=>{let{initDataType:s,initData:r}=i,o=`"${i.type}" event: init data type: "${s}"`;if(this.debug(o),r!==null){if(!this.keyFormatPromise){let a=Object.keys(this.keySystemAccessPromises);a.length||(a=Li(this.config));let c=a.map(ys).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(c)}this.keyFormatPromise.then(a=>{let c=Rs(a),l,d;if(s==="sinf"){if(c!==ue.FAIRPLAY){this.warn(`Ignoring unexpected "${i.type}" event with init data type: "${s}" for selected key-system ${c}`);return}let m=Se(new Uint8Array(r));try{let v=Fo(JSON.parse(m).sinf),y=Mc(v);if(!y)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=new Uint8Array(y.subarray(8,24)),d=ue.FAIRPLAY}catch(v){this.warn(`${o} Failed to parse sinf: ${v}`);return}}else{if(c!==ue.WIDEVINE&&c!==ue.PLAYREADY){this.warn(`Ignoring unexpected "${i.type}" event with init data type: "${s}" for selected key-system ${c}`);return}let m=Ru(r),v=m.filter(T=>!!T.systemId&&Jn(T.systemId)===c);v.length>1&&this.warn(`${o} Using first of ${v.length} pssh found for selected key-system ${c}`);let y=v[0];if(!y){m.length===0||m.some(T=>!T.systemId)?this.warn(`${o} contains incomplete or invalid pssh data`):this.log(`ignoring ${o} for ${m.map(T=>Jn(T.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(d=Jn(y.systemId),y.version===0&&y.data)if(d===ue.WIDEVINE){let T=y.data.length-22;l=new Uint8Array(y.data.subarray(T,T+16))}else d===ue.PLAYREADY&&(l=zc(y.data))}if(!d||!l)return;let h=dt.hexDump(l),{keyIdToKeySessionPromise:u,mediaKeySessions:f}=this,g=u[h];for(let m=0;m<f.length;m++){let v=f[m],y=v.decryptdata;if(!y.keyId)continue;let T=dt.hexDump(y.keyId);if(h===T||y.uri.replace(/-/g,"").indexOf(h)!==-1){if(g=u[T],y.pssh)break;delete u[T],y.pssh=new Uint8Array(r),y.keyId=l,g=u[h]=g.then(()=>this.generateRequestWithPreferredKeySession(v,s,r,"encrypted-event-key-match")),g.catch(S=>this.handleError(S));break}}if(!g){if(d!==c){this.log(`Ignoring "${i.type}" event with ${d} init data for selected key-system ${c}`);return}g=u[h]=this.getKeySystemSelectionPromise([d]).then(({keySystem:m,mediaKeys:v})=>{var y;this.throwIfDestroyed();let T=new $i("ISO-23001-7",h,(y=ys(m))!=null?y:"");return T.pssh=new Uint8Array(r),T.keyId=l,this.attemptSetMediaKeys(m,v).then(()=>{this.throwIfDestroyed();let S=this.createMediaKeySessionContext({decryptdata:T,keySystem:m,mediaKeys:v});return this.generateRequestWithPreferredKeySession(S,s,r,"encrypted-event-no-match")})}),g.catch(m=>this.handleError(m))}})}},this.onWaitingForKey=i=>{this.log(`"${i.type}" event`)},this.hls=t,this.config=t.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();let t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(p.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(p.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(p.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(p.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(p.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(p.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(t){let{drmSystems:i,widevineLicenseUrl:s}=this.config,r=i[t];if(r)return r.licenseUrl;if(t===ue.WIDEVINE&&s)return s}getLicenseServerUrlOrThrow(t){let i=this.getLicenseServerUrl(t);if(i===void 0)throw new Error(`no license server URL configured for key-system "${t}"`);return i}getServerCertificateUrl(t){let{drmSystems:i}=this.config,s=i[t];if(s)return s.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${t}"]`)}attemptKeySystemAccess(t){let i=this.hls.levels,s=(a,c,l)=>!!a&&l.indexOf(a)===c,r=i.map(a=>a.audioCodec).filter(s),o=i.map(a=>a.videoCodec).filter(s);return r.length+o.length===0&&o.push("avc1.42e01e"),new Promise((a,c)=>{let l=d=>{let h=d.shift();this.getMediaKeysPromise(h,r,o).then(u=>a({keySystem:h,mediaKeys:u})).catch(u=>{d.length?l(d):u instanceof Ne?c(u):c(new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_NO_ACCESS,error:u,fatal:!0},u.message))})};l(t)})}requestMediaKeySystemAccess(t,i){let{requestMediaKeySystemAccessFunc:s}=this.config;if(typeof s!="function"){let r=`Configured requestMediaKeySystemAccess is not a function ${s}`;return Yc===null&&self.location.protocol==="http:"&&(r=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(r))}return s(t,i)}getMediaKeysPromise(t,i,s){let r=uf(t,i,s,this.config.drmSystemOptions),o=this.keySystemAccessPromises[t],a=o?.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${t}" key-system access with config: ${me(r)}`),a=this.requestMediaKeySystemAccess(t,r);let c=this.keySystemAccessPromises[t]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${t}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);let d=this.fetchServerCertificate(t);return this.log(`Create media-keys for "${t}"`),c.mediaKeys=l.createMediaKeys().then(h=>(this.log(`Media-keys created for "${t}"`),c.hasMediaKeys=!0,d.then(u=>u?this.setMediaKeysServerCertificate(h,t,u):h))),c.mediaKeys.catch(h=>{this.error(`Failed to create media-keys for "${t}"}: ${h}`)}),c.mediaKeys})}return a.then(()=>o.mediaKeys)}createMediaKeySessionContext({decryptdata:t,keySystem:i,mediaKeys:s}){this.log(`Creating key-system session "${i}" keyId: ${dt.hexDump(t.keyId||[])}`);let r=s.createSession(),o={decryptdata:t,keySystem:i,mediaKeys:s,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(o),o}renewKeySession(t){let i=t.decryptdata;if(i.pssh){let s=this.createMediaKeySessionContext(t),r=this.getKeyIdString(i),o="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(s,o,i.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)}getKeyIdString(t){if(!t)throw new Error("Could not read keyId of undefined decryptdata");if(t.keyId===null)throw new Error("keyId is null");return dt.hexDump(t.keyId)}updateKeySession(t,i){var s;let r=t.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${dt.hexDump(((s=t.decryptdata)==null?void 0:s.keyId)||[])}
      } (data length: ${i&&i.byteLength})`),r.update(i)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(t=>({keySystem:t,hasMediaKeys:this.keySystemAccessPromises[t].hasMediaKeys})).filter(({hasMediaKeys:t})=>!!t).map(({keySystem:t})=>ys(t)).filter(t=>!!t)}getKeySystemAccess(t){return this.getKeySystemSelectionPromise(t).then(({keySystem:i,mediaKeys:s})=>this.attemptSetMediaKeys(i,s))}selectKeySystem(t){return new Promise((i,s)=>this.getKeySystemSelectionPromise(t).then(({keySystem:r})=>{let o=ys(r);o?i(o):s(new Error(`Unable to find format for key-system "${r}"`))}).catch(s))}selectKeySystemFormat(t){let i=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${t.sn} ${t.type}: ${t.level}) key formats ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)),this.keyFormatPromise}getKeyFormatPromise(t){let i=Li(this.config),s=t.map(Rs).filter(r=>!!r&&i.indexOf(r)!==-1);return this.selectKeySystem(s)}loadKey(t){let i=t.keyInfo.decryptdata,s=this.getKeyIdString(i),r=`(keyId: ${s} format: "${i.keyFormat}" method: ${i.method} uri: ${i.uri})`;this.log(`Starting session for key ${r}`);let o=this.keyIdToKeySessionPromise[s];return o||(o=this.getKeySystemForKeyPromise(i).then(({keySystem:c,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${t.frag.sn} ${t.frag.type}: ${t.frag.level} using key ${r}`),this.attemptSetMediaKeys(c,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:c,mediaKeys:l,decryptdata:i}))))),(this.keyIdToKeySessionPromise[s]=o.then(c=>{let l="cenc",d=i.pssh?i.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(c,l,d,"playlist-key")})).catch(c=>this.handleError(c))),o}throwIfDestroyed(t="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(t){this.hls&&(this.error(t.message),t instanceof Ne?this.hls.trigger(p.ERROR,t.data):this.hls.trigger(p.ERROR,{type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))}getKeySystemForKeyPromise(t){let i=this.getKeyIdString(t),s=this.keyIdToKeySessionPromise[i];if(!s){let r=Rs(t.keyFormat),o=r?[r]:Li(this.config);return this.attemptKeySystemAccess(o)}return s}getKeySystemSelectionPromise(t){if(t.length||(t=Li(this.config)),t.length===0)throw new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${me({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(t)}attemptSetMediaKeys(t,i){if(this.mediaKeys===i)return Promise.resolve();let s=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${t}"`);let r=Promise.all(s).then(()=>{if(!this.media)throw this.mediaKeys=null,new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(i)});return this.mediaKeys=i,this.setMediaKeysQueue.push(r),r.then(()=>{this.log(`Media-keys set for "${t}"`),s.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(o=>s.indexOf(o)===-1)})}generateRequestWithPreferredKeySession(t,i,s,r){var o,a;let c=(o=this.config.drmSystems)==null||(a=o[t.keySystem])==null?void 0:a.generateRequest;if(c)try{let m=c.call(this.hls,i,s,t);if(!m)throw new Error("Invalid response from configured generateRequest filter");i=m.initDataType,s=m.initData?m.initData:null,t.decryptdata.pssh=s?new Uint8Array(s):null}catch(m){var l;if(this.warn(m.message),(l=this.hls)!=null&&l.config.debug)throw m}if(s===null)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(t);let d=this.getKeyIdString(t.decryptdata);this.log(`Generating key-session request for "${r}": ${d} (init data type: ${i} length: ${s?s.byteLength:null})`);let h=new No,u=t._onmessage=m=>{let v=t.mediaKeysSession;if(!v){h.emit("error",new Error("invalid state"));return}let{messageType:y,message:T}=m;this.log(`"${y}" message event for session "${v.sessionId}" message size: ${T.byteLength}`),y==="license-request"||y==="license-renewal"?this.renewLicense(t,T).catch(S=>{h.eventNames().length?h.emit("error",S):this.handleError(S)}):y==="license-release"?t.keySystem===ue.FAIRPLAY&&(this.updateKeySession(t,wr("acknowledged")),this.removeSession(t)):this.warn(`unhandled media key message type "${y}"`)},f=t._onkeystatuseschange=m=>{if(!t.mediaKeysSession){h.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(t);let y=t.keyStatus;h.emit("keyStatus",y),y==="expired"&&(this.warn(`${t.keySystem} expired for key ${d}`),this.renewKeySession(t))};$e(t.mediaKeysSession,"message",u),$e(t.mediaKeysSession,"keystatuseschange",f);let g=new Promise((m,v)=>{h.on("error",v),h.on("keyStatus",y=>{y.startsWith("usable")?m():y==="output-restricted"?v(new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):y==="internal-error"?v(new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${y}"`)):y==="expired"?v(new Error("key expired while generating request")):this.warn(`unhandled key status change "${y}"`)})});return t.mediaKeysSession.generateRequest(i,s).then(()=>{var m;this.log(`Request generated for key-session "${(m=t.mediaKeysSession)==null?void 0:m.sessionId}" keyId: ${d}`)}).catch(m=>{throw new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_NO_SESSION,error:m,fatal:!1},`Error generating key-session request: ${m}`)}).then(()=>g).catch(m=>{throw h.removeAllListeners(),this.removeSession(t),m}).then(()=>(h.removeAllListeners(),t))}onKeyStatusChange(t){t.mediaKeysSession.keyStatuses.forEach((i,s)=>{if(typeof s=="string"&&typeof i=="object"){let r=s;s=i,i=r}this.log(`key status change "${i}" for keyStatuses keyId: ${dt.hexDump("buffer"in s?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):new Uint8Array(s))} session keyId: ${dt.hexDump(new Uint8Array(t.decryptdata.keyId||[]))} uri: ${t.decryptdata.uri}`),t.keyStatus=i})}fetchServerCertificate(t){let i=this.config,s=i.loader,r=new s(i),o=this.getServerCertificateUrl(t);return o?(this.log(`Fetching server certificate for "${t}"`),new Promise((a,c)=>{let l={responseType:"arraybuffer",url:o},d=i.certLoadPolicy.default,h={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(f,g,m,v)=>{a(f.data)},onError:(f,g,m,v)=>{c(new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:he({url:l.url,data:void 0},f)},`"${t}" certificate request failed (${o}). Status: ${f.code} (${f.text})`))},onTimeout:(f,g,m)=>{c(new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:{url:l.url,data:void 0}},`"${t}" certificate request timed out (${o})`))},onAbort:(f,g,m)=>{c(new Error("aborted"))}};r.load(l,h,u)})):Promise.resolve()}setMediaKeysServerCertificate(t,i,s){return new Promise((r,o)=>{t.setServerCertificate(s).then(a=>{this.log(`setServerCertificate ${a?"success":"not supported by CDM"} (${s?.byteLength}) on "${i}"`),r(t)}).catch(a=>{o(new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:!0},a.message))})})}renewLicense(t,i){return this.requestLicense(t,new Uint8Array(i)).then(s=>this.updateKeySession(t,new Uint8Array(s)).catch(r=>{throw new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:r,fatal:!0},r.message)}))}unpackPlayReadyKeyMessage(t,i){let s=String.fromCharCode.apply(null,new Uint16Array(i.buffer));if(!s.includes("PlayReadyKeyMessage"))return t.setRequestHeader("Content-Type","text/xml; charset=utf-8"),i;let r=new DOMParser().parseFromString(s,"application/xml"),o=r.querySelectorAll("HttpHeader");if(o.length>0){let h;for(let u=0,f=o.length;u<f;u++){var a,c;h=o[u];let g=(a=h.querySelector("name"))==null?void 0:a.textContent,m=(c=h.querySelector("value"))==null?void 0:c.textContent;g&&m&&t.setRequestHeader(g,m)}}let l=r.querySelector("Challenge"),d=l?.textContent;if(!d)throw new Error("Cannot find <Challenge> in key message");return wr(atob(d))}setupLicenseXHR(t,i,s,r){let o=this.config.licenseXhrSetup;return o?Promise.resolve().then(()=>{if(!s.decryptdata)throw new Error("Key removed");return o.call(this.hls,t,i,s,r)}).catch(a=>{if(!s.decryptdata)throw a;return t.open("POST",i,!0),o.call(this.hls,t,i,s,r)}).then(a=>(t.readyState||t.open("POST",i,!0),{xhr:t,licenseChallenge:a||r})):(t.open("POST",i,!0),Promise.resolve({xhr:t,licenseChallenge:r}))}requestLicense(t,i){let s=this.config.keyLoadPolicy.default;return new Promise((r,o)=>{let a=this.getLicenseServerUrlOrThrow(t.keySystem);this.log(`Sending license request to URL: ${a}`);let c=new XMLHttpRequest;c.responseType="arraybuffer",c.onreadystatechange=()=>{if(!this.hls||!t.mediaKeysSession)return o(new Error("invalid state"));if(c.readyState===4)if(c.status===200){this._requestLicenseFailureCount=0;let l=c.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);let d=this.config.licenseResponseCallback;if(d)try{l=d.call(this.hls,c,a,t)}catch(h){this.error(h)}r(l)}else{let l=s.errorRetry,d=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>d||c.status>=400&&c.status<500)o(new Ne({type:z.KEY_SYSTEM_ERROR,details:R.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:c,response:{url:a,data:void 0,code:c.status,text:c.statusText}},`License Request XHR failed (${a}). Status: ${c.status} (${c.statusText})`));else{let h=d-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${h} attempts left`),this.requestLicense(t,i).then(r,o)}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=c,this.setupLicenseXHR(c,a,t,i).then(({xhr:l,licenseChallenge:d})=>{t.keySystem==ue.PLAYREADY&&(d=this.unpackPlayReadyKeyMessage(l,d)),l.send(d)})})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(t,i){if(!this.config.emeEnabled)return;let s=i.media;this.media=s,$e(s,"encrypted",this.onMediaEncrypted),$e(s,"waitingforkey",this.onWaitingForKey)}onMediaDetached(){let t=this.media;t&&(ze(t,"encrypted",this.onMediaEncrypted),ze(t,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var t;if(this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},!this.mediaKeys&&!this.mediaKeySessions.length)return;let i=this.media,s=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,$i.clearKeyUriToKeyIdMap();let r=s.length;n.CDMCleanupPromise=Promise.all(s.map(o=>this.removeSession(o)).concat(i==null||(t=i.setMediaKeys(null))==null?void 0:t.catch(o=>{var a;this.log(`Could not clear media keys: ${o}`),(a=this.hls)==null||a.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${o}`)})}))).catch(o=>{var a;this.log(`Could not close sessions and clear media keys: ${o}`),(a=this.hls)==null||a.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${o}`)})}).then(()=>{r&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(t,{sessionKeys:i}){if(!(!i||!this.config.emeEnabled)&&!this.keyFormatPromise){let s=i.reduce((r,o)=>(r.indexOf(o.keyFormat)===-1&&r.push(o.keyFormat),r),[]);this.log(`Selecting key-system from session-keys ${s.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(s)}}removeSession(t){let{mediaKeysSession:i,licenseXhr:s}=t;if(i){this.log(`Remove licenses and keys and close session ${i.sessionId}`),t._onmessage&&(i.removeEventListener("message",t._onmessage),t._onmessage=void 0),t._onkeystatuseschange&&(i.removeEventListener("keystatuseschange",t._onkeystatuseschange),t._onkeystatuseschange=void 0),s&&s.readyState!==XMLHttpRequest.DONE&&s.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;let r=this.mediaKeySessions.indexOf(t);r>-1&&this.mediaKeySessions.splice(r,1);let{drmSystemOptions:o}=this.config;return(gf(o)?new Promise((c,l)=>{self.setTimeout(()=>l(new Error("MediaKeySession.remove() timeout")),8e3),i.remove().then(c)}):Promise.resolve()).catch(c=>{var l;this.log(`Could not remove session: ${c}`),(l=this.hls)==null||l.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${c}`)})}).then(()=>i.close()).catch(c=>{var l;this.log(`Could not close session: ${c}`),(l=this.hls)==null||l.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${c}`)})})}}}return n.CDMCleanupPromise=void 0,n})(),Ne=class extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}},so=class{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(p.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(p.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){let i=this.hls.config;if(i.capLevelOnFPSDrop){let s=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){let s=performance.now();if(t){if(this.lastTime){let r=s-this.lastTime,o=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,c=1e3*o/r,l=this.hls;if(l.trigger(p.FPS_DROP,{currentDropped:o,currentDecoded:a,totalDroppedFrames:i}),c>0&&o>l.config.fpsDroppedMonitoringThreshold*a){let d=l.currentLevel;l.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+d),d>0&&(l.autoLevelCapping===-1||l.autoLevelCapping>=d)&&(d=d-1,l.trigger(p.FPS_DROP_LEVEL_CAPPING,{level:d,droppedLevel:l.currentLevel}),l.autoLevelCapping=d,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){let e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){let t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}};function Dd(n,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=n,e.dispatchEvent(t)}function Rd(n,e){let t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues&&!n.cues.getCueById(e.id))try{if(n.addCue(e),!n.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){ce.debug(`[texttrack-utils]: ${i}`);try{let s=new self.TextTrackCue(e.startTime,e.endTime,e.text);s.id=e.id,n.addCue(s)}catch(s){ce.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${s}`)}}t==="disabled"&&(n.mode=t)}function si(n,e){let t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues)for(let i=n.cues.length;i--;)e&&n.cues[i].removeEventListener("enter",e),n.removeCue(n.cues[i]);t==="disabled"&&(n.mode=t)}function no(n,e,t,i){let s=n.mode;if(s==="disabled"&&(n.mode="hidden"),n.cues&&n.cues.length>0){let r=ap(n.cues,e,t);for(let o=0;o<r.length;o++)(!i||i(r[o]))&&n.removeCue(r[o])}s==="disabled"&&(n.mode=s)}function op(n,e){if(e<=n[0].startTime)return 0;let t=n.length-1;if(e>n[t].endTime)return-1;let i=0,s=t,r;for(;i<=s;)if(r=Math.floor((s+i)/2),e<n[r].startTime)s=r-1;else if(e>n[r].startTime&&i<t)i=r+1;else return r;return n[i].startTime-e<e-n[s].startTime?i:s}function ap(n,e,t){let i=[],s=op(n,e);if(s>-1)for(let r=s,o=n.length;r<o;r++){let a=n[r];if(a.startTime>=e&&a.endTime<=t)i.push(a);else if(a.startTime>t)return i}return i}function ks(n){let e=[];for(let t=0;t<n.length;t++){let i=n[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(n[t])}return e}var ro=class extends Yi{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null,i=ks(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}let s=this.findTrackForTextTrack(t);this.subtitleTrack!==s&&this.setSubtitleTrack(s)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){let{hls:e}=this;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(p.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADING,this.onLevelLoading,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(p.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){let i=this.media;if(!i)return;let s=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,s)return;ks(i.textTracks).forEach(o=>{si(o)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){let{id:i,groupId:s,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==s){this.warn(`Subtitle track with id:${i} and group:${s} not found in active group ${o?.groupId}`);return}let a=o.details;o.details=t.details,this.log(`Subtitle track ${i} "${o.name}" lang:${o.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){let t=this.hls.levels[e];if(!t)return;let i=t.subtitleGroups||null,s=this.groupIds,r=this.currentTrack;if(!i||s?.length!==i?.length||i!=null&&i.some(o=>s?.indexOf(o)===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;let o=this.tracks.filter(d=>!i||i.indexOf(d.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(d=>d.default)&&(this.selectDefaultTrack=!1),o.forEach((d,h)=>{d.id=h});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;let a=this.hls.config.subtitlePreference;if(!r&&a){this.selectDefaultTrack=!1;let d=ut(a,o);if(d>-1)r=o[d];else{let h=ut(a,this.tracks);r=this.tracks[h]}}let c=this.findTrackId(r);c===-1&&r&&(c=this.findTrackId(null));let l={subtitleTracks:o};this.log(`Updating subtitle tracks, ${o.length} track(s) found in "${i?.join(",")}" group-id`),this.hls.trigger(p.SUBTITLE_TRACKS_UPDATED,l),c!==-1&&this.trackId===-1&&this.setSubtitleTrack(c)}}findTrackId(e){let t=this.tracksInGroup,i=this.selectDefaultTrack;for(let s=0;s<t.length;s++){let r=t[s];if(!(i&&!r.default||!i&&!e)&&(!e||Ht(r,e)))return s}if(e){for(let s=0;s<t.length;s++){let r=t[s];if(zi(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<t.length;s++){let r=t[s];if(zi(e.attrs,r.attrs,["LANGUAGE"]))return s}}return-1}findTrackForTextTrack(e){if(e){let t=this.tracksInGroup;for(let i=0;i<t.length;i++){let s=t[i];if(Yr(s,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===ne.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;let t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){let i=this.currentTrack;if(i&&Ht(e,i))return i;let s=ut(e,this.tracksInGroup);if(s>-1){let r=this.tracksInGroup[s];return this.setSubtitleTrack(s),r}else{if(i)return null;{let r=ut(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);let i=e.id,s=e.groupId,r=this.getUrlWithDirectives(e.url,t),o=e.details,a=o?.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${s}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${r}`),this.hls.trigger(p.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:t||null,track:e})}toggleTrackModes(){let{media:e}=this;if(!e)return;let t=ks(e.textTracks),i=this.currentTrack,s;if(i&&(s=t.filter(r=>Yr(i,r))[0],s||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==s&&(r.mode="disabled")}),s){let r=this.subtitleDisplay?"showing":"hidden";s.mode!==r&&(s.mode=r)}}setSubtitleTrack(e){let t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!G(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;let i=this.currentTrack,s=t[e]||null;if(this.trackId=e,this.currentTrack=s,this.toggleTrackModes(),!s){this.hls.trigger(p.SUBTITLE_TRACK_SWITCH,{id:e});return}let r=!!s.details&&!s.details.live;if(e===this.trackId&&s===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:""));let{id:o,groupId:a="",name:c,type:l,url:d}=s;this.hls.trigger(p.SUBTITLE_TRACK_SWITCH,{id:o,groupId:a,name:c,type:l,url:d});let h=this.switchParams(s.url,i?.details,s.details);this.loadPlaylist(h)}};function lp(){try{return crypto.randomUUID()}catch{try{let e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{let r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(s=="x"?r:r&3|8).toString(16)})}}}function Mi(n){let e=5381,t=n.length;for(;t;)e=e*33^n.charCodeAt(--t);return(e>>>0).toString()}var ai=.025,tn=function(n){return n[n.Point=0]="Point",n[n.Range=1]="Range",n}({});function cp(n,e,t){return`${n.identifier}-${t+1}-${Mi(e)}`}var oo=class{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;let i=this.playoutLimit;return e<=0||isNaN(i)?!1:i===0?!0:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>i}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){let e=this.dateRange.startTime;if(this.snapOptions.out){let t=this.dateRange.tagAnchor;if(t)return lr(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;let e=this.dateRange.tagAnchor;if(e){let t=this.dateRange.startTime,i=lr(t,e);return t-i<.1}return!1}get resumptionOffset(){let e=this.resumeOffset,t=G(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){let e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){let t=this.resumeAnchor;if(t)return lr(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<ai))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){let e=this.playoutLimit,t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?tn.Range:tn.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return dp(this)}};function lr(n,e){return n-e.start<e.duration/2&&!(Math.abs(n-(e.start+e.duration))<ai)?e.start:e.start+e.duration}function Ld(n,e,t){let i=new self.URL(n,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function cr(n,e){for(;(t=n.assetList[++e])!=null&&t.error;)var t;return e}function dp(n){return`["${n.identifier}" ${n.cue.pre?"<pre>":n.cue.post?"<post>":""}${n.timelineStart.toFixed(2)}-${n.resumeTime.toFixed(2)}]`}function ii(n){let e=n.timelineStart,t=n.duration||0;return`["${n.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}var ao=class{constructor(e,t,i,s){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls.trigger(p.PLAYOUT_LIMIT_REACHED,{})};let r=this.hls=new e(t);this.interstitial=i,this.assetItem=s;let o=s.uri;try{o=Ld(o,t.primarySessionId).href}catch{}r.loadSource(o);let a=()=>{this.hasDetails=!0};r.once(p.LEVEL_LOADED,a),r.once(p.AUDIO_TRACK_LOADED,a),r.once(p.SUBTITLE_TRACK_LOADED,a),r.on(p.MEDIA_ATTACHING,(c,{media:l})=>{this.removeMediaListeners(),this.mediaAttached=l,this.interstitial.playoutLimit&&(l.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&r.on(p.BUFFER_APPENDED,()=>{let h=this.bufferedEnd;this.reachedPlayout(h)&&(this._bufferedEosTime=h,r.trigger(p.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){var e;return((e=this.interstitial)==null?void 0:e.appendInPlace)||!1}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;let i=this.timelineOffset,s=ie.bufferInfo(e,i,0);return this.getAssetTime(s.end)>=this._bufferedEosTime-.02}reachedPlayout(e){let i=this.interstitial.playoutLimit;return this.startOffset+e>=i}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){let e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;let t=ie.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){let e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){let e=this.assetItem.duration;return e||0}get remaining(){let e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){let t=this.timelineOffset;if(e!==t){let i=e-t;if(Math.abs(i)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){let t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){let e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}resetDetails(){let e=this.hls;if(this.hasDetails){e.stopLoad();let t=i=>delete i.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,i){this.hls.on(e,t)}once(e,t,i){this.hls.once(e,t)}off(e,t,i){this.hls.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${ii(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}},pc=.033,lo=class extends rt{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,s)=>e<=s.startOffset&&t>s.startOffset?(delete s.error,i+1):i,0):0}get duration(){let e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);let s=this.items;if(s)for(s[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(r=s[i])!=null&&r.event;){var r;i--}return i}findItemIndexAtTime(e,t){let i=this.items;if(i)for(let s=0;s<i.length;s++){let r=i[s];if(t&&t!=="primary"&&(r=r[t]),e===r.start||e>r.start&&e<r.end)return s}return-1}findJumpRestrictedIndex(e,t){let i=this.items;if(i)for(let s=e;s<=t&&i[s];s++){let r=i[s].event;if(r!=null&&r.restrictions.jump&&!r.appendInPlace)return s}return-1}findEventIndex(e){let t=this.items;if(t)for(let s=t.length;s--;){var i;if(((i=t[s].event)==null?void 0:i.identifier)===e)return s}return-1}findAssetIndex(e,t){let i=e.assetList,s=i.length;if(s>1)for(let r=0;r<s;r++){let o=i[r];if(!o.error){let a=o.timelineStart;if(t===a||t>a&&t<a+(o.duration||0))return r}}return 0}get assetIdAtEnd(){var e,t;let i=(e=this.items)==null||(t=e[this.length-1])==null?void 0:t.event;if(i){let s=i.assetList,r=s[s.length-1];if(r)return r.identifier}return null}parseInterstitialDateRanges(e,t){let i=e.main.details,{dateRanges:s}=i,r=this.events,o=this.parseDateRanges(s,{url:i.url},t),a=Object.keys(s),c=r?r.filter(l=>!a.includes(l.identifier)):[];o.length&&o.sort((l,d)=>{let h=l.cue.pre,u=l.cue.post,f=d.cue.pre,g=d.cue.post;if(h&&!f)return-1;if(f&&!h||u&&!g)return 1;if(g&&!u)return-1;if(!h&&!f&&!u&&!g){let m=l.startTime,v=d.startTime;if(m!==v)return m-v}return l.dateRange.tagOrder-d.dateRange.tagOrder}),this.events=o,c.forEach(l=>{this.removeEvent(l)}),this.updateSchedule(e,c)}updateSchedule(e,t=[]){let i=this.events||[];if(i.length||t.length||this.length<2){let s=this.items,r=this.parseSchedule(i,e);(t.length||s?.length!==r.length||r.some((a,c)=>Math.abs(a.playout.start-s[c].playout.start)>.005||Math.abs(a.playout.end-s[c].playout.end)>.005))&&(this.items=r,this.onScheduleUpdate(t,s))}}parseDateRanges(e,t,i){let s=[],r=Object.keys(e);for(let o=0;o<r.length;o++){let a=r[o],c=e[a];if(c.isInterstitial){let l=this.eventMap[a];l?l.setDateRange(c):(l=new oo(c,t),this.eventMap[a]=l,i===!1&&(l.appendInPlace=i)),s.push(l)}}return s}parseSchedule(e,t){let i=[],s=t.main.details,r=s.live?1/0:s.edge,o=0;if(e=e.filter(c=>!c.error&&!(c.cue.once&&c.hasPlayed)),e.length){this.resolveOffsets(e,t);let c=0,l=0;if(e.forEach((d,h)=>{let u=d.cue.pre,f=d.cue.post,g=e[h-1]||null,m=d.appendInPlace,v=f?r:d.startOffset,y=d.duration,T=d.timelineOccupancy===tn.Range?y:0,S=d.resumptionOffset,b=g?.startTime===v,A=v+d.cumulativeDuration,L=m?A+y:v+S;if(u||!f&&v<=0){let D=l;l+=T,d.timelineStart=A;let w=o;o+=y,i.push({event:d,start:A,end:L,playout:{start:w,end:o},integrated:{start:D,end:l}})}else if(v<=r){if(!b){let C=v-c;if(C>pc){let P=c,U=l;l+=C;let q=o;o+=C;let H={previousEvent:e[h-1]||null,nextEvent:d,start:P,end:P+C,playout:{start:q,end:o},integrated:{start:U,end:l}};i.push(H)}else C>0&&g&&(g.cumulativeDuration+=C,i[i.length-1].end=v)}f&&(L=A),d.timelineStart=A;let D=l;l+=T;let w=o;o+=y,i.push({event:d,start:A,end:L,playout:{start:w,end:o},integrated:{start:D,end:l}})}else return;let I=d.resumeTime;f||I>r?c=r:c=I}),c<r){var a;let d=c,h=l,u=r-c;l+=u;let f=o;o+=u,i.push({previousEvent:((a=i[i.length-1])==null?void 0:a.event)||null,nextEvent:null,start:c,end:d+u,playout:{start:f,end:o},integrated:{start:h,end:l}})}this.setDurations(r,o,l)}else i.push({previousEvent:null,nextEvent:null,start:0,end:r,playout:{start:0,end:r},integrated:{start:0,end:r}}),this.setDurations(r,r,r);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){let i=t.main.details,s=i.live?1/0:i.edge,r=0,o=-1;e.forEach((a,c)=>{let l=a.cue.pre,d=a.cue.post,h=l?0:d?s:a.startTime;this.updateAssetDurations(a),o===h?a.cumulativeDuration=r:(r=0,o=h),!d&&a.snapOptions.in&&(a.resumeAnchor=Wt(null,i.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)),!a.appendInPlace&&c+1<e.length&&e[c+1].startTime-e[c].resumeTime<pc&&(e[c+1].appendInPlace=!1,e[c+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));let f=G(a.resumeOffset)?a.resumeOffset:a.duration;r+=f})}primaryCanResumeInPlaceAt(e,t){let i=e.resumeTime,s=e.startTime+e.resumptionOffset;return Math.abs(i-s)>ai?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${s}`),!1):t?!Object.keys(t).some(o=>{let a=t[o].details,c=a.edge;if(i>=c)return this.log(`"${e.identifier}" resumption ${i} past ${o} playlist end ${c}`),!1;let l=Wt(null,a.fragments,i);if(!l)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${o} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;let d=o==="audio"?.175:0;return Math.abs(l.start-i)<ai+d||Math.abs(l.end-i)<ai+d?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${o} fragment bounds (${l.start}-${l.end} sn: ${l.sn} cc: ${l.cc})`),!0)}):(this.log(`"${e.identifier}" resumption ${i} can not be aligned with media (none selected)`),!1)}updateAssetDurations(e){if(!e.assetListLoaded)return;let t=e.timelineStart,i=0,s=!1,r=!1;e.assetList.forEach((o,a)=>{let c=t+i;o.startOffset=i,o.timelineStart=c,s||(s=o.duration===null),r||(r=!!o.error);let l=o.error?0:o.duration||0;i+=l}),s&&!r?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}};function At(n){return`[${n.event?'"'+n.event.identifier+'"':"primary"}: ${n.start.toFixed(2)}-${n.end.toFixed(2)}]`}var co=class{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){let i=e.assetListUrl,s;try{s=Ld(i,this.hls.sessionId,e.baseUrl)}catch(u){let f=this.assignAssetListError(e,R.ASSET_LIST_LOAD_ERROR,u,i);this.hls.trigger(p.ERROR,f);return}t&&s.protocol!=="data:"&&s.searchParams.set("_HLS_start_offset",""+t);let r=this.hls.config,o=r.loader,a=new o(r),c={responseType:"json",url:s.href},l=r.interstitialAssetListLoadPolicy.default,d={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(u,f,g,m)=>{let v=u.data,y=v?.ASSETS;if(!Array.isArray(y)){let T=this.assignAssetListError(e,R.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),g.url,f,m);this.hls.trigger(p.ERROR,T);return}e.assetListResponse=v,this.hls.trigger(p.ASSET_LIST_LOADED,{event:e,assetListResponse:v,networkDetails:m})},onError:(u,f,g,m)=>{let v=this.assignAssetListError(e,R.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${u.code} ${u.text} (${f.url})`),f.url,m,g);this.hls.trigger(p.ERROR,v)},onTimeout:(u,f,g)=>{let m=this.assignAssetListError(e,R.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${f.url})`),f.url,u,g);this.hls.trigger(p.ERROR,m)}};return a.load(c,d,h),this.hls.trigger(p.ASSET_LIST_LOADING,{event:e}),a}assignAssetListError(e,t,i,s,r,o){return e.error=i,{type:z.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:s,error:i,networkDetails:o,stats:r}}};function mc(n){n?.play().catch(()=>{})}var ho=class extends rt{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{let i=this.currentTime;if(i===void 0||this.playbackDisabled)return;let s=i-this.timelinePos;if(Math.abs(s)<1/7056e5)return;let o=s<=-.01;this.timelinePos=i,this.bufferedPos=i;let a=this.playingItem;if(!a){this.checkBuffer();return}if(o&&this.schedule.resetErrorsInRange(i,i-s)&&this.updateSchedule(),this.checkBuffer(),o&&i<a.start||i>=a.end){var c;let u=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(a)&&(c=this.media)!=null&&c.paused&&(this.shouldPlay=!1),!o){let f=this.findItemIndex(a);if(u>f){let g=this.schedule.findJumpRestrictedIndex(f+1,u);if(g>f){this.setSchedulePosition(g);return}}}this.setSchedulePosition(u);return}let l=this.playingAsset;if(!l){if(this.playingLastItem&&this.isInterstitial(a)){let u=a.event.assetList[0];u&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,u))}return}let d=l.timelineStart,h=l.duration||0;(o&&i<d||i>=d+h)&&this.setScheduleToAssetAtTime(i,l)},this.onTimeupdate=()=>{let i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;let s=this.playingItem;if(!s||this.playingLastItem)return;if(i>=s.end){this.timelinePos=s.end;let a=this.findItemIndex(s);this.setSchedulePosition(a+1)}let r=this.playingAsset;if(!r)return;let o=r.timelineStart+(r.duration||0);i>=o&&this.setScheduleToAssetAtTime(i,r)},this.onScheduleUpdate=(i,s)=>{let r=this.schedule,o=this.playingItem,a=r.events||[],c=r.items||[],l=r.durations,d=i.map(g=>g.identifier),h=!!(a.length||d.length);(h||s)&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${c.map(g=>At(g))} pos: ${this.timelinePos}`),d.length&&this.log(`Removed events ${d}`),this.playerQueue.forEach(g=>{if(g.interstitial.appendInPlace){let m=g.assetItem.timelineStart,v=g.timelineOffset-m;if(v)try{g.timelineOffset=m}catch(y){Math.abs(v)>ai&&this.warn(`${y} ("${g.assetId}" ${g.timelineOffset}->${m})`)}}});let u=null;if(o){let g=this.updateItem(o,this.timelinePos);this.itemsMatch(o,g)&&(this.playingItem=g,this.waitingItem=this.endedItem=null,u=()=>this.trimInPlace(g,o))}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);let f=this.bufferingItem;if(f){let g=this.updateItem(f,this.bufferedPos);this.itemsMatch(f,g)?(this.bufferingItem=g,u||(u=()=>this.trimInPlace(g,f))):f.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(f.event,null))}if(i.forEach(g=>{g.assetList.forEach(m=>{this.clearAssetPlayer(m.identifier,null)})}),h||s){if(this.hls.trigger(p.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:c.slice(0),durations:l,removedIds:d}),this.isInterstitial(o)&&d.includes(o.event.identifier)){this.warn(`Interstitial "${o.event.identifier}" removed while playing`),this.primaryFallback(o.event);return}u&&u(),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new co(e),this.schedule=new lo(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){let e=this.hls;e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(p.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(p.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(p.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(p.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(p.BUFFER_APPENDED,this.onBufferAppended,this),e.on(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(p.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(p.MEDIA_ENDED,this.onMediaEnded,this),e.on(p.ERROR,this.onError,this),e.on(p.DESTROYING,this.onDestroying,this)}unregisterListeners(){let e=this.hls;e&&(e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(p.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(p.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(p.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(p.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(p.BUFFER_CODECS,this.onBufferCodecs,this),e.off(p.BUFFER_APPENDED,this.onBufferAppended,this),e.off(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(p.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(p.MEDIA_ENDED,this.onMediaEnded,this),e.off(p.ERROR,this.onError,this),e.off(p.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){let e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){ze(e,"play",this.onPlay),ze(e,"pause",this.onPause),ze(e,"seeking",this.onSeeking),ze(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){let i=this.media=t.media;$e(i,"seeking",this.onSeeking),$e(i,"timeupdate",this.onTimeupdate),$e(i,"play",this.onPlay),$e(i,"pause",this.onPause)}onMediaAttached(e,t){let i=this.effectivePlayingItem,s=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!s){this.clearScheduleState();let r=this.findItemIndex(i);this.setSchedulePosition(r)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){let i=!!t.transferMedia,s=this.media;if(this.media=null,!i&&(s&&this.removeMediaListeners(s),this.detachedData)){let r=this.getBufferingPlayer();r&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,r.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;let e=this,t=()=>e.bufferingItem||e.waitingItem,i=h=>h&&e.getAssetPlayer(h.identifier),s=(h,u,f,g,m)=>{if(h){let v=h[u].start,y=h.event;if(y){if(u==="playout"||y.timelineOccupancy!==tn.Point){let T=i(f);T?.interstitial===y&&(v+=T.assetItem.startOffset+T[m])}}else{let T=g==="bufferedPos"?o():e[g];v+=T-h.start}return v}return 0},r=(h,u)=>{if(h!==0&&u!=="primary"&&e.schedule.length){var f;let g=e.schedule.findItemIndexAtTime(h),m=(f=e.schedule.items)==null?void 0:f[g];if(m){let v=m[u].start-m.start;return h+v}}return h},o=()=>{let h=e.bufferedPos;return h===Number.MAX_VALUE?a("primary"):Math.max(h,0)},a=h=>{var u;return(u=e.primaryDetails)!=null&&u.live?e.primaryDetails.edge:e.schedule.durations[h]},c=(h,u)=>{var f,g;let m=e.effectivePlayingItem;if(m!=null&&(f=m.event)!=null&&f.restrictions.skip)return;e.log(`seek to ${h} "${u}"`);let v=e.effectivePlayingItem,y=e.schedule.findItemIndexAtTime(h,u),T=(g=e.schedule.items)==null?void 0:g[y],S=e.getBufferingPlayer(),b=S?.interstitial,A=b?.appendInPlace,L=v&&e.itemsMatch(v,T);if(v&&(A||L)){let D=i(e.playingAsset),w=D?.media||e.primaryMedia;if(w){let C=u==="primary"?w.currentTime:s(v,u,e.playingAsset,"timelinePos","currentTime"),P=h-C,U=(A?C:w.currentTime)+P;if(U>=0&&(!D||A||U<=D.duration)){w.currentTime=U;return}}}if(T){let D=h;if(u!=="primary"){let C=T[u].start,P=h-C;D=T.start+P}let w=!e.isInterstitial(T);if((!e.isInterstitial(v)||v.event.appendInPlace)&&(w||T.event.appendInPlace)){let C=e.media||(A?S?.media:null);C&&(C.currentTime=D)}else if(v){let C=e.findItemIndex(v);if(y>C){let U=e.schedule.findJumpRestrictedIndex(C+1,y);if(U>C){e.setSchedulePosition(U);return}}let P=0;if(w)e.timelinePos=D,e.checkBuffer();else{var I;let U=T==null||(I=T.event)==null?void 0:I.assetList;if(U){let q=h-(T[u]||T).start;for(let H=U.length;H--;){let K=U[H];if(K.duration&&q>=K.startOffset&&q<K.startOffset+K.duration){P=H;break}}}}e.setSchedulePosition(y,P)}}},l=()=>{let h=e.effectivePlayingItem;if(e.isInterstitial(h))return h;let u=t();return e.isInterstitial(u)?u:null},d={get currentTime(){let h=l(),u=e.effectivePlayingItem;return u&&u===h?s(u,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-u.playout.start:0},set currentTime(h){let u=l(),f=e.effectivePlayingItem;f&&f===u&&c(h+f.playout.start,"playout")},get duration(){let h=l();return h?h.playout.end-h.playout.start:0},get assetPlayers(){var h;let u=(h=l())==null?void 0:h.event.assetList;return u?u.map(f=>e.getAssetPlayer(f.identifier)):[]},get playingIndex(){var h;let u=(h=l())==null?void 0:h.event;return u&&e.effectivePlayingAsset?u.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return l()}};this.manager={get events(){var h,u;return((h=e.schedule)==null||(u=h.events)==null?void 0:u.slice(0))||[]},get schedule(){var h,u;return((h=e.schedule)==null||(u=h.items)==null?void 0:u.slice(0))||[]},get interstitialPlayer(){return l()?d:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){let h=t();return e.findItemIndex(h)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){let h=e.effectivePlayingItem;return e.findItemIndex(h)},primary:{get bufferedEnd(){return o()},get currentTime(){let h=e.timelinePos;return h>0?h:0},set currentTime(h){c(h,"primary")},get duration(){return a("primary")},get seekableStart(){var h;return((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0}},integrated:{get bufferedEnd(){return s(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return s(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(h){c(h,"integrated")},get duration(){return a("integrated")},get seekableStart(){var h;return r(((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0,"integrated")}},skip:()=>{let h=e.effectivePlayingItem,u=h?.event;if(u&&!u.restrictions.skip){let f=e.findItemIndex(h);if(u.appendInPlace){let g=h.playout.start+h.event.duration;c(g+.001,"playout")}else e.advanceAfterAssetEnded(u,f,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;let t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t,i;if(this.mediaSelection===null)return;let s=this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&!s.event.appendInPlace)return;let r=this.media;!r&&(e=this.bufferingItem)!=null&&(t=e.event)!=null&&t.appendInPlace&&(r=this.primaryMedia);let o=(i=r)==null?void 0:i.currentTime;if(!(o===void 0||!G(o)))return o}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){let i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){let i=e.interstitial.appendInPlace,s=e.media;if(i&&s===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&s){this.detachedData={media:s};return}let r=e.transferMedia();this.log(`transfer MediaSource from ${e} ${me(r)}`),this.detachedData=r}else t&&s&&(this.shouldPlay||(this.shouldPlay=!s.paused))}transferMediaTo(e,t){var i,s;if(e.media===t)return;let r=null,o=this.hls,a=e!==o,c=a&&e.interstitial.appendInPlace,l=(i=this.detachedData)==null?void 0:i.mediaSource,d;if(o.media)c&&(r=o.transferMedia(),this.detachedData=r),d="Primary";else if(l){let f=this.getBufferingPlayer();f?(r=f.transferMedia(),d=`${f}`):d="detached MediaSource"}else d="detached media";if(!r){if(l)r=this.detachedData,this.log(`using detachedData: MediaSource ${me(r)}`);else if(!this.detachedData||o.media===t){let f=this.playerQueue;f.length>1&&f.forEach(g=>{if(a&&g.interstitial.appendInPlace!==c){let m=g.interstitial;this.clearInterstitial(g.interstitial,null),m.appendInPlace=!1,m.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${m}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}let h=r&&"mediaSource"in r&&((s=r.mediaSource)==null?void 0:s.readyState)!=="closed",u=h&&r?r:t;if(this.log(`${h?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${d}`),u===r){let f=a&&e.assetId===this.schedule.assetIdAtEnd;u.overrides={duration:this.schedule.duration,endOfStream:!a||f,cueRemoval:!a}}e.attachMedia(u)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){let e=this.schedule,t=e.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);let i=this.timelinePos,s=this.effectivePlayingItem;if(i===-1){let r=this.hls.startPosition;if(this.timelinePos=r,t.length&&t[0].cue.pre){let o=e.findEventIndex(t[0].identifier);this.setSchedulePosition(o)}else if(r>=0||!this.primaryLive){let o=this.timelinePos=r>0?r:0,a=e.findItemIndexAtTime(o);this.setSchedulePosition(a)}}else if(s&&!this.playingItem){let r=e.findItemIndex(s);this.setSchedulePosition(r)}}advanceAfterAssetEnded(e,t,i){let s=cr(e,i);if(!e.isAssetPastPlayoutLimit(s))this.setSchedulePosition(t,s);else{let r=this.schedule.items;if(r){let o=t+1,a=r.length;if(o>=a){this.setSchedulePosition(-1);return}let c=e.resumeTime;this.timelinePos<c&&(this.timelinePos=c,this.checkBuffer()),this.setSchedulePosition(o)}}}setScheduleToAssetAtTime(e,t){let i=this.schedule,s=t.parentIdentifier,r=i.getEvent(s);if(r){let o=i.findEventIndex(s),a=i.findAssetIndex(r,e);this.advanceAfterAssetEnded(r,o,a-1)}}setSchedulePosition(e,t){let i=this.schedule.items;if(!i||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${t}`);let s=e>=0?i[e]:null,r=this.playingItem,o=this.playingLastItem;if(this.isInterstitial(r)){var a;let l=r.event,d=this.playingAsset,h=d?.identifier,u=h?this.getAssetPlayer(h):null;if(u&&h&&(!this.eventItemsMatch(r,s)||t!==void 0&&h!==((a=l.assetList)==null?void 0:a[t].identifier))){var c;let f=l.findAssetIndex(d);this.log(`INTERSTITIAL_ASSET_ENDED ${f+1}/${l.assetList.length} ${ii(d)}`),this.endedAsset=d,this.playingAsset=null,this.hls.trigger(p.INTERSTITIAL_ASSET_ENDED,{asset:d,assetListIndex:f,event:l,schedule:i.slice(0),scheduleIndex:e,player:u}),this.retreiveMediaSource(h,s),u.media&&!((c=this.detachedData)!=null&&c.mediaSource)&&u.detachMedia()}if(!this.eventItemsMatch(r,s)&&(this.endedItem=r,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${l} ${At(r)}`),l.hasPlayed=!0,this.hls.trigger(p.INTERSTITIAL_ENDED,{event:l,schedule:i.slice(0),scheduleIndex:e}),l.cue.once)){this.updateSchedule();let f=this.schedule.items;if(s&&f){let g=this.schedule.findItemIndex(s);this.advanceSchedule(g,f,t,r,o)}return}}this.advanceSchedule(e,i,t,r,o)}advanceSchedule(e,t,i,s,r){let o=e>=0?t[e]:null,a=this.primaryMedia,c=this.playerQueue;if(c.length&&c.forEach(l=>{let d=l.interstitial,h=this.schedule.findEventIndex(d.identifier);(h<e||h>e+1)&&this.clearInterstitial(d,o)}),this.isInterstitial(o)){this.timelinePos=Math.min(Math.max(this.timelinePos,o.start),o.end);let l=o.event;if(i===void 0){i=this.schedule.findAssetIndex(l,this.timelinePos);let f=cr(l,i-1);if(l.isAssetPastPlayoutLimit(f)){this.advanceAfterAssetEnded(l,e,i);return}i=f}let d=this.waitingItem;this.assetsBuffered(o,a)||this.setBufferingItem(o);let h=this.preloadAssets(l,i);if(this.eventItemsMatch(o,d||s)||(this.waitingItem=o,this.log(`INTERSTITIAL_STARTED ${At(o)} ${l.appendInPlace?"append in place":""}`),this.hls.trigger(p.INTERSTITIAL_STARTED,{event:l,schedule:t.slice(0),scheduleIndex:e})),!l.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${l}`);return}if(l.assetListLoader&&(l.assetListLoader.destroy(),l.assetListLoader=void 0),!a){this.log(`Waiting for attachMedia to start Interstitial ${l}`);return}this.waitingItem=this.endedItem=null,this.playingItem=o;let u=l.assetList[i];if(!u){let f=t[e+1],g=this.media;f&&g&&!this.isInterstitial(f)&&g.currentTime<f.start&&(g.currentTime=this.timelinePos=f.start),this.advanceAfterAssetEnded(l,e,i||0);return}if(h||(h=this.getAssetPlayer(u.identifier)),h===null||h.destroyed){let f=l.assetList.length;this.warn(`asset ${i+1}/${f} player destroyed ${l}`),h=this.createAssetPlayer(l,u,i)}if(!this.eventItemsMatch(o,this.bufferingItem)&&l.appendInPlace&&this.isAssetBuffered(u))return;this.startAssetPlayer(h,i,t,e,a),this.shouldPlay&&mc(h.media)}else o!==null?(this.resumePrimary(o,e,s),this.shouldPlay&&mc(this.hls.media)):r&&this.isInterstitial(s)&&(this.endedItem=null,this.playingItem=s,s.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e,t;return(e=this.mediaSelection)==null||(t=e.main)==null?void 0:t.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var s;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${At(e)}`),!((s=this.detachedData)!=null&&s.mediaSource)){let o=this.timelinePos;(o<e.start||o>=e.end)&&(o=this.getPrimaryResumption(e,t),this.timelinePos=o),this.attachPrimary(o,e)}if(!i)return;let r=this.schedule.items;r&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${At(e)}`),this.hls.trigger(p.INTERSTITIALS_PRIMARY_RESUMED,{schedule:r.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){let i=e.start;if(this.primaryLive){let s=this.primaryDetails;if(t===0)return this.hls.startPosition;if(s&&(i<s.fragmentStart||i>s.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){let t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:ie.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;let s=this.primaryMedia;if(!s)return;let r=this.hls;r.media?this.checkBuffer():(this.transferMediaTo(r,s),i&&this.startLoadingPrimaryAt(e,i)),i||(this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;let s=this.hls;!s.loadingEnabled||!s.media||Math.abs((((i=s.mainForwardBufferInfo)==null?void 0:i.start)||s.media.currentTime)-e)>.5?s.startLoad(e,t):s.bufferingEnabled||s.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(p.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(p.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1)return;let i=this.hls.levels[t.level],s=he(he({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=s,this.schedule.parseInterstitialDateRanges(s,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){let i=this.hls.audioTracks[t.id],s=this.mediaSelection;if(!s){this.altSelection=he(he({},this.altSelection),{},{audio:i});return}let r=he(he({},s),{},{audio:i});this.mediaSelection=r}onSubtitleTrackUpdated(e,t){let i=this.hls.subtitleTracks[t.id],s=this.mediaSelection;if(!s){this.altSelection=he(he({},this.altSelection),{},{subtitles:i});return}let r=he(he({},s),{},{subtitles:i});this.mediaSelection=r}onAudioTrackSwitching(e,t){let i=wl(t);this.playerQueue.forEach(s=>s.hls.setAudioOption(t)||s.hls.setAudioOption(i))}onSubtitleTrackSwitch(e,t){let i=wl(t);this.playerQueue.forEach(s=>s.hls.setSubtitleOption(t)||t.id!==-1&&s.hls.setSubtitleOption(i))}onBufferCodecs(e,t){let i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){let i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){let s=this.timelinePos;this.bufferedPos=s,this.checkBuffer()}}onBufferedToEnd(e){let t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let s=0;s<t.length;s++){let r=t[s];if(r.cue.post){var i;let o=this.schedule.findEventIndex(r.identifier),a=(i=this.schedule.items)==null?void 0:i[o];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){let t=this.playingItem;if(!this.playingLastItem&&t){let i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){let i=this.schedule.items;if(e&&i){let s=this.findItemIndex(e,t);return i[s]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((r,o)=>{e.event.isAssetPastPlayoutLimit(o)&&this.clearAssetPlayer(r.identifier,null)});let i=e.end+.25,s=ie.bufferInfo(this.primaryMedia,i,0);(s.end>i||(s.nextStart||0)>i)&&(this.attachPrimary(i,null),this.flushFrontBuffer(i))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e?this.schedule.findItemIndex(e,t):-1}updateSchedule(){let e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){let t=this.schedule.items;if(!t)return;let i=ie.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,t,e)}updateBufferedPos(e,t,i){let s=this.schedule,r=this.bufferingItem;if(this.bufferedPos>e)return;if(t.length===1&&this.itemsMatch(t[0],r)){this.bufferedPos=e;return}let o=this.playingItem,a=this.findItemIndex(o),c=s.findItemIndexAtTime(e);if(this.bufferedPos<e){var l,d;let h=this.findItemIndex(r),u=Math.min(h+1,t.length-1),f=t[u];if((c===-1&&r&&e>=r.end||(l=f.event)!=null&&l.appendInPlace&&e+.01>=f.start)&&(c=u),u-a>1&&(r==null||(d=r.event)==null?void 0:d.appendInPlace)===!1)return;if(this.bufferedPos=e,c>h&&c>a)this.bufferedToItem(f);else{let g=this.primaryDetails;this.primaryLive&&g&&e>g.edge-g.targetduration&&f.start<g.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(f)&&this.preloadAssets(f.event,0)}}else i&&o&&!this.itemsMatch(o,r)&&(c===a?this.bufferedToItem(o):c===a+1&&this.bufferedToItem(t[c]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(s=>{let r=this.getAssetPlayer(s.identifier);return!(r!=null&&r.bufferedInPlaceToEnd(t))})}setBufferingItem(e){let t=this.bufferingItem,i=this.schedule;if(this.itemsMatch(e,t))this.bufferingItem!==e&&(this.bufferingItem=e);else{let{items:s,events:r}=i;if(!s||!r)return t;let o=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));let c=a?a.remaining:t?t.end-this.timelinePos:0;this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${At(e)}`+(t?` (${c.toFixed(2)} remaining)`:"")),this.playbackDisabled||(o?e.event.assetList.forEach(l=>{let d=this.getAssetPlayer(l.identifier);d&&d.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(l=>l.pauseBuffering()))),this.hls.trigger(p.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:r.slice(0),schedule:s.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return t}bufferedToItem(e,t=0){let i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;let s=this.detachedData;s?s.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){let t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){let i=e.event,s=i.assetList.length===0&&!i.assetListLoader,r=i.cue.once;if(s||!r){let o=this.preloadAssets(i,t);if(o!=null&&o.interstitial.appendInPlace){let a=i.assetList[t],c=this.primaryMedia;a&&c&&this.bufferAssetPlayer(o,c)}}}preloadAssets(e,t){let i=e.assetUrl,s=e.assetList.length,r=s===0&&!e.assetListLoader,o=e.cue.once;if(r){let c=e.timelineStart;if(e.appendInPlace){var a;let u=this.playingItem;!this.isInterstitial(u)&&(u==null||(a=u.nextEvent)==null?void 0:a.identifier)===e.identifier&&this.flushFrontBuffer(c+.25)}let l,d=0;if(!this.playingItem&&this.primaryLive&&(d=this.hls.startPosition,d===-1&&(d=this.hls.liveSyncPosition||0)),d&&!(e.cue.pre||e.cue.post)){let u=d-c;u>0&&(l=Math.round(u*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:s} ${e}${l?` live-start: ${d} start-offset: ${l}`:""}`),i)return this.createAsset(e,0,0,c,e.duration,i);let h=this.assetListLoader.loadAssetList(e,l);h&&(e.assetListLoader=h)}else if(!o&&s){for(let c=t;c<s;c++){let l=e.assetList[c],d=this.getAssetPlayerQueueIndex(l.identifier);(d===-1||this.playerQueue[d].destroyed)&&!l.error&&this.createAssetPlayer(e,l,c)}return this.getAssetPlayer(e.assetList[t].identifier)}return null}flushFrontBuffer(e){let t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(s=>{this.hls.trigger(p.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:s})})}getAssetPlayerQueueIndex(e){let t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){let t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){let{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,s,r,o){let a={parentIdentifier:e.identifier,identifier:cp(e,o,t),duration:r,startOffset:i,timelineStart:s,uri:o};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,i){let s=this.hls,r=s.userConfig,o=r.videoPreference,a=s.loadLevelObj||s.levels[s.currentLevel];(o||a)&&(o=fe({},o),a.videoCodec&&(o.videoCodec=a.videoCodec),a.videoRange&&(o.allowedVideoRanges=[a.videoRange]));let c=s.audioTracks[s.audioTrack],l=s.subtitleTracks[s.subtitleTrack],d=0;if(this.primaryLive||e.appendInPlace){let S=this.timelinePos-t.timelineStart;if(S>1){let b=t.duration;b&&S<b&&(d=S)}}let h=t.identifier,u=he(he({},r),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:s.sessionId,assetPlayerId:h,abrEwmaDefaultEstimate:s.bandwidthEstimate,interstitialsController:void 0,startPosition:d,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:o,audioPreference:c||r.audioPreference,subtitlePreference:l||r.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(u.timelineOffset=t.timelineStart));let f=u.cmcd;f!=null&&f.sessionId&&f.contentId&&(u.cmcd=fe({},f,{contentId:Mi(t.uri)})),this.getAssetPlayer(h)&&this.warn(`Duplicate date range identifier ${e} and asset ${h}`);let g=new ao(this.HlsPlayerClass,u,e,t);this.playerQueue.push(g),e.assetList[i]=t;let m=S=>{if(S.live){let L=new Error(`Interstitials MUST be VOD assets ${e}`),I={fatal:!0,type:z.OTHER_ERROR,details:R.INTERSTITIAL_ASSET_ITEM_ERROR,error:L};this.handleAssetItemError(I,e,this.schedule.findEventIndex(e.identifier),i,L.message);return}let b=S.edge-S.fragmentStart,A=t.duration;(A===null||b>A)&&(this.log(`Interstitial asset "${h}" duration change ${A} > ${b}`),t.duration=b,this.updateSchedule())};g.on(p.LEVEL_UPDATED,(S,{details:b})=>m(b)),g.on(p.LEVEL_PTS_UPDATED,(S,{details:b})=>m(b));let v=(S,b)=>{let A=this.getAssetPlayer(h);if(A&&b.tracks){A.off(p.BUFFER_CODECS,v),A.tracks=b.tracks;let L=this.primaryMedia;this.bufferingAsset===A.assetItem&&L&&!A.media&&this.bufferAssetPlayer(A,L)}};g.on(p.BUFFER_CODECS,v);let y=()=>{var S;let b=this.getAssetPlayer(h);if(this.log(`buffered to end of asset ${b}`),!b)return;let A=this.schedule.findEventIndex(e.identifier),L=(S=this.schedule.items)==null?void 0:S[A];if(this.isInterstitial(L)){let D=e.findAssetIndex(t),w=cr(e,D);if(!e.isAssetPastPlayoutLimit(w))this.bufferedToItem(L,w);else{var I;let C=(I=this.schedule.items)==null?void 0:I[A+1];C&&this.bufferedToItem(C)}}};g.on(p.BUFFERED_TO_END,y);let T=S=>()=>{if(!this.getAssetPlayer(h))return;this.shouldPlay=!0;let A=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,A,S)};return g.once(p.MEDIA_ENDED,T(i)),g.once(p.PLAYOUT_LIMIT_REACHED,T(1/0)),g.on(p.ERROR,(S,b)=>{let A=this.getAssetPlayer(h);if(b.details===R.BUFFER_STALLED_ERROR){if(A!=null&&A.media){let L=A.currentTime,I=A.duration-L;L&&e.appendInPlace&&I/A.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${h} ${e} at ${A.media.currentTime}`),y()):(this.warn(`Stalled at ${L} of ${L+I} in asset ${h} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}return}this.handleAssetItemError(b,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${b.error} ${e}`)}),g.on(p.DESTROYING,()=>{if(!this.getAssetPlayer(h))return;let b=new Error(`Asset player destroyed unexpectedly ${h}`),A={fatal:!0,type:z.OTHER_ERROR,details:R.INTERSTITIAL_ASSET_ITEM_ERROR,error:b};this.handleAssetItemError(A,e,this.schedule.findEventIndex(e.identifier),i,b.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${ii(t)}`),this.hls.trigger(p.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:g}),g}clearInterstitial(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)}),e.reset()}resetAssetPlayer(e){let t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);let i=this.playerQueue[t];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(e,t){let i=this.getAssetPlayerQueueIndex(e);if(i!==-1){this.log(`clear asset player "${e}" toSegment: ${t&&At(t)}`);let s=this.playerQueue[i];this.transferMediaFromPlayer(s,t),this.playerQueue.splice(i,1),s.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,s,r){let{interstitial:o,assetItem:a,assetId:c}=e,l=o.assetList.length,d=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!d||d.identifier!==c)&&(d&&(this.clearAssetPlayer(d.identifier,i[s]),delete d.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${l} ${ii(a)}`),this.hls.trigger(p.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:o,schedule:i.slice(0),scheduleIndex:s,player:e})),this.bufferAssetPlayer(e,r)}bufferAssetPlayer(e,t){var i,s;let{interstitial:r,assetItem:o}=e,a=this.schedule.findEventIndex(r.identifier),c=(i=this.schedule.items)==null?void 0:i[a];if(!c)return;this.setBufferingItem(c),this.bufferingAsset=o;let l=this.getBufferingPlayer();if(l===e)return;let d=r.appendInPlace;if(d&&l?.interstitial.appendInPlace===!1)return;let h=l?.tracks||((s=this.detachedData)==null?void 0:s.tracks)||this.requiredTracks;if(d&&o!==this.playingAsset){if(!e.tracks)return;if(h&&!Dc(h,e.tracks)){let u=new Error(`Asset ${ii(o)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(h)}')`),f={fatal:!0,type:z.OTHER_ERROR,details:R.INTERSTITIAL_ASSET_ITEM_ERROR,error:u},g=r.findAssetIndex(o);this.handleAssetItemError(f,r,a,g,u.message);return}}this.transferMediaTo(e,t)}handleAssetItemError(e,t,i,s,r){if(e.details===R.BUFFER_STALLED_ERROR)return;let o=t.assetList[s];this.warn(`INTERSTITIAL_ASSET_ERROR ${o&&ii(o)} ${e.error}`);let a=o?.identifier,c=this.getAssetPlayerQueueIndex(a),l=this.playerQueue[c]||null,d=this.schedule.items,h=fe({},e,{fatal:!1,errorAction:Bi(!0),asset:o,assetListIndex:s,event:t,schedule:d,scheduleIndex:i,player:l});if(this.hls.trigger(p.INTERSTITIAL_ASSET_ERROR,h),!e.fatal)return;let u=this.playingAsset,f=new Error(r);if(o&&(this.clearAssetPlayer(a,null),o.error=f),!t.assetList.some(g=>!g.error))t.error=f;else if(t.appendInPlace){for(let g=s;g<t.assetList.length;g++)this.resetAssetPlayer(t.assetList[g].identifier);this.updateSchedule()}t.error?this.primaryFallback(t):u&&u.identifier===a&&this.advanceAfterAssetEnded(t,i,s)}primaryFallback(e){let t=e.timelineStart,i=this.effectivePlayingItem;if(this.updateSchedule(),i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${i?At(i):"<none>"} error: ${e.error}`);let s=this.timelinePos;s===-1&&(s=this.hls.startPosition);let r=this.updateItem(i,s);this.itemsMatch(i,r)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));let o=this.schedule.findItemIndexAtTime(s);this.setSchedulePosition(o)}else this.checkStart()}onAssetListLoaded(e,t){var i;let s=t.event,r=s.identifier,o=t.assetListResponse.ASSETS;if(!this.schedule.hasEvent(r))return;let a=s.timelineStart,c=s.duration,l=0;o.forEach((g,m)=>{let v=parseFloat(g.DURATION);this.createAsset(s,m,l,a+l,v,g.URI),l+=v}),s.duration=l,this.log(`Loaded asset-list with duration: ${l} (was: ${c}) ${s}`);let d=this.waitingItem,h=d?.event.identifier===r;this.updateSchedule();let u=(i=this.bufferingItem)==null?void 0:i.event;if(h){var f;let g=this.schedule.findEventIndex(r),m=(f=this.schedule.items)==null?void 0:f[g];if(m){if(!this.playingItem&&this.timelinePos>m.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==g){s.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${s}`),this.primaryFallback(s);return}this.setBufferingItem(m)}this.setSchedulePosition(g)}else if(u?.identifier===r&&u.appendInPlace){let g=s.assetList[0],m=this.getAssetPlayer(g.identifier),v=this.primaryMedia;g&&m&&v&&this.bufferAssetPlayer(m,v)}}onError(e,t){switch(t.details){case R.ASSET_LIST_PARSING_ERROR:case R.ASSET_LIST_LOAD_ERROR:case R.ASSET_LIST_LOAD_TIMEOUT:{let i=t.interstitial;i&&this.primaryFallback(i);break}case R.BUFFER_STALLED_ERROR:{this.onTimeupdate(),this.checkBuffer(!0);break}}}},vc=500,uo=class extends Gi{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",W.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();let{hls:e}=this;e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(p.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();let{hls:e}=this;e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(p.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=k.IDLE,this.setInterval(vc),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){let{frag:i,success:s}=t;if(Ce(i)&&(this.fragPrevious=i),this.state=k.IDLE,!s)return;let r=this.tracksBuffered[this.currentTrackId];if(!r)return;let o,a=i.start;for(let l=0;l<r.length;l++)if(a>=r[l].start&&a<=r[l].end){o=r[l];break}let c=i.start+i.duration;o?o.end=c:(o={start:a,end:c},r.push(o)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){let{startOffset:i,endOffset:s}=t;if(i===0&&s!==Number.POSITIVE_INFINITY){let r=s-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(o=>{for(let a=0;a<o.length;){if(o[a].end<=r){o.shift();continue}else if(o[a].start<r)o[a].start=r;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(i,r,W.SUBTITLE)}}onError(e,t){let i=t.frag;i?.type===W.SUBTITLE&&(t.details===R.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==k.STOPPED&&(this.state=k.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&Sd(this.levels,t)){this.levels=t.map(i=>new jt(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{let s=new jt(i);return this.tracksBuffered[s.id]=[],s}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,W.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}let s=this.levels[this.currentTrackId];s!=null&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.state!==k.STOPPED&&this.setInterval(vc)}onSubtitleTrackLoaded(e,t){var i;let{currentTrackId:s,levels:r}=this,{details:o,id:a}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}let c=r[a];if(a>=r.length||!c)return;this.log(`Subtitle track ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""},duration:${o.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(o.live||(i=c.details)!=null&&i.live){let h=this.mainDetails;if(o.deltaUpdateFailed||!h)return;let u=h.fragments[0];if(!c.details)o.hasProgramDateTime&&h.hasProgramDateTime?(Ws(o,h),l=o.fragmentStart):u&&(l=u.start,Pr(o,l));else{var d;l=this.alignPlaylists(o,c.details,(d=this.levelLastLoaded)==null?void 0:d.details),l===0&&u&&(l=u.start,Pr(o,l))}}c.details=o,this.levelLastLoaded=c,a===s&&(this.hls.trigger(p.SUBTITLE_TRACK_UPDATED,{details:o,id:a,groupId:t.groupId}),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===k.IDLE&&(Wt(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),c.details=void 0)))}_handleFragmentLoadComplete(e){let{frag:t,payload:i}=e,s=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&s!=null&&s.key&&s.iv&&ri(s.method)){let o=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer,Oo(s.method)).catch(a=>{throw r.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{let c=performance.now();r.trigger(p.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:o,tdecrypt:c}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=k.IDLE})}}doTick(){if(!this.media){this.state=k.IDLE;return}if(this.state===k.IDLE){let{currentTrackId:e,levels:t}=this,i=t?.[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;let{config:s}=this,r=this.getLoadPosition(),o=ie.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,s.maxBufferHole),{end:a,len:c}=o,l=i.details,d=this.hls.maxBufferLength+l.levelTargetDuration;if(c>d)return;let h=l.fragments,u=h.length,f=l.edge,g=null,m=this.fragPrevious;if(a<f){let T=s.maxFragLookUpTolerance,S=a>f-T?0:T;g=Wt(m,h,Math.max(h[0].start,a),S),!g&&m&&m.start<h[0].start&&(g=h[0])}else g=h[u-1];if(g=this.filterReplacedPrimary(g,i.details),!g)return;let v=g.sn-l.startSN,y=h[v-1];if(y&&y.cc===g.cc&&this.fragmentTracker.getState(y)===xe.NOT_LOADED&&(g=y),this.fragmentTracker.getState(g)===xe.NOT_LOADED){let T=this.mapToInitFragWhenRequired(g);T&&this.loadFragment(T,i,a)}}}loadFragment(e,t,i){Ce(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new fo(this.tracksBuffered[this.currentTrackId]||[])}},fo=class{constructor(e){this.buffered=void 0;let t=(i,s,r)=>{if(s=s>>>0,s>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${r})`);return e[s][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}},hp={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},wd=n=>String.fromCharCode(hp[n]||n),it=15,_t=100,up={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},fp={17:2,18:4,21:6,22:8,23:10,19:13,20:15},gp={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},pp={25:2,26:4,29:6,30:8,31:10,27:13,28:15},mp=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],go=class{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){let i=typeof t=="function"?t():t;ce.log(`${this.time} [${e}] ${i}`)}}},Vt=function(e){let t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t},sn=class{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){let t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){let s=t[i];e.hasOwnProperty(s)&&(this[s]=e[s])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}},po=class{constructor(){this.uchar=" ",this.penState=new sn}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}},mo=class{constructor(e){this.chars=[],this.pos=0,this.currPenState=new sn,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<_t;t++)this.chars.push(new po);this.logger=e}equals(e){for(let t=0;t<_t;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<_t;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<_t;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>_t&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=_t)}moveCursor(e){let t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();let t=wd(e);if(this.pos>=_t){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<_t;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){let e=[],t=!0;for(let i=0;i<_t;i++){let s=this.chars[i].uchar;s!==" "&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}},Oi=class{constructor(e){this.rows=[],this.currRow=it-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<it;t++)this.rows.push(new mo(e));this.logger=e}reset(){for(let e=0;e<it;e++)this.rows[e].clear();this.currRow=it-1}equals(e){let t=!0;for(let i=0;i<it;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<it;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<it;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+me(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<it;a++)this.rows[a].clear();let r=this.currRow+1-this.nrRollUpRows,o=this.lastOutputScreen;if(o){let a=o.rows[r].cueStartTime,c=this.logger.time;if(a!==null&&c!==null&&a<c)for(let l=0;l<this.nrRollUpRows;l++)this.rows[t-this.nrRollUpRows+l+1].copy(o.rows[r+l])}}this.currRow=t;let i=this.rows[this.currRow];if(e.indent!==null){let r=e.indent,o=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[o].penState.foreground}let s={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+me(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());let e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;let t=[],i="",s=-1;for(let r=0;r<it;r++){let o=this.rows[r].getTextString();o&&(s=r+1,e?t.push("Row "+s+": '"+o+"'"):t.push(o.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}},nn=class{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Oi(i),this.nonDisplayedMemory=new Oi(i),this.lastOutputScreen=new Oi(i),this.currRollUpRow=this.displayedMemory.rows[it-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[it-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);let t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){let e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){let t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{let i=Math.floor(e/2)-16,s=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=s[i]}this.logger.log(2,"MIDROW: "+me(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){let t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}},rn=class{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=yp(),this.logger=void 0;let s=this.logger=new go;this.channels=[null,new nn(e,t,s),new nn(e+1,i,s)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){let s=t[i]&127,r=t[i+1]&127,o=!1,a=null;if(s===0&&r===0)continue;this.logger.log(3,()=>"["+Vt([t[i],t[i+1]])+"] -> ("+Vt([s,r])+")");let c=this.cmdHistory;if(s>=16&&s<=31){if(vp(s,r,c)){bs(null,null,c),this.logger.log(3,()=>"Repeated command ("+Vt([s,r])+") is dropped");continue}bs(s,r,this.cmdHistory),o=this.parseCmd(s,r),o||(o=this.parseMidrow(s,r)),o||(o=this.parsePAC(s,r)),o||(o=this.parseBackgroundAttributes(s,r))}else bs(null,null,c);if(!o&&(a=this.parseChars(s,r),a)){let d=this.currentChannel;d&&d>0?this.channels[d].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!o&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Vt([s,r])+" orig: "+Vt([t[i],t[i+1]]))}}parseCmd(e,t){let i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=33&&t<=35;if(!(i||s))return!1;let r=e===20||e===21||e===23?1:2,o=this.channels[r];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),this.currentChannel=r,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;let s=this.channels[i];return s?(s.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+Vt([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i,s=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,r=(e===16||e===24)&&t>=64&&t<=95;if(!(s||r))return!1;let o=e<=23?1:2;t>=64&&t<=95?i=o===1?up[e]:gp[e]:i=o===1?fp[e]:pp[e];let a=this.channels[o];return a?(a.setPAC(this.interpretPAC(i,t)),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i,s={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,s.underline=(i&1)===1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=Math.floor((i-16)/2)*4,s}parseChars(e,t){let i,s=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let o;r===17?o=t+80:r===18?o=t+112:o=t+144,this.logger.log(2,()=>"Special char '"+wd(o)+"' in channel "+i),s=[o]}else e>=32&&e<=127&&(s=t===0?[e]:[e,t]);return s&&this.logger.log(3,()=>"Char codes =  "+Vt(s).join(",")),s}parseBackgroundAttributes(e,t){let i=(e===16||e===24)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=45&&t<=47;if(!(i||s))return!1;let r,o={};e===16||e===24?(r=Math.floor((t-32)/2),o.background=mp[r],t%2===1&&(o.background=o.background+"_semi")):t===45?o.background="transparent":(o.foreground="black",t===47&&(o.underline=!0));let a=e<=23?1:2;return this.channels[a].setBkgData(o),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){let t=this.channels[e];t&&t.reset()}bs(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){let i=this.channels[t];i&&i.cueSplitAtTime(e)}}};function bs(n,e,t){t.a=n,t.b=e}function vp(n,e,t){return t.a===n&&t.b===e}function yp(){return{a:null,b:null}}var Ko=function(){if(js!=null&&js.VTTCue)return self.VTTCue;let n=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,c){if(typeof c!="string"||!Array.isArray(a))return!1;let l=c.toLowerCase();return~a.indexOf(l)?l:!1}function i(a){return t(n,a)}function s(a){return t(e,a)}function r(a,...c){let l=1;for(;l<arguments.length;l++){let d=arguments[l];for(let h in d)a[h]=d[h]}return a}function o(a,c,l){let d=this,h={enumerable:!0};d.hasBeenReset=!1;let u="",f=!1,g=a,m=c,v=l,y=null,T="",S=!0,b="auto",A="start",L=50,I="middle",D=50,w="middle";Object.defineProperty(d,"id",r({},h,{get:function(){return u},set:function(C){u=""+C}})),Object.defineProperty(d,"pauseOnExit",r({},h,{get:function(){return f},set:function(C){f=!!C}})),Object.defineProperty(d,"startTime",r({},h,{get:function(){return g},set:function(C){if(typeof C!="number")throw new TypeError("Start time must be set to a number.");g=C,this.hasBeenReset=!0}})),Object.defineProperty(d,"endTime",r({},h,{get:function(){return m},set:function(C){if(typeof C!="number")throw new TypeError("End time must be set to a number.");m=C,this.hasBeenReset=!0}})),Object.defineProperty(d,"text",r({},h,{get:function(){return v},set:function(C){v=""+C,this.hasBeenReset=!0}})),Object.defineProperty(d,"region",r({},h,{get:function(){return y},set:function(C){y=C,this.hasBeenReset=!0}})),Object.defineProperty(d,"vertical",r({},h,{get:function(){return T},set:function(C){let P=i(C);if(P===!1)throw new SyntaxError("An invalid or illegal string was specified.");T=P,this.hasBeenReset=!0}})),Object.defineProperty(d,"snapToLines",r({},h,{get:function(){return S},set:function(C){S=!!C,this.hasBeenReset=!0}})),Object.defineProperty(d,"line",r({},h,{get:function(){return b},set:function(C){if(typeof C!="number"&&C!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");b=C,this.hasBeenReset=!0}})),Object.defineProperty(d,"lineAlign",r({},h,{get:function(){return A},set:function(C){let P=s(C);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");A=P,this.hasBeenReset=!0}})),Object.defineProperty(d,"position",r({},h,{get:function(){return L},set:function(C){if(C<0||C>100)throw new Error("Position must be between 0 and 100.");L=C,this.hasBeenReset=!0}})),Object.defineProperty(d,"positionAlign",r({},h,{get:function(){return I},set:function(C){let P=s(C);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");I=P,this.hasBeenReset=!0}})),Object.defineProperty(d,"size",r({},h,{get:function(){return D},set:function(C){if(C<0||C>100)throw new Error("Size must be between 0 and 100.");D=C,this.hasBeenReset=!0}})),Object.defineProperty(d,"align",r({},h,{get:function(){return w},set:function(C){let P=s(C);if(!P)throw new SyntaxError("An invalid or illegal string was specified.");w=P,this.hasBeenReset=!0}})),d.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o}(),vo=class{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}};function kd(n){function e(i,s,r,o){return(i|0)*3600+(s|0)*60+(r|0)+parseFloat(o||0)}let t=n.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}var yo=class{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){let i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}};function Pd(n,e,t,i){let s=i?n.split(i):[n];for(let r in s){if(typeof s[r]!="string")continue;let o=s[r].split(t);if(o.length!==2)continue;let a=o[0],c=o[1];e(a,c)}}var _o=new Ko(0,0,""),As=_o.align==="middle"?"middle":"center";function _p(n,e,t){let i=n;function s(){let a=kd(n);if(a===null)throw new Error("Malformed timestamp: "+i);return n=n.replace(/^[^\sa-zA-Z-]+/,""),a}function r(a,c){let l=new yo;Pd(a,function(u,f){let g;switch(u){case"region":for(let m=t.length-1;m>=0;m--)if(t[m].id===f){l.set(u,t[m].region);break}break;case"vertical":l.alt(u,f,["rl","lr"]);break;case"line":g=f.split(","),l.integer(u,g[0]),l.percent(u,g[0])&&l.set("snapToLines",!1),l.alt(u,g[0],["auto"]),g.length===2&&l.alt("lineAlign",g[1],["start",As,"end"]);break;case"position":g=f.split(","),l.percent(u,g[0]),g.length===2&&l.alt("positionAlign",g[1],["start",As,"end","line-left","line-right","auto"]);break;case"size":l.percent(u,f);break;case"align":l.alt(u,f,["start",As,"end","left","right"]);break}},/:/,/\s/),c.region=l.get("region",null),c.vertical=l.get("vertical","");let d=l.get("line","auto");d==="auto"&&_o.line===-1&&(d=-1),c.line=d,c.lineAlign=l.get("lineAlign","start"),c.snapToLines=l.get("snapToLines",!0),c.size=l.get("size",100),c.align=l.get("align",As);let h=l.get("position","auto");h==="auto"&&_o.position===50&&(h=c.align==="start"||c.align==="left"?0:c.align==="end"||c.align==="right"?100:50),c.position=h}function o(){n=n.replace(/^\s+/,"")}if(o(),e.startTime=s(),o(),n.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);n=n.slice(3),o(),e.endTime=s(),o(),r(n,e)}function Md(n){return n.replace(/<br(?: \/)?>/gi,`
`)}var Eo=class{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new vo,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){let t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,o=0;for(r=Md(r);o<r.length&&r[o]!=="\r"&&r[o]!==`
`;)++o;let a=r.slice(0,o);return r[o]==="\r"&&++o,r[o]===`
`&&++o,t.buffer=r.slice(o),a}function s(r){Pd(r,function(o,a){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();let a=r.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let o=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(o?o=!1:r=i(),t.state){case"HEADER":/:/.test(r)?s(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new Ko(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{_p(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{let a=r.indexOf("-->")!==-1;if(!r||a&&(o=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){let e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}},Ep=/\r\n|\n\r|\n|\r/g,dr=function(e,t,i=0){return e.slice(i,i+t.length)===t},Sp=function(e){let t=parseInt(e.slice(-3)),i=parseInt(e.slice(-6,-4)),s=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!G(t)||!G(i)||!G(s)||!G(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*s,t+=60*60*1e3*r,t};function jo(n,e,t){return Mi(n.toString())+Mi(e.toString())+Mi(t)}var xp=function(e,t,i){let s=e[t],r=e[s.prevCC];if(!r||!r.new&&s.new){e.ccOffset=e.presentationOffset=s.start,s.new=!1;return}for(;(o=r)!=null&&o.new;){var o;e.ccOffset+=s.start-r.start,s.new=!1,s=r,r=e[s.prevCC]}e.presentationOffset=i};function Tp(n,e,t,i,s,r,o){let a=new Eo,c=Ge(new Uint8Array(n)).trim().replace(Ep,`
`).split(`
`),l=[],d=e?lg(e.baseTime,e.timescale):0,h="00:00.000",u=0,f=0,g,m=!0;a.oncue=function(v){let y=t[i],T=t.ccOffset,S=(u-d)/9e4;if(y!=null&&y.new&&(f!==void 0?T=t.ccOffset=y.start:xp(t,i,S)),S){if(!e){g=new Error("Missing initPTS for VTT MPEGTS");return}T=S-t.presentationOffset}let b=v.endTime-v.startTime,A=Ye((v.startTime+T-f)*9e4,s*9e4)/9e4;v.startTime=Math.max(A,0),v.endTime=Math.max(A+b,0);let L=v.text.trim();v.text=decodeURIComponent(encodeURIComponent(L)),v.id||(v.id=jo(v.startTime,v.endTime,L)),v.endTime>0&&l.push(v)},a.onparsingerror=function(v){g=v},a.onflush=function(){if(g){o(g);return}r(l)},c.forEach(v=>{if(m)if(dr(v,"X-TIMESTAMP-MAP=")){m=!1,v.slice(16).split(",").forEach(y=>{dr(y,"LOCAL:")?h=y.slice(6):dr(y,"MPEGTS:")&&(u=parseInt(y.slice(7)))});try{f=Sp(h)/1e3}catch(y){g=y}return}else v===""&&(m=!1);a.parse(v+`
`)}),a.flush()}var hr="stpp.ttml.im1t",Od=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Fd=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,bp={left:"start",center:"center",right:"end",start:"start",end:"end"};function yc(n,e,t,i){let s=te(new Uint8Array(n),["mdat"]);if(s.length===0){i(new Error("Could not parse IMSC1 mdat"));return}let r=s.map(a=>Ge(a)),o=ag(e.baseTime,1,e.timescale);try{r.forEach(a=>t(Ap(a,o)))}catch(a){i(a)}}function Ap(n,e){let s=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("tt")[0];if(!s)throw new Error("Invalid ttml");let r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},o=Object.keys(r).reduce((h,u)=>(h[u]=s.getAttribute(`ttp:${u}`)||r[u],h),{}),a=s.getAttribute("xml:space")!=="preserve",c=_c(ur(s,"styling","style")),l=_c(ur(s,"layout","region")),d=ur(s,"body","[begin]");return[].map.call(d,h=>{let u=Nd(h,a);if(!u||!h.hasAttribute("begin"))return null;let f=gr(h.getAttribute("begin"),o),g=gr(h.getAttribute("dur"),o),m=gr(h.getAttribute("end"),o);if(f===null)throw Ec(h);if(m===null){if(g===null)throw Ec(h);m=f+g}let v=new Ko(f-e,m-e,u);v.id=jo(v.startTime,v.endTime,v.text);let y=l[h.getAttribute("region")],T=c[h.getAttribute("style")],S=Ip(y,T,c),{textAlign:b}=S;if(b){let A=bp[b];A&&(v.lineAlign=A),v.align=b}return fe(v,S),v}).filter(h=>h!==null)}function ur(n,e,t){let i=n.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function _c(n){return n.reduce((e,t)=>{let i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function Nd(n,e){return[].slice.call(n.childNodes).reduce((t,i,s)=>{var r;return i.nodeName==="br"&&s?t+`
`:(r=i.childNodes)!=null&&r.length?Nd(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function Ip(n,e,t){let i="http://www.w3.org/ns/ttml#styling",s=null,r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=n!=null&&n.hasAttribute("style")?n.getAttribute("style"):null;return o&&t.hasOwnProperty(o)&&(s=t[o]),r.reduce((a,c)=>{let l=fr(e,i,c)||fr(n,i,c)||fr(s,i,c);return l&&(a[c]=l),a},{})}function fr(n,e,t){return n&&n.hasAttributeNS(e,t)?n.getAttributeNS(e,t):null}function Ec(n){return new Error(`Could not parse ttml timestamp ${n}`)}function gr(n,e){if(!n)return null;let t=kd(n);return t===null&&(Od.test(n)?t=Cp(n,e):Fd.test(n)&&(t=Dp(n,e))),t}function Cp(n,e){let t=Od.exec(n),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function Dp(n,e){let t=Fd.exec(n),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}var ni=class{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}},So=class{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=xc(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(p.FRAG_LOADING,this.onFragLoading,this),e.on(p.FRAG_LOADED,this.onFragLoaded,this),e.on(p.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(p.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(p.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){let{hls:e}=this;e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(p.FRAG_LOADING,this.onFragLoading,this),e.off(p.FRAG_LOADED,this.onFragLoaded,this),e.off(p.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(p.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(p.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){let e=new ni(this,"textTrack1"),t=new ni(this,"textTrack2"),i=new ni(this,"textTrack3"),s=new ni(this,"textTrack4");this.cea608Parser1=new rn(1,e,t),this.cea608Parser2=new rn(3,i,s)}addCues(e,t,i,s,r){let o=!1;for(let a=r.length;a--;){let c=r[a],l=Rp(c[0],c[1],t,i);if(l>=0&&(c[0]=Math.min(c[0],t),c[1]=Math.max(c[1],i),o=!0,l/(i-t)>.5))return}if(o||r.push([t,i]),this.config.renderTextTracksNatively){let a=this.captionsTracks[e];this.Cues.newCue(a,t,i,s)}else{let a=this.Cues.newCue(null,t,i,s);this.hls.trigger(p.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){let{unparsedVttFrags:o}=this;i===W.MAIN&&(this.initPTS[t.cc]={baseTime:s,timescale:r}),o.length&&(this.unparsedVttFrags=[],o.forEach(a=>{this.onFragLoaded(p.FRAG_LOADED,a)}))}getExistingTrack(e,t){let{media:i}=this;if(i)for(let s=0;s<i.textTracks.length;s++){let r=i.textTracks[s];if(Sc(r,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;let{captionsProperties:t,captionsTracks:i,media:s}=this,{label:r,languageCode:o}=t[e],a=this.getExistingTrack(r,o);if(a)i[e]=a,si(i[e]),Dd(i[e],s);else{let c=this.createTextTrack("captions",r,o);c&&(c[e]=!0,i[e]=c)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;let t=this.captionsProperties[e];if(!t)return;let i=t.label,s={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=s,this.hls.trigger(p.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(e,t,i){let s=this.media;if(s)return s.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){let i=!!t.transferMedia;if(this.media=null,i)return;let{captionsTracks:s}=this;Object.keys(s).forEach(r=>{si(s[r]),delete s[r]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=xc(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){let{media:e}=this;if(!e)return;let t=e.textTracks;if(t)for(let i=0;i<t.length;i++)si(t[i])}onSubtitleTracksUpdated(e,t){let i=t.subtitleTracks||[],s=i.some(r=>r.textCodec===hr);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(Sd(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){let o=this.media,a=o?ks(o.textTracks):null;if(this.tracks.forEach((c,l)=>{let d;if(a){let h=null;for(let u=0;u<a.length;u++)if(a[u]&&Sc(a[u],c)){h=a[u],a[u]=null;break}h&&(d=h)}if(d)si(d);else{let h=Bd(c);d=this.createTextTrack(h,c.name,c.lang),d&&(d.mode="disabled")}d&&this.textTracks.push(d)}),a!=null&&a.length){let c=a.filter(l=>l!==null).map(l=>l.label);c.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${c.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){let o=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(p.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{let s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!s)return;let r=`textTrack${s[1]}`,o=this.captionsProperties[r];o&&(o.label=i.name,i.lang&&(o.languageCode=i.lang),o.media=i)})}closedCaptionsForLevel(e){let t=this.hls.levels[e.level];return t?.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===W.MAIN){var i,s;let{cea608Parser1:r,cea608Parser2:o,lastSn:a}=this,{cc:c,sn:l}=t.frag,d=(i=(s=t.part)==null?void 0:s.index)!=null?i:-1;r&&o&&(l!==a+1||l===a&&d!==this.lastPartIndex+1||c!==this.lastCc)&&(r.reset(),o.reset()),this.lastCc=c,this.lastSn=l,this.lastPartIndex=d}}onFragLoaded(e,t){let{frag:i,payload:s}=t;if(i.type===W.SUBTITLE)if(s.byteLength){let r=i.decryptdata,o="stats"in t;if(r==null||!r.encrypted||o){let a=this.tracks[i.level],c=this.vttCCs;c[i.cc]||(c[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),a&&a.textCodec===hr?this._parseIMSC1(i,s):this._parseVTTs(t)}}else this.hls.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){let i=this.hls;yc(t,this.initPTS[e.cc],s=>{this._appendCues(s,e.level),i.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},s=>{i.logger.log(`Failed to parse IMSC1: ${s}`),i.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:s})})}_parseVTTs(e){var t;let{frag:i,payload:s}=e,{initPTS:r,unparsedVttFrags:o}=this,a=r.length-1;if(!r[i.cc]&&a===-1){o.push(e);return}let c=this.hls,l=(t=i.initSegment)!=null&&t.data?qe(i.initSegment.data,new Uint8Array(s)).buffer:s;Tp(l,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,d=>{this._appendCues(d,i.level),c.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},d=>{let h=d.message==="Missing initPTS for VTT MPEGTS";h?o.push(e):this._fallbackToIMSC1(i,s),c.logger.log(`Failed to parse VTT cue: ${d}`),!(h&&a>i.cc)&&c.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:d})})}_fallbackToIMSC1(e,t){let i=this.tracks[e.level];i.textCodec||yc(t,this.initPTS[e.cc],()=>{i.textCodec=hr,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){let i=this.hls;if(this.config.renderTextTracksNatively){let s=this.textTracks[t];if(!s||s.mode==="disabled")return;e.forEach(r=>Rd(s,r))}else{let s=this.tracks[t];if(!s)return;let r=s.default?"default":"subtitles"+t;i.trigger(p.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){let{frag:i}=t;i.type===W.SUBTITLE&&this.onFragLoaded(p.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;let{frag:i,samples:s}=t;if(!(i.type===W.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let r=0;r<s.length;r++){let o=s[r].bytes;if(o){this.cea608Parser1||this.initCea608Parsers();let a=this.extractCea608Data(o);this.cea608Parser1.addData(s[r].pts,a[0]),this.cea608Parser2.addData(s[r].pts,a[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:s,type:r}){let{media:o}=this;if(!(!o||o.currentTime<i)){if(!r||r==="video"){let{captionsTracks:a}=this;Object.keys(a).forEach(c=>no(a[c],t,i))}if(this.config.renderTextTracksNatively&&t===0&&s!==void 0){let{textTracks:a}=this;Object.keys(a).forEach(c=>no(a[c],t,s))}}}extractCea608Data(e){let t=[[],[]],i=e[0]&31,s=2;for(let r=0;r<i;r++){let o=e[s++],a=127&e[s++],c=127&e[s++];if(a===0&&c===0)continue;if((4&o)!==0){let d=3&o;(d===0||d===1)&&(t[d].push(a),t[d].push(c))}}return t}};function Bd(n){return n.characteristics&&/transcribes-spoken-dialog/gi.test(n.characteristics)&&/describes-music-and-sound/gi.test(n.characteristics)?"captions":"subtitles"}function Sc(n,e){return!!n&&n.kind===Bd(e)&&Yr(e,n)}function Rp(n,e,t,i){return Math.min(e,i)-Math.max(n,t)}function xc(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}var Lp=/\s/,wp={newCue(n,e,t,i){let s=[],r,o,a,c,l,d=self.VTTCue||self.TextTrackCue;for(let u=0;u<i.rows.length;u++)if(r=i.rows[u],a=!0,c=0,l="",!r.isEmpty()){var h;for(let m=0;m<r.chars.length;m++)Lp.test(r.chars[m].uchar)&&a?c++:(l+=r.chars[m].uchar,a=!1);r.cueStartTime=e,e===t&&(t+=1e-4),c>=16?c--:c++;let f=Md(l.trim()),g=jo(e,t,f);n!=null&&(h=n.cues)!=null&&h.getCueById(g)||(o=new d(e,t,f),o.id=g,o.line=u+1,o.align="left",o.position=10+Math.min(80,Math.floor(c*8/32)*10),s.push(o))}return n&&s.length&&(s.sort((u,f)=>u.line==="auto"||f.line==="auto"?0:u.line>8&&f.line>8?f.line-u.line:u.line-f.line),s.forEach(u=>Rd(n,u))),s}};function kp(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var Pp=/(\d+)-(\d+)\/(\d+)/,on=class{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||Np,this.controller=new self.AbortController,this.stats=new Fi}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){let s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();let r=Mp(e,this.controller.signal),o=e.responseType==="arraybuffer",a=o?"byteLength":"length",{maxTimeToFirstByteMs:c,maxLoadTimeMs:l}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=c&&G(c)?c:l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(s,e,this.response))},t.timeout),(Wi(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(h=>{var u;this.response=this.loader=h;let f=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(s,e,this.response))},l-(f-s.loading.start)),!h.ok){let{status:m,statusText:v}=h;throw new xo(v||"fetch, bad network response",m,h)}s.loading.first=f,s.total=Fp(h.headers)||s.total;let g=(u=this.callbacks)==null?void 0:u.onProgress;return g&&G(t.highWaterMark)?this.loadProgressively(h,s,e,t.highWaterMark,g):o?h.arrayBuffer():e.responseType==="json"?h.json():h.text()}).then(h=>{var u,f;let g=this.response;if(!g)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);let m=h[a];m&&(s.loaded=s.total=m);let v={url:g.url,data:h,code:g.status},y=(u=this.callbacks)==null?void 0:u.onProgress;y&&!G(t.highWaterMark)&&y(s,e,h,g),(f=this.callbacks)==null||f.onSuccess(v,s,e,g)}).catch(h=>{var u;if(self.clearTimeout(this.requestTimeout),s.aborted)return;let f=h&&h.code||0,g=h?h.message:null;(u=this.callbacks)==null||u.onError({code:f,text:g},e,h?h.details:null,s)})}getCacheAge(){let e=null;if(this.response){let t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,s=0,r){let o=new Ys,a=e.body.getReader(),c=()=>a.read().then(l=>{if(l.done)return o.dataLength&&r(t,i,o.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));let d=l.value,h=d.length;return t.loaded+=h,h<s||o.dataLength?(o.push(d),o.dataLength>=s&&r(t,i,o.flush().buffer,e)):r(t,i,d.buffer,e),c()}).catch(()=>Promise.reject());return c()}};function Mp(n,e){let t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(fe({},n.headers))};return n.rangeEnd&&t.headers.set("Range","bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)),t}function Op(n){let e=Pp.exec(n);if(e)return parseInt(e[2])-parseInt(e[1])+1}function Fp(n){let e=n.get("Content-Range");if(e){let i=Op(e);if(G(i))return i}let t=n.get("Content-Length");if(t)return parseInt(t)}function Np(n,e){return new self.Request(n.url,e)}var xo=class extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}},Bp=/^age:\s*[\d.]+\s*$/im,an=class{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new Fi,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){let e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){let{config:e,context:t}=this;if(!e||!t)return;let i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;let r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return r(i,t.url)}).catch(o=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),r(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(o=>{var a;(a=this.callbacks)==null||a.onError({code:i.status,text:o.message},t,i,s)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);let s=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:o}=i.loadPolicy;if(s)for(let a in s)e.setRequestHeader(a,s[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&G(r)?r:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){let{context:e,loader:t,stats:i}=this;if(!e||!t)return;let s=t.readyState,r=this.config;if(!i.aborted&&s>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;let l=t.status,d=t.responseType==="text"?t.responseText:null;if(l>=200&&l<300){let g=d??t.response;if(g!=null){var o,a;i.loading.end=Math.max(self.performance.now(),i.loading.first);let m=t.responseType==="arraybuffer"?g.byteLength:g.length;i.loaded=i.total=m,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);let v=(o=this.callbacks)==null?void 0:o.onProgress;v&&v(i,e,g,t);let y={url:t.responseURL,data:g,code:l};(a=this.callbacks)==null||a.onSuccess(y,i,e,t);return}}let h=r.loadPolicy.errorRetry,u=i.retry,f={url:e.url,data:void 0,code:l};if(Gs(h,u,!1,f))this.retry(h);else{var c;ce.error(`${l} while loading ${e.url}`),(c=this.callbacks)==null||c.onError({code:l,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;let e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Gs(e,t,!0))this.retry(e);else{var i;ce.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);let s=this.callbacks;s&&(this.abortInternal(),s.onTimeout(this.stats,this.context,this.loader))}}retry(e){let{context:t,stats:i}=this;this.retryDelay=Mo(e,i.retry),i.retry++,ce.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t?.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){let t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&Bp.test(this.loader.getAllResponseHeaders())){let t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}},Up={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Vp=he(he({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:an,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:xr,bufferController:Qr,capLevelController:Zr,errorController:Tr,fpsController:so,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Yc,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:Up},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},$p()),{},{subtitleStreamController:uo,subtitleTrackController:ro,timelineController:So,audioStreamController:Wr,audioTrackController:zr,emeController:rp,cmcdController:to,contentSteeringController:io,interstitialsController:ho});function $p(){return{cueHandler:wp,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function Gp(n,e,t){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');let i=To(n),s=["manifest","level","frag"],r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return s.forEach(o=>{let a=`${o==="level"?"playlist":o}LoadPolicy`,c=e[a]===void 0,l=[];r.forEach(d=>{let h=`${o}Loading${d}`,u=e[h];if(u!==void 0&&c){l.push(h);let f=i[a].default;switch(e[a]={default:f},d){case"TimeOut":f.maxLoadTimeMs=u,f.maxTimeToFirstByteMs=u;break;case"MaxRetry":f.errorRetry.maxNumRetry=u,f.timeoutRetry.maxNumRetry=u;break;case"RetryDelay":f.errorRetry.retryDelayMs=u,f.timeoutRetry.retryDelayMs=u;break;case"MaxRetryTimeout":f.errorRetry.maxRetryDelayMs=u,f.timeoutRetry.maxRetryDelayMs=u;break}}}),l.length&&t.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${me(e[a])}`)}),he(he({},i),e)}function To(n){return n&&typeof n=="object"?Array.isArray(n)?n.map(To):Object.keys(n).reduce((e,t)=>(e[t]=To(n[t]),e),{}):n}function Hp(n,e){let t=n.loader;t!==on&&t!==an?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),n.progressive=!1):kp()&&(n.loader=on,n.progressive=!0,n.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}var Ps=2,Kp=.1,jp=.05,Wp=100,bo=class extends Hs{constructor(e,t){super("gap-controller",e.logger),this.hls=null,this.fragmentTracker=null,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var i;(i=this.media)!=null&&i.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var i;this.ended=((i=this.media)==null?void 0:i.currentTime)||1,this.hls.trigger(p.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){let{hls:e}=this;e&&(e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){let{hls:e}=this;e&&(e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(Wp),this.mediaSource=t.mediaSource;let i=this.media=t.media;$e(i,"playing",this.onMediaPlaying),$e(i,"waiting",this.onMediaWaiting),$e(i,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();let{media:i}=this;i&&(ze(i,"playing",this.onMediaPlaying),ze(i,"waiting",this.onMediaWaiting),ze(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;let t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var i,s;let r=(i=this.hls)==null?void 0:i.config;if(!r)return;let o=this.media;if(!o)return;let{seeking:a}=o,c=this.seeking&&!a,l=!this.seeking&&a,d=o.paused&&!a||o.ended||o.playbackRate===0;if(this.seeking=a,e!==t){t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,r.nudgeOnVideoHole&&!d&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(l||c){c&&this.stallResolved(e);return}if(d){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&o.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(p.MEDIA_ENDED,{stalled:!1}));return}if(!ie.getBuffered(o).length){this.nudgeRetry=0;return}let h=ie.bufferInfo(o,e,0),u=h.nextStart||0,f=this.fragmentTracker;if(a&&f&&this.hls){let L=Tc(this.hls.inFlightFragments,e),I=h.len>Ps,D=!u||L||u-e>Ps&&!f.getPartialFragment(e);if(I||D)return;this.moved=!1}let g=(s=this.hls)==null?void 0:s.latestLevelDetails;if(!this.moved&&this.stalled!==null&&f){if(!(h.len>0)&&!u)return;let I=Math.max(u,h.start||0)-e,w=!!(g!=null&&g.live)?g.targetduration*2:Ps,C=f.getPartialFragment(e);if(I>0&&(I<=w||C)){o.paused||this._trySkipBufferHole(C);return}}let m=r.detectStallWithCurrentTimeMs,v=self.performance.now(),y=this.waiting,T=this.stalled;if(T===null)if(y>0&&v-y<m)T=this.stalled=y;else{this.stalled=v;return}let S=v-T;if(!a&&(S>=m||y)&&this.hls){var b;if(((b=this.mediaSource)==null?void 0:b.readyState)==="ended"&&!(g!=null&&g.live)&&Math.abs(e-(g?.edge||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(p.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(h),!this.media||!this.hls)return}let A=ie.bufferInfo(o,e,r.maxBufferHole);this._tryFixBufferStall(A,S,e)}stallResolved(e){let t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){let i=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(p.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var i;let s=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(i=this.buffered.audio)!=null&&i.length&&s&&s.length>1&&e>s.end(0)){let r=ie.bufferedInfo(ie.timeRangesToArray(this.buffered.audio),e,0);if(r.len>1&&t>=r.start){let o=ie.timeRangesToArray(s),a=ie.bufferedInfo(o,t,0).bufferedIndex;if(a>-1&&a<o.length-1){let c=ie.bufferedInfo(o,e,0).bufferedIndex,l=o[a].end,d=o[a+1].start;if((c===-1||c>a)&&d-l<1&&e-l<2){let h=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${l} -> ${d} buffered index: ${c}`);this.warn(h.message),this.media.currentTime+=1e-6;let u=this.fragmentTracker.getPartialFragment(e)||void 0,f=ie.bufferInfo(this.media,e,0);this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:h,reason:h.message,frag:u,buffer:f.len,bufferInfo:f})}}}}}_tryFixBufferStall(e,t,i){var s,r;let{fragmentTracker:o,media:a}=this,c=(s=this.hls)==null?void 0:s.config;if(!a||!o||!c)return;let l=(r=this.hls)==null?void 0:r.latestLevelDetails,d=o.getPartialFragment(i);if((d||l!=null&&l.live&&i<l.fragmentStart)&&(this._trySkipBufferHole(d)||!this.media))return;let h=e.buffered,u=this.adjacentTraversal(e,i);(h&&h.length>1&&e.len>c.maxBufferHole||e.nextStart&&(e.nextStart-i<c.maxBufferHole||u))&&(t>c.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){let i=this.fragmentTracker,s=e.nextStart;if(i&&s){let r=i.getFragAtPos(t,W.MAIN),o=i.getFragAtPos(s,W.MAIN);if(r&&o)return o.sn-r.sn<2}return!1}_reportStall(e){let{hls:t,media:i,stallReported:s,stalled:r}=this;if(!s&&r!==null&&i&&t){this.stallReported=!0;let o=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${me(e)})`);this.warn(o.message),t.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.BUFFER_STALLED_ERROR,fatal:!1,error:o,buffer:e.len,bufferInfo:e,stalled:{start:r}})}}_trySkipBufferHole(e){var t;let{fragmentTracker:i,media:s}=this,r=(t=this.hls)==null?void 0:t.config;if(!s||!i||!r)return 0;let o=s.currentTime,a=ie.bufferInfo(s,o,0),c=o<a.start?a.start:a.nextStart;if(c&&this.hls){let d=a.len<=r.maxBufferHole,h=a.len>0&&a.len<1&&s.readyState<3,u=c-o;if(u>0&&(d||h)){if(u>r.maxBufferHole){let g=!1;if(o===0){let m=i.getAppendedFrag(0,W.MAIN);m&&c<m.end&&(g=!0)}if(!g){let m=e||i.getAppendedFrag(o,W.MAIN);if(m){var l;if(!((l=this.hls.loadLevelObj)!=null&&l.details)||Tc(this.hls.inFlightFragments,c))return 0;let y=!1,T=m.end;for(;T<c;){let S=i.getPartialFragment(T);if(S)T+=S.duration;else{y=!0;break}}if(y)return 0}}}let f=Math.max(c+jp,o+Kp);if(this.warn(`skipping hole, adjusting currentTime from ${o} to ${f}`),this.moved=!0,s.currentTime=f,!(e!=null&&e.gap)){let g=new Error(`fragment loaded with buffer holes, seeking from ${o} to ${f}`);this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:g,reason:g.message,frag:e||void 0,buffer:a.len,bufferInfo:a})}return f}}return 0}_tryNudgeBuffer(e){let{hls:t,media:i,nudgeRetry:s}=this,r=t?.config;if(!i||!r)return 0;let o=i.currentTime;if(this.nudgeRetry++,s<r.nudgeMaxRetry){let a=o+(s+1)*r.nudgeOffset,c=new Error(`Nudging 'currentTime' from ${o} to ${a}`);this.warn(c.message),i.currentTime=a,t.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.BUFFER_NUDGE_ON_STALL,error:c,fatal:!1,buffer:e.len,bufferInfo:e})}else{let a=new Error(`Playhead still not moving while enough data buffered @${o} after ${r.nudgeMaxRetry} nudges`);this.error(a.message),t.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:e.len,bufferInfo:e})}}};function Tc(n,e){let t=bc(n.main);if(t&&t.start<=e)return t;let i=bc(n.audio);return i&&i.start<=e?i:null}function bc(n){if(!n)return null;switch(n.state){case k.IDLE:case k.STOPPED:case k.ENDED:case k.ERROR:return null}return n.frag}var Yp=.25;function Ao(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function Ac(n,e,t,i,s){let r=new n(e,t,"");try{r.value=i,s&&(r.type=s)}catch{r=new n(e,t,me(s?he({type:s},i):i))}return r}var Is=(()=>{let n=Ao();try{n&&new n(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function zp(n){return Uint8Array.from(n.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}var Io=class{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(p.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){let{hls:e}=this;e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(p.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}_unregisterListeners(){let{hls:e}=this;e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(p.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}onMediaAttaching(e,t){var i;this.media=t.media,((i=t.overrides)==null?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){let e=this.hls.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&(this.removeCues&&si(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){let t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){let i=e[t];if(i.kind==="metadata"&&i.label==="id3")return Dd(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;let{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:s}}}=this;if(!i&&!s)return;let{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));let o=Ao();if(o)for(let a=0;a<r.length;a++){let c=r[a].type;if(c===Ve.emsg&&!i||!s)continue;let l=dd(r[a].data);if(l){let d=r[a].pts,h=d+r[a].duration;h>Is&&(h=Is),h-d<=0&&(h=d+Yp);for(let f=0;f<l.length;f++){let g=l[f];if(!hd(g)){this.updateId3CueEnds(d,c);let m=Ac(o,d,h,g,c);m&&this.id3Track.addCue(m)}}}}}updateId3CueEnds(e,t){var i;let s=(i=this.id3Track)==null?void 0:i.cues;if(s)for(let r=s.length;r--;){let o=s[r];o.type===t&&o.startTime<e&&o.endTime===Is&&(o.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:s}){let{id3Track:r,hls:o}=this;if(!o)return;let{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:c}}=o;if(r&&(a||c)){let l;s==="audio"?l=d=>d.type===Ve.audioId3&&c:s==="video"?l=d=>d.type===Ve.emsg&&a:l=d=>d.type===Ve.audioId3&&c||d.type===Ve.emsg&&a,no(r,t,i,l)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;let{id3Track:i}=this,{dateRanges:s}=e,r=Object.keys(s),o=this.dateRangeCuesAppended;if(i&&t){var a;if((a=i.cues)!=null&&a.length){let d=Object.keys(o).filter(h=>!r.includes(h));for(let h=d.length;h--;){let u=d[h],f=o[u].cues;delete o[u],Object.keys(f).forEach(g=>{try{let m=f[g];m.removeEventListener("enter",this.onEventCueEnter),i.removeCue(m)}catch{}})}}else o=this.dateRangeCuesAppended={}}let c=e.fragments[e.fragments.length-1];if(r.length===0||!G(c?.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));let l=Ao();for(let d=0;d<r.length;d++){let h=r[d],u=s[h],f=u.startTime,g=o[h],m=g?.cues||{},v=g?.durationKnown||!1,y=Is,{duration:T,endDate:S}=u;if(S&&T!==null)y=f+T,v=!0;else if(u.endOnNext&&!v){let A=r.reduce((L,I)=>{if(I!==u.id){let D=s[I];if(D.class===u.class&&D.startDate>u.startDate&&(!L||u.startDate<L.startDate))return D}return L},null);A&&(y=A.startTime,v=!0)}let b=Object.keys(u.attr);for(let A=0;A<b.length;A++){let L=b[A];if(!of(L))continue;let I=m[L];if(I)v&&!g.durationKnown?I.endTime=y:Math.abs(I.startTime-f)>.01&&(I.startTime=f,I.endTime=y);else if(l){let D=u.attr[L];af(L)&&(D=zp(D));let C=Ac(l,f,y,{key:L,data:D},Ve.dateRange);C&&(C.id=h,this.id3Track.addCue(C),m[L]=C,this.hls.config.interstitialsController&&(L==="X-ASSET-LIST"||L==="X-ASSET-URL")&&C.addEventListener("enter",this.onEventCueEnter))}}o[h]={cues:m,dateRange:u,durationKnown:v}}}},Co=class{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{let{media:t}=this,i=this.levelDetails;if(!t||!i)return;this.currentTime=t.currentTime;let s=this.computeLatency();if(s===null)return;this._latency=s;let{lowLatencyMode:r,maxLiveSyncPlaybackRate:o}=this.config;if(!r||o===1||!i.live)return;let a=this.targetLatency;if(a===null)return;let c=s-a,l=Math.min(this.maxLatency,a+i.targetduration);if(c<l&&c>.05&&this.forwardBufferLength>1){let h=Math.min(2,Math.max(1,o)),u=Math.round(2/(1+Math.exp(-.75*c-this.edgeStalled))*20)/20,f=Math.min(h,Math.max(1,u));this.changeMediaPlaybackRate(t,f)}else t.playbackRate!==1&&t.playbackRate!==0&&this.changeMediaPlaybackRate(t,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){let{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;let t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){let e=this.levelDetails;if(e===null||this.hls===null)return null;let{holdBack:t,partHoldBack:i,targetduration:s}=e,{liveSyncDuration:r,liveSyncDurationCount:o,lowLatencyMode:a}=this.config,c=this.hls.userConfig,l=a&&i||t;(this._targetLatencyUpdated||c.liveSyncDuration||c.liveSyncDurationCount||l===0)&&(l=r!==void 0?r:o*s);let d=s;return l+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,d)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){let e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;let i=this.levelDetails;if(i===null)return null;let s=i.edge,r=e-t-this.edgeStalled,o=s-i.totalduration,a=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(o,r),a)}get drift(){let e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){let e=this.levelDetails;if(e===null)return 0;let t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){let{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;let i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){let{hls:e}=this;e&&(e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(p.ERROR,this.onError,this))}unregisterListeners(){let{hls:e}=this;e&&(e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(p.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var i;t.details===R.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(i=this.levelDetails)!=null&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var i,s;e.playbackRate!==t&&((i=this.hls)==null||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(s=this.targetLatency)==null?void 0:s.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){let e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){let e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}},Do=class extends Yi{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){let{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this),e.on(p.ERROR,this.onError,this)}_unregisterListeners(){let{hls:e}=this;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this),e.off(p.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){let i=this.hls.config.preferManagedMediaSource,s=[],r={},o={},a=!1,c=!1,l=!1;t.levels.forEach(d=>{let h=d.attrs,{audioCodec:u,videoCodec:f}=d;u&&(d.audioCodec=u=Ns(u,i)||void 0),f&&(f=d.videoCodec=Mu(f));let{width:g,height:m,unknownCodecs:v}=d,y=v?v.length:0;if(v)for(let C=y;C--;){let P=v[C];this.isAudioSupported(P)?(d.audioCodec=u=u?`${u},${P}`:P,y--,li.audio[u.substring(0,4)]=2):this.isVideoSupported(P)&&(d.videoCodec=f=f?`${f},${P}`:P,y--,li.video[f.substring(0,4)]=2)}if(a||(a=!!(g&&m)),c||(c=!!f),l||(l=!!u),y||u&&!this.isAudioSupported(u)||f&&!this.isVideoSupported(f)){this.log(`Some or all CODECS not supported "${h.CODECS}"`);return}let{CODECS:T,"FRAME-RATE":S,"HDCP-LEVEL":b,"PATHWAY-ID":A,RESOLUTION:L,"VIDEO-RANGE":I}=h,w=`${`${A||"."}-`}${d.bitrate}-${L}-${S}-${T}-${I}-${b}`;if(r[w])if(r[w].uri!==d.url&&!d.attrs["PATHWAY-ID"]){let C=o[w]+=1;d.attrs["PATHWAY-ID"]=new Array(C+1).join(".");let P=this.createLevel(d);r[w]=P,s.push(P)}else r[w].addGroupId("audio",h.AUDIO),r[w].addGroupId("text",h.SUBTITLES);else{let C=this.createLevel(d);r[w]=C,o[w]=1,s.push(C)}}),this.filterAndSortMediaOptions(s,t,a,c,l)}createLevel(e){let t=new jt(e),i=e.supplemental;if(i!=null&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){let s=new Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(s.message),t.supportedResult=$c(s,[])}return t}isAudioSupported(e){return Er(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return Er(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,i,s,r){let o=[],a=[],c=e;if((i||s)&&r&&(c=c.filter(({videoCodec:v,videoRange:y,width:T,height:S})=>(!!v||!!(T&&S))&&Uu(y))),c.length===0){Promise.resolve().then(()=>{if(this.hls){let v="no level with compatible codecs found in manifest",y=v;t.levels.length&&(y=`one or more CODECS in variant not supported: ${me(t.levels.map(S=>S.attrs.CODECS).filter((S,b,A)=>A.indexOf(S)===b))}`,this.warn(y),v+=` (${y})`);let T=new Error(v);this.hls.trigger(p.ERROR,{type:z.MEDIA_ERROR,details:R.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:T,reason:y})}});return}t.audioTracks&&(o=t.audioTracks.filter(v=>!v.audioCodec||this.isAudioSupported(v.audioCodec)),Ic(o)),t.subtitles&&(a=t.subtitles,Ic(a));let l=c.slice(0);c.sort((v,y)=>{if(v.attrs["HDCP-LEVEL"]!==y.attrs["HDCP-LEVEL"])return(v.attrs["HDCP-LEVEL"]||"")>(y.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&v.height!==y.height)return v.height-y.height;if(v.frameRate!==y.frameRate)return v.frameRate-y.frameRate;if(v.videoRange!==y.videoRange)return Bs.indexOf(v.videoRange)-Bs.indexOf(y.videoRange);if(v.videoCodec!==y.videoCodec){let T=Il(v.videoCodec),S=Il(y.videoCodec);if(T!==S)return S-T}if(v.uri===y.uri&&v.codecSet!==y.codecSet){let T=Fs(v.codecSet),S=Fs(y.codecSet);if(T!==S)return S-T}return v.averageBitrate!==y.averageBitrate?v.averageBitrate-y.averageBitrate:0});let d=l[0];if(this.steering&&(c=this.steering.filterParsedLevels(c),c.length!==l.length)){for(let v=0;v<l.length;v++)if(l[v].pathwayId===c[0].pathwayId){d=l[v];break}}this._levels=c;for(let v=0;v<c.length;v++)if(c[v]===d){var h;this._firstLevel=v;let y=d.bitrate,T=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${c.length} level(s) found, first bitrate: ${y}`),((h=this.hls.userConfig)==null?void 0:h.abrEwmaDefaultEstimate)===void 0){let S=Math.min(y,this.hls.config.abrEwmaDefaultEstimateMax);S>T&&T===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=S)}break}let u=r&&!s,f=this.hls.config,g=!!(f.audioStreamController&&f.audioTrackController),m={levels:c,audioTracks:o,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:r,video:s,altAudio:g&&!u&&o.some(v=>!!v.url)};this.hls.trigger(p.MANIFEST_PARSED,m)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){let t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){let d=new Error("invalid level idx"),h=e<0;if(this.hls.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.LEVEL_SWITCH_ERROR,level:e,fatal:h,error:d,reason:d.message}),h)return;e=Math.min(e,t.length-1)}let i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,o=t[e],a=o.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=o,i===e&&s&&r===a)return;this.log(`Switching to level ${e} (${o.height?o.height+"p ":""}${o.videoRange?o.videoRange+" ":""}${o.codecSet?o.codecSet+" ":""}@${o.bitrate})${a?" with Pathway "+a:""} from level ${i}${r?" with Pathway "+r:""}`);let c={level:e,attrs:o.attrs,details:o.details,bitrate:o.bitrate,averageBitrate:o.averageBitrate,maxBitrate:o.maxBitrate,realBitrate:o.realBitrate,width:o.width,height:o.height,codecSet:o.codecSet,audioCodec:o.audioCodec,videoCodec:o.videoCodec,audioGroups:o.audioGroups,subtitleGroups:o.subtitleGroups,loaded:o.loaded,loadError:o.loadError,fragmentError:o.fragmentError,name:o.name,id:o.id,uri:o.uri,url:o.url,urlId:0,audioGroupIds:o.audioGroupIds,textGroupIds:o.textGroupIds};this.hls.trigger(p.LEVEL_SWITCHING,c);let l=o.details;if(!l||l.live){let d=this.switchParams(o.uri,s?.details,l);this.loadPlaylist(d)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){let e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){let t=this.steering.pathways(),i=e.filter(s=>t.indexOf(s)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=i}}onError(e,t){t.fatal||!t.context||t.context.type===ne.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===W.MAIN){let i=t.elementaryStreams;if(!Object.keys(i).some(r=>!!i[r]))return;let s=this._levels[t.level];s!=null&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(e,t){var i;let{level:s,details:r}=t,o=t.levelInfo;if(!o){var a;this.warn(`Invalid level index ${s}`),(a=t.deliveryDirectives)!=null&&a.skip&&(r.deltaUpdateFailed=!0);return}if(o===this.currentLevel||t.withoutMultiVariant){o.fragmentError===0&&(o.loadError=0);let c=o.details;c===t.details&&c.advanced&&(c=void 0),this.playlistLoaded(s,t,c)}else(i=t.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);let i=this.getUrlWithDirectives(e.uri,t),s=this.currentLevelIndex,r=e.attrs["PATHWAY-ID"],o=e.details,a=o?.age;this.log(`Loading level index ${s}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${r?" Pathway "+r:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${i}`),this.hls.trigger(p.LEVEL_LOADING,{url:i,level:s,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;let i=this._levels.filter((r,o)=>o!==e?!0:(this.steering&&this.steering.removeLevel(r),r===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,r.details&&r.details.fragments.forEach(a=>a.level=-1)),!1));td(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);let s=i.length-1;this._firstLevel=Math.min(this._firstLevel,s),this._startLevel&&(this._startLevel=Math.min(this._startLevel,s)),this.hls.trigger(p.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){let{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(p.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}};function Ic(n){let e={};n.forEach(t=>{let i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function Ud(){return self.SourceBuffer||self.WebKitSourceBuffer}function Vd(){if(!Dt())return!1;let e=Ud();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function qp(){if(!Vd())return!1;let n=Dt();return typeof n?.isTypeSupported=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>n.isTypeSupported(Ni(e,"video")))||["mp4a.40.2","fLaC"].some(e=>n.isTypeSupported(Ni(e,"audio"))))}function Xp(){var n;let e=Ud();return typeof(e==null||(n=e.prototype)==null?void 0:n.changeType)=="function"}var Qp=100,Ro=class extends Gi{constructor(e,t,i){super(e,t,i,"stream-controller",W.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{let s=this.media,r=s?s.currentTime:null;if(r===null||!G(r)||(this.log(`Media seeked to ${r.toFixed(3)}`),!this.getBufferedFrag(r)))return;let o=this.getFwdBufferInfoAtPos(s,r,W.MAIN,0);if(o===null||o.len===0){this.warn(`Main forward buffer length at ${r} on "seeked" event ${o?o.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();let{hls:e}=this;e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(p.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(p.BUFFER_CREATED,this.onBufferCreated,this),e.on(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();let{hls:e}=this;e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(p.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(p.BUFFER_CREATED,this.onBufferCreated,this),e.off(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){let{lastCurrentTime:i,hls:s}=this;if(this.stopLoad(),this.setInterval(Qp),this.level=-1,!this.startFragRequested){let r=s.startLevel;r===-1&&(s.config.testBandwidth&&this.levels.length>1?(r=0,this.bitrateTest=!0):r=s.firstAutoLevel),s.nextLoadLevel=r,this.level=s.loadLevel,this._hasEnoughToStart=!!t}i>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i),this.state=k.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=k.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case k.WAITING_LEVEL:{let{levels:t,level:i}=this,s=t?.[i],r=s?.details;if(r&&(!r.live||this.levelLastLoaded===s&&!this.waitForLive(s))){if(this.waitForCdnTuneIn(r))break;this.state=k.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=k.IDLE;break}break}case k.FRAG_LOADING_WAITING_RETRY:{var e;let t=self.performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){let{levels:s,level:r}=this,o=s?.[r];this.resetStartWhenNotLoaded(o||null),this.state=k.IDLE}}break}this.state===k.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){let{hls:e,levelLastLoaded:t,levels:i,media:s}=this;if(t===null||!s&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;let r=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(i!=null&&i[r]))return;let o=i[r],a=this.getMainFwdBufferInfo();if(a===null)return;let c=this.getLevelDetails();if(c&&this._streamEnded(a,c)){let m={};this.altAudio===2&&(m.type="video"),this.hls.trigger(p.BUFFER_EOS,m),this.state=k.ENDED;return}if(!this.buffering)return;e.loadLevel!==r&&e.manualLevel===-1&&this.log(`Adapting to level ${r} from level ${this.level}`),this.level=e.nextLoadLevel=r;let l=o.details;if(!l||this.state===k.WAITING_LEVEL||this.waitForLive(o)){this.level=r,this.state=k.WAITING_LEVEL,this.startFragRequested=!1;return}let d=a.len,h=this.getMaxBufferLength(o.maxBitrate);if(d>=h)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);let u=this.backtrackFragment?this.backtrackFragment.start:a.end,f=this.getNextFragment(u,l);if(this.couldBacktrack&&!this.fragPrevious&&f&&Ce(f)&&this.fragmentTracker.getState(f)!==xe.OK){var g;let v=((g=this.backtrackFragment)!=null?g:f).sn-l.startSN,y=l.fragments[v-1];y&&f.cc===y.cc&&(f=y,this.fragmentTracker.removeFragment(y))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(f&&this.isLoopLoading(f,u)){if(!f.gap){let v=this.audioOnly&&!this.altAudio?pe.AUDIO:pe.VIDEO,y=(v===pe.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;y&&this.afterBufferFlushed(y,v,W.MAIN)}f=this.getNextFragmentLoopLoading(f,l,a,W.MAIN,h)}f&&(f.initSegment&&!f.initSegment.data&&!this.bitrateTest&&(f=f.initSegment),this.loadFragment(f,o,u))}loadFragment(e,t,i){let s=this.fragmentTracker.getState(e);s===xe.NOT_LOADED||s===xe.PARTIAL?Ce(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,W.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){let{levels:e,media:t}=this;if(t!=null&&t.readyState){let i,s=this.getAppendedFrag(t.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);let r=this.getLevelDetails();if(r!=null&&r.live){let a=this.getMainFwdBufferInfo();if(!a||a.len<r.targetduration*2)return}if(!t.paused&&e){let a=this.hls.nextLoadLevel,c=e[a],l=this.fragLastKbps;l&&this.fragCurrent?i=this.fragCurrent.duration*c.maxBitrate/(1e3*l)+1:i=0}else i=0;let o=this.getBufferedFrag(t.currentTime+i);if(o){let a=this.followingBufferedFrag(o);if(a){this.abortCurrentFrag();let c=a.maxStartPTS?a.maxStartPTS:a.start,l=a.duration,d=Math.max(o.end,c+Math.min(Math.max(l-this.config.maxFragLookUpTolerance,l*(this.couldBacktrack?.5:.125)),l*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(d,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){let e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case k.KEY_LOADING:case k.FRAG_LOADING:case k.FRAG_LOADING_WAITING_RETRY:case k.PARSING:case k.PARSED:this.state=k.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);let i=t.media;$e(i,"playing",this.onMediaPlaying),$e(i,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){let{media:i}=this;i&&(ze(i,"playing",this.onMediaPlaying),ze(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(p.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let i=!1,s=!1;t.levels.forEach(r=>{let o=r.audioCodec;o&&(i=i||o.indexOf("mp4a.40.2")!==-1,s=s||o.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&s&&!Xp(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){let{levels:i}=this;if(!i||this.state!==k.IDLE)return;let s=t.levelInfo;(!s.details||s.details.live&&(this.levelLastLoaded!==s||s.details.expired)||this.waitForCdnTuneIn(s.details))&&(this.state=k.WAITING_LEVEL)}onLevelLoaded(e,t){var i;let{levels:s,startFragRequested:r}=this,o=t.level,a=t.details,c=a.totalduration;if(!s){this.warn(`Levels were reset while loading level ${o}`);return}this.log(`Level ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${c}`);let l=t.levelInfo,d=this.fragCurrent;d&&(this.state===k.FRAG_LOADING||this.state===k.FRAG_LOADING_WAITING_RETRY)&&d.level!==t.level&&d.loader&&this.abortCurrentFrag();let h=0;if(a.live||(i=l.details)!=null&&i.live){var u;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;h=this.alignPlaylists(a,l.details,(u=this.levelLastLoaded)==null?void 0:u.details)}if(l.details=a,this.levelLastLoaded=l,r||this.setStartPosition(a,h),this.hls.trigger(p.LEVEL_UPDATED,{details:a,level:o}),this.state===k.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=k.IDLE}r&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){let{config:t,media:i}=this;if(!i)return;let s=this.hls.liveSyncPosition,r=this.getLoadPosition(),o=e.fragmentStart,a=e.edge,c=r>=o-t.maxFragLookUpTolerance&&r<=a;if(s!==null&&i.duration>s&&(r<s||!c)){let d=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!c&&i.readyState<4||r<a-d)&&(this._hasEnoughToStart||(this.nextLoadPosition=s),i.readyState))if(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${s.toFixed(3)}`),this.config.liveSyncMode==="buffered"){var l;let h=ie.bufferInfo(i,s,0);if(!(h!=null&&(l=h.buffered)!=null&&l.length)){i.currentTime=s;return}if(h.start<=r){i.currentTime=s;return}let{nextStart:f}=ie.bufferedInfo(h.buffered,r,0);f&&(i.currentTime=f)}else i.currentTime=s}}_handleFragmentLoadProgress(e){var t;let i=e.frag,{part:s,payload:r}=e,{levels:o}=this;if(!o){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}let a=o[i.level];if(!a){this.warn(`Level ${i.level} not found on progress`);return}let c=a.details;if(!c){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}let l=a.videoCodec,d=c.PTSKnown||!c.live,h=(t=i.initSegment)==null?void 0:t.data,u=this._getAudioCodec(a),f=this.transmuxer=this.transmuxer||new Js(this.hls,W.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),g=s?s.index:-1,m=g!==-1,v=new Vi(i.level,i.sn,i.stats.chunkCount,r.byteLength,g,m),y=this.initPTS[i.cc];f.push(r,h,u,l,i,s,c.totalduration,d,v,y)}onAudioTrackSwitching(e,t){let i=this.hls,s=this.altAudio===2;if(Vs(t.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;let o=this.fragCurrent;o&&(this.log("Switching to main audio track, cancel main fragment load"),o.abortRequests(),this.fragmentTracker.removeFragment(o)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(s){this.fragmentTracker.removeAllFragments(),i.once(p.BUFFER_FLUSHED,()=>{var o;(o=this.hls)==null||o.trigger(p.AUDIO_TRACK_SWITCHED,t)}),i.trigger(p.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}i.trigger(p.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){let i=Vs(t.url,this.hls);if(i){let s=this.videoBuffer;s&&this.mediaBuffer!==s&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=s)}this.altAudio=i?2:0,this.tick()}onBufferCreated(e,t){let i=t.tracks,s,r,o=!1;for(let a in i){let c=i[a];if(c.id==="main"){if(r=a,s=c,a==="video"){let l=i[a];l&&(this.videoBuffer=l.buffer)}}else o=!0}o&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){let{frag:i,part:s}=t,r=i.type===W.MAIN;if(r){if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===k.PARSED&&(this.state=k.IDLE);return}let a=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),Ce(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}let o=this.media;o&&(!this._hasEnoughToStart&&ie.getBuffered(o).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),r&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var i;if(t.fatal){this.state=k.ERROR;return}switch(t.details){case R.FRAG_GAP:case R.FRAG_PARSING_ERROR:case R.FRAG_DECRYPT_ERROR:case R.FRAG_LOAD_ERROR:case R.FRAG_LOAD_TIMEOUT:case R.KEY_LOAD_ERROR:case R.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(W.MAIN,t);break;case R.LEVEL_LOAD_ERROR:case R.LEVEL_LOAD_TIMEOUT:case R.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===k.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===ne.LEVEL&&(this.state=k.IDLE);break;case R.BUFFER_ADD_CODEC_ERROR:case R.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.resetLoadingState();break;case R.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case R.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=k.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==pe.AUDIO||!this.altAudio){let i=(t===pe.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;i&&(this.afterBufferFlushed(i,t,W.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){let{media:e}=this;if(!e)return;let t=e.currentTime,i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}let s=this.timelineOffset;s&&i&&(i+=s);let r=this.getLevelDetails(),o=ie.getBuffered(e),a=o.length?o.start(0):0,c=a-i,l=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||c>0&&(c<l||this.loadingParts&&c<2*(r?.partTarget||0)))&&(this.log(`adjusting start position by ${c} to match buffer start`),i+=c,this.startPosition=i),t<i&&(this.log(`seek to target start position ${i} from current time ${t} buffer start ${a}`),e.currentTime=i)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{let{hls:s}=this,r=i?.frag;if(!r||this.fragContextChanged(r))return;t.fragmentError=0,this.state=k.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;let o=r.stats;o.parsing.start=o.parsing.end=o.buffering.start=o.buffering.end=self.performance.now(),s.trigger(p.FRAG_LOADED,i),r.bitrateTest=!1})}_handleTransmuxComplete(e){var t;let i=this.playlistType,{hls:s}=this,{remuxResult:r,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}let{frag:c,part:l,level:d}=a,{video:h,text:u,id3:f,initSegment:g}=r,{details:m}=d,v=this.altAudio?void 0:r.audio;if(this.fragContextChanged(c)){this.fragmentTracker.removeFragment(c);return}if(this.state=k.PARSING,g){if(g!=null&&g.tracks){let S=c.initSegment||c;this._bufferInitSegment(d,g.tracks,S,o),s.trigger(p.FRAG_PARSING_INIT_SEGMENT,{frag:S,id:i,tracks:g.tracks})}let y=g.initPTS,T=g.timescale;G(y)&&(this.initPTS[c.cc]={baseTime:y,timescale:T},s.trigger(p.INIT_PTS_FOUND,{frag:c,id:i,initPTS:y,timescale:T}))}if(h&&m){v&&h.type==="audiovideo"&&this.logMuxedErr(c);let y=m.fragments[c.sn-1-m.startSN],T=c.sn===m.startSN,S=!y||c.cc>y.cc;if(r.independent!==!1){let{startPTS:b,endPTS:A,startDTS:L,endDTS:I}=h;if(l)l.elementaryStreams[h.type]={startPTS:b,endPTS:A,startDTS:L,endDTS:I};else if(h.firstKeyFrame&&h.independent&&o.id===1&&!S&&(this.couldBacktrack=!0),h.dropped&&h.independent){let D=this.getMainFwdBufferInfo(),w=(D?D.end:this.getLoadPosition())+this.config.maxBufferHole,C=h.firstKeyFramePTS?h.firstKeyFramePTS:b;if(!T&&w<C-this.config.maxBufferHole&&!S){this.backtrack(c);return}else S&&(c.gap=!0);c.setElementaryStreamInfo(h.type,c.start,A,c.start,I,!0)}else T&&b-(m.appliedTimelineOffset||0)>Ps&&(c.gap=!0);c.setElementaryStreamInfo(h.type,b,A,L,I),this.backtrackFragment&&(this.backtrackFragment=c),this.bufferFragmentData(h,c,l,o,T||S)}else if(T||S)c.gap=!0;else{this.backtrack(c);return}}if(v){let{startPTS:y,endPTS:T,startDTS:S,endDTS:b}=v;l&&(l.elementaryStreams[pe.AUDIO]={startPTS:y,endPTS:T,startDTS:S,endDTS:b}),c.setElementaryStreamInfo(pe.AUDIO,y,T,S,b),this.bufferFragmentData(v,c,l,o)}if(m&&f!=null&&(t=f.samples)!=null&&t.length){let y={id:i,frag:c,details:m,samples:f.samples};s.trigger(p.FRAG_PARSING_METADATA,y)}if(m&&u){let y={id:i,frag:c,details:m,samples:u.samples};s.trigger(p.FRAG_PARSING_USERDATA,y)}}logMuxedErr(e){this.warn(`${Ce(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,i,s){if(this.state!==k.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));let{audio:r,video:o,audiovideo:a}=t;if(r){let l=Cs(r.codec,e.audioCodec);l==="mp4a"&&(l="mp4a.40.5");let d=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){l&&(l.indexOf("mp4a.40.5")!==-1?l="mp4a.40.2":l="mp4a.40.5");let h=r.metadata;h&&"channelCount"in h&&(h.channelCount||1)!==1&&d.indexOf("firefox")===-1&&(l="mp4a.40.5")}l&&l.indexOf("mp4a.40.5")!==-1&&d.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(l="mp4a.40.2",this.log(`Android: force audio codec to ${l}`)),e.audioCodec&&e.audioCodec!==l&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${l}"`),r.levelCodec=l,r.id=W.MAIN,this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${l||""}/${e.audioCodec||""}/${r.codec}]`),delete t.audiovideo}if(o){o.levelCodec=e.videoCodec,o.id=W.MAIN;let l=o.codec;if(l?.length===4)switch(l){case"hvc1":case"hev1":o.codec="hvc1.1.6.L120.90";break;case"av01":o.codec="av01.0.04M.08";break;case"avc1":o.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${o.container}, codecs[level/parsed]=[${e.videoCodec||""}/${l}]${o.codec!==l?" parsed-corrected="+o.codec:""}${o.supplemental?" supplemental="+o.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);let c=Object.keys(t);if(c.length){if(this.hls.trigger(p.BUFFER_CODECS,t),!this.hls)return;c.forEach(l=>{let h=t[l].initSegment;h!=null&&h.byteLength&&this.hls.trigger(p.BUFFER_APPENDING,{type:l,data:h,frag:i,part:null,chunkMeta:s,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){let e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,W.MAIN)}get maxBufferLength(){let{levels:e,level:t}=this,i=e?.[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=k.IDLE}checkFragmentChanged(){let e=this.media,t=null;if(e&&e.readyState>1&&e.seeking===!1){let i=e.currentTime;if(ie.isBuffered(e,i)?t=this.getAppendedFrag(i):ie.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;let s=this.fragPlaying,r=t.level;(!s||t.sn!==s.sn||s.level!==r)&&(this.fragPlaying=t,this.hls.trigger(p.FRAG_CHANGED,{frag:t}),(!s||s.level!==r)&&this.hls.trigger(p.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){let e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;let t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return G(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;let t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(G(t)){let i=this.getLevelDetails(),s=this.currentFrag||(i?Wt(null,i.fragments,t):null);if(s){let r=s.programDateTime;if(r!==null){let o=r+(t-s.start)*1e3;return new Date(o)}}}return null}get currentLevel(){let e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){let e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}},Lo=class{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(let i in this.keyUriToKeyInfo){let s=this.keyUriToKeyInfo[i].loader;if(s){var t;if(e&&e!==((t=s.context)==null?void 0:t.frag.type))return;s.abort()}}}detach(){for(let e in this.keyUriToKeyInfo){let t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(let e in this.keyUriToKeyInfo){let t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=R.KEY_LOAD_ERROR,i,s,r){return new nt({type:z.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:i,networkDetails:s})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length){let{sn:i,cc:s}=e;for(let r=0;r<t.length;r++){let o=t[r];if(s<=o.cc&&(i==="initSegment"||o.sn==="initSegment"||i<o.sn))return this.emeController.selectKeySystemFormat(o).then(a=>{if(o.setKeyFormat(a),this.emeController&&this.config.requireKeySystemAccessOnStart){let c=Rs(a);if(c)return this.emeController.getKeySystemAccess([c])}})}}else if(this.config.requireKeySystemAccessOnStart){let i=Li(this.config);if(i.length)return this.emeController.getKeySystemAccess(i)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,s;t&&e.setKeyFormat(t);let r=e.decryptdata;if(!r){let l=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,R.KEY_LOAD_ERROR,l))}let o=r.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,R.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${o}"`)));let a=this.keyUriToKeyInfo[o];if((i=a)!=null&&i.decryptdata.key)return r.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});if((s=a)!=null&&s.keyLoadPromise){var c;switch((c=a.mediaKeySessionContext)==null?void 0:c.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(l=>(r.key=l.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}}switch(a=this.keyUriToKeyInfo[o]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,R.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){let i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){let s=this.emeController.loadKey(i);if(s)return(e.keyLoadPromise=s.then(r=>(e.mediaKeySessionContext=r,i))).catch(r=>{throw e.keyLoadPromise=null,r})}return Promise.resolve(i)}loadKeyHTTP(e,t){let i=this.config,s=i.loader,r=new s(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((o,a)=>{let c={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},l=i.keyLoadPolicy.default,d={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(u,f,g,m)=>{let{frag:v,keyInfo:y,url:T}=g;if(!v.decryptdata||y!==this.keyUriToKeyInfo[T])return a(this.createKeyLoadError(v,R.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),m));y.decryptdata.key=v.decryptdata.key=new Uint8Array(u.data),v.keyLoader=null,y.loader=null,o({frag:v,keyInfo:y})},onError:(u,f,g,m)=>{this.resetLoader(f),a(this.createKeyLoadError(t,R.KEY_LOAD_ERROR,new Error(`HTTP Error ${u.code} loading key ${u.text}`),g,he({url:c.url,data:void 0},u)))},onTimeout:(u,f,g)=>{this.resetLoader(f),a(this.createKeyLoadError(t,R.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),g))},onAbort:(u,f,g)=>{this.resetLoader(f),a(this.createKeyLoadError(t,R.INTERNAL_ABORTED,new Error("key loading aborted"),g))}};r.load(c,d,h)})}resetLoader(e){let{frag:t,keyInfo:i,url:s}=e,r=i.loader;t.keyLoader===r&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[s],r&&r.destroy()}};function Cc(n){let{type:e}=n;switch(e){case ne.AUDIO_TRACK:return W.AUDIO;case ne.SUBTITLE_TRACK:return W.SUBTITLE;default:return W.MAIN}}function pr(n,e){let t=n.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}var wo=class{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){let{hls:e}=this;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(p.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){let{hls:e}=this;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_LOADING,this.onLevelLoading,this),e.off(p.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(p.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){let t=this.hls.config,i=t.pLoader,s=t.loader,r=i||s,o=new r(t);return this.loaders[e.type]=o,o}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(let e in this.loaders){let t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){let{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:ne.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){let{id:i,level:s,pathwayId:r,url:o,deliveryDirectives:a,levelInfo:c}=t;this.load({id:i,level:s,pathwayId:r,responseType:"text",type:ne.LEVEL,url:o,deliveryDirectives:a,levelOrTrack:c})}onAudioTrackLoading(e,t){let{id:i,groupId:s,url:r,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:ne.AUDIO_TRACK,url:r,deliveryDirectives:o,levelOrTrack:a})}onSubtitleTrackLoading(e,t){let{id:i,groupId:s,url:r,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:ne.SUBTITLE_TRACK,url:r,deliveryDirectives:o,levelOrTrack:a})}onLevelsUpdated(e,t){let i=this.loaders[ne.LEVEL];if(i){let s=i.context;s&&!t.levels.some(r=>r===s.levelOrTrack)&&(i.abort(),delete this.loaders[ne.LEVEL])}}load(e){var t;let i=this.hls.config,s=this.getInternalLoader(e);if(s){let l=this.hls.logger,d=s.context;if(d&&d.levelOrTrack===e.levelOrTrack&&(d.url===e.url||d.deliveryDirectives&&!e.deliveryDirectives)){d.url===e.url?l.log(`[playlist-loader]: ignore ${e.url} ongoing request`):l.log(`[playlist-loader]: ignore ${e.url} in favor of ${d.url}`);return}l.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}let r;if(e.type===ne.MANIFEST?r=i.manifestLoadPolicy.default:r=fe({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),G((t=e.deliveryDirectives)==null?void 0:t.part)){let l;if(e.type===ne.LEVEL&&e.level!==null?l=this.hls.levels[e.level].details:e.type===ne.AUDIO_TRACK&&e.id!==null?l=this.hls.audioTracks[e.id].details:e.type===ne.SUBTITLE_TRACK&&e.id!==null&&(l=this.hls.subtitleTracks[e.id].details),l){let d=l.partTarget,h=l.targetduration;if(d&&h){let u=Math.max(d*3,h*.8)*1e3;r=fe({},r,{maxTimeToFirstByteMs:Math.min(u,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(u,r.maxTimeToFirstByteMs)})}}}let o=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(l,d,h,u)=>{let f=this.getInternalLoader(h);this.resetInternalLoader(h.type);let g=l.data;if(g.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(l,h,new Error("no EXTM3U delimiter"),u||null,d);return}d.parsing.start=performance.now(),Gt.isMediaPlaylist(g)||h.type!==ne.MANIFEST?this.handleTrackOrLevelPlaylist(l,d,h,u||null,f):this.handleMasterPlaylist(l,d,h,u)},onError:(l,d,h,u)=>{this.handleNetworkError(d,h,!1,l,u)},onTimeout:(l,d,h)=>{this.handleNetworkError(d,h,!0,void 0,l)}};s.load(e,a,c)}checkAutostartLoad(){if(!this.hls)return;let{config:{autoStartLoad:e,startPosition:t},forceStartLoad:i}=this.hls;(e||i)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,i,s){let r=this.hls,o=e.data,a=pr(e,i),c=Gt.parseMasterPlaylist(o,a);if(c.playlistParsingError){this.handleManifestParsingError(e,i,c.playlistParsingError,s,t);return}let{contentSteering:l,levels:d,sessionData:h,sessionKeys:u,startTimeOffset:f,variableList:g}=c;this.variableList=g;let{AUDIO:m=[],SUBTITLES:v,"CLOSED-CAPTIONS":y}=Gt.parseMasterPlaylistMedia(o,a,c);m.length&&!m.some(S=>!S.url)&&d[0].audioCodec&&!d[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new ve({}),bitrate:0,url:""})),r.trigger(p.MANIFEST_LOADED,{levels:d,audioTracks:m,subtitles:v,captions:y,contentSteering:l,url:a,stats:t,networkDetails:s,sessionData:h,sessionKeys:u,startTimeOffset:f,variableList:g})}handleTrackOrLevelPlaylist(e,t,i,s,r){let o=this.hls,{id:a,level:c,type:l}=i,d=pr(e,i),h=G(c)?c:G(a)?a:0,u=Cc(i),f=Gt.parseLevelPlaylist(e.data,d,h,u,0,this.variableList);if(l===ne.MANIFEST){let g={attrs:new ve({}),bitrate:0,details:f,name:"",url:d};f.requestScheduled=t.loading.start+Zc(f,0),o.trigger(p.MANIFEST_LOADED,{levels:[g],audioTracks:[],url:d,stats:t,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=f,this.handlePlaylistLoaded(f,e,t,i,s,r)}handleManifestParsingError(e,t,i,s,r){this.hls.trigger(p.ERROR,{type:z.NETWORK_ERROR,details:R.MANIFEST_PARSING_ERROR,fatal:t.type===ne.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:s,stats:r})}handleNetworkError(e,t,i=!1,s,r){let o=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${e.type}`;e.type===ne.LEVEL?o+=`: ${e.level} id: ${e.id}`:(e.type===ne.AUDIO_TRACK||e.type===ne.SUBTITLE_TRACK)&&(o+=` id: ${e.id} group-id: "${e.groupId}"`);let a=new Error(o);this.hls.logger.warn(`[playlist-loader]: ${o}`);let c=R.UNKNOWN,l=!1,d=this.getInternalLoader(e);switch(e.type){case ne.MANIFEST:c=i?R.MANIFEST_LOAD_TIMEOUT:R.MANIFEST_LOAD_ERROR,l=!0;break;case ne.LEVEL:c=i?R.LEVEL_LOAD_TIMEOUT:R.LEVEL_LOAD_ERROR,l=!1;break;case ne.AUDIO_TRACK:c=i?R.AUDIO_TRACK_LOAD_TIMEOUT:R.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case ne.SUBTITLE_TRACK:c=i?R.SUBTITLE_TRACK_LOAD_TIMEOUT:R.SUBTITLE_LOAD_ERROR,l=!1;break}d&&this.resetInternalLoader(e.type);let h={type:z.NETWORK_ERROR,details:c,fatal:l,url:e.url,loader:d,context:e,error:a,networkDetails:t,stats:r};if(s){let u=t?.url||e.url;h.response=he({url:u,data:void 0},s)}this.hls.trigger(p.ERROR,h)}handlePlaylistLoaded(e,t,i,s,r,o){let a=this.hls,{type:c,level:l,id:d,groupId:h,deliveryDirectives:u}=s,f=pr(t,s),g=Cc(s),m=typeof s.level=="number"&&g===W.MAIN?l:void 0;if(!e.fragments.length){let y=e.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(p.ERROR,{type:z.NETWORK_ERROR,details:R.LEVEL_EMPTY_ERROR,fatal:!1,url:f,error:y,reason:y.message,response:t,context:s,level:m,parent:g,networkDetails:r,stats:i});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));let v=e.playlistParsingError;if(v){if(this.hls.logger.warn(v),!a.config.ignorePlaylistParsingErrors){a.trigger(p.ERROR,{type:z.NETWORK_ERROR,details:R.LEVEL_PARSING_ERROR,fatal:!1,url:f,error:v,reason:v.message,response:t,context:s,level:m,parent:g,networkDetails:r,stats:i});return}e.playlistParsingError=null}switch(e.live&&o&&(o.getCacheAge&&(e.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),c){case ne.MANIFEST:case ne.LEVEL:a.trigger(p.LEVEL_LOADED,{details:e,levelInfo:s.levelOrTrack||a.levels[0],level:m||0,id:d||0,stats:i,networkDetails:r,deliveryDirectives:u,withoutMultiVariant:c===ne.MANIFEST});break;case ne.AUDIO_TRACK:a.trigger(p.AUDIO_TRACK_LOADED,{details:e,track:s.levelOrTrack,id:d||0,groupId:h||"",stats:i,networkDetails:r,deliveryDirectives:u});break;case ne.SUBTITLE_TRACK:a.trigger(p.SUBTITLE_TRACK_LOADED,{details:e,track:s.levelOrTrack,id:d||0,groupId:h||"",stats:i,networkDetails:r,deliveryDirectives:u});break}}},dn=(()=>{class n{static get version(){return Hi}static isMSESupported(){return Vd()}static isSupported(){return qp()}static getMediaSource(){return Dt()}static get Events(){return p}static get MetadataSchema(){return Ve}static get ErrorTypes(){return z}static get ErrorDetails(){return R}static get DefaultConfig(){return n.defaultConfig?n.defaultConfig:Vp}static set DefaultConfig(t){n.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new No,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;let i=this.logger=hu(t.debug||!1,"Hls instance",t.assetPlayerId),s=this.config=Gp(n.DefaultConfig,t,i);this.userConfig=t,s.progressive&&Hp(s,i);let{abrController:r,bufferController:o,capLevelController:a,errorController:c,fpsController:l}=s,d=new c(this),h=this.abrController=new r(this),u=new br(this),f=s.interstitialsController,g=f?this.interstitialsController=new f(this,n):null,m=this.bufferController=new o(this,u),v=this.capLevelController=new a(this),y=new l(this),T=new wo(this),S=s.contentSteeringController,b=S?new S(this):null,A=this.levelController=new Do(this,b),L=new Io(this),I=new Lo(this.config),D=this.streamController=new Ro(this,u,I),w=this.gapController=new bo(this,u);v.setStreamController(D),y.setStreamController(D);let C=[T,A,D];g&&C.splice(1,0,g),b&&C.splice(1,0,b),this.networkControllers=C;let P=[h,m,w,v,y,L,u];this.audioTrackController=this.createController(s.audioTrackController,C);let U=s.audioStreamController;U&&C.push(this.audioStreamController=new U(this,u,I)),this.subtitleTrackController=this.createController(s.subtitleTrackController,C);let q=s.subtitleStreamController;q&&C.push(this.subtititleStreamController=new q(this,u,I)),this.createController(s.timelineController,P),I.emeController=this.emeController=this.createController(s.emeController,P),this.cmcdController=this.createController(s.cmcdController,P),this.latencyController=this.createController(Co,P),this.coreComponents=P,C.push(d);let H=d.onErrorOut;typeof H=="function"&&this.on(p.ERROR,H,d),this.on(p.MANIFEST_LOADED,T.onManifestLoaded,T)}createController(t,i){if(t){let s=new t(this);return i&&i.push(s),s}return null}on(t,i,s=this){this._emitter.on(t,i,s)}once(t,i,s=this){this._emitter.once(t,i,s)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,i,s=this,r){this._emitter.off(t,i,s,r)}listeners(t){return this._emitter.listeners(t)}emit(t,i,s){return this._emitter.emit(t,i,s)}trigger(t,i){if(this.config.debug)return this.emit(t,t,i);try{return this.emit(t,t,i)}catch(s){if(this.logger.error("An internal error happened while handling event "+t+'. Error message: "'+s.message+'". Here is a stacktrace:',s),!this.triggeringException){this.triggeringException=!0;let r=t===p.ERROR;this.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.INTERNAL_EXCEPTION,fatal:r,event:t,error:s}),this.triggeringException=!1}}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){this.logger.log("destroy"),this.trigger(p.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(i=>i.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(i=>i.destroy()),this.coreComponents.length=0;let t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){if(!t||"media"in t&&!t.media){let o=new Error(`attachMedia failed: invalid argument (${t})`);this.trigger(p.ERROR,{type:z.OTHER_ERROR,details:R.ATTACH_MEDIA_ERROR,fatal:!0,error:o});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());let i="media"in t,s=i?t.media:t,r=i?t:{media:s};this._media=s,this.trigger(p.MEDIA_ATTACHING,r)}detachMedia(){this.logger.log("detachMedia"),this.trigger(p.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;let t=this.bufferController.transferMedia();return this.trigger(p.MEDIA_DETACHING,{transferMedia:t}),t}loadSource(t){this.stopLoad();let i=this.media,s=this._url,r=this._url=ko.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${r}`),i&&s&&(s!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(i)),this.trigger(p.MANIFEST_LOADING,{url:t})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(t=-1,i){this.logger.log(`startLoad(${t+(i?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let s=0;s<this.networkControllers.length&&(this.networkControllers[s].startLoad(t,i),!(!this.started||!this.networkControllers));s++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let t=0;t<this.networkControllers.length&&(this.networkControllers[t].stopLoad(),!(this.started||!this.networkControllers));t++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(t=>{t.resumeBuffering&&t.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(t=>{t.pauseBuffering&&t.pauseBuffering()}))}get inFlightFragments(){let t={[W.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(t[W.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(t[W.SUBTITLE]=this.subtititleStreamController.inFlightFrag),t}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");let t=this._media,i=t?.currentTime;this.detachMedia(),t&&(this.attachMedia(t),i&&this.startLoad(i))}removeLevel(t){this.levelController.removeLevel(t)}get sessionId(){let t=this._sessionId;return t||(t=this._sessionId=lp()),t}get levels(){let t=this.levelController.levels;return t||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){this.logger.log(`set currentLevel:${t}`),this.levelController.manualLevel=t,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){this.logger.log(`set nextLevel:${t}`),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){this.logger.log(`set loadLevel:${t}`),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){this.logger.log(`set firstLevel:${t}`),this.levelController.firstLevel=t}get startLevel(){let t=this.levelController.startLevel;return t===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:t}set startLevel(t){this.logger.log(`set startLevel:${t}`),t!==-1&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){let i=!!t;i!==this.config.capLevelToPlayerSize&&(i?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=i)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){let{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}set bandwidthEstimate(t){this.abrController.resetEstimator(t)}get abrEwmaDefaultEstimate(){let{bwEstimator:t}=this.abrController;return t?t.defaultEstimate:NaN}get ttfbEstimate(){let{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(this.logger.log(`set autoLevelCapping:${t}`),this._autoLevelCapping=t,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){Bu(t)&&this._maxHdcpLevel!==t&&(this._maxHdcpLevel=t,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){let{levels:t,config:{minAutoBitrate:i}}=this;if(!t)return 0;let s=t.length;for(let r=0;r<s;r++)if(t[r].maxBitrate>=i)return r;return 0}get maxAutoLevel(){let{levels:t,autoLevelCapping:i,maxHdcpLevel:s}=this,r;if(i===-1&&t!=null&&t.length?r=t.length-1:r=i,s)for(let o=r;o--;){let a=t[o].attrs["HDCP-LEVEL"];if(a&&a<=s)return o}return r}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(t){this.abrController.nextAutoLevel=t}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(t){var i;return((i=this.audioTrackController)==null?void 0:i.setAudioOption(t))||null}setSubtitleOption(t){var i;return((i=this.subtitleTrackController)==null?void 0:i.setSubtitleOption(t))||null}get allAudioTracks(){let t=this.audioTrackController;return t?t.allAudioTracks:[]}get audioTracks(){let t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){let t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){let i=this.audioTrackController;i&&(i.audioTrack=t)}get allSubtitleTracks(){let t=this.subtitleTrackController;return t?t.allSubtitleTracks:[]}get subtitleTracks(){let t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){let t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){let i=this.subtitleTrackController;i&&(i.subtitleTrack=t)}get subtitleDisplay(){let t=this.subtitleTrackController;return t?t.subtitleDisplay:!1}set subtitleDisplay(t){let i=this.subtitleTrackController;i&&(i.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(t){this.latencyController.targetLatency=t}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(t){this.levelController.pathwayPriority=t}get bufferedToEnd(){var t;return!!((t=this.bufferController)!=null&&t.bufferedToEnd)}get interstitialsManager(){var t;return((t=this.interstitialsController)==null?void 0:t.interstitialsManager)||null}getMediaDecodingInfo(t,i=this.allAudioTracks){let s=Hc(i);return Gc(t,s,navigator.mediaCapabilities)}}return n.defaultConfig=void 0,n})();var $d=(()=>{class n{constructor(t){this.http=t,this.baseUrl="http://192.168.1.235:45032"}setSettings(t,i){let s=new va;s=s.set("Access-Control-Allow-Origin","*"),this.http.put(this.baseUrl+"/camera/settings",t,{headers:s}).subscribe(r=>{i&&i(r)})}getSettings(t){this.http.get(this.baseUrl+"/camera/settings").subscribe(i=>{t&&t(i)})}static{this.\u0275fac=function(i){return new(i||n)(J(ya))}}static{this.\u0275prov=ye({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var Jp=["videoPlayer"];function em(n,e){n&1&&(_(0,"div",9),at(1,"video",10,0),E())}function tm(n,e){if(n&1){let t=Mt();_(0,"div",11)(1,"div",1)(2,"div",12)(3,"button",13),$("click",function(){N(t);let s=F();return s.settings.AEL=="Unlocked"?s.settings.AEL="Locked":s.settings.AEL="Unlocked",B(s.sendSetting("AEL"))}),x(4,"AEL"),E(),_(5,"button",13),$("click",function(){N(t);let s=F();return s.settings.AWBL=="Unlocked"?s.settings.AWBL="Locked":s.settings.AWBL="Unlocked",B(s.sendSetting("AWBL"))}),x(6,"AWBL"),E()(),_(7,"div",14)(8,"button",15),x(9,"AF"),E(),_(10,"button",16),at(11,"i",17),E()(),_(12,"div",18)(13,"label"),x(14,"Display"),E(),_(15,"select",19),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.DispMode,s)||(r.settings.DispMode=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("DispMode"))}),_(16,"option",20),x(17,"Tutte le informazioni"),E(),_(18,"option",21),x(19,"Informazioni grafiche"),E(),_(20,"option",22),x(21,"Nessuna informazione"),E(),_(22,"option",23),x(23,"Istogramma"),E(),_(24,"option",24),x(25,"Livelli"),E(),_(26,"option",25),x(27,"Viewfinder"),E(),_(28,"option",26),x(29,"Spegni"),E()(),_(30,"label"),x(31,"Griglia"),E(),_(32,"select",19),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.GridLineDisplay,s)||(r.settings.GridLineDisplay=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("GridLineDisplay"))}),_(33,"option",27),x(34,"Disattivato"),E(),_(35,"option",28),x(36,"Attivato"),E()()()()()}if(n&2){let t=F();X(3),We("btn-primary",t.settings.AEL=="Locked"),X(2),We("btn-primary",t.settings.AWBL=="Locked"),X(10),Ze("ngModel",t.settings.DispMode),X(17),Ze("ngModel",t.settings.GridLineDisplay)}}function im(n,e){n&1&&(_(0,"span"),x(1,"M"),E())}function sm(n,e){n&1&&(_(0,"span"),x(1,"P"),E())}function nm(n,e){n&1&&(_(0,"span"),x(1,"i"),E())}function rm(n,e){n&1&&(_(0,"span"),x(1,"A"),E())}function om(n,e){n&1&&(_(0,"span"),x(1,"S"),E())}function am(n,e){if(n&1){let t=Mt();_(0,"div",11)(1,"div",1)(2,"div",29)(3,"label"),x(4,"Mode"),E(),at(5,"br"),_(6,"div",30)(7,"button",31),at(8,"i",32),Oe(9,im,2,0,"span",33)(10,sm,2,0,"span",33)(11,nm,2,0,"span",33)(12,rm,2,0,"span",33)(13,om,2,0,"span",33),E(),_(14,"ul",34)(15,"li")(16,"a",35),$("click",function(){N(t);let s=F();return s.settings.ExposureProgramMode="M_Manual",B(s.sendSetting("ExposureProgramMode"))}),x(17,"Manuale (M)"),E()(),_(18,"li")(19,"a",35),$("click",function(){N(t);let s=F();return s.settings.ExposureProgramMode="P_Auto",B(s.sendSetting("ExposureProgramMode"))}),x(20,"Automatico (P)"),E()(),_(21,"li")(22,"a",35),$("click",function(){N(t);let s=F();return s.settings.ExposureProgramMode="Auto",B(s.sendSetting("ExposureProgramMode"))}),x(23,"Programmata auto"),E()(),_(24,"li")(25,"a",35),$("click",function(){N(t);let s=F();return s.settings.ExposureProgramMode="A_AperturePriority",B(s.sendSetting("ExposureProgramMode"))}),x(26,"Priorit\xE0 diaframma (A)"),E()(),x(27," A_AperturePriority "),_(28,"li")(29,"a",35),$("click",function(){N(t);let s=F();return s.settings.ExposureProgramMode="S_ShutterSpeedPriority",B(s.sendSetting("ExposureProgramMode"))}),x(30,"Priorit\xE0 tempi (S)"),E()()()()(),_(31,"div",36)(32,"label"),x(33,"Shutter Speed"),E(),_(34,"select",37),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.ShutterSpeed,s)||(r.settings.ShutterSpeed=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("ShutterSpeed"))}),_(35,"option",38),x(36,"BULB"),E(),_(37,"option",39),x(38,"30''"),E(),_(39,"option",40),x(40,"25''"),E(),_(41,"option",41),x(42,"20''"),E(),_(43,"option",42),x(44,"15''"),E(),_(45,"option",43),x(46,"13''"),E(),_(47,"option",44),x(48,"10''"),E(),_(49,"option",45),x(50,"8''"),E(),_(51,"option",46),x(52,"6''"),E(),_(53,"option",47),x(54,"4''"),E(),_(55,"option",48),x(56,"3.2''"),E(),_(57,"option",49),x(58,"2.5''"),E(),_(59,"option",50),x(60,"2''"),E(),_(61,"option",51),x(62,"1.6''"),E(),_(63,"option",52),x(64,"1.3''"),E(),_(65,"option",53),x(66,"1''"),E(),_(67,"option",54),x(68,"0.8''"),E(),_(69,"option",55),x(70,"0.6''"),E(),_(71,"option",56),x(72,"0.5''"),E(),_(73,"option",57),x(74,"0.4''"),E(),_(75,"option",58),x(76,"1/3"),E(),_(77,"option",59),x(78,"1/4"),E(),_(79,"option",60),x(80,"1/5"),E(),_(81,"option",61),x(82,"1/6"),E(),_(83,"option",62),x(84,"1/8"),E(),_(85,"option",63),x(86,"1/10"),E(),_(87,"option",64),x(88,"1/13"),E(),_(89,"option",65),x(90,"1/15"),E(),_(91,"option",66),x(92,"1/20"),E(),_(93,"option",67),x(94,"1/25"),E(),_(95,"option",68),x(96,"1/30"),E(),_(97,"option",69),x(98,"1/40"),E(),_(99,"option",70),x(100,"1/50"),E(),_(101,"option",71),x(102,"1/60"),E(),_(103,"option",72),x(104,"1/80"),E(),_(105,"option",73),x(106,"1/100"),E(),_(107,"option",74),x(108,"1/125"),E(),_(109,"option",75),x(110,"1/160"),E(),_(111,"option",76),x(112,"1/200"),E(),_(113,"option",77),x(114,"1/250"),E(),_(115,"option",78),x(116,"1/320"),E(),_(117,"option",79),x(118,"1/400"),E(),_(119,"option",80),x(120,"1/500"),E(),_(121,"option",81),x(122,"1/640"),E(),_(123,"option",82),x(124,"1/800"),E(),_(125,"option",83),x(126,"1/1000"),E(),_(127,"option",84),x(128,"1/1250"),E(),_(129,"option",85),x(130,"1/1600"),E(),_(131,"option",86),x(132,"1/2000"),E(),_(133,"option",87),x(134,"1/2500"),E(),_(135,"option",88),x(136,"1/3200"),E(),_(137,"option",89),x(138,"1/4000"),E()()(),_(139,"div",29)(140,"label"),x(141,"F"),E(),_(142,"select",37),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.FNumber,s)||(r.settings.FNumber=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("FNumber"))}),_(143,"option",90),x(144,"2.8"),E(),_(145,"option",91),x(146,"3.2"),E(),_(147,"option",92),x(148,"3.5"),E(),_(149,"option",93),x(150,"4"),E(),_(151,"option",94),x(152,"4.5"),E(),_(153,"option",95),x(154,"5"),E(),_(155,"option",96),x(156,"5.6"),E(),_(157,"option",97),x(158,"6.3"),E(),_(159,"option",98),x(160,"7.1"),E(),_(161,"option",99),x(162,"8"),E(),_(163,"option",100),x(164,"9"),E(),_(165,"option",101),x(166,"10"),E(),_(167,"option",102),x(168,"11"),E(),_(169,"option",103),x(170,"13"),E(),_(171,"option",104),x(172,"14"),E(),_(173,"option",105),x(174,"16"),E(),_(175,"option",106),x(176,"18"),E(),_(177,"option",107),x(178,"20"),E(),_(179,"option",108),x(180,"22"),E()()(),_(181,"div",18)(182,"label"),x(183,"ISO"),E(),_(184,"select",37),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.IsoSensitivity,s)||(r.settings.IsoSensitivity=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("IsoSensitivity"))}),_(185,"option",109),x(186,"AUTO"),E(),_(187,"option",110),x(188,"102400"),E(),_(189,"option",111),x(190,"80000"),E(),_(191,"option",112),x(192,"64000"),E(),_(193,"option",113),x(194,"51200"),E(),_(195,"option",114),x(196,"40000"),E(),_(197,"option",115),x(198,"32000"),E(),_(199,"option",116),x(200,"25600"),E(),_(201,"option",117),x(202,"20000"),E(),_(203,"option",118),x(204,"16000"),E(),_(205,"option",119),x(206,"12800"),E(),_(207,"option",120),x(208,"10000"),E(),_(209,"option",121),x(210,"8000"),E(),_(211,"option",122),x(212,"6400"),E(),_(213,"option",123),x(214,"5000"),E(),_(215,"option",124),x(216,"4000"),E(),_(217,"option",125),x(218,"3200"),E(),_(219,"option",126),x(220,"2500"),E(),_(221,"option",127),x(222,"2000"),E(),_(223,"option",128),x(224,"1600"),E(),_(225,"option",129),x(226,"1250"),E(),_(227,"option",130),x(228,"1000"),E(),_(229,"option",131),x(230,"800"),E(),_(231,"option",132),x(232,"640"),E(),_(233,"option",133),x(234,"500"),E(),_(235,"option",134),x(236,"400"),E(),_(237,"option",135),x(238,"320"),E(),_(239,"option",136),x(240,"250"),E(),_(241,"option",137),x(242,"200"),E(),_(243,"option",138),x(244,"160"),E(),_(245,"option",139),x(246,"125"),E(),_(247,"option",140),x(248,"100"),E(),_(249,"option",141),x(250,"80"),E(),_(251,"option",142),x(252,"64"),E(),_(253,"option",143),x(254,"50"),E()()(),_(255,"div",18)(256,"label"),x(257,"EV"),E(),_(258,"select",37),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.ExposureBiasCompensation,s)||(r.settings.ExposureBiasCompensation=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("ExposureBiasCompensation"))}),_(259,"option",144),x(260,"+5.0"),E(),_(261,"option"),x(262,"+4.7"),E(),_(263,"option"),x(264,"+4.3"),E(),_(265,"option"),x(266,"+4.0"),E(),_(267,"option"),x(268,"+3.7"),E(),_(269,"option"),x(270,"+3.3"),E(),_(271,"option"),x(272,"+3.0"),E(),_(273,"option"),x(274,"+2.7"),E(),_(275,"option"),x(276,"+2.3"),E(),_(277,"option"),x(278,"+2.0"),E(),_(279,"option"),x(280,"+1.7"),E(),_(281,"option"),x(282,"+1.3"),E(),_(283,"option"),x(284,"+1.0"),E(),_(285,"option"),x(286,"+0.7"),E(),_(287,"option",145),x(288,"+0.3"),E(),_(289,"option",146),x(290,"0.0"),E(),_(291,"option"),x(292,"-0.3"),E(),_(293,"option"),x(294,"-0.7"),E(),_(295,"option"),x(296,"-1.0"),E(),_(297,"option"),x(298,"-1.3"),E(),_(299,"option"),x(300,"-1.7"),E(),_(301,"option"),x(302,"-2.0"),E(),_(303,"option"),x(304,"-2.3"),E(),_(305,"option"),x(306,"-2.7"),E(),_(307,"option"),x(308,"-3.0"),E(),_(309,"option"),x(310,"-3.3"),E(),_(311,"option"),x(312,"-3.7"),E(),_(313,"option"),x(314,"-4.0"),E(),_(315,"option"),x(316,"-4.3"),E(),_(317,"option"),x(318,"-4.7"),E(),_(319,"option"),x(320,"-5.0"),E()()()()()}if(n&2){let t=F();X(9),le("ngIf",t.settings.ExposureProgramMode=="M_Manual"),X(),le("ngIf",t.settings.ExposureProgramMode=="P_Auto"),X(),le("ngIf",t.settings.ExposureProgramMode=="Auto"),X(),le("ngIf",t.settings.ExposureProgramMode=="A_AperturePriority"),X(),le("ngIf",t.settings.ExposureProgramMode=="S_ShutterSpeedPriority"),X(21),Ze("ngModel",t.settings.ShutterSpeed),X(108),Ze("ngModel",t.settings.FNumber),X(42),Ze("ngModel",t.settings.IsoSensitivity),X(74),Ze("ngModel",t.settings.ExposureBiasCompensation)}}function lm(n,e){n&1&&(_(0,"span"),x(1,"3:2"),E())}function cm(n,e){n&1&&(_(0,"span"),x(1,"4:3"),E())}function dm(n,e){n&1&&(_(0,"span"),x(1,"16:9"),E())}function hm(n,e){n&1&&(_(0,"span"),x(1,"1:1"),E())}function um(n,e){n&1&&(_(0,"span"),x(1,"AWB"),E())}function fm(n,e){n&1&&(_(0,"span"),x(1,"Multipla"),E())}function gm(n,e){n&1&&(_(0,"span"),x(1,"Centro"),E())}function pm(n,e){n&1&&(_(0,"span"),x(1,"Spot STD"),E())}function mm(n,e){n&1&&(_(0,"span"),x(1,"Spot largo"),E())}function vm(n,e){n&1&&(_(0,"span"),x(1,"Media"),E())}function ym(n,e){n&1&&(_(0,"span"),x(1,"Luci"),E())}function _m(n,e){n&1&&(_(0,"span"),x(1,"MF"),E())}function Em(n,e){n&1&&(_(0,"span"),x(1,"AF S"),E())}function Sm(n,e){n&1&&(_(0,"span"),x(1,"AF C"),E())}function xm(n,e){n&1&&(_(0,"span"),x(1,"AF A"),E())}function Tm(n,e){n&1&&(_(0,"span"),x(1,"DMF"),E())}function bm(n,e){n&1&&(_(0,"span"),x(1,"PF"),E())}function Am(n,e){if(n&1){let t=Mt();_(0,"div",11)(1,"div",1)(2,"div",29)(3,"label"),x(4,"Format"),E(),_(5,"select",37),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.FileType,s)||(r.settings.FileType=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("FileType"))}),_(6,"option",147),x(7,"JPEG"),E(),_(8,"option",148),x(9,"RAW"),E(),_(10,"option",149),x(11,"RAW+J"),E()()(),_(12,"div",29)(13,"label"),x(14,"Type"),E(),_(15,"select",37),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.RAW_FileCompressionType,s)||(r.settings.RAW_FileCompressionType=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("RAW_FileCompressionType"))}),_(16,"option",150),x(17,"RAW (non compresso)"),E(),_(18,"option",151),x(19,"RAW L"),E(),_(20,"option",152),x(21,"RAW M"),E(),_(22,"option",153),x(23,"RAW S"),E(),_(24,"option",154),x(25,"RAW (compresso)"),E()()(),_(26,"div",29)(27,"label"),x(28,"Quality"),E(),_(29,"select",37),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.StillImageQuality,s)||(r.settings.StillImageQuality=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("StillImageQuality"))}),_(30,"option",155),x(31,"X.FINE"),E(),_(32,"option",156),x(33,"FINE"),E(),_(34,"option",157),x(35,"STD"),E(),_(36,"option",158),x(37,"LIGHT"),E()()(),_(38,"div",29)(39,"label"),x(40,"Size"),E(),_(41,"select",37),et("ngModelChange",function(s){N(t);let r=F();return Je(r.settings.ImageSize,s)||(r.settings.ImageSize=s),B(s)}),$("ngModelChange",function(){N(t);let s=F();return B(s.sendSetting("ImageSize"))}),_(42,"option"),x(43,"L"),E(),_(44,"option"),x(45,"M"),E(),_(46,"option"),x(47,"S"),E()()()(),_(48,"div",159)(49,"div",160)(50,"div",30)(51,"button",161),Oe(52,lm,2,0,"span",33)(53,cm,2,0,"span",33)(54,dm,2,0,"span",33)(55,hm,2,0,"span",33),E(),_(56,"ul",162)(57,"li")(58,"a",35),$("click",function(){N(t);let s=F();return s.settings.AspectRatio="3_2",B(s.sendSetting("AspectRatio"))}),x(59,"3:2"),E()(),_(60,"li")(61,"a",35),$("click",function(){N(t);let s=F();return s.settings.AspectRatio="4_3",B(s.sendSetting("AspectRatio"))}),x(62,"4:3"),E()(),_(63,"li")(64,"a",35),$("click",function(){N(t);let s=F();return s.settings.AspectRatio="16_9",B(s.sendSetting("AspectRatio"))}),x(65,"16:9"),E()(),_(66,"li")(67,"a",35),$("click",function(){N(t);let s=F();return s.settings.AspectRatio="1_1",B(s.sendSetting("AspectRatio"))}),x(68,"1:1"),E()()()()(),_(69,"div",160)(70,"div",30)(71,"button",163),x(72),E(),_(73,"ul",164)(74,"li")(75,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Scatto singolo")}),x(76,"Scatto singolo"),E()(),_(77,"li")(78,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Scatto multiplo")}),x(79,"Scatto multiplo"),E()(),_(80,"li")(81,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Autoscatto singolo")}),x(82,"Autoscatto singolo"),E()(),_(83,"li")(84,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Autoscatto multiplo")}),x(85,"Autoscatto multiplo"),E()(),_(86,"li")(87,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Esp. a forc. cont.")}),x(88,"Esp. a forc. cont."),E()(),_(89,"li")(90,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Esp. a forc. sing.")}),x(91,"Esp. a forc. sing."),E()(),_(92,"li")(93,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Esp. forc. ms. fco")}),x(94,"Esp. forc. ms. fco"),E()(),_(95,"li")(96,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Esp. forc. WB")}),x(97,"Esp. forc. WB"),E()(),_(98,"li")(99,"a",35),$("click",function(){N(t);let s=F();return B(s.settings2.modeNext="Esp. forc. DRO")}),x(100,"Esp. forc. DRO"),E()()()()(),_(101,"div",160)(102,"div",30)(103,"button",165),Oe(104,um,2,0,"span",33),x(105),E(),_(106,"ul",166)(107,"li")(108,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="AWB",B(s.sendSetting("WhiteBalance"))}),x(109,"Automatico"),E()(),_(110,"li")(111,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Daylight",B(s.sendSetting("WhiteBalance"))}),x(112,"Luce giorno"),E()(),_(113,"li")(114,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Shadow",B(s.sendSetting("WhiteBalance"))}),x(115,"Ombra"),E()(),_(116,"li")(117,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Cloudy",B(s.sendSetting("WhiteBalance"))}),x(118,"Cielo coperto"),E()(),_(119,"li")(120,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Tungsten",B(s.sendSetting("WhiteBalance"))}),x(121,"A incandescente"),E()(),_(122,"li")(123,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Fluorescent",B(s.sendSetting("WhiteBalance"))}),x(124,"Fluorescente"),E()(),_(125,"li")(126,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Fluorescent_WarmWhite",B(s.sendSetting("WhiteBalance"))}),x(127,"Fluorescente bianca calda"),E()(),_(128,"li")(129,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Fluorescent_CoolWhite",B(s.sendSetting("WhiteBalance"))}),x(130,"Fluorescente bianca fredda"),E()(),_(131,"li")(132,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Fluorescent_Daylight",B(s.sendSetting("WhiteBalance"))}),x(133,"Fluorescente luce giorno"),E()(),_(134,"li")(135,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Underwater_Auto",B(s.sendSetting("WhiteBalance"))}),x(136,"Automatico sottoacqua"),E()(),_(137,"li")(138,"a",35),$("click",function(){N(t);let s=F();return s.settings.WhiteBalance="Flush",B(s.sendSetting("WhiteBalance"))}),x(139,"T. Colore/Filtro"),E()()()()(),_(140,"div",160)(141,"div",30)(142,"button",167),x(143," OFF "),E(),_(144,"ul",168)(145,"li")(146,"a",169),x(147,"Disattivato"),E()(),_(148,"li")(149,"a",169),x(150,"Automatico"),E()(),_(151,"li")(152,"a",169),x(153,"Lv1"),E()(),_(154,"li")(155,"a",169),x(156,"Lv2"),E()(),_(157,"li")(158,"a",169),x(159,"Lv3"),E()(),_(160,"li")(161,"a",169),x(162,"Lv4"),E()(),_(163,"li")(164,"a",169),x(165,"Lv5"),E()()()()(),_(166,"div",160)(167,"div",30)(168,"button",170),x(169),E(),_(170,"ul",171)(171,"li")(172,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusArea="Wide",B(s.sendSetting("FocusArea"))}),x(173,"Ampia"),E()(),_(174,"li")(175,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusArea="Zone",B(s.sendSetting("FocusArea"))}),x(176,"Zona"),E()(),_(177,"li")(178,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusArea="Center",B(s.sendSetting("FocusArea"))}),x(179,"Centro"),E()(),_(180,"li")(181,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusArea="Flexible_Spot_L",B(s.sendSetting("FocusArea"))}),x(182,"Spot: L"),E()(),_(183,"li")(184,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusArea="Flexible_Spot_M",B(s.sendSetting("FocusArea"))}),x(185,"Spot: M"),E()(),_(186,"li")(187,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusArea="Flexible_Spot_S",B(s.sendSetting("FocusArea"))}),x(188,"Spot: S"),E()(),_(189,"li")(190,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusArea="Expand_Flexible_Spot",B(s.sendSetting("FocusArea"))}),x(191,"Spot: Espanso"),E()()()()(),_(192,"div",160)(193,"div",30)(194,"button",172),Oe(195,fm,2,0,"span",33)(196,gm,2,0,"span",33)(197,pm,2,0,"span",33)(198,mm,2,0,"span",33)(199,vm,2,0,"span",33)(200,ym,2,0,"span",33),E(),_(201,"ul",173)(202,"li")(203,"a",35),$("click",function(){N(t);let s=F();return s.settings.MeteringMode="Multi",B(s.sendSetting("MeteringMode"))}),x(204,"Multipla"),E()(),_(205,"li")(206,"a",35),$("click",function(){N(t);let s=F();return s.settings.MeteringMode="CenterSpot",B(s.sendSetting("MeteringMode"))}),x(207,"Centro spot"),E()(),_(208,"li")(209,"a",35),$("click",function(){N(t);let s=F();return s.settings.MeteringMode="Spot_Standard",B(s.sendSetting("MeteringMode"))}),x(210,"Spot: STD"),E()(),_(211,"li")(212,"a",35),$("click",function(){N(t);let s=F();return s.settings.MeteringMode="Spot_Large",B(s.sendSetting("MeteringMode"))}),x(213,"Spot: L"),E()(),_(214,"li")(215,"a",35),$("click",function(){N(t);let s=F();return s.settings.MeteringMode="Average",B(s.sendSetting("MeteringMode"))}),x(216,"Media schermo intero"),E()(),_(217,"li")(218,"a",35),$("click",function(){N(t);let s=F();return s.settings.MeteringMode="HighLightWeigheted",B(s.sendSetting("MeteringMode"))}),x(219,"Highlight"),E()()()()(),_(220,"div",160)(221,"div",30)(222,"button",174),Oe(223,_m,2,0,"span",33)(224,Em,2,0,"span",33)(225,Sm,2,0,"span",33)(226,xm,2,0,"span",33)(227,Tm,2,0,"span",33)(228,bm,2,0,"span",33),E(),_(229,"ul",175)(230,"li")(231,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusMode="MF",B(s.sendSetting("FocusMode"))}),x(232,"Fuoco manuale"),E()(),_(233,"li")(234,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusMode="AF_S",B(s.sendSetting("FocusMode"))}),x(235,"AF Singolo"),E()(),_(236,"li")(237,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusMode="AF_C",B(s.sendSetting("FocusMode"))}),x(238,"AF Automatico"),E()(),_(239,"li")(240,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusMode="AF_A",B(s.sendSetting("FocusMode"))}),x(241,"AF Continuo"),E()(),_(242,"li")(243,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusMode="DMF",B(s.sendSetting("FocusMode"))}),x(244,"Fuoco manuale direzionale"),E()(),_(245,"li")(246,"a",35),$("click",function(){N(t);let s=F();return s.settings.FocusMode="PF",B(s.sendSetting("FocusMode"))}),x(247,"Preset focus"),E()()()()(),_(248,"div",160)(249,"div",30)(250,"button",176),x(251," ST "),E(),_(252,"ul",177)(253,"li")(254,"a",169),x(255,"ST+"),E()(),_(256,"li")(257,"a",169),x(258,"PT+"),E()(),_(259,"li")(260,"a",169),x(261,"NT+"),E()(),_(262,"li")(263,"a",169),x(264,"VV+"),E()(),_(265,"li")(266,"a",169),x(267,"VV2+"),E()(),_(268,"li")(269,"a",169),x(270,"FL+"),E()(),_(271,"li")(272,"a",169),x(273,"IN+"),E()(),_(274,"li")(275,"a",169),x(276,"SH+"),E()(),_(277,"li")(278,"a",169),x(279,"BW+"),E()(),_(280,"li")(281,"a",169),x(282,"SE+"),E()()()()()()()}if(n&2){let t=F();X(5),Ze("ngModel",t.settings.FileType),X(10),Ze("ngModel",t.settings.RAW_FileCompressionType),X(14),Ze("ngModel",t.settings.StillImageQuality),X(12),Ze("ngModel",t.settings.ImageSize),X(11),le("ngIf",t.settings.AspectRatio=="3_2"),X(),le("ngIf",t.settings.AspectRatio=="4_3"),X(),le("ngIf",t.settings.AspectRatio=="16_9"),X(),le("ngIf",t.settings.AspectRatio=="1_1"),X(17),is(" ",t.settings2.modeNext," "),X(32),le("ngIf",t.settings.WhiteBalance=="AWB"),X(),is(" ",t.settings.WhiteBalance," "),X(64),is(" ",t.settings.FocusArea," "),X(26),le("ngIf",t.settings.MeteringMode=="Multi"),X(),le("ngIf",t.settings.MeteringMode=="CenterSpot"),X(),le("ngIf",t.settings.MeteringMode=="Spot_Standard"),X(),le("ngIf",t.settings.MeteringMode=="Spot_Large"),X(),le("ngIf",t.settings.MeteringMode=="Average"),X(),le("ngIf",t.settings.MeteringMode=="HighLightWeigheted"),X(23),le("ngIf",t.settings.FocusMode=="MF"),X(),le("ngIf",t.settings.FocusMode=="AF_S"),X(),le("ngIf",t.settings.FocusMode=="AF_C"),X(),le("ngIf",t.settings.FocusMode=="AF_A"),X(),le("ngIf",t.settings.FocusMode=="DMF"),X(),le("ngIf",t.settings.FocusMode=="PF")}}function Im(n,e){n&1&&(_(0,"span"),x(1," MF "),E())}function Cm(n,e){n&1&&(_(0,"span"),x(1," AF "),E())}function Dm(n,e){if(n&1){let t=Mt();_(0,"div",11)(1,"div",1)(2,"div",12)(3,"button",178),$("click",function(){N(t);let s=F();return s.settings.FocusModeSetting=="Manual"?s.settings.FocusModeSetting="Automatic":s.settings.FocusModeSetting="Manual",B(s.sendSetting("FocusModeSetting"))}),Oe(4,Im,2,0,"span",33)(5,Cm,2,0,"span",33),E()(),_(6,"div",179)(7,"small"),at(8,"i",180),E(),_(9,"button",181),$("click",function(){N(t);let s=F();return B(s.setFocalDistanceInMeter(-10))}),x(10," <<< "),E(),_(11,"button",181),$("click",function(){N(t);let s=F();return B(s.setFocalDistanceInMeter(-1))}),x(12," << "),E(),_(13,"button",181),$("click",function(){N(t);let s=F();return B(s.setFocalDistanceInMeter(-.1))}),x(14," < "),E(),_(15,"button",181),$("click",function(){N(t);let s=F();return B(s.setFocalDistanceInMeter(.1))}),x(16," > "),E(),_(17,"button",181),$("click",function(){N(t);let s=F();return B(s.setFocalDistanceInMeter(1))}),x(18," >> "),E(),_(19,"button",181),$("click",function(){N(t);let s=F();return B(s.setFocalDistanceInMeter(10))}),x(20," >>> "),E(),_(21,"small"),at(22,"i",182),E()()()()}if(n&2){let t=F();X(4),le("ngIf",t.settings.FocusModeSetting=="Manual"),X(),le("ngIf",t.settings.FocusModeSetting=="Automatic")}}var Gd=(()=>{class n{constructor(t){this.sonyApi=t,this.panels={shooting:!0,main:!0,sub:!0,focus:!0},this.showPreview=!1,this.url="/hls/hls/1_0.m3u8",this.settings={DispMode:"DisplayAllInfo",GridLineDisplay:"Off",AEL:"Unlocked",AWBL:"Unlocked",FNumber:"F22",ExposureBiasCompensation:"0Ev",ShutterSpeed:"bulb",IsoSensitivity:"ISO 100",ExposureProgramMode:"M_Manual",FocusModeSetting:"Manual",FileType:"Jpeg",RAW_FileCompressionType:"Uncompression",StillImageQuality:"Fine",WhiteBalance:"AWB",FocusMode:"MF",MeteringMode:"Multi",DriveMode:"Single",DRO:"Auto",ImageSize:"L",AspectRatio:"3_2",FocusArea:"Wide",ColorTemp:0,ColorTuningAB:"B0.00",ColorTuningGM:"M0.00",LiveViewDisplayEffect:"ON",StillImageStoreDestination:"MemoryCard",PriorityKeySettings:"CameraPosition",AFTrackingSensitivity:"3",FocalDistanceInMeter:2},this.settings2={modality:"A",ShutterSpeed:"1/500",F:2.8,ISO:100,EV:0,format:"RAW",type:"RAW (non compresso)",quality:"X.FINE",size:"L",aspectRatio:"3:2",modeNext:"Scatto singolo",WB:"AWB",FocusMode:"MF"}}ngAfterViewInit(){this.initVideoPlayer()}ngOnInit(){this.getSettings()}getSettings(){this.sonyApi.getSettings(t=>{t.data&&(this.settings=t.data[0])})}sendSetting(t){let i={};i[t]=this.settings[t],this.sonyApi.setSettings(i,s=>{console.log(s)})}sendSettings(){this.sonyApi.setSettings(this.settings,t=>{console.log(t)})}setFocalDistanceInMeter(t){t<0&&this.settings.FocalDistanceInMeter==0||(this.settings.FocalDistanceInMeter+t,this.settings.FocalDistanceInMeter<0&&(this.settings.FocalDistanceInMeter=0),this.sendSetting("FocalDistanceInMeter"))}initVideoPlayer(){if(!this.videoPlayer?.nativeElement)return;let t=this.videoPlayer.nativeElement;dn.isSupported()&&(this.hls=new dn,this.hls.loadSource(this.url),this.hls.attachMedia(t),this.hls.on(dn.Events.MANIFEST_PARSED,()=>{console.log("sup"),t.play().catch(i=>{console.warn("Autoplay fallito:",i)})}))}static{this.\u0275fac=function(i){return new(i||n)(re($d))}}static{this.\u0275cmp=Pt({type:n,selectors:[["app-dashboard"]],viewQuery:function(i,s){if(i&1&&_i(Jp,5),i&2){let r;Ot(r=Ft())&&(s.videoPlayer=r.first)}},standalone:!0,features:[Ei],decls:23,vars:23,consts:[["videoPlayer",""],[1,"row"],["class","col-md-8",4,"ngIf"],[1,"col-md-4"],[1,"card"],[1,"card-header"],[1,"fa","fa-chevron-up",3,"click"],["class","card-body",4,"ngIf"],[1,"card","mt-2"],[1,"col-md-8"],[2,"width","100%","height","100%"],[1,"card-body"],[1,"col-2"],["type","button",1,"btn","btn-sm","btn-block",3,"click"],[1,"col-6","text-center"],["type","button",1,"btn","btn-primary","btn-floating","m-1"],["type","button",1,"btn","btn-primary","btn-lg","btn-floating","m-1"],[1,"fa","fa-camera"],[1,"col-4"],[1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["value","DisplayAllInfo"],["value","GraphicDisplay"],["value","NoDispInfo"],["value","Histogram"],["value","Level"],["value","ForViewFinder"],["value","MonitorOff"],["value","Off"],["value","On"],[1,"col-3"],["mdbDropdown","",1,"dropdown"],["type","button","id","modality","aria-expanded","false","mdbDropdownToggle","","title","Modalit\xE0",1,"btn","dropdown-toggle"],[1,"fa","fa-camera","fa-3x"],[4,"ngIf"],["mdbDropdownMenu","","aria-labelledby","modality",1,"dropdown-menu"],["href","#",1,"dropdown-item",3,"click"],[1,"col-6"],[1,"form-control",3,"ngModelChange","ngModel"],["value","bulb"],["value",'30"'],["value",'25"'],["value",'20"'],["value",'15"'],["value",'13"'],["value",'10"'],["value",'8"'],["value",'6"'],["value",'4"'],["value",'3.2"'],["value",'2.5"'],["value",'2"'],["value",'1.6"'],["value",'1.3"'],["value",'1"'],["value",'0.8"'],["value",'0.6"'],["value",'0.5"'],["value",'0.4"'],["value","1/3"],["value","1/4"],["value","1/5"],["value","1/6"],["value","1/8"],["value","1/10"],["value","1/13"],["value","1/15"],["value","1/20"],["value","1/25"],["value","1/30"],["value","1/40"],["value","1/50"],["value","1/60"],["value","1/80"],["value","1/100"],["value","1/125"],["value","1/160"],["value","1/200"],["value","1/250"],["value","1/320"],["value","1/400"],["value","1/500"],["value","1/640"],["value","1/800"],["value","1/1000"],["value","1/1250"],["value","1/1600"],["value","1/2000"],["value","1/2500"],["value","1/3200"],["value","1/4000"],["value","F2.8"],["value","F3.2"],["value","F3.5"],["value","F4"],["value","F4.5"],["value","F5"],["value","F5.6"],["value","F6.3"],["value","F7"],["value","F8"],["value","F9"],["value","F10"],["value","F11"],["value","F13"],["value","F14"],["value","F16"],["value","F18"],["value","F20"],["value","F22"],["value","ISO AUTO"],["value","ISO 102400"],["value","ISO 80000"],["value","ISO 64000"],["value","ISO 51200"],["value","ISO 40000"],["value","ISO 32000"],["value","ISO 25600"],["value","ISO 20000"],["value","ISO 16000"],["value","ISO 12800"],["value","ISO 10000"],["value","ISO 8000"],["value","ISO 6400"],["value","ISO 5000"],["value","ISO 4000"],["value","ISO 3200"],["value","ISO 2500"],["value","ISO 2000"],["value","ISO 1600"],["value","ISO 1250"],["value","ISO 1000"],["value","ISO 800"],["value","ISO 640"],["value","ISO 500"],["value","ISO 400"],["value","ISO 320"],["value","ISO 250"],["value","ISO 200"],["value","ISO 160"],["value","ISO 125"],["value","ISO 100"],["value","ISO 80"],["value","ISO 64"],["value","ISO 50"],["value","5.0Ev"],["value","0_3Ev"],["value","0Ev"],["value","Jpeg"],["value","Raw"],["value","RawJpeg"],["value","Uncompression"],["value","LossLessL"],["value","LossLessM"],["value","LossLessS"],["value","Compression"],["value","ExFine"],["value","Fine"],["value","Standard"],["value","Light"],[1,"row","border-top","mt-1"],[1,"col-2","m-2"],["type","button","id","aspectRatio","aria-expanded","false","mdbDropdownToggle","","title","Rapporto aspetto",1,"btn","btn-primary","dropdown-toggle"],["mdbDropdownMenu","","aria-labelledby","AspectRatio",1,"dropdown-menu"],["type","button","id","modeNext","aria-expanded","false","mdbDropdownToggle","","title","Modo avanzamento",1,"btn","btn-primary","dropdown-toggle"],["mdbDropdownMenu","","aria-labelledby","modeNext",1,"dropdown-menu"],["type","button","id","WB","aria-expanded","false","mdbDropdownToggle","","title","Bilanciamento bianco",1,"btn","btn-primary","dropdown-toggle"],["mdbDropdownMenu","","aria-labelledby","WB",1,"dropdown-menu"],["type","button","id","optimizer","aria-expanded","false","mdbDropdownToggle","","title","Ottimizzazione gm. din.",1,"btn","btn-primary","dropdown-toggle"],["mdbDropdownMenu","","aria-labelledby","optimizer",1,"dropdown-menu"],["href","#",1,"dropdown-item"],["type","button","id","focusArea","aria-expanded","false","mdbDropdownToggle","","title","Area messa a fuoco",1,"btn","btn-primary","dropdown-toggle"],["mdbDropdownMenu","","aria-labelledby","focusArea",1,"dropdown-menu"],["type","button","id","modeMisEsp","aria-expanded","false","mdbDropdownToggle","","title","Modo mis.esp.",1,"btn","btn-primary","dropdown-toggle"],["mdbDropdownMenu","","aria-labelledby","modeMisEsp",1,"dropdown-menu"],["type","button","id","modeFocus","aria-expanded","false","mdbDropdownToggle","","title","Modo messa a fuoco",1,"btn","btn-primary","dropdown-toggle"],["mdbDropdownMenu","","aria-labelledby","modeFocus",1,"dropdown-menu"],["type","button","id","custom","aria-expanded","false","mdbDropdownToggle","","title","Aspetto personale",1,"btn","btn-primary","dropdown-toggle"],["mdbDropdownMenu","","aria-labelledby","custom",1,"dropdown-menu"],["title","Alterna MF/AF",1,"btn","btn-lg",3,"click"],[1,"col-10"],[1,"fa","fa-user"],[1,"btn",3,"click"],[1,"fa","fa-mountain"]],template:function(i,s){i&1&&(_(0,"div",1),Oe(1,em,3,0,"div",2),_(2,"div",3)(3,"div",4)(4,"div",5)(5,"i",6),$("click",function(){return s.panels.shooting=!s.panels.shooting}),E(),x(6," \xA0Shooting "),E(),Oe(7,tm,37,6,"div",7),E(),_(8,"div",8)(9,"div",5)(10,"i",6),$("click",function(){return s.panels.main=!s.panels.main}),E(),x(11," \xA0Main Settings "),E(),Oe(12,am,321,9,"div",7),E(),_(13,"div",8)(14,"div",5)(15,"i",6),$("click",function(){return s.panels.sub=!s.panels.sub}),E(),x(16," \xA0Sub Settings "),E(),Oe(17,Am,283,24,"div",7),E(),_(18,"div",4)(19,"div",5)(20,"i",6),$("click",function(){return s.panels.focus=!s.panels.focus}),E(),x(21," \xA0Focus "),E(),Oe(22,Dm,23,2,"div",7),E()()()),i&2&&(X(),le("ngIf",s.showPreview),X(),We("col-md-12",!s.showPreview),X(3),We("fa-chevron-up",!s.panels.shooting)("fa-chevron-down",s.panels.shooting),X(2),le("ngIf",s.panels.shooting),X(3),We("fa-chevron-up",!s.panels.main)("fa-chevron-down",s.panels.main),X(2),le("ngIf",s.panels.main),X(3),We("fa-chevron-up",!s.panels.sub)("fa-chevron-down",s.panels.sub),X(2),le("ngIf",s.panels.sub),X(3),We("fa-chevron-up",!s.panels.focus)("fa-chevron-down",s.panels.focus),X(2),le("ngIf",s.panels.focus))},dependencies:[_l,yl,Yn,zn,El,ss,pa,Za,qa,Qa,ds,ja,Dn]})}}return n})();var Hd=[{path:"",component:Gd}];var Kd={providers:[Ia(Hd),Sa(),Ta(),_a()]};var Rm={providers:[ba()]},jd=fa(Kd,Rm);var Lm=()=>Ea(Ca,jd),Zv=Lm;export{Zv as a};
